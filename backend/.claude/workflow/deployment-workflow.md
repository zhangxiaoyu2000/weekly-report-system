# 后端智能部署工作流

## 🔄 智能部署流程 (超时30min/最大重试10次)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                🔄 后端智能持续改进闭环 (超时30min/最大重试10次)            │
└─────────────────────────────────────────────────────────────────────────┘

1️⃣ 本地查看后端DEPLOY.md
           ↓
2️⃣ 按照文档中过往经验修改配置
           ↓
3️⃣ git push到gitea仓库
           ↓
4️⃣ Webhook自动触发Jenkins CI/CD部署 [⏱️启动30分钟超时计时器]
           ↓
5️⃣ 使用Playwright MCP查看Jenkins控制台
           ↓
      ┌─────────────┐
      │后端构建成功？│
      └─────────────┘
           ↓
    ┌─────┴─────┐
    │    NO     │                    │    YES    │
    │   ❌ 失败  │                    │   ✅ 成功  │
    └─────┬─────┘                    └─────┬─────┘
          ↓                                ↓
   6️⃣ Playwright MCP提取错误信息       7️⃣ 继续查看Jenkins日志
          ↓                                ↓
   📋 后端错误分类标签识别            ┌─────────────┐
      🏗️ Maven/Gradle构建问题       │后端Docker镜像│
      ⚙️ application.yml配置        │  构建成功？   │
      🌐 数据库连接问题               └─────────────┘
      🔗 JWT/Security问题                  ↓
          ↓                         ┌─────┴─────┐
   🔍 在后端DEPLOY.md中搜索相同错误
          同时参考.claude/deploy-helper.md命令模板  │    NO     │      │    YES    │
          ↓                         │   ❌ 失败  │      │   ✅ 成功  │
      ┌─────────────┐                └─────┬─────┘      └─────┬─────┘
      │找到相同错误？│                      ↓                  ↓
      └─────────────┘               📋 错误分类+搜索      🚀 后端容器部署
           ↓                         DEPLOY.md             ↓
    ┌─────┴─────┐                          ↓          ┌─────────────┐
    │   YES     │      │    NO     │       ↓          │后端容器状态？│
    │使用已有方案│      │ 全新错误   │    应用已知方案        └─────────────┘
    └─────┬─────┘      └─────┬─────┘       ↓                  ↓
          ↓                  ↓             ↓           ┌─────┴─────┐
   ✅ 应用已知解决方案  🆕 分析新错误原因      ↓           │启动失败或 │      │启动成功│
          ↓                  ↓             ↓           │DB连接异常 │      │健康检查OK│
   🔄 git push部署           ↓        ┌─────────────┐    └─────┬─────┘      └─────┬─────┘
          ↓                  ↓        │ 问题解决？   │          ↓                  ↓
   Playwright MCP验证        ↓        └─────────────┘   🔧 sshpass SSH       ✅ 后端部署完成
          ↓                  ↓             ↓             查看应用日志              ↓
      ┌─────────────┐        ↓      ┌─────┴─────┐             ↓            记录后端成功状态
      │ 问题解决？   │        ↓      │    NO     │      │YES │ ↓                  ↓
      └─────────────┘        ↓      │ 继续分析   │      │✅ │ 📋 错误分类         📊 更新统计
           ↓                  ↓      └─────┬─────┘      └──┘  + DEPLOY.md搜索
    ┌─────┴─────┐            ↓            ↓              ↓        ↓
    │   YES     │      │ NO │ ↓      重复Docker分析     ↓   应用已知方案
    │   ✅ 完成  │      │ 💡 │ ↓          ↑             ↓        ↓
    └─────┬─────┘      └──┘  ↓          │             ↓   ┌─────────────┐
          ↓                  ↓          │             ↓   │ 问题解决？   │
    📝 记录解决方案          ↓          │             ↓   └─────────────┘
    (追加到已有问题)          ↓          │             ↓        ↓
          ↓                  ↓          │             ↓ ┌─────┴─────┐
      到7️⃣继续流程           ↓          │             ↓ │    NO     ││YES│
                          📝记录新方案    │             ↓ │继续SSH调试││ ✅ │
                          到DEPLOY.md   │             ↓ └─────┬─────┘└──┘
                              ↓         │             ↓       ↓        ↓
                          到7️⃣继续       │             ↓   重复调试   📝追加方案
                                        │             ↓       ↑    到DEPLOY.md
                                        │             ↓       │        ↓
                             ⏱️ 超时检查 │             ↓       │    到🚀运行镜像
                            (30分钟)     │             ↓       │
                              ↓         │             ↓       │
                          ┌─────────────┐│             ↓       │
                          │超时或达到10次││             ↓       │
                          │  最大重试？  ││             ↓       │
                          └─────────────┘│             ↓       │
                              ↓         │             ↓       │
                       ┌─────┴─────┐    │             ↓       │
                       │   YES     │    │NO           ↓       │
                       │ 🚨 告警升级 │   └←←←←←    后端服务启动成功
                       └─────┬─────┘              且健康检查通过
                             ↓                        ↓
                       📞 通知团队Lead           🎉 后端部署循环结束
                       📋 生成问题报告               ↓
                       🔄 手动接管流程           📊 更新成功率统计
```

## 🏷️ 后端问题分类标签系统

| 标签 | 描述 | 后端常见错误关键词 |
|------|------|----------------|
| 🏗️ **构建问题** | Maven/Gradle构建、Java编译失败 | `maven build failed`, `compilation error`, `dependency resolution` |
| ⚙️ **配置问题** | application.yml、环境变量错误 | `configuration error`, `yaml invalid`, `property missing` |
| 🌐 **环境问题** | 数据库连接、端口冲突问题 | `database connection`, `port 8082 in use`, `mysql timeout` |
| 🔗 **依赖问题** | 数据库、外部服务连接问题 | `connection refused`, `flyway migration`, `service unavailable` |
| 🐳 **Docker问题** | 后端镜像构建、容器运行问题 | `spring boot failed`, `container exit`, `jar execution error` |
| 🔐 **安全问题** | JWT、认证、授权配置问题 | `JWT signature`, `authentication failed`, `security config` |

## 🔍 后端智能错误匹配系统

**后端特定匹配规则**:
1. **构建错误匹配**: Maven、Gradle、Java编译错误
2. **运行时错误匹配**: Spring Boot、数据库、配置错误
3. **API服务错误**: REST端点、认证、业务逻辑错误
4. **部署环境错误**: 容器、端口、环境变量问题

## 📊 部署核心理念

- **故障是正常的**: 后端部署流程设计考虑了构建失败、数据库连接失败等情况
- **智能解决**: 优先使用后端DEPLOY.md中的已知解决方案，避免重复调试相同问题
- **持续学习**: 每次后端部署失败都更新文档，多原因问题支持追加解决方案
- **自动化监控**: 使用Playwright MCP自动化Jenkins监控和后端错误提取
- **知识沉淀**: 后端分类标签管理，智能匹配，所有解决方案都记录在DEPLOY.md中
- **安全边界**: 30分钟超时和10次重试限制，防止无限循环
- **人工兜底**: 超时或达到最大重试时自动升级到团队Lead处理

## 🎯 成功标准

### 后端部署完成确认
- ✅ 后端容器运行正常 (weekly-report-backend)
- ✅ MySQL数据库容器运行正常
- ✅ 后端健康检查通过
- ✅ 后端API接口响应正常 (http://23.95.193.155:8082/api/health)
- ✅ 数据库连接正常
- ✅ JWT认证功能正常
- ✅ 新后端问题已记录到backend/DEPLOY.md

### 质量指标
- 后端部署成功率 > 85%
- 后端平均解决时间 < 20分钟
- 后端重复问题发生率 < 10%
- 后端知识库覆盖率持续提升
