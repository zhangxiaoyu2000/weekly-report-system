pipeline {
    agent any
    
    environment {
        PROJECT_NAME = 'weekly-report-backend'
        DOCKER_COMPOSE_FILE = 'docker-compose.yml'
        BACKEND_PORT = '8080'
        MYSQL_PORT = '3306'
        // ä»ç¯å¢ƒå˜é‡æˆ–å‚æ•°è·å–å‰ç«¯URLï¼Œç”¨äºCORSé…ç½®
        FRONTEND_URL = "${params.FRONTEND_URL ?: 'http://localhost:3003'}"
    }
    
    parameters {
        string(name: 'FRONTEND_URL', defaultValue: 'http://23.95.193.155:3003', description: 'å‰ç«¯åº”ç”¨URLï¼ˆç”¨äºCORSé…ç½®ï¼‰')
        choice(name: 'DEPLOY_ENV', choices: ['production', 'staging', 'development'], description: 'éƒ¨ç½²ç¯å¢ƒ')
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
                echo 'âœ… ä»£ç æ£€å‡ºå®Œæˆ'
            }
        }
        
        stage('Environment Setup') {
            steps {
                script {
                    // åœæ­¢ç°æœ‰å®¹å™¨
                    sh '''
                        echo "ğŸ”„ åœæ­¢ç°æœ‰å®¹å™¨..."
                        if docker ps -a | grep -q ${PROJECT_NAME}; then
                            docker-compose -f ${DOCKER_COMPOSE_FILE} down || true
                        fi
                        
                        # æ¸…ç†æ‚¬æŒ‚é•œåƒ
                        docker image prune -f || true
                    '''
                }
            }
        }
        
        stage('Database Preparation') {
            steps {
                script {
                    sh '''
                        echo "ğŸ—„ï¸  å‡†å¤‡æ•°æ®åº“..."
                        
                        # å¯åŠ¨MySQLå®¹å™¨
                        docker-compose -f ${DOCKER_COMPOSE_FILE} up -d mysql
                        
                        # ç­‰å¾…MySQLå°±ç»ª
                        echo "â³ ç­‰å¾…MySQLå¯åŠ¨..."
                        for i in {1..60}; do
                            if docker exec weekly-report-backend-mysql mysqladmin ping -h localhost -u root -prootpass123 2>/dev/null; then
                                echo "âœ… MySQLå·²å°±ç»ª"
                                break
                            fi
                            echo "â³ ç­‰å¾…MySQLå¯åŠ¨... ($i/60)"
                            sleep 5
                        done
                        
                        # æ¸…ç†å¯èƒ½å¤±è´¥çš„Flywayè¿ç§»è®°å½•
                        echo "ğŸ”§ æ¸…ç†æ•°æ®åº“è¿ç§»è®°å½•..."
                        docker exec weekly-report-backend-mysql mysql -u root -prootpass123 -e "
                            USE weekly_report_system;
                            DELETE FROM flyway_schema_history WHERE success = 0;
                            SELECT 'æ•°æ®åº“æ¸…ç†å®Œæˆ' as status;
                        " || echo "æ•°æ®åº“æ¸…ç†å®Œæˆæˆ–æ— éœ€æ¸…ç†"
                    '''
                }
            }
        }
        
        stage('Backend Build & Deploy') {
            steps {
                script {
                    try {
                        sh '''
                            echo "ğŸ”¨ æ„å»ºå¹¶å¯åŠ¨åç«¯æœåŠ¡..."
                            
                            # è®¾ç½®ç¯å¢ƒå˜é‡
                            export FRONTEND_URL="${FRONTEND_URL}"
                            
                            # æ„å»ºå¹¶å¯åŠ¨åç«¯æœåŠ¡
                            docker-compose -f ${DOCKER_COMPOSE_FILE} up --build -d backend
                            
                            # ç­‰å¾…åç«¯æœåŠ¡å¥åº·
                            echo "â³ ç­‰å¾…åç«¯æœåŠ¡å¯åŠ¨..."
                            for i in {1..30}; do
                                if curl -f http://localhost:${BACKEND_PORT}/api/health >/dev/null 2>&1; then
                                    echo "âœ… åç«¯æœåŠ¡å·²å¯åŠ¨"
                                    break
                                fi
                                echo "â³ ç­‰å¾…åç«¯æœåŠ¡... ($i/30)"
                                sleep 10
                            done
                        '''
                    } catch (Exception e) {
                        echo "âŒ åç«¯æ„å»ºå¤±è´¥: ${e.getMessage()}"
                        sh '''
                            echo "ğŸ“‹ è·å–è°ƒè¯•æ—¥å¿—..."
                            docker-compose -f ${DOCKER_COMPOSE_FILE} logs backend
                        '''
                        throw e
                    }
                }
            }
        }
        
        stage('Health Check') {
            steps {
                script {
                    sh '''
                        echo "ğŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥..."
                        
                        # æ£€æŸ¥åç«¯APIå¥åº·çŠ¶æ€
                        echo "ğŸ” æ£€æŸ¥åç«¯API..."
                        for i in {1..10}; do
                            if curl -f http://localhost:${BACKEND_PORT}/api/health; then
                                echo "âœ… åç«¯APIå¥åº·æ£€æŸ¥é€šè¿‡"
                                break
                            fi
                            echo "â³ åç«¯APIæœªå°±ç»ª... ($i/10)"
                            sleep 5
                        done
                        
                        # æ£€æŸ¥æ•°æ®åº“è¿æ¥
                        echo "ğŸ” æ£€æŸ¥æ•°æ®åº“è¿æ¥..."
                        if docker exec weekly-report-backend-mysql mysqladmin ping -h localhost -u root -prootpass123; then
                            echo "âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸"
                        else
                            echo "âŒ æ•°æ®åº“è¿æ¥å¤±è´¥"
                            exit 1
                        fi
                        
                        # æµ‹è¯•åŸºæœ¬APIç«¯ç‚¹
                        echo "ğŸ” æµ‹è¯•APIç«¯ç‚¹..."
                        curl -I http://localhost:${BACKEND_PORT}/api/auth/login || echo "âš ï¸  è®¤è¯ç«¯ç‚¹æµ‹è¯•"
                    '''
                }
            }
        }
        
        stage('Integration Test') {
            steps {
                script {
                    sh '''
                        echo "ğŸ§ª æ‰§è¡Œé›†æˆæµ‹è¯•..."
                        
                        # åŸºæœ¬APIå¯ç”¨æ€§æµ‹è¯•
                        echo "æµ‹è¯•å¥åº·ç«¯ç‚¹..."
                        HEALTH_RESPONSE=$(curl -s http://localhost:${BACKEND_PORT}/api/health)
                        echo "å¥åº·æ£€æŸ¥å“åº”: $HEALTH_RESPONSE"
                        
                        # æ•°æ®åº“è¿æ¥æµ‹è¯•
                        echo "æµ‹è¯•æ•°æ®åº“è¿æ¥..."
                        docker exec weekly-report-backend-mysql mysql -u root -prootpass123 -e "SELECT 'Database connection successful' as test_result;"
                        
                        echo "âœ… é›†æˆæµ‹è¯•å®Œæˆ"
                    '''
                }
            }
        }
        
        stage('Service Status') {
            steps {
                sh '''
                    echo "ğŸ“Š æœ€ç»ˆæœåŠ¡çŠ¶æ€..."
                    echo "=== Dockerå®¹å™¨çŠ¶æ€ ==="
                    docker-compose -f ${DOCKER_COMPOSE_FILE} ps
                    
                    echo "=== è¿è¡Œä¸­çš„å®¹å™¨ ==="
                    docker ps | grep weekly-report
                    
                    echo "=== ç«¯å£ç›‘å¬çŠ¶æ€ ==="
                    netstat -tlnp | grep -E "(${BACKEND_PORT}|${MYSQL_PORT})" || echo "ç«¯å£æ£€æŸ¥å®Œæˆ"
                    
                    echo "=== æœåŠ¡å¥åº·çŠ¶æ€ ==="
                    curl -s http://localhost:${BACKEND_PORT}/api/health || echo "å¥åº·æ£€æŸ¥å®Œæˆ"
                '''
            }
        }
    }
    
    post {
        success {
            echo 'ğŸ‰ åç«¯éƒ¨ç½²æˆåŠŸ!'
            sh '''
                echo "ğŸ“‹ éƒ¨ç½²æ‘˜è¦:"
                echo "åç«¯API: http://localhost:${BACKEND_PORT}"
                echo "æ•°æ®åº“: localhost:${MYSQL_PORT}"
                echo "å¥åº·æ£€æŸ¥: http://localhost:${BACKEND_PORT}/api/health"
                echo "å‰ç«¯CORSé…ç½®: ${FRONTEND_URL}"
                echo ""
                echo "æœåŠ¡çŠ¶æ€:"
                docker-compose -f ${DOCKER_COMPOSE_FILE} ps
            '''
        }
        
        failure {
            echo 'âŒ åç«¯éƒ¨ç½²å¤±è´¥!'
            sh '''
                echo "ğŸ“‹ è°ƒè¯•ä¿¡æ¯:"
                echo "=== Docker Composeæ—¥å¿— ==="
                docker-compose -f ${DOCKER_COMPOSE_FILE} logs
                echo "=== å®¹å™¨çŠ¶æ€ ==="
                docker ps -a | grep weekly-report
            '''
        }
        
        always {
            echo 'ğŸ§¹ æ¸…ç†å·¥ä½œç©ºé—´...'
            // ä¿ç•™å®¹å™¨è¿è¡Œï¼Œåªæ¸…ç†æ„å»ºç¼“å­˜
            sh 'docker builder prune -f || true'
        }
    }
}