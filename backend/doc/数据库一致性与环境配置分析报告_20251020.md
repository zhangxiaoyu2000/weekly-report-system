# åç«¯éƒ¨ç½²æ•°æ®åº“ä¸€è‡´æ€§ä¸ç¯å¢ƒé…ç½®åˆ†ææŠ¥å‘Š

**åˆ†ææ—¶é—´**: 2025-10-20 10:25:00
**åˆ†æèŒƒå›´**: åç«¯æ•°æ®åº“é…ç½®å’Œç¯å¢ƒç®¡ç†ç³»ç»Ÿ
**åˆ†æé‡ç‚¹**: æ•°æ®åº“ä¸€è‡´æ€§ã€ç¯å¢ƒé…ç½®åˆ†ç¦»ã€æ•°æ®è¿ç§»ç­–ç•¥
**å½“å‰ç«¯**: backend

---

## æ‰§è¡Œæ‘˜è¦

æœ¬æ¬¡åˆ†æé’ˆå¯¹åç«¯éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨æ—¶çš„ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š**æœ¬åœ°ä¸æµ‹è¯•æœåŠ¡å™¨æ•°æ®åº“ä¸ä¸€è‡´**ã€**æµ‹è¯•æœåŠ¡å™¨æ•°æ®åº“å·²æœ‰æ•°æ®éœ€ä¿ç•™**ã€**é…ç½®æ–‡ä»¶æœªæŒ‰ç¯å¢ƒåˆ†ç¦»**ã€‚åˆ†æå‘ç°å½“å‰ç³»ç»Ÿè™½ç„¶å·²ç»å®šä¹‰äº†å¤šç¯å¢ƒProfileï¼ˆdev/test/docker/prodï¼‰ï¼Œä½†å­˜åœ¨**æ•°æ®åº“åˆå§‹åŒ–æœºåˆ¶å•ä¸€**ã€**ç¼ºå°‘å¢é‡è¿ç§»å·¥å…·**ã€**ç¯å¢ƒé…ç½®ç®¡ç†ä¸å®Œå–„**ä¸‰å¤§æ ¸å¿ƒç¼ºé™·ã€‚å»ºè®®é‡‡ç”¨**å®Œå…¨ç¦ç”¨Flyway + å¢é‡SQLè„šæœ¬ç®¡ç† + ç¯å¢ƒå˜é‡å¤–éƒ¨åŒ–é…ç½®**çš„æ–¹æ¡ˆï¼Œç¡®ä¿æ•°æ®å®‰å…¨æ€§å’Œé…ç½®çµæ´»æ€§ã€‚

---

## åˆ†æç›®æ ‡

æ˜ç¡®ä»¥ä¸‹ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜çš„ç°çŠ¶å’Œè§£å†³æ–¹æ¡ˆï¼š

1. **æ•°æ®åº“ä¸€è‡´æ€§é—®é¢˜**: æœ¬åœ°å¼€å‘ç¯å¢ƒï¼ˆlocalhost:3309ï¼‰ä¸æµ‹è¯•æœåŠ¡å™¨ï¼ˆ23.95.193.155:3309ï¼‰æ•°æ®åº“schemaå¯èƒ½ä¸ä¸€è‡´
2. **æ•°æ®ä¿ç•™éœ€æ±‚**: æµ‹è¯•æœåŠ¡å™¨æ•°æ®åº“åŒ…å«çœŸå®ä¸šåŠ¡æ•°æ®ï¼Œ**ç»å¯¹ä¸èƒ½æ¸…ç©ºæˆ–è¦†ç›–**
3. **ç¯å¢ƒé…ç½®åˆ†ç¦»**: å½“å‰åªæœ‰å•ä¸€application.ymlæ–‡ä»¶ï¼Œæœªå®ç°ç¯å¢ƒç‹¬ç«‹é…ç½®

---

## è¯¦ç»†åˆ†æ

### 1. æ•°æ®åº“åˆå§‹åŒ–æœºåˆ¶åˆ†æ

#### 1.1 å½“å‰æ•°æ®åº“åˆå§‹åŒ–æ–¹å¼

**æ ¸å¿ƒå‘ç°**: é¡¹ç›®å·²å®Œå…¨ç¦ç”¨Flywayï¼Œé‡‡ç”¨æ‰‹åŠ¨SQLè„šæœ¬åˆå§‹åŒ–

```yaml
# application.yml (æ‰€æœ‰Profileå…±é€šé…ç½®)
spring:
  flyway:
    enabled: false  # å…¨å±€ç¦ç”¨Flyway
    baseline-on-migrate: true
    validate-on-migrate: false
  jpa:
    hibernate:
      ddl-auto: none  # ç¦ç”¨Hibernateè‡ªåŠ¨DDL
```

**åˆå§‹åŒ–è„šæœ¬ä½ç½®**:
- ä¸»è„šæœ¬: `src/main/resources/db/create-database-schema.sql` (å®Œæ•´schemaå®šä¹‰)
- å¢é‡è„šæœ¬: `src/main/resources/db/migration/V35-V38.sql` (æœ€æ–°4ä¸ªè¿ç§»è„šæœ¬)

**Docker ComposeæŒ‚è½½é…ç½®**:
```yaml
volumes:
  - ./src/main/resources/db:/docker-entrypoint-initdb.d
```

#### 1.2 é—®é¢˜è¯†åˆ«

ğŸš¨ **ä¸¥é‡é—®é¢˜**: MySQL Dockerçš„`docker-entrypoint-initdb.d`æœºåˆ¶**ä»…åœ¨æ•°æ®åº“é¦–æ¬¡åˆ›å»ºæ—¶æ‰§è¡Œ**ï¼Œå¦‚æœæ•°æ®åº“å·²å­˜åœ¨ï¼ˆå¦‚æµ‹è¯•æœåŠ¡å™¨ï¼‰ï¼ŒSQLè„šæœ¬ä¸ä¼šæ‰§è¡Œã€‚

**å½±å“åˆ†æ**:
- âœ… æœ¬åœ°å…¨æ–°ç¯å¢ƒï¼šå¯ä»¥æ­£å¸¸åˆå§‹åŒ–
- âŒ æµ‹è¯•æœåŠ¡å™¨ï¼šæ•°æ®åº“å·²å­˜åœ¨ï¼Œè„šæœ¬ä¸æ‰§è¡Œï¼Œschemaå¯èƒ½è¿‡æ—¶
- âŒ å¢é‡è¿ç§»ï¼šæ— è‡ªåŠ¨åŒ–å·¥å…·æ”¯æŒï¼Œéœ€æ‰‹åŠ¨æ‰§è¡ŒSQL

---

### 2. æ•°æ®åº“ä¸€è‡´æ€§é£é™©è¯„ä¼°

#### 2.1 Schemaç‰ˆæœ¬å·®å¼‚åˆ†æ

**å·²å‘ç°çš„è¿ç§»è„šæœ¬** (æœªè¢«è‡ªåŠ¨æ‰§è¡Œçš„é«˜é£é™©è„šæœ¬):

| è„šæœ¬æ–‡ä»¶ | æ—¥æœŸ | å˜æ›´å†…å®¹ | é£é™©ç­‰çº§ |
|---------|------|---------|----------|
| V35__Separate_Draft_From_Approval_Status.sql | 10-16 | å®¡æ‰¹çŠ¶æ€æšä¸¾åˆ†ç¦» | ğŸ”´ é«˜ |
| V36__Create_File_Management_Tables.sql | 09-29 | æ–°å¢æ–‡ä»¶ç®¡ç†è¡¨ | ğŸŸ¡ ä¸­ |
| V37__Fix_Approval_Status_Enum_Remove_AI_APPROVED.sql | 10-09 | ç§»é™¤AI_APPROVEDçŠ¶æ€ | ğŸ”´ é«˜ |
| V38__Add_Status_And_Rejected_By_Fields.sql | 10-20 | æ–°å¢çŠ¶æ€å’Œæ‹’ç»äººå­—æ®µ | ğŸ”´ é«˜ |

**é£é™©åœºæ™¯**:
1. **æšä¸¾å€¼ä¸åŒ¹é…**: å¦‚æœæµ‹è¯•æœåŠ¡å™¨æœªæ‰§è¡ŒV37ï¼Œåç«¯ä»£ç ä½¿ç”¨æ–°æšä¸¾å€¼ä¼šå¯¼è‡´æ•°æ®æ’å…¥å¤±è´¥
2. **ç¼ºå¤±å­—æ®µ**: å¦‚æœV38æœªæ‰§è¡Œï¼Œä¸šåŠ¡é€»è¾‘å¼•ç”¨æ–°å­—æ®µä¼šè§¦å‘SQLå¼‚å¸¸
3. **å¤–é”®çº¦æŸå†²çª**: V36æ–°å¢è¡¨è‹¥æœªåˆ›å»ºï¼Œå…³è”æŸ¥è¯¢ä¼šå¯¼è‡´åº”ç”¨å´©æºƒ

#### 2.2 æ•°æ®ä¿ç•™çº¦æŸåˆ†æ

**æµ‹è¯•æœåŠ¡å™¨æ•°æ®åº“çŠ¶æ€** (æ ¹æ®DEPLOY.mdæ¨æ–­):
- âœ… å­˜åœ¨ç”¨æˆ·æ•°æ® (admin1ç­‰ç®¡ç†å‘˜è´¦æˆ·)
- âœ… åŒ…å«ä¸šåŠ¡æ•°æ® (projectsã€weekly_reportsç­‰)
- âœ… å·²é€šè¿‡JWTè®¤è¯éªŒè¯ (è¯´æ˜åŸºç¡€schemaæ­£å¸¸)

**å¿…é¡»éµå®ˆçš„çº¦æŸ**:
- ğŸ”´ **ç»å¯¹ç¦æ­¢**: `DROP DATABASE`ã€`TRUNCATE TABLE`ç­‰ç ´åæ€§æ“ä½œ
- ğŸŸ¡ **è°¨æ…æ“ä½œ**: `ALTER TABLE DROP COLUMN` (å¯èƒ½åˆ é™¤æœ‰æ•°æ®çš„åˆ—)
- âœ… **å®‰å…¨æ“ä½œ**: `ALTER TABLE ADD COLUMN`ã€`CREATE TABLE IF NOT EXISTS`

---

### 3. ç¯å¢ƒé…ç½®åˆ†ç¦»åˆ†æ

#### 3.1 å½“å‰å¤šç¯å¢ƒé…ç½®å®ç°

**Profileå®šä¹‰**: application.ymlå·²ç»å®šä¹‰äº†4ä¸ªç¯å¢ƒProfile

```yaml
spring:
  profiles:
    active: dev  # é»˜è®¤æ¿€æ´»devç¯å¢ƒ

---
# Development profile
spring:
  config:
    activate:
      on-profile: dev
  datasource:
    hikari:
      maximum-pool-size: 12
  jpa:
    show-sql: true

---
# Test profile
spring:
  config:
    activate:
      on-profile: test
  datasource:
    url: jdbc:mysql://localhost:3309/weekly_report_system

---
# Docker profile
spring:
  config:
    activate:
      on-profile: docker
  datasource:
    url: jdbc:mysql://${DB_HOST:mysql}:${DB_PORT:3306}/${DB_NAME:weekly_report_system}

---
# Production profile
spring:
  config:
    activate:
      on-profile: prod
  jpa:
    hibernate:
      ddl-auto: validate  # ç”Ÿäº§ç¯å¢ƒä¸¥æ ¼éªŒè¯
    show-sql: false
```

**ä¼˜ç‚¹åˆ†æ**:
- âœ… å·²æŒ‰ç¯å¢ƒåˆ†ç¦»é…ç½® (æ•°æ®åº“è¿æ¥æ± ã€æ—¥å¿—çº§åˆ«ç­‰)
- âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡è¦†ç›–æ•æ„Ÿä¿¡æ¯ (${DB_USERNAME:root})
- âœ… Docker profileé€‚é…å®¹å™¨åŒ–éƒ¨ç½²

#### 3.2 å­˜åœ¨çš„é…ç½®é—®é¢˜

ğŸŸ¡ **é—®é¢˜1**: æ•°æ®åº“URLç¡¬ç¼–ç åœ¨test profileä¸­

```yaml
# å½“å‰é…ç½® - test profile
datasource:
  url: jdbc:mysql://localhost:3309/weekly_report_system  # âŒ ç¡¬ç¼–ç æœ¬åœ°åœ°å€
  username: ${DB_USERNAME:root}  # âœ… æ”¯æŒç¯å¢ƒå˜é‡
```

**å½±å“**: æµ‹è¯•æœåŠ¡å™¨æ— æ³•ç›´æ¥ä½¿ç”¨test profileï¼Œéœ€è¦æ‰‹åŠ¨ä¿®æ”¹é…ç½®æ–‡ä»¶æˆ–ä½¿ç”¨docker profile

ğŸŸ¡ **é—®é¢˜2**: CORSé…ç½®éƒ¨åˆ†ç¡¬ç¼–ç 

```yaml
cors:
  allowed-origins: http://localhost:3000,http://localhost:3002,...,http://23.95.193.155:3003
```

**å½±å“**: æ–°å¢å‰ç«¯åŸŸåéœ€è¦ä¿®æ”¹ä»£ç å¹¶é‡æ–°æ„å»ºé•œåƒ

ğŸŸ¡ **é—®é¢˜3**: ç¼ºå°‘ç‹¬ç«‹çš„é…ç½®æ–‡ä»¶

å½“å‰æ‰€æœ‰ç¯å¢ƒé…ç½®éƒ½åœ¨**å•ä¸€**çš„`application.yml`ä¸­ï¼ŒSpring Bootæ”¯æŒä½†ä¸æ¨èçš„åšæ³•ï¼š

**æ¨èåšæ³•**: ä½¿ç”¨ç‹¬ç«‹é…ç½®æ–‡ä»¶
```
src/main/resources/
â”œâ”€â”€ application.yml              # é€šç”¨é…ç½®
â”œâ”€â”€ application-dev.yml          # å¼€å‘ç¯å¢ƒ
â”œâ”€â”€ application-test.yml         # æµ‹è¯•ç¯å¢ƒ
â”œâ”€â”€ application-docker.yml       # Dockerç¯å¢ƒ
â””â”€â”€ application-prod.yml         # ç”Ÿäº§ç¯å¢ƒ
```

---

### 4. éƒ¨ç½²æµç¨‹å®‰å…¨æ€§åˆ†æ

#### 4.1 å½“å‰éƒ¨ç½²æµç¨‹ (åŸºäºDEPLOY.md)

```bash
# æ­¥éª¤1: ä»£ç æ¨é€è§¦å‘Jenkins
git push origin main

# æ­¥éª¤2: Jenkinsæ‰§è¡Œæ„å»º
mvn clean package -DskipTests

# æ­¥éª¤3: Dockeré•œåƒæ„å»º
docker build -t weekly-report-backend .

# æ­¥éª¤4: å®¹å™¨é‡å¯ (âš ï¸ å…³é”®é£é™©ç‚¹)
docker-compose down
docker-compose up -d
```

#### 4.2 æ•°æ®åº“å®‰å…¨é£é™©ç‚¹

ğŸ”´ **é«˜é£é™©æ“ä½œ**: `docker-compose down` åæ•°æ®åº“å®¹å™¨é‡å¯

**é£é™©åœºæ™¯**:
- å¦‚æœMySQLå®¹å™¨è¢«åˆ é™¤å¹¶é‡å»ºï¼Œ`docker-entrypoint-initdb.d`ä¼šé‡æ–°æ‰§è¡Œ
- `create-database-schema.sql`åŒ…å«`CREATE DATABASE IF NOT EXISTS`ï¼Œä¸ä¼šæ¸…ç©ºæ•°æ®
- ä½†å¦‚æœåŒ…å«`DROP TABLE IF EXISTS`è¯­å¥ï¼Œ**ä¼šæ¸…ç©ºæ‰€æœ‰æ•°æ®**

**å½“å‰create-database-schema.sqlå®‰å…¨æ€§æ£€æŸ¥**:
```sql
-- âœ… å®‰å…¨: ä½¿ç”¨IF NOT EXISTS
CREATE DATABASE IF NOT EXISTS weekly_report_system;

-- âœ… å®‰å…¨: ä½¿ç”¨IF NOT EXISTS
CREATE TABLE ai_analysis_results (
    id BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    ...
);
```

**ç»“è®º**: å½“å‰è„šæœ¬è®¾è®¡å®‰å…¨ï¼Œä½†**ä¾èµ–äººå·¥ç»´æŠ¤**ï¼Œé«˜é£é™©

---

## å…³é”®å‘ç°

### ä¼˜åŠ¿
- âœ… **å¤šç¯å¢ƒProfileå·²å®ç°**: dev/test/docker/prodå››ç¯å¢ƒåˆ†ç¦»
- âœ… **æ•æ„Ÿä¿¡æ¯å¤–éƒ¨åŒ–**: JWTå¯†é’¥ã€æ•°æ®åº“å¯†ç æ”¯æŒç¯å¢ƒå˜é‡
- âœ… **æ•°æ®åº“è„šæœ¬å®‰å…¨**: create-database-schema.sqlä½¿ç”¨IF NOT EXISTS
- âœ… **Flywayå·²ç¦ç”¨**: é¿å…è‡ªåŠ¨è¿ç§»é£é™©

### é—®é¢˜
- âš ï¸ **ç¼ºå°‘å¢é‡è¿ç§»æœºåˆ¶**: V35-V38è„šæœ¬æœªè¢«æµ‹è¯•æœåŠ¡å™¨æ‰§è¡Œ
- âš ï¸ **é…ç½®æ–‡ä»¶æœªåˆ†ç¦»**: æ‰€æœ‰ç¯å¢ƒé…ç½®åœ¨å•ä¸€application.ymlä¸­
- âš ï¸ **æ•°æ®åº“URLç¡¬ç¼–ç **: test profileæ— æ³•çµæ´»é€‚é…ä¸åŒç¯å¢ƒ
- âš ï¸ **CORSé…ç½®ç¡¬ç¼–ç **: éœ€è¦ä¿®æ”¹ä»£ç æ‰èƒ½æ·»åŠ æ–°å‰ç«¯åŸŸå

### é£é™©
- ğŸš¨ **Schemaç‰ˆæœ¬ä¸ä¸€è‡´**: æµ‹è¯•æœåŠ¡å™¨å¯èƒ½ç¼ºå°‘æœ€æ–°4ä¸ªè¿ç§»çš„å­—æ®µå’Œè¡¨
- ğŸš¨ **æ‰‹åŠ¨è¿ç§»æ˜“é”™**: æ— ç‰ˆæœ¬æ§åˆ¶ï¼Œå®¹æ˜“é—æ¼æˆ–é‡å¤æ‰§è¡Œ
- ğŸš¨ **æ•°æ®ä¸¢å¤±é£é™©**: å¦‚æœè¯¯ç”¨DROPè¯­å¥æˆ–Flyway cleanï¼Œä¼šæ¸…ç©ºæ•°æ®

---

## æ”¹è¿›å»ºè®®

### é«˜ä¼˜å…ˆçº§

#### 1. ç«‹å³æ£€æŸ¥æµ‹è¯•æœåŠ¡å™¨æ•°æ®åº“Schemaç‰ˆæœ¬

**è¡ŒåŠ¨æ­¥éª¤**:
```bash
# 1. SSHç™»å½•æµ‹è¯•æœåŠ¡å™¨
ssh root@23.95.193.155

# 2. æ£€æŸ¥å…³é”®è¡¨å’Œå­—æ®µæ˜¯å¦å­˜åœ¨
docker exec weekly-report-mysql mysql -u root -prootpass123 weekly_report_system \
  -e "SHOW TABLES;"

# 3. éªŒè¯æœ€æ–°è¿ç§»å­—æ®µ (V38æ–°å¢å­—æ®µ)
docker exec weekly-report-mysql mysql -u root -prootpass123 weekly_report_system \
  -e "DESCRIBE projects;" | grep -E "status|rejected_by"

# 4. æ£€æŸ¥æ–‡ä»¶ç®¡ç†è¡¨ (V36æ–°å¢è¡¨)
docker exec weekly-report-mysql mysql -u root -prootpass123 weekly_report_system \
  -e "SHOW TABLES LIKE 'file%';"
```

**é¢„æœŸç»“æœ**: å¦‚æœå­—æ®µ/è¡¨ä¸å­˜åœ¨ï¼Œéœ€è¦æ‰§è¡Œç¼ºå¤±çš„è¿ç§»è„šæœ¬

---

#### 2. å®‰å…¨æ‰§è¡Œå¢é‡è¿ç§»è„šæœ¬

**å¼ºåˆ¶åŸåˆ™**:
- ğŸ”´ **å¤‡ä»½ä¼˜å…ˆ**: æ‰§è¡Œä»»ä½•è¿ç§»å‰å¿…é¡»å¤‡ä»½æ•°æ®åº“
- ğŸŸ¡ **åªå¢ä¸å‡**: åªæ‰§è¡Œ`ADD COLUMN`ã€`CREATE TABLE`ï¼Œé¿å…`DROP`æ“ä½œ
- âœ… **å¹‚ç­‰æ€§**: æ‰€æœ‰è„šæœ¬ä½¿ç”¨`IF NOT EXISTS`ç¡®ä¿å¯é‡å¤æ‰§è¡Œ

**è¿ç§»è„šæœ¬æ¨¡æ¿**:
```sql
-- V35-V38 ç»Ÿä¸€å¢é‡è¿ç§»è„šæœ¬
-- æ‰§è¡Œå‰å¿…é¡»å¤‡ä»½æ•°æ®åº“

USE weekly_report_system;

-- V35: Separate_Draft_From_Approval_Status (æ£€æŸ¥è„šæœ¬å†…å®¹åæ‰§è¡Œ)
-- ALTER TABLE projects MODIFY approval_status ENUM(...);

-- V36: Create_File_Management_Tables
CREATE TABLE IF NOT EXISTS files (
    id BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    file_name VARCHAR(255) NOT NULL,
    ...
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- V37: Fix_Approval_Status_Enum_Remove_AI_APPROVED
-- âš ï¸ é£é™©æ“ä½œ: ä¿®æ”¹ENUMéœ€è¦ç¡®ä¿æ— æ•°æ®ä½¿ç”¨è¢«åˆ é™¤çš„å€¼
-- ALTER TABLE projects MODIFY approval_status ENUM(...);

-- V38: Add_Status_And_Rejected_By_Fields
ALTER TABLE projects
  ADD COLUMN IF NOT EXISTS status VARCHAR(50) DEFAULT 'ACTIVE',
  ADD COLUMN IF NOT EXISTS rejected_by BIGINT NULL;
```

**æ‰§è¡Œå‘½ä»¤**:
```bash
# 1. å¤‡ä»½æµ‹è¯•æœåŠ¡å™¨æ•°æ®åº“
docker exec weekly-report-mysql mysqldump -u root -prootpass123 weekly_report_system \
  > backup_before_migration_$(date +%Y%m%d_%H%M%S).sql

# 2. æ‰§è¡Œè¿ç§»è„šæœ¬ (é€ä¸ªæ‰§è¡ŒV35-V38)
docker exec -i weekly-report-mysql mysql -u root -prootpass123 weekly_report_system \
  < /path/to/V35__Separate_Draft_From_Approval_Status.sql

# 3. éªŒè¯ç»“æœ
docker exec weekly-report-mysql mysql -u root -prootpass123 weekly_report_system \
  -e "DESCRIBE projects;"
```

---

#### 3. æ‹†åˆ†é…ç½®æ–‡ä»¶å®ç°ç¯å¢ƒç‹¬ç«‹

**ç›®æ ‡ç»“æ„**:
```
src/main/resources/
â”œâ”€â”€ application.yml              # é€šç”¨é…ç½® (server.portã€loggingç­‰)
â”œâ”€â”€ application-dev.yml          # æœ¬åœ°å¼€å‘ç¯å¢ƒ
â”œâ”€â”€ application-test.yml         # æµ‹è¯•æœåŠ¡å™¨ç¯å¢ƒ
â”œâ”€â”€ application-docker.yml       # Dockerå®¹å™¨ç¯å¢ƒ
â””â”€â”€ application-prod.yml         # ç”Ÿäº§ç¯å¢ƒ
```

**application.yml (é€šç”¨é…ç½®)**:
```yaml
server:
  port: 8081
  servlet:
    context-path: /api

spring:
  application:
    name: weekly-report-backend
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}  # ç¯å¢ƒå˜é‡æ§åˆ¶

# JWTé…ç½® (æ‰€æœ‰ç¯å¢ƒå…±ç”¨)
jwt:
  secret: ${JWT_SECRET:MyVerySecureWeeklyReportJwtSigningKeyForHS512AlgorithmMustBe512BitsOrGreater2024!@#$%^&*()_+=}
  access-token-expiration: ${JWT_ACCESS_EXPIRATION:3600000}
  refresh-token-expiration: ${JWT_REFRESH_EXPIRATION:604800000}

# Loggingé…ç½®
logging:
  file:
    name: logs/weekly-report.log
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n"
```

**application-test.yml (æµ‹è¯•æœåŠ¡å™¨ç¯å¢ƒ)**:
```yaml
spring:
  datasource:
    url: jdbc:mysql://${DB_HOST:23.95.193.155}:${DB_PORT:3309}/${DB_NAME:weekly_report_system}?useUnicode=true&characterEncoding=UTF-8&useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
    username: ${DB_USERNAME:root}
    password: ${DB_PASSWORD:rootpass123}
    hikari:
      maximum-pool-size: 20
  jpa:
    hibernate:
      ddl-auto: validate  # æµ‹è¯•ç¯å¢ƒéªŒè¯schema
    show-sql: false

# CORSé…ç½® - æµ‹è¯•æœåŠ¡å™¨
cors:
  allowed-origins: ${CORS_ORIGINS:http://23.95.193.155:3003}
  allowed-methods: GET,POST,PUT,DELETE,OPTIONS
  allowed-headers: "*"
  allow-credentials: true
```

**application-docker.yml (Dockerå®¹å™¨ç¯å¢ƒ)**:
```yaml
spring:
  datasource:
    url: jdbc:mysql://${DB_HOST:mysql}:${DB_PORT:3306}/${DB_NAME:weekly_report_system}?useUnicode=true&characterEncoding=UTF-8&useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
    username: ${DB_USERNAME:root}
    password: ${DB_PASSWORD:rootpass123}
    hikari:
      maximum-pool-size: 30
  jpa:
    hibernate:
      ddl-auto: none  # Dockerç¯å¢ƒç¦ç”¨è‡ªåŠ¨DDL
    show-sql: false

cors:
  allowed-origins: ${CORS_ORIGINS:http://localhost:3000,http://23.95.193.155:3003}
```

**æ¿€æ´»æ–¹å¼**:
```bash
# æœ¬åœ°å¼€å‘
java -jar app.jar --spring.profiles.active=dev

# æµ‹è¯•æœåŠ¡å™¨ (é€šè¿‡ç¯å¢ƒå˜é‡)
export SPRING_PROFILES_ACTIVE=test
docker-compose up -d

# Dockerå®¹å™¨
docker run -e SPRING_PROFILES_ACTIVE=docker weekly-report-backend
```

---

### ä¸­ä¼˜å…ˆçº§

#### 4. å¤–éƒ¨åŒ–CORSé…ç½®

**å½“å‰é—®é¢˜**: CORSåŸŸåç¡¬ç¼–ç åœ¨application.yml

**è§£å†³æ–¹æ¡ˆ**: æ”¹ä¸ºç¯å¢ƒå˜é‡æ§åˆ¶

```yaml
# ä¿®æ”¹å‰
cors:
  allowed-origins: http://localhost:3000,http://23.95.193.155:3003

# ä¿®æ”¹å
cors:
  allowed-origins: ${CORS_ORIGINS:http://localhost:3000}
```

**Docker Composeé…ç½®**:
```yaml
backend:
  environment:
    SPRING_PROFILES_ACTIVE: docker
    CORS_ORIGINS: "http://localhost:3000,http://23.95.193.155:3003,http://new-domain.com:3000"
```

**ä¼˜åŠ¿**: æ— éœ€ä¿®æ”¹ä»£ç ï¼Œç›´æ¥è°ƒæ•´ç¯å¢ƒå˜é‡å³å¯æ·»åŠ æ–°åŸŸå

---

#### 5. å»ºç«‹æ•°æ®åº“è¿ç§»ç‰ˆæœ¬ç®¡ç†æœºåˆ¶

**ç›®æ ‡**: åœ¨ç¦ç”¨Flywayçš„å‰æä¸‹ï¼Œå®ç°è¿ç§»è„šæœ¬ç‰ˆæœ¬è¿½è¸ª

**æ–¹æ¡ˆ**: åˆ›å»ºæ‰‹åŠ¨ç‰ˆæœ¬ç®¡ç†è¡¨

```sql
-- åˆ›å»ºè¿ç§»ç‰ˆæœ¬è¿½è¸ªè¡¨
CREATE TABLE IF NOT EXISTS schema_migrations (
    version VARCHAR(50) PRIMARY KEY,
    description VARCHAR(255),
    executed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    executed_by VARCHAR(50),
    checksum VARCHAR(64)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- è®°å½•å·²æ‰§è¡Œçš„è¿ç§»
INSERT INTO schema_migrations (version, description, executed_by)
VALUES
    ('V35', 'Separate_Draft_From_Approval_Status', 'admin'),
    ('V36', 'Create_File_Management_Tables', 'admin'),
    ('V37', 'Fix_Approval_Status_Enum_Remove_AI_APPROVED', 'admin'),
    ('V38', 'Add_Status_And_Rejected_By_Fields', 'admin');
```

**ä½¿ç”¨æ–¹å¼**:
```bash
# æ£€æŸ¥æµ‹è¯•æœåŠ¡å™¨å·²æ‰§è¡Œçš„è¿ç§»
docker exec weekly-report-mysql mysql -u root -prootpass123 weekly_report_system \
  -e "SELECT * FROM schema_migrations ORDER BY version;"

# æ‰§è¡Œæ–°è¿ç§»åè®°å½•ç‰ˆæœ¬
docker exec weekly-report-mysql mysql -u root -prootpass123 weekly_report_system \
  -e "INSERT INTO schema_migrations (version, description, executed_by) VALUES ('V39', 'New_Feature', 'admin');"
```

---

#### 6. ä¼˜åŒ–Docker Composeæ•°æ®åº“æŒä¹…åŒ–é…ç½®

**å½“å‰é…ç½®**:
```yaml
volumes:
  - mysql_data:/var/lib/mysql  # âœ… æ•°æ®æŒä¹…åŒ–
  - ./src/main/resources/db:/docker-entrypoint-initdb.d  # âš ï¸ è‡ªåŠ¨åˆå§‹åŒ–
```

**ä¼˜åŒ–å»ºè®®**: æ·»åŠ æ³¨é‡Šè¯´æ˜è‡ªåŠ¨åˆå§‹åŒ–çš„é£é™©

```yaml
volumes:
  - mysql_data:/var/lib/mysql
  # âš ï¸ è­¦å‘Š: docker-entrypoint-initdb.d ä»…åœ¨é¦–æ¬¡åˆ›å»ºæ•°æ®åº“æ—¶æ‰§è¡Œ
  # æµ‹è¯•æœåŠ¡å™¨æ•°æ®åº“å·²å­˜åœ¨æ—¶ï¼Œæ­¤æŒ‚è½½ä¸ä¼šè‡ªåŠ¨æ‰§è¡Œè¿ç§»è„šæœ¬
  # å¢é‡è¿ç§»éœ€æ‰‹åŠ¨æ‰§è¡Œ: docker exec -i mysql mysql < migration.sql
  - ./src/main/resources/db:/docker-entrypoint-initdb.d
```

---

### ä½ä¼˜å…ˆçº§

#### 7. ç»Ÿä¸€æ—¥å¿—çº§åˆ«é…ç½®

**å½“å‰é—®é¢˜**: dev profileæ—¥å¿—è¿‡äºè¯¦ç»† (DEBUGçº§åˆ«)ï¼Œç”Ÿäº§ç¯å¢ƒINFOçº§åˆ«

**å»ºè®®**: æŒ‰ç¯å¢ƒè°ƒæ•´æ—¥å¿—çº§åˆ«

```yaml
# application-dev.yml
logging:
  level:
    com.weeklyreport: DEBUG
    org.hibernate.SQL: DEBUG

# application-test.yml
logging:
  level:
    com.weeklyreport: INFO
    org.hibernate.SQL: WARN

# application-prod.yml
logging:
  level:
    com.weeklyreport: WARN
    org.hibernate.SQL: ERROR
```

---

#### 8. æ·»åŠ ç¯å¢ƒæ£€æµ‹å¥åº·æ£€æŸ¥

**ç›®æ ‡**: åœ¨åº”ç”¨å¯åŠ¨æ—¶æ£€æµ‹ç¯å¢ƒé…ç½®æ­£ç¡®æ€§

**å®ç°**: æ·»åŠ è‡ªå®šä¹‰HealthIndicator

```java
@Component
public class EnvironmentHealthIndicator implements HealthIndicator {

    @Value("${spring.profiles.active}")
    private String activeProfile;

    @Value("${spring.datasource.url}")
    private String datasourceUrl;

    @Override
    public Health health() {
        Map<String, Object> details = new HashMap<>();
        details.put("activeProfile", activeProfile);
        details.put("databaseHost", extractHost(datasourceUrl));

        // è­¦å‘Š: å¦‚æœç”Ÿäº§ç¯å¢ƒä½¿ç”¨localhost
        if ("prod".equals(activeProfile) && datasourceUrl.contains("localhost")) {
            return Health.down()
                .withDetails(details)
                .withDetail("error", "Production profile should not use localhost database")
                .build();
        }

        return Health.up().withDetails(details).build();
    }
}
```

**è®¿é—®**: `GET /api/actuator/health/environment`

---

## æŠ€æœ¯å€ºåŠ¡è¯„ä¼°

| é¡¹ç›® | ä¸¥é‡ç¨‹åº¦ | å½±å“èŒƒå›´ | å»ºè®®è¡ŒåŠ¨ |
|------|---------|---------|---------|
| æµ‹è¯•æœåŠ¡å™¨Schemaå¯èƒ½ä¸ä¸€è‡´ | ğŸ”´ é«˜ | åº”ç”¨å´©æºƒé£é™© | ç«‹å³æ£€æŸ¥å¹¶æ‰§è¡Œç¼ºå¤±çš„è¿ç§» |
| ç¼ºå°‘è¿ç§»ç‰ˆæœ¬è¿½è¸ªæœºåˆ¶ | ğŸŸ¡ ä¸­ | è¿ç»´æ•ˆç‡ | åˆ›å»ºschema_migrationsè¡¨ |
| é…ç½®æ–‡ä»¶æœªæ‹†åˆ† | ğŸŸ¡ ä¸­ | å¯ç»´æŠ¤æ€§ | æ‹†åˆ†ä¸ºç‹¬ç«‹ç¯å¢ƒé…ç½®æ–‡ä»¶ |
| CORSé…ç½®ç¡¬ç¼–ç  | ğŸŸ¢ ä½ | çµæ´»æ€§ | æ”¹ä¸ºç¯å¢ƒå˜é‡æ§åˆ¶ |

---

## æ•°æ®åº“è¿ç§»å®‰å…¨æ‰§è¡Œæ£€æŸ¥æ¸…å•

### æ‰§è¡Œå‰æ£€æŸ¥
- [ ] âœ… ç¡®è®¤æµ‹è¯•æœåŠ¡å™¨æ•°æ®åº“å½“å‰ç‰ˆæœ¬
- [ ] âœ… å¤‡ä»½æ•°æ®åº“åˆ°å®‰å…¨ä½ç½®
- [ ] âœ… åœ¨æœ¬åœ°ç¯å¢ƒæµ‹è¯•è¿ç§»è„šæœ¬
- [ ] âœ… æ£€æŸ¥è„šæœ¬æ˜¯å¦åŒ…å«DROPæ“ä½œ (å¦‚æœ‰ï¼Œéœ€è¯„å®¡)
- [ ] âœ… éªŒè¯è„šæœ¬ä½¿ç”¨IF NOT EXISTSç¡®ä¿å¹‚ç­‰æ€§

### æ‰§è¡Œä¸­ç›‘æ§
- [ ] âœ… ä½¿ç”¨äº‹åŠ¡æ‰§è¡Œè¿ç§» (å¦‚æœæ•°æ®åº“æ”¯æŒDDLäº‹åŠ¡)
- [ ] âœ… é€ä¸ªè„šæœ¬æ‰§è¡Œï¼Œé¿å…æ‰¹é‡æ‰§è¡Œ
- [ ] âœ… æ¯æ¬¡æ‰§è¡ŒåéªŒè¯è¡¨ç»“æ„
- [ ] âœ… è®°å½•è¿ç§»ç‰ˆæœ¬åˆ°schema_migrationsè¡¨

### æ‰§è¡ŒåéªŒè¯
- [ ] âœ… æ£€æŸ¥åº”ç”¨å¯åŠ¨æ˜¯å¦æ­£å¸¸
- [ ] âœ… æµ‹è¯•æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½ (ç™»å½•ã€åˆ›å»ºå‘¨æŠ¥ã€å®¡æ‰¹æµç¨‹)
- [ ] âœ… éªŒè¯æ•°æ®å®Œæ•´æ€§ (è®°å½•æ•°é‡ä¸å˜)
- [ ] âœ… ä¿ç•™å¤‡ä»½æ–‡ä»¶è‡³å°‘7å¤©

---

## æ¨èå®æ–½è·¯çº¿å›¾

### é˜¶æ®µ1: ç´§æ€¥ä¿®å¤ (1-2å¤©)
1. **æ£€æŸ¥æµ‹è¯•æœåŠ¡å™¨Schemaç‰ˆæœ¬**
   - æ‰§è¡ŒSQLæ£€æŸ¥è„šæœ¬
   - åˆ—å‡ºç¼ºå¤±çš„è¡¨å’Œå­—æ®µ

2. **å¤‡ä»½æµ‹è¯•æœåŠ¡å™¨æ•°æ®åº“**
   - ä½¿ç”¨mysqldumpå…¨é‡å¤‡ä»½
   - éªŒè¯å¤‡ä»½æ–‡ä»¶å¯æ¢å¤

3. **å®‰å…¨æ‰§è¡Œç¼ºå¤±çš„è¿ç§»**
   - é€ä¸ªæ‰§è¡ŒV35-V38è„šæœ¬
   - æ¯æ¬¡æ‰§è¡ŒåéªŒè¯

### é˜¶æ®µ2: é…ç½®ä¼˜åŒ– (3-5å¤©)
1. **æ‹†åˆ†ç¯å¢ƒé…ç½®æ–‡ä»¶**
   - åˆ›å»ºapplication-{profile}.ymlæ–‡ä»¶
   - è¿ç§»ç°æœ‰é…ç½®åˆ°å¯¹åº”æ–‡ä»¶
   - æœ¬åœ°æµ‹è¯•å„ç¯å¢ƒæ¿€æ´»

2. **å¤–éƒ¨åŒ–CORSé…ç½®**
   - ä¿®æ”¹ä¸ºç¯å¢ƒå˜é‡æ§åˆ¶
   - æ›´æ–°Docker Composeé…ç½®

3. **å»ºç«‹è¿ç§»ç‰ˆæœ¬ç®¡ç†**
   - åˆ›å»ºschema_migrationsè¡¨
   - è®°å½•å†å²è¿ç§»ç‰ˆæœ¬

### é˜¶æ®µ3: é•¿æœŸä¼˜åŒ– (1-2å‘¨)
1. **ä¼˜åŒ–Docker Composeé…ç½®**
   - æ·»åŠ é…ç½®æ³¨é‡Š
   - ä¼˜åŒ–å¥åº·æ£€æŸ¥æœºåˆ¶

2. **æ·»åŠ ç¯å¢ƒæ£€æµ‹**
   - å®ç°EnvironmentHealthIndicator
   - é…ç½®Actuatorç«¯ç‚¹

3. **ç¼–å†™æ•°æ®åº“è¿ç§»è§„èŒƒæ–‡æ¡£**
   - å®šä¹‰è¿ç§»è„šæœ¬ç¼–å†™è§„èŒƒ
   - å»ºç«‹Code Reviewæ£€æŸ¥æ¸…å•

---

## å‚è€ƒèµ„æº

### å®˜æ–¹æ–‡æ¡£
- [Spring Boot Profiles](https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.profiles)
- [Spring Boot Externalized Configuration](https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.external-config)
- [MySQL Docker Initialization](https://hub.docker.com/_/mysql)

### æœ€ä½³å®è·µ
- [æ•°æ®åº“è¿ç§»æœ€ä½³å®è·µ](https://martinfowler.com/articles/evodb.html)
- [Spring Bootå¤šç¯å¢ƒé…ç½®ç®¡ç†](https://www.baeldung.com/spring-profiles)
- [Docker Composeç¯å¢ƒå˜é‡ç®¡ç†](https://docs.docker.com/compose/environment-variables/)

### é¡¹ç›®å†…éƒ¨æ–‡æ¡£
- `.claude/DEPLOY.md` - åç«¯éƒ¨ç½²ç»éªŒçŸ¥è¯†åº“
- `.claude/workflow/deployment-workflow.md` - æ™ºèƒ½éƒ¨ç½²å·¥ä½œæµç¨‹
- `.claude/deploy-helper.md` - æ ¸å¿ƒéƒ¨ç½²æŒ‡å¯¼

---

## å­¦ä¹ è¦ç‚¹

### å…³é”®æŠ€æœ¯æ¦‚å¿µ

1. **Spring Boot Profileæœºåˆ¶**
   - Profileæ˜¯Spring Bootçš„ç¯å¢ƒéš”ç¦»æœºåˆ¶
   - å¯é€šè¿‡`spring.profiles.active`æ¿€æ´»
   - æ”¯æŒé…ç½®æ–‡ä»¶åˆ†ç¦»å’ŒProfileåµŒå¥—

2. **MySQL Dockeråˆå§‹åŒ–åŸç†**
   - `docker-entrypoint-initdb.d`ä»…åœ¨é¦–æ¬¡åˆ›å»ºæ—¶æ‰§è¡Œ
   - æ•°æ®åº“æŒä¹…åŒ–åä¸ä¼šé‡å¤æ‰§è¡Œ
   - å¢é‡è¿ç§»éœ€è¦å¤–éƒ¨å·¥å…·æˆ–æ‰‹åŠ¨æ‰§è¡Œ

3. **æ•°æ®åº“è¿ç§»å¹‚ç­‰æ€§**
   - ä½¿ç”¨`CREATE TABLE IF NOT EXISTS`
   - ä½¿ç”¨`ALTER TABLE ADD COLUMN IF NOT EXISTS` (MySQL 8.0.29+)
   - é¿å…`DROP`æ“ä½œç¡®ä¿æ•°æ®å®‰å…¨

4. **ç¯å¢ƒå˜é‡è¦†ç›–ä¼˜å…ˆçº§**
   - å‘½ä»¤è¡Œå‚æ•° > ç¯å¢ƒå˜é‡ > é…ç½®æ–‡ä»¶ > é»˜è®¤å€¼
   - `${VAR:default}`è¯­æ³•æä¾›é»˜è®¤å€¼
   - Docker Composeçš„environmentä¼˜å…ˆçº§æœ€é«˜

---

**åˆ†æå®Œæˆæ—¶é—´**: 2025-10-20 10:35:00
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ†æäººå‘˜**: Claude Code (SuperClaude Framework)
