# 评论接口测试指南

**创建时间**: 2025-10-20 15:35:00
**测试目标**: 验证评论功能和权限控制
**测试工具**: Postman或前端页面

---

## 测试前准备

### 1. 确认服务运行
```bash
curl http://localhost:8081/api/actuator/health
# 预期: {"status":"UP"}
```

### 2. 准备测试账号

| 账号 | 密码 | 角色 | 用户ID | 评论权限 |
|------|------|------|-------|---------|
| superadmin | SuperAdmin123@ | SUPER_ADMIN | 1 | ✅ 可评论所有周报 |
| manager1 | Manager123@ | MANAGER | 3 | ✅ 只能评论自己的周报 |
| admin2 | Admin123@ | ADMIN | 8 | ❌ 无评论权限 |

### 3. 查找APPROVED状态的周报

**查询周报列表**:
```
GET /api/weekly-reports/my
Authorization: Bearer {manager1_token}
```

**找到符合条件的周报**:
- 状态: `APPROVED`
- 提交者ID: 3 (manager1的周报，用于测试MANAGER权限)
- 提交者ID: 非3 (他人周报，用于测试权限拒绝)

---

## 测试用例

### 用例1: 获取评论列表

**接口**: `GET /api/weekly-reports/{weeklyReportId}/comments`

**请求示例**:
```http
GET /api/weekly-reports/11/comments?page=0&size=10
Authorization: Bearer {token}
```

**预期响应**:
```json
{
  "success": true,
  "message": "操作成功",
  "data": {
    "comments": [],
    "totalCount": 0,
    "pageNum": 0,
    "pageSize": 10,
    "hasMore": false
  }
}
```

**验证点**:
- ✅ 状态码200
- ✅ success: true
- ✅ 返回评论列表（可能为空）

---

### 用例2: 创建评论（SUPER_ADMIN）

**接口**: `POST /api/weekly-reports/{weeklyReportId}/comments`

**角色**: superadmin
**周报**: 任意APPROVED状态的周报

**请求示例**:
```http
POST /api/weekly-reports/11/comments
Authorization: Bearer {superadmin_token}
Content-Type: application/json

{
  "content": "这是超级管理员的测试评论，评论功能验证"
}
```

**预期响应**:
```json
{
  "success": true,
  "message": "操作成功",
  "data": {
    "id": 1,
    "weeklyReportId": 11,
    "userId": 1,
    "content": "这是超级管理员的测试评论，评论功能验证",
    "commentType": "COMMENT",
    "status": "ACTIVE",
    "username": "superadmin",
    "userRole": "SUPER_ADMIN",
    "replies": [],
    "replyCount": 0
  }
}
```

**验证点**:
- ✅ 状态码201 Created
- ✅ success: true
- ✅ 返回评论ID
- ✅ 日志显示: `Creating comment for weekly report X by user 1`

---

### 用例3: 创建评论（MANAGER - 自己的周报）

**接口**: `POST /api/weekly-reports/{weeklyReportId}/comments`

**角色**: manager1 (ID=3)
**周报**: userId=3的APPROVED周报

**请求示例**:
```http
POST /api/weekly-reports/11/comments
Authorization: Bearer {manager1_token}
Content-Type: application/json

{
  "content": "主管评论自己的周报，测试权限控制"
}
```

**预期响应**:
```json
{
  "success": true,
  "message": "操作成功",
  "data": {
    "id": 2,
    "weeklyReportId": 11,
    "userId": 3,
    "content": "主管评论自己的周报，测试权限控制",
    "commentType": "COMMENT",
    "status": "ACTIVE",
    "username": "manager1",
    "userRole": "MANAGER"
  }
}
```

**验证点**:
- ✅ 状态码201
- ✅ success: true
- ✅ 日志显示: `✅ MANAGER manager1 可评论自己的周报 X`

---

### 用例4: 创建评论（MANAGER - 他人周报，应失败）

**接口**: `POST /api/weekly-reports/{weeklyReportId}/comments`

**角色**: manager1 (ID=3)
**周报**: userId≠3的APPROVED周报

**请求示例**:
```http
POST /api/weekly-reports/9/comments
Authorization: Bearer {manager1_token}
Content-Type: application/json

{
  "content": "主管尝试评论他人周报"
}
```

**预期响应**:
```json
{
  "success": false,
  "message": "只能评论自己提交的周报"
}
```

**验证点**:
- ✅ 状态码403 Forbidden
- ✅ success: false
- ✅ 错误消息: "只能评论自己提交的周报"

---

### 用例5: 创建评论（ADMIN - 应失败）

**接口**: `POST /api/weekly-reports/{weeklyReportId}/comments`

**角色**: admin2 (ID=8)
**周报**: 任意APPROVED周报

**请求示例**:
```http
POST /api/weekly-reports/11/comments
Authorization: Bearer {admin2_token}
Content-Type: application/json

{
  "content": "管理员尝试评论"
}
```

**预期响应**:
```json
{
  "success": false,
  "message": "无权限对此周报进行评论"
}
```

**验证点**:
- ✅ 状态码403
- ✅ success: false
- ✅ 错误消息: "无权限对此周报进行评论"

---

### 用例6: 评论非APPROVED周报（应失败）

**接口**: `POST /api/weekly-reports/{weeklyReportId}/comments`

**角色**: superadmin
**周报**: DRAFT或REJECTED或AI_PROCESSING状态

**请求示例**:
```http
POST /api/weekly-reports/17/comments
Authorization: Bearer {superadmin_token}
Content-Type: application/json

{
  "content": "尝试评论非APPROVED状态的周报"
}
```

**预期响应**:
```json
{
  "success": false,
  "message": "只能对审核通过的周报进行评论"
}
```

**验证点**:
- ✅ 状态码400或403
- ✅ success: false
- ✅ 错误消息正确

---

### 用例7: 创建回复

**接口**: `POST /api/weekly-reports/{weeklyReportId}/comments`

**前置条件**: 先创建一个评论，获取评论ID

**请求示例**:
```http
POST /api/weekly-reports/11/comments
Authorization: Bearer {superadmin_token}
Content-Type: application/json

{
  "content": "这是对评论的回复",
  "parentCommentId": 1
}
```

**预期响应**:
```json
{
  "success": true,
  "data": {
    "id": 3,
    "commentType": "REPLY",
    "parentCommentId": 1,
    "content": "这是对评论的回复"
  }
}
```

**验证点**:
- ✅ commentType: "REPLY"
- ✅ parentCommentId: 1

---

## Postman测试步骤

### 步骤1: 登录获取Token
```
POST http://localhost:8081/api/auth/login
Body (JSON):
{
  "username": "superadmin",
  "password": "SuperAdmin123@"
}

保存响应中的 data.accessToken
```

### 步骤2: 查询周报列表
```
GET http://localhost:8081/api/weekly-reports/my?page=0&size=100
Headers:
  Authorization: Bearer {上一步的token}

找到status="APPROVED"的周报ID
```

### 步骤3: 获取评论列表
```
GET http://localhost:8081/api/weekly-reports/{reportId}/comments?page=0&size=10
Headers:
  Authorization: Bearer {token}
```

### 步骤4: 创建评论
```
POST http://localhost:8081/api/weekly-reports/{reportId}/comments
Headers:
  Authorization: Bearer {token}
  Content-Type: application/json
Body:
{
  "content": "测试评论内容"
}
```

### 步骤5: 验证权限（用不同角色重复步骤4）

---

## 日志监控

### 正常评论创建日志
```
CommentController - 🎯 createComment method called! WeeklyReportId: X
WeeklyReportCommentService - Creating comment for weekly report X by user Y
WeeklyReportCommentService - ✅ SUPER_ADMIN xxx 可评论周报 X
或
WeeklyReportCommentService - ✅ MANAGER xxx 可评论自己的周报 X
WeeklyReportCommentService - Comment created successfully with ID: Z
```

### 权限拒绝日志
```
WeeklyReportCommentService - Creating comment for weekly report X by user Y
WeeklyReportCommentService - AccessDeniedException: 只能评论自己提交的周报
或
WeeklyReportCommentService - AccessDeniedException: 无权限对此周报进行评论
```

### 状态验证失败日志
```
WeeklyReportCommentService - IllegalStateException: 只能对审核通过的周报进行评论
```

---

## 测试检查清单

### 权限测试
- [ ] SUPER_ADMIN可评论任何APPROVED周报 ✅
- [ ] MANAGER可评论自己的APPROVED周报 ✅
- [ ] MANAGER不能评论他人的周报 ❌ (应拒绝)
- [ ] ADMIN不能评论任何周报 ❌ (应拒绝)

### 状态测试
- [ ] 可评论APPROVED周报 ✅
- [ ] 不能评论DRAFT周报 ❌
- [ ] 不能评论AI_PROCESSING周报 ❌
- [ ] 不能评论ADMIN_REVIEWING周报 ❌
- [ ] 不能评论REJECTED周报 ❌

### 功能测试
- [ ] 创建顶级评论 ✅
- [ ] 创建回复 ✅
- [ ] 获取评论列表（分页）✅
- [ ] 评论包含用户信息 ✅
- [ ] 回复嵌套在评论下 ✅

---

## 快速测试命令

如果您能通过前端测试更好，以下是使用curl的快速测试（需要先解决代理问题）：

```bash
# 1. 获取superadmin token
SUPER_TOKEN=$(curl -s -X POST http://localhost:8081/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"superadmin","password":"SuperAdmin123@"}' | \
  jq -r '.data.accessToken')

# 2. 创建评论（替换11为实际的APPROVED周报ID）
curl -X POST http://localhost:8081/api/weekly-reports/11/comments \
  -H "Authorization: Bearer $SUPER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"content":"测试评论"}' | jq

# 3. 获取评论列表
curl http://localhost:8081/api/weekly-reports/11/comments?page=0&size=10 \
  -H "Authorization: Bearer $SUPER_TOKEN" | jq
```

---

## 当前代码状态

### 评论权限规则（已修复）
```java
// SUPER_ADMIN: 可评论所有周报
if (currentUser.isSuperAdmin()) {
    return;
}

// MANAGER: 只能评论自己的周报
if (currentUser.getRole() == User.Role.MANAGER) {
    if (weeklyReport.getUserId().equals(currentUserId)) {
        return;
    } else {
        throw new AccessDeniedException("只能评论自己提交的周报");
    }
}

// 其他角色: 无权限
throw new AccessDeniedException("无权限对此周报进行评论");
```

### 周报状态验证（已修复）
```java
// 只允许APPROVED状态
if (weeklyReport.getStatus() != WeeklyReport.ReportStatus.APPROVED) {
    throw new IllegalStateException("只能对审核通过的周报进行评论");
}
```

---

**建议**: 通过前端页面测试评论功能，观察是否能正常创建和显示评论。
