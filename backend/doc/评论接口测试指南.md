# è¯„è®ºæ¥å£æµ‹è¯•æŒ‡å—

**åˆ›å»ºæ—¶é—´**: 2025-10-20 15:35:00
**æµ‹è¯•ç›®æ ‡**: éªŒè¯è¯„è®ºåŠŸèƒ½å’Œæƒé™æ§åˆ¶
**æµ‹è¯•å·¥å…·**: Postmanæˆ–å‰ç«¯é¡µé¢

---

## æµ‹è¯•å‰å‡†å¤‡

### 1. ç¡®è®¤æœåŠ¡è¿è¡Œ
```bash
curl http://localhost:8081/api/actuator/health
# é¢„æœŸ: {"status":"UP"}
```

### 2. å‡†å¤‡æµ‹è¯•è´¦å·

| è´¦å· | å¯†ç  | è§’è‰² | ç”¨æˆ·ID | è¯„è®ºæƒé™ |
|------|------|------|-------|---------|
| superadmin | SuperAdmin123@ | SUPER_ADMIN | 1 | âœ… å¯è¯„è®ºæ‰€æœ‰å‘¨æŠ¥ |
| manager1 | Manager123@ | MANAGER | 3 | âœ… åªèƒ½è¯„è®ºè‡ªå·±çš„å‘¨æŠ¥ |
| admin2 | Admin123@ | ADMIN | 8 | âŒ æ— è¯„è®ºæƒé™ |

### 3. æŸ¥æ‰¾APPROVEDçŠ¶æ€çš„å‘¨æŠ¥

**æŸ¥è¯¢å‘¨æŠ¥åˆ—è¡¨**:
```
GET /api/weekly-reports/my
Authorization: Bearer {manager1_token}
```

**æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å‘¨æŠ¥**:
- çŠ¶æ€: `APPROVED`
- æäº¤è€…ID: 3 (manager1çš„å‘¨æŠ¥ï¼Œç”¨äºæµ‹è¯•MANAGERæƒé™)
- æäº¤è€…ID: é3 (ä»–äººå‘¨æŠ¥ï¼Œç”¨äºæµ‹è¯•æƒé™æ‹’ç»)

---

## æµ‹è¯•ç”¨ä¾‹

### ç”¨ä¾‹1: è·å–è¯„è®ºåˆ—è¡¨

**æ¥å£**: `GET /api/weekly-reports/{weeklyReportId}/comments`

**è¯·æ±‚ç¤ºä¾‹**:
```http
GET /api/weekly-reports/11/comments?page=0&size=10
Authorization: Bearer {token}
```

**é¢„æœŸå“åº”**:
```json
{
  "success": true,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "comments": [],
    "totalCount": 0,
    "pageNum": 0,
    "pageSize": 10,
    "hasMore": false
  }
}
```

**éªŒè¯ç‚¹**:
- âœ… çŠ¶æ€ç 200
- âœ… success: true
- âœ… è¿”å›è¯„è®ºåˆ—è¡¨ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰

---

### ç”¨ä¾‹2: åˆ›å»ºè¯„è®ºï¼ˆSUPER_ADMINï¼‰

**æ¥å£**: `POST /api/weekly-reports/{weeklyReportId}/comments`

**è§’è‰²**: superadmin
**å‘¨æŠ¥**: ä»»æ„APPROVEDçŠ¶æ€çš„å‘¨æŠ¥

**è¯·æ±‚ç¤ºä¾‹**:
```http
POST /api/weekly-reports/11/comments
Authorization: Bearer {superadmin_token}
Content-Type: application/json

{
  "content": "è¿™æ˜¯è¶…çº§ç®¡ç†å‘˜çš„æµ‹è¯•è¯„è®ºï¼Œè¯„è®ºåŠŸèƒ½éªŒè¯"
}
```

**é¢„æœŸå“åº”**:
```json
{
  "success": true,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "id": 1,
    "weeklyReportId": 11,
    "userId": 1,
    "content": "è¿™æ˜¯è¶…çº§ç®¡ç†å‘˜çš„æµ‹è¯•è¯„è®ºï¼Œè¯„è®ºåŠŸèƒ½éªŒè¯",
    "commentType": "COMMENT",
    "status": "ACTIVE",
    "username": "superadmin",
    "userRole": "SUPER_ADMIN",
    "replies": [],
    "replyCount": 0
  }
}
```

**éªŒè¯ç‚¹**:
- âœ… çŠ¶æ€ç 201 Created
- âœ… success: true
- âœ… è¿”å›è¯„è®ºID
- âœ… æ—¥å¿—æ˜¾ç¤º: `Creating comment for weekly report X by user 1`

---

### ç”¨ä¾‹3: åˆ›å»ºè¯„è®ºï¼ˆMANAGER - è‡ªå·±çš„å‘¨æŠ¥ï¼‰

**æ¥å£**: `POST /api/weekly-reports/{weeklyReportId}/comments`

**è§’è‰²**: manager1 (ID=3)
**å‘¨æŠ¥**: userId=3çš„APPROVEDå‘¨æŠ¥

**è¯·æ±‚ç¤ºä¾‹**:
```http
POST /api/weekly-reports/11/comments
Authorization: Bearer {manager1_token}
Content-Type: application/json

{
  "content": "ä¸»ç®¡è¯„è®ºè‡ªå·±çš„å‘¨æŠ¥ï¼Œæµ‹è¯•æƒé™æ§åˆ¶"
}
```

**é¢„æœŸå“åº”**:
```json
{
  "success": true,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "id": 2,
    "weeklyReportId": 11,
    "userId": 3,
    "content": "ä¸»ç®¡è¯„è®ºè‡ªå·±çš„å‘¨æŠ¥ï¼Œæµ‹è¯•æƒé™æ§åˆ¶",
    "commentType": "COMMENT",
    "status": "ACTIVE",
    "username": "manager1",
    "userRole": "MANAGER"
  }
}
```

**éªŒè¯ç‚¹**:
- âœ… çŠ¶æ€ç 201
- âœ… success: true
- âœ… æ—¥å¿—æ˜¾ç¤º: `âœ… MANAGER manager1 å¯è¯„è®ºè‡ªå·±çš„å‘¨æŠ¥ X`

---

### ç”¨ä¾‹4: åˆ›å»ºè¯„è®ºï¼ˆMANAGER - ä»–äººå‘¨æŠ¥ï¼Œåº”å¤±è´¥ï¼‰

**æ¥å£**: `POST /api/weekly-reports/{weeklyReportId}/comments`

**è§’è‰²**: manager1 (ID=3)
**å‘¨æŠ¥**: userIdâ‰ 3çš„APPROVEDå‘¨æŠ¥

**è¯·æ±‚ç¤ºä¾‹**:
```http
POST /api/weekly-reports/9/comments
Authorization: Bearer {manager1_token}
Content-Type: application/json

{
  "content": "ä¸»ç®¡å°è¯•è¯„è®ºä»–äººå‘¨æŠ¥"
}
```

**é¢„æœŸå“åº”**:
```json
{
  "success": false,
  "message": "åªèƒ½è¯„è®ºè‡ªå·±æäº¤çš„å‘¨æŠ¥"
}
```

**éªŒè¯ç‚¹**:
- âœ… çŠ¶æ€ç 403 Forbidden
- âœ… success: false
- âœ… é”™è¯¯æ¶ˆæ¯: "åªèƒ½è¯„è®ºè‡ªå·±æäº¤çš„å‘¨æŠ¥"

---

### ç”¨ä¾‹5: åˆ›å»ºè¯„è®ºï¼ˆADMIN - åº”å¤±è´¥ï¼‰

**æ¥å£**: `POST /api/weekly-reports/{weeklyReportId}/comments`

**è§’è‰²**: admin2 (ID=8)
**å‘¨æŠ¥**: ä»»æ„APPROVEDå‘¨æŠ¥

**è¯·æ±‚ç¤ºä¾‹**:
```http
POST /api/weekly-reports/11/comments
Authorization: Bearer {admin2_token}
Content-Type: application/json

{
  "content": "ç®¡ç†å‘˜å°è¯•è¯„è®º"
}
```

**é¢„æœŸå“åº”**:
```json
{
  "success": false,
  "message": "æ— æƒé™å¯¹æ­¤å‘¨æŠ¥è¿›è¡Œè¯„è®º"
}
```

**éªŒè¯ç‚¹**:
- âœ… çŠ¶æ€ç 403
- âœ… success: false
- âœ… é”™è¯¯æ¶ˆæ¯: "æ— æƒé™å¯¹æ­¤å‘¨æŠ¥è¿›è¡Œè¯„è®º"

---

### ç”¨ä¾‹6: è¯„è®ºéAPPROVEDå‘¨æŠ¥ï¼ˆåº”å¤±è´¥ï¼‰

**æ¥å£**: `POST /api/weekly-reports/{weeklyReportId}/comments`

**è§’è‰²**: superadmin
**å‘¨æŠ¥**: DRAFTæˆ–REJECTEDæˆ–AI_PROCESSINGçŠ¶æ€

**è¯·æ±‚ç¤ºä¾‹**:
```http
POST /api/weekly-reports/17/comments
Authorization: Bearer {superadmin_token}
Content-Type: application/json

{
  "content": "å°è¯•è¯„è®ºéAPPROVEDçŠ¶æ€çš„å‘¨æŠ¥"
}
```

**é¢„æœŸå“åº”**:
```json
{
  "success": false,
  "message": "åªèƒ½å¯¹å®¡æ ¸é€šè¿‡çš„å‘¨æŠ¥è¿›è¡Œè¯„è®º"
}
```

**éªŒè¯ç‚¹**:
- âœ… çŠ¶æ€ç 400æˆ–403
- âœ… success: false
- âœ… é”™è¯¯æ¶ˆæ¯æ­£ç¡®

---

### ç”¨ä¾‹7: åˆ›å»ºå›å¤

**æ¥å£**: `POST /api/weekly-reports/{weeklyReportId}/comments`

**å‰ç½®æ¡ä»¶**: å…ˆåˆ›å»ºä¸€ä¸ªè¯„è®ºï¼Œè·å–è¯„è®ºID

**è¯·æ±‚ç¤ºä¾‹**:
```http
POST /api/weekly-reports/11/comments
Authorization: Bearer {superadmin_token}
Content-Type: application/json

{
  "content": "è¿™æ˜¯å¯¹è¯„è®ºçš„å›å¤",
  "parentCommentId": 1
}
```

**é¢„æœŸå“åº”**:
```json
{
  "success": true,
  "data": {
    "id": 3,
    "commentType": "REPLY",
    "parentCommentId": 1,
    "content": "è¿™æ˜¯å¯¹è¯„è®ºçš„å›å¤"
  }
}
```

**éªŒè¯ç‚¹**:
- âœ… commentType: "REPLY"
- âœ… parentCommentId: 1

---

## Postmanæµ‹è¯•æ­¥éª¤

### æ­¥éª¤1: ç™»å½•è·å–Token
```
POST http://localhost:8081/api/auth/login
Body (JSON):
{
  "username": "superadmin",
  "password": "SuperAdmin123@"
}

ä¿å­˜å“åº”ä¸­çš„ data.accessToken
```

### æ­¥éª¤2: æŸ¥è¯¢å‘¨æŠ¥åˆ—è¡¨
```
GET http://localhost:8081/api/weekly-reports/my?page=0&size=100
Headers:
  Authorization: Bearer {ä¸Šä¸€æ­¥çš„token}

æ‰¾åˆ°status="APPROVED"çš„å‘¨æŠ¥ID
```

### æ­¥éª¤3: è·å–è¯„è®ºåˆ—è¡¨
```
GET http://localhost:8081/api/weekly-reports/{reportId}/comments?page=0&size=10
Headers:
  Authorization: Bearer {token}
```

### æ­¥éª¤4: åˆ›å»ºè¯„è®º
```
POST http://localhost:8081/api/weekly-reports/{reportId}/comments
Headers:
  Authorization: Bearer {token}
  Content-Type: application/json
Body:
{
  "content": "æµ‹è¯•è¯„è®ºå†…å®¹"
}
```

### æ­¥éª¤5: éªŒè¯æƒé™ï¼ˆç”¨ä¸åŒè§’è‰²é‡å¤æ­¥éª¤4ï¼‰

---

## æ—¥å¿—ç›‘æ§

### æ­£å¸¸è¯„è®ºåˆ›å»ºæ—¥å¿—
```
CommentController - ğŸ¯ createComment method called! WeeklyReportId: X
WeeklyReportCommentService - Creating comment for weekly report X by user Y
WeeklyReportCommentService - âœ… SUPER_ADMIN xxx å¯è¯„è®ºå‘¨æŠ¥ X
æˆ–
WeeklyReportCommentService - âœ… MANAGER xxx å¯è¯„è®ºè‡ªå·±çš„å‘¨æŠ¥ X
WeeklyReportCommentService - Comment created successfully with ID: Z
```

### æƒé™æ‹’ç»æ—¥å¿—
```
WeeklyReportCommentService - Creating comment for weekly report X by user Y
WeeklyReportCommentService - AccessDeniedException: åªèƒ½è¯„è®ºè‡ªå·±æäº¤çš„å‘¨æŠ¥
æˆ–
WeeklyReportCommentService - AccessDeniedException: æ— æƒé™å¯¹æ­¤å‘¨æŠ¥è¿›è¡Œè¯„è®º
```

### çŠ¶æ€éªŒè¯å¤±è´¥æ—¥å¿—
```
WeeklyReportCommentService - IllegalStateException: åªèƒ½å¯¹å®¡æ ¸é€šè¿‡çš„å‘¨æŠ¥è¿›è¡Œè¯„è®º
```

---

## æµ‹è¯•æ£€æŸ¥æ¸…å•

### æƒé™æµ‹è¯•
- [ ] SUPER_ADMINå¯è¯„è®ºä»»ä½•APPROVEDå‘¨æŠ¥ âœ…
- [ ] MANAGERå¯è¯„è®ºè‡ªå·±çš„APPROVEDå‘¨æŠ¥ âœ…
- [ ] MANAGERä¸èƒ½è¯„è®ºä»–äººçš„å‘¨æŠ¥ âŒ (åº”æ‹’ç»)
- [ ] ADMINä¸èƒ½è¯„è®ºä»»ä½•å‘¨æŠ¥ âŒ (åº”æ‹’ç»)

### çŠ¶æ€æµ‹è¯•
- [ ] å¯è¯„è®ºAPPROVEDå‘¨æŠ¥ âœ…
- [ ] ä¸èƒ½è¯„è®ºDRAFTå‘¨æŠ¥ âŒ
- [ ] ä¸èƒ½è¯„è®ºAI_PROCESSINGå‘¨æŠ¥ âŒ
- [ ] ä¸èƒ½è¯„è®ºADMIN_REVIEWINGå‘¨æŠ¥ âŒ
- [ ] ä¸èƒ½è¯„è®ºREJECTEDå‘¨æŠ¥ âŒ

### åŠŸèƒ½æµ‹è¯•
- [ ] åˆ›å»ºé¡¶çº§è¯„è®º âœ…
- [ ] åˆ›å»ºå›å¤ âœ…
- [ ] è·å–è¯„è®ºåˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰âœ…
- [ ] è¯„è®ºåŒ…å«ç”¨æˆ·ä¿¡æ¯ âœ…
- [ ] å›å¤åµŒå¥—åœ¨è¯„è®ºä¸‹ âœ…

---

## å¿«é€Ÿæµ‹è¯•å‘½ä»¤

å¦‚æœæ‚¨èƒ½é€šè¿‡å‰ç«¯æµ‹è¯•æ›´å¥½ï¼Œä»¥ä¸‹æ˜¯ä½¿ç”¨curlçš„å¿«é€Ÿæµ‹è¯•ï¼ˆéœ€è¦å…ˆè§£å†³ä»£ç†é—®é¢˜ï¼‰ï¼š

```bash
# 1. è·å–superadmin token
SUPER_TOKEN=$(curl -s -X POST http://localhost:8081/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"superadmin","password":"SuperAdmin123@"}' | \
  jq -r '.data.accessToken')

# 2. åˆ›å»ºè¯„è®ºï¼ˆæ›¿æ¢11ä¸ºå®é™…çš„APPROVEDå‘¨æŠ¥IDï¼‰
curl -X POST http://localhost:8081/api/weekly-reports/11/comments \
  -H "Authorization: Bearer $SUPER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"content":"æµ‹è¯•è¯„è®º"}' | jq

# 3. è·å–è¯„è®ºåˆ—è¡¨
curl http://localhost:8081/api/weekly-reports/11/comments?page=0&size=10 \
  -H "Authorization: Bearer $SUPER_TOKEN" | jq
```

---

## å½“å‰ä»£ç çŠ¶æ€

### è¯„è®ºæƒé™è§„åˆ™ï¼ˆå·²ä¿®å¤ï¼‰
```java
// SUPER_ADMIN: å¯è¯„è®ºæ‰€æœ‰å‘¨æŠ¥
if (currentUser.isSuperAdmin()) {
    return;
}

// MANAGER: åªèƒ½è¯„è®ºè‡ªå·±çš„å‘¨æŠ¥
if (currentUser.getRole() == User.Role.MANAGER) {
    if (weeklyReport.getUserId().equals(currentUserId)) {
        return;
    } else {
        throw new AccessDeniedException("åªèƒ½è¯„è®ºè‡ªå·±æäº¤çš„å‘¨æŠ¥");
    }
}

// å…¶ä»–è§’è‰²: æ— æƒé™
throw new AccessDeniedException("æ— æƒé™å¯¹æ­¤å‘¨æŠ¥è¿›è¡Œè¯„è®º");
```

### å‘¨æŠ¥çŠ¶æ€éªŒè¯ï¼ˆå·²ä¿®å¤ï¼‰
```java
// åªå…è®¸APPROVEDçŠ¶æ€
if (weeklyReport.getStatus() != WeeklyReport.ReportStatus.APPROVED) {
    throw new IllegalStateException("åªèƒ½å¯¹å®¡æ ¸é€šè¿‡çš„å‘¨æŠ¥è¿›è¡Œè¯„è®º");
}
```

---

**å»ºè®®**: é€šè¿‡å‰ç«¯é¡µé¢æµ‹è¯•è¯„è®ºåŠŸèƒ½ï¼Œè§‚å¯Ÿæ˜¯å¦èƒ½æ­£å¸¸åˆ›å»ºå’Œæ˜¾ç¤ºè¯„è®ºã€‚
