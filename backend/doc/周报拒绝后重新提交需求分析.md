# 周报拒绝后重新提交需求分析

**需求来源**: 用户反馈
**需求时间**: 2025-10-20
**影响范围**: 前端UI + 后端API（可选）

---

## 需求说明

### 当前行为
1. 周报被AI拒绝或管理员拒绝后，状态变为`REJECTED`
2. 用户可以修改被拒绝的周报
3. 修改页面有两个按钮：
   - "保存草稿" - 保存为DRAFT状态
   - "提交周报" - 提交审核

### 期望行为
1. 周报被拒绝后进入修改页面
2. **只显示"提交周报"按钮**，隐藏"保存草稿"按钮
3. 点击"提交周报"后，**直接进入AI_PROCESSING状态**，不经过DRAFT

---

## 实现方案

### 方案1: 纯前端实现（推荐）

#### 前端修改（frontend/src/views/weekly-reports/index.vue）

**修改点1: 条件显示保存草稿按钮**
```vue
<template>
  <!-- 原代码: -->
  <el-button @click="saveDraft">保存草稿</el-button>
  <el-button type="primary" @click="submitReport">提交周报</el-button>

  <!-- 修改为: -->
  <el-button
    v-if="!isRejectedReport"
    @click="saveDraft">
    保存草稿
  </el-button>
  <el-button type="primary" @click="submitReport">
    {{ isRejectedReport ? '重新提交' : '提交周报' }}
  </el-button>
</template>

<script setup>
// 添加computed属性
const isRejectedReport = computed(() => {
  return currentReport.value?.status === 'REJECTED'
})

// 修改submitReport方法
const submitReport = async () => {
  if (isRejectedReport.value) {
    // 拒绝后重新提交，使用update+submit方式
    await weeklyReportApi.update(reportId, formData)
    await weeklyReportApi.submitForReview(reportId)
  } else {
    // 新建周报，直接提交
    await weeklyReportApi.submitDirectly(formData)
  }
}
</script>
```

**优点**:
- ✅ 无需修改后端
- ✅ 实现简单
- ✅ 前端完全控制UI逻辑

---

### 方案2: 后端增强支持（备选）

如果需要后端强制执行逻辑，可以添加新的API：

#### 后端新增API
```java
// WeeklyReportController.java
@PutMapping("/{id}/resubmit")
public ResponseEntity<ApiResponse<WeeklyReport>> resubmitRejectedReport(
        @PathVariable Long id,
        @Valid @RequestBody WeeklyReportUpdateRequest request) {

    // 1. 验证周报状态必须是REJECTED
    WeeklyReport report = weeklyReportService.getWeeklyReportDetail(id);
    if (!report.isRejected()) {
        throw new IllegalStateException("只能重新提交被拒绝的周报");
    }

    // 2. 更新周报内容
    weeklyReportService.updateWeeklyReport(id, request);

    // 3. 直接提交审核（进入AI_PROCESSING）
    WeeklyReport submitted = weeklyReportService.submitForReview(id);

    return ResponseEntity.ok(ApiResponse.success("周报已重新提交", submitted));
}
```

**优点**:
- ✅ 后端保证业务逻辑
- ✅ 防止非法操作
- ✅ 更清晰的API语义

**缺点**:
- ❌ 需要修改后端
- ❌ 前端需要调用新API

---

## 状态流转对比

### 当前流程
```
REJECTED状态周报修改
  ↓
保存草稿 → DRAFT
  ↓
提交审核 → AI_PROCESSING
```

### 期望流程
```
REJECTED状态周报修改
  ↓
提交周报 → AI_PROCESSING（直接）
```

---

## 推荐实现（方案1）

### 前端修改清单

#### 文件: `frontend/src/views/weekly-reports/index.vue`

**修改1: 添加computed属性（约第300行）**
```javascript
// 判断是否是被拒绝的周报
const isRejectedReport = computed(() => {
  return currentReport.value?.status === 'REJECTED'
})
```

**修改2: 条件显示保存草稿按钮（约第766行）**
```vue
<!-- 只在非拒绝状态显示保存草稿按钮 -->
<el-button
  v-if="!isRejectedReport"
  @click="saveDraft"
  :loading="saving">
  保存草稿
</el-button>

<!-- 提交按钮文本根据状态调整 -->
<el-button
  type="primary"
  @click="submitReport"
  :loading="submitting">
  {{ isRejectedReport ? '重新提交' : '提交周报' }}
</el-button>
```

**修改3: 调整提交逻辑（约第732行）**
```javascript
const submitReport = async () => {
  try {
    submitting.value = true

    if (isRejectedReport.value) {
      // 被拒绝的周报：先更新再提交
      await weeklyReportApi.update(currentReport.value.id, formData)
      await weeklyReportApi.submitForReview(currentReport.value.id)
      ElMessage.success('周报已重新提交')
    } else {
      // 新建周报：直接提交
      await weeklyReportApi.submitDirectly(formData)
      ElMessage.success('周报已提交')
    }

    router.push('/weekly-reports')
  } catch (error) {
    console.error('提交周报失败:', error)
    ElMessage.error('提交周报失败: ' + error.message)
  } finally {
    submitting.value = false
  }
}
```

---

## 后端当前支持情况

### ✅ 已支持的API

**1. 更新周报**
```
PUT /api/weekly-reports/{id}
```
- ✅ 更新周报内容
- ✅ 保持当前状态（REJECTED不变）
- ✅ 清除旧的关联数据
- ✅ **现已修复DELETE查询错误**

**2. 提交审核**
```
POST /api/weekly-reports/{id}/submit
```
- ✅ 验证状态（只能提交DRAFT或REJECTED）
- ✅ 状态转换：REJECTED → AI_PROCESSING
- ✅ 触发AI分析
- ✅ 发送提交邮件

**3. 直接提交**
```
POST /api/weekly-reports/submit-directly
```
- ✅ 创建并直接提交
- ✅ 状态：AI_PROCESSING
- ✅ 触发AI分析
- ✅ 发送提交邮件

### 前端调用建议

**拒绝后重新提交流程**:
```javascript
// 步骤1: 更新周报内容
await weeklyReportApi.update(reportId, updatedData)

// 步骤2: 提交审核
await weeklyReportApi.submitForReview(reportId)
```

这样：
- ✅ REJECTED → AI_PROCESSING
- ✅ 不经过DRAFT
- ✅ 触发新的AI分析
- ✅ 发送提交邮件

---

## 状态机说明

### 后端WeeklyReport.submit()方法
```java
// WeeklyReport.java
public void submit() {
    if (!isEditable()) {
        throw new IllegalStateException("只能提交草稿或已拒绝状态的周报");
    }
    this.status = ReportStatus.AI_PROCESSING;
    this.submittedAt = LocalDateTime.now();
}
```

**支持的状态转换**:
- ✅ DRAFT → AI_PROCESSING
- ✅ REJECTED → AI_PROCESSING ⬅️ **这就是您需要的**

---

## 前端修改示例（完整代码）

```vue
<template>
  <div class="weekly-report-form">
    <!-- ... 表单内容 ... -->

    <div class="form-actions">
      <!-- 条件显示保存草稿按钮 -->
      <el-button
        v-if="!isRejectedReport"
        @click="saveDraft"
        :loading="saving"
        :disabled="submitting">
        保存草稿
      </el-button>

      <!-- 提交按钮 -->
      <el-button
        type="primary"
        @click="submitReport"
        :loading="submitting"
        :disabled="saving">
        {{ submitButtonText }}
      </el-button>
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed } from 'vue'

// 判断是否是被拒绝的周报
const isRejectedReport = computed(() => {
  return currentReport.value?.status === 'REJECTED'
})

// 提交按钮文本
const submitButtonText = computed(() => {
  return isRejectedReport.value ? '重新提交' : '提交周报'
})

// 保存草稿（仅新建周报可用）
const saveDraft = async () => {
  try {
    saving.value = true

    if (currentReport.value?.id) {
      // 更新现有草稿
      await weeklyReportApi.update(currentReport.value.id, formData.value)
      ElMessage.success('草稿已保存')
    } else {
      // 创建新草稿
      const created = await weeklyReportApi.create(formData.value)
      currentReport.value = created
      ElMessage.success('草稿已创建')
    }
  } catch (error) {
    ElMessage.error('保存草稿失败: ' + error.message)
  } finally {
    saving.value = false
  }
}

// 提交周报
const submitReport = async () => {
  try {
    submitting.value = true

    if (isRejectedReport.value) {
      // 被拒绝的周报：先更新内容，再提交审核
      console.log('重新提交被拒绝的周报，ID:', currentReport.value.id)

      // 步骤1: 更新周报内容
      await weeklyReportApi.update(currentReport.value.id, formData.value)

      // 步骤2: 提交审核（REJECTED → AI_PROCESSING）
      await weeklyReportApi.submitForReview(currentReport.value.id)

      ElMessage.success('周报已重新提交，正在进行AI分析')
    } else {
      // 新建周报：直接提交
      console.log('直接提交新周报')
      await weeklyReportApi.submitDirectly(formData.value)
      ElMessage.success('周报已提交，正在进行AI分析')
    }

    // 返回列表页
    router.push('/weekly-reports')
  } catch (error) {
    console.error('提交周报失败:', error)
    ElMessage.error('提交周报失败: ' + error.message)
  } finally {
    submitting.value = false
  }
}
</script>

<style scoped>
.form-actions {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  margin-top: 24px;
}
</style>
```

---

## 后端无需修改

✅ **后端已经支持您需要的流程**：

1. ✅ `WeeklyReport.submit()` 支持 REJECTED → AI_PROCESSING
2. ✅ `WeeklyReportService.submitForReview()` 验证状态并提交
3. ✅ 提交后触发AI分析和邮件通知
4. ✅ **DELETE查询错误已修复**

---

## 前端API调用示例

### 被拒绝周报的重新提交
```javascript
// 假设reportId = 17，状态 = REJECTED

// 步骤1: 更新周报
PUT /api/weekly-reports/17
Body: { title, reportWeek, content, nextWeekPlan, ... }
Response: { status: "REJECTED" } // 状态不变

// 步骤2: 提交审核
POST /api/weekly-reports/17/submit
Response: { status: "AI_PROCESSING" } // 状态变更
触发: AI分析 + 提交邮件
```

---

## 状态流转说明

### 拒绝后的状态机
```
REJECTED (被拒绝)
    ↓
  [用户修改]
    ↓
  [点击提交] - 调用update + submitForReview
    ↓
AI_PROCESSING (AI处理中)
    ↓
  [AI分析]
    ↓
PENDING_REVIEW 或 REJECTED (再次)
```

**关键**:
- ✅ 不经过DRAFT状态
- ✅ 直接从REJECTED → AI_PROCESSING
- ✅ 重新触发AI分析
- ✅ 发送新的提交邮件

---

## 前端修改位置参考

根据错误信息`index.vue:766`，修改位置应该在：

**文件**: `frontend/src/views/weekly-reports/index.vue`

**需要修改的部分**:
1. **第300-400行左右**: 添加`isRejectedReport` computed属性
2. **第700-800行左右**: 修改`submitReport`方法
3. **模板部分**: 条件渲染"保存草稿"按钮

---

## 验证步骤

### 1. 准备被拒绝的周报
- 提交一份低质量周报（AI置信度<0.7）
- 或让管理员拒绝一份周报

### 2. 修改前端代码
- 添加isRejectedReport判断
- 条件显示保存草稿按钮
- 修改提交逻辑

### 3. 测试流程
```
1. 打开被拒绝的周报（status=REJECTED）
2. 验证：只显示"重新提交"按钮，无"保存草稿"
3. 修改内容后点击"重新提交"
4. 验证：周报状态变为AI_PROCESSING
5. 验证：收到提交成功邮件
6. 等待AI分析完成
7. 验证：收到AI分析结果邮件
```

---

## 后端已完成的修复

✅ **DELETE查询错误已修复**：
- 添加`@Modifying`注解
- 添加`@Transactional`注解
- 服务已重启

**您现在可以正常修改和重新提交被拒绝的周报了！**

---

**文档类型**: 需求分析 + 实现方案
**实现范围**: 主要是前端修改
**后端支持**: 已就绪，无需修改
