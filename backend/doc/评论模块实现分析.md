# è¯„è®ºæ¨¡å—å®ç°åˆ†æ

**åˆ†ææ—¶é—´**: 2025-10-20 15:10:00
**åˆ†æèŒƒå›´**: commentæ¨¡å—å®Œæ•´å®ç°
**åˆ†æé‡ç‚¹**: æ¶æ„è®¾è®¡ã€åŠŸèƒ½å®Œæ•´æ€§ã€æƒé™æ§åˆ¶
**å½“å‰ç«¯**: backend

---

## æ‰§è¡Œæ‘˜è¦

è¯„è®ºæ¨¡å—é‡‡ç”¨**æ ‡å‡†çš„åˆ†å±‚æ¶æ„è®¾è®¡**ï¼Œå®ç°äº†åŸºæœ¬çš„è¯„è®ºå’Œå›å¤åŠŸèƒ½ï¼ŒåŒ…å«æƒé™æ§åˆ¶å’Œè½¯åˆ é™¤æœºåˆ¶ã€‚**åŠŸèƒ½å·²åŸºæœ¬å®Œæ•´**ï¼Œä½†å­˜åœ¨ä¸€äº›å¯ä¼˜åŒ–çš„è®¾è®¡ç‚¹å’Œæœªå®Œå…¨å®ç°çš„åŠŸèƒ½ã€‚æ€»ä½“ä»£ç è´¨é‡è‰¯å¥½ï¼Œæƒé™æ§åˆ¶è¾ƒä¸ºå®Œå–„ï¼Œé€‚åˆå½“å‰ä¸šåŠ¡éœ€æ±‚ã€‚

**å…³é”®å‘ç°**:
- âœ… æ”¯æŒæ ‘å½¢è¯„è®ºç»“æ„ï¼ˆè¯„è®º+å›å¤ï¼‰
- âœ… æƒé™æ§åˆ¶è¾ƒå®Œå–„
- âœ… è½¯åˆ é™¤æœºåˆ¶
- âš ï¸ éƒ¨åˆ†RepositoryæŸ¥è¯¢æœªè¢«Serviceä½¿ç”¨
- âš ï¸ ç¼ºå°‘æ›´æ–°å’Œåˆ é™¤çš„Controllerç«¯ç‚¹

---

## åˆ†æç›®æ ‡

åˆ†æå‘¨æŠ¥è¯„è®ºæ¨¡å—çš„å®Œæ•´å®ç°ï¼Œè¯„ä¼°å…¶æ¶æ„è®¾è®¡ã€åŠŸèƒ½å®Œæ•´æ€§ã€æ€§èƒ½è¡¨ç°å’Œæ½œåœ¨é—®é¢˜ï¼Œä¸ºåç»­ä¼˜åŒ–æä¾›ä¾æ®ã€‚

---

## è¯¦ç»†åˆ†æ

### 1. æ¨¡å—æ¶æ„

#### 1.1 åˆ†å±‚ç»“æ„

```
comment/
â”œâ”€â”€ controller/
â”‚   â”œâ”€â”€ CommentController.java          # ä¸»è¦APIæ§åˆ¶å™¨
â”‚   â””â”€â”€ SimpleCommentController.java     # ç®€åŒ–ç‰ˆæ§åˆ¶å™¨
â”œâ”€â”€ service/
â”‚   â””â”€â”€ WeeklyReportCommentService.java  # ä¸šåŠ¡é€»è¾‘å±‚
â”œâ”€â”€ repository/
â”‚   â””â”€â”€ WeeklyReportCommentRepository.java  # æ•°æ®è®¿é—®å±‚
â”œâ”€â”€ entity/
â”‚   â””â”€â”€ WeeklyReportComment.java         # å®ä½“ç±»
â””â”€â”€ dto/
    â”œâ”€â”€ CommentCreateRequest.java        # åˆ›å»ºè¯·æ±‚DTO
    â”œâ”€â”€ CommentUpdateRequest.java        # æ›´æ–°è¯·æ±‚DTO
    â”œâ”€â”€ CommentResponse.java             # å“åº”DTO
    â””â”€â”€ CommentListResponse.java         # åˆ—è¡¨å“åº”DTO
```

**è¯„ä»·**: âœ… **æ ‡å‡†çš„ä¸‰å±‚æ¶æ„**ï¼ŒèŒè´£æ¸…æ™°ï¼Œç¬¦åˆSpring Bootæœ€ä½³å®è·µ

#### 1.2 æ•°æ®æ¨¡å‹è®¾è®¡

**è¡¨ç»“æ„**: `weekly_report_comments`

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | è®¾è®¡è¯„ä»· |
|------|------|------|---------|
| id | BIGINT | ä¸»é”® | âœ… æ ‡å‡†è®¾è®¡ |
| weekly_report_id | BIGINT | å‘¨æŠ¥IDï¼ˆå¤–é”®ï¼‰ | âœ… å¿…è¦å­—æ®µ |
| user_id | BIGINT | ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰ | âœ… å¿…è¦å­—æ®µ |
| parent_comment_id | BIGINT | çˆ¶è¯„è®ºID | âœ… æ”¯æŒå›å¤ |
| content | TEXT | è¯„è®ºå†…å®¹ | âœ… TEXTç±»å‹æ”¯æŒé•¿æ–‡æœ¬ |
| comment_type | ENUM | è¯„è®ºç±»å‹ | âœ… åŒºåˆ†è¯„è®º/å›å¤ |
| status | ENUM | çŠ¶æ€ | âœ… è½¯åˆ é™¤æ”¯æŒ |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ | âœ… è‡ªåŠ¨æ—¶é—´æˆ³ |
| updated_at | TIMESTAMP | æ›´æ–°æ—¶é—´ | âœ… è‡ªåŠ¨æ›´æ–° |

**å¤–é”®å…³ç³»**:
```
weekly_report_comments.weekly_report_id â†’ weekly_reports.id (ON DELETE CASCADE)
weekly_report_comments.user_id â†’ users.id (ON DELETE CASCADE)
weekly_report_comments.parent_comment_id â†’ weekly_report_comments.id (ON DELETE CASCADE)
```

**ç´¢å¼•**:
- âœ… `idx_weekly_report_comments_report_id` - æŒ‰å‘¨æŠ¥æŸ¥è¯¢è¯„è®º
- âœ… `idx_weekly_report_comments_user_id` - æŒ‰ç”¨æˆ·æŸ¥è¯¢è¯„è®º
- âœ… `idx_weekly_report_comments_parent_id` - æŸ¥è¯¢å›å¤
- âœ… `idx_weekly_report_comments_status` - çŠ¶æ€è¿‡æ»¤
- âœ… `idx_weekly_report_comments_created_at` - æ—¶é—´æ’åº

**è¯„ä»·**: âœ… **ç´¢å¼•è®¾è®¡å®Œå–„**ï¼Œè¦†ç›–äº†æ‰€æœ‰å¸¸è§æŸ¥è¯¢åœºæ™¯

---

### 2. æ ¸å¿ƒåŠŸèƒ½å®ç°

#### 2.1 è¯„è®ºåˆ›å»º

**Serviceå±‚**: WeeklyReportCommentService.createComment (51-82è¡Œ)

**æµç¨‹**:
```
1. æƒé™éªŒè¯ - validateCommentPermission
2. å‘¨æŠ¥çŠ¶æ€éªŒè¯ - åªèƒ½å¯¹APPROVEDçŠ¶æ€çš„å‘¨æŠ¥è¯„è®º
3. åˆ›å»ºè¯„è®ºå®ä½“
4. åˆ¤æ–­ç±»å‹ï¼ˆè¯„è®º/å›å¤ï¼‰
5. ä¿å­˜æ•°æ®åº“
6. è¿”å›å“åº”DTO
```

**æƒé™é€»è¾‘** (181-207è¡Œ):
- âœ… è¶…çº§ç®¡ç†å‘˜: å¯è¯„è®ºä»»ä½•å‘¨æŠ¥
- âœ… ç®¡ç†å‘˜: å¯è¯„è®ºä»»ä½•å‘¨æŠ¥
- âœ… ä¸»ç®¡: å¯è¯„è®ºä»»ä½•å‘¨æŠ¥ï¼ˆç®€åŒ–å®ç°ï¼‰
- âŒ æ™®é€šå‘˜å·¥: æ— è¯„è®ºæƒé™

**é—®é¢˜åˆ†æ**:
```java
// ç¬¬58-60è¡Œ
if (!commentRepository.existsApprovedWeeklyReport(request.getWeeklyReportId())) {
    throw new IllegalStateException("åªèƒ½å¯¹å®¡æ ¸é€šè¿‡çš„å‘¨æŠ¥è¿›è¡Œè¯„è®º");
}
```

âš ï¸ **é™åˆ¶è¿‡ä¸¥**: åªèƒ½å¯¹APPROVEDçŠ¶æ€è¯„è®ºï¼Œä½†å®é™…ä¸šåŠ¡ä¸­å¯èƒ½éœ€è¦åœ¨å®¡æ ¸è¿‡ç¨‹ä¸­è¯„è®ºï¼ˆç»™å‡ºå®¡æ ¸æ„è§ï¼‰

**å»ºè®®**: å…è®¸ç®¡ç†å‘˜åœ¨PENDING_REVIEWçŠ¶æ€æ—¶è¯„è®º

#### 2.2 è¯„è®ºæŸ¥è¯¢

**RepositoryæŸ¥è¯¢æ–¹æ³•** (9ç§):

| æ–¹æ³• | Serviceä½¿ç”¨ | è¯´æ˜ |
|------|-----------|------|
| findTopLevelCommentsWithUser | âœ… ä½¿ç”¨ | åˆ†é¡µæŸ¥è¯¢é¡¶çº§è¯„è®º |
| findRepliesWithUser | âœ… ä½¿ç”¨ | æŸ¥è¯¢å›å¤ï¼ˆå«ç”¨æˆ·ä¿¡æ¯ï¼‰ |
| findByWeeklyReportIdAndStatusActive | âŒ æœªä½¿ç”¨ | æŸ¥è¯¢å‘¨æŠ¥æ‰€æœ‰è¯„è®º |
| findTopLevelCommentsByWeeklyReportId | âŒ æœªä½¿ç”¨ | åˆ†é¡µé¡¶çº§è¯„è®ºï¼ˆæ— ç”¨æˆ·ï¼‰ |
| findRepliesByParentCommentId | âŒ æœªä½¿ç”¨ | æŸ¥è¯¢å›å¤ï¼ˆæ— ç”¨æˆ·ï¼‰ |
| countByWeeklyReportIdAndStatusActive | âŒ æœªä½¿ç”¨ | ç»Ÿè®¡è¯„è®ºæ•° |
| countRepliesByParentCommentId | âŒ æœªä½¿ç”¨ | ç»Ÿè®¡å›å¤æ•° |
| findByUserIdAndStatusActive | âŒ æœªä½¿ç”¨ | ç”¨æˆ·çš„æ‰€æœ‰è¯„è®º |
| findCommentWithPermissionCheck | âŒ æœªä½¿ç”¨ | æƒé™æ£€æŸ¥æŸ¥è¯¢ |

âš ï¸ **ä»£ç å†—ä½™**: 50%çš„Repositoryæ–¹æ³•æœªè¢«ä½¿ç”¨

**å®é™…ä½¿ç”¨çš„æŸ¥è¯¢** (2ä¸ª):
1. `findTopLevelCommentsWithUser` - è·å–è¯„è®ºåˆ—è¡¨
2. `findRepliesWithUser` - è·å–å›å¤

**æ€§èƒ½ä¼˜åŒ–**: âœ… ä½¿ç”¨JOIN FETCHé¢„åŠ è½½ç”¨æˆ·ä¿¡æ¯ï¼Œé¿å…N+1é—®é¢˜

#### 2.3 è¯„è®ºæ›´æ–°

**Serviceå±‚**: WeeklyReportCommentService.updateComment (115-131è¡Œ)

**æƒé™æ§åˆ¶**:
```java
// åªæœ‰è¯„è®ºä½œè€…æˆ–è¶…çº§ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹è¯„è®º
if (!comment.getUserId().equals(currentUserId) && !isCurrentUserSuperAdmin(currentUserId)) {
    throw new AccessDeniedException("æ— æƒé™ä¿®æ”¹æ­¤è¯„è®º");
}
```

âœ… **æƒé™è®¾è®¡åˆç†**

âš ï¸ **Controlleræœªå®ç°**: æ²¡æœ‰å¯¹åº”çš„PUTç«¯ç‚¹

#### 2.4 è¯„è®ºåˆ é™¤

**Serviceå±‚**: WeeklyReportCommentService.deleteComment (136-153è¡Œ)

**åˆ é™¤ç­–ç•¥**: è½¯åˆ é™¤
```java
@Modifying
@Query("UPDATE WeeklyReportComment c SET c.status = 'DELETED', c.updatedAt = CURRENT_TIMESTAMP WHERE c.id = :commentId")
int softDeleteComment(@Param("commentId") Long commentId);
```

âœ… **è½¯åˆ é™¤æœºåˆ¶**: ä¿ç•™æ•°æ®ï¼Œä»…æ ‡è®°çŠ¶æ€
âœ… **çº§è”åˆ é™¤**: å¤–é”®ON DELETE CASCADEï¼Œåˆ é™¤å‘¨æŠ¥æ—¶è‡ªåŠ¨åˆ é™¤è¯„è®º

âš ï¸ **Controlleræœªå®ç°**: æ²¡æœ‰å¯¹åº”çš„DELETEç«¯ç‚¹

---

### 3. APIç«¯ç‚¹åˆ†æ

#### 3.1 å·²å®ç°çš„ç«¯ç‚¹ (2ä¸ª)

**CommentController.java**:

| ç«¯ç‚¹ | æ–¹æ³• | æƒé™ | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|------|------|
| GET /weekly-reports/{id}/comments | getComments | MANAGER+ | è·å–è¯„è®ºåˆ—è¡¨ | âœ… å®Œæ•´ |
| POST /weekly-reports/{id}/comments | createComment | MANAGER+ | åˆ›å»ºè¯„è®º | âœ… å®Œæ•´ |

#### 3.2 ç¼ºå¤±çš„ç«¯ç‚¹ (2ä¸ª)

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ | Serviceæ”¯æŒ | å½±å“ |
|------|------|------|-----------|------|
| PUT /comments/{id} | updateComment | æ›´æ–°è¯„è®º | âœ… å·²å®ç° | âš ï¸ åŠŸèƒ½ä¸å®Œæ•´ |
| DELETE /comments/{id} | deleteComment | åˆ é™¤è¯„è®º | âœ… å·²å®ç° | âš ï¸ åŠŸèƒ½ä¸å®Œæ•´ |

**ä»£ç å·²å®ç°ä½†æœªæš´éœ²API**:
- Serviceå±‚æœ‰`updateComment`å’Œ`deleteComment`æ–¹æ³•
- Controllerå±‚ç¼ºå°‘å¯¹åº”ç«¯ç‚¹

---

### 4. æƒé™æ§åˆ¶åˆ†æ

#### 4.1 æƒé™æ¨¡å‹

**è¯„è®ºæƒé™**ï¼ˆvalidateCommentPermissionï¼‰:
```
è¶…çº§ç®¡ç†å‘˜ â†’ å¯è¯„è®ºä»»ä½•å‘¨æŠ¥
ç®¡ç†å‘˜ â†’ å¯è¯„è®ºä»»ä½•å‘¨æŠ¥
ä¸»ç®¡ â†’ å¯è¯„è®ºä»»ä½•å‘¨æŠ¥ï¼ˆç®€åŒ–ï¼‰
æ™®é€šå‘˜å·¥ â†’ æ— æƒé™
```

**æŸ¥çœ‹æƒé™**ï¼ˆvalidateAccessPermissionï¼‰:
```
è¶…çº§ç®¡ç†å‘˜ â†’ å¯æŸ¥çœ‹æ‰€æœ‰è¯„è®º
ç®¡ç†å‘˜ â†’ å¯æŸ¥çœ‹æ‰€æœ‰è¯„è®º
å‘¨æŠ¥ä½œè€… â†’ å¯æŸ¥çœ‹è‡ªå·±å‘¨æŠ¥çš„è¯„è®º
ä¸»ç®¡ â†’ å¯æŸ¥çœ‹æ‰€æœ‰è¯„è®º
```

**ä¿®æ”¹/åˆ é™¤æƒé™**:
```
è¯„è®ºä½œè€… â†’ å¯ä¿®æ”¹/åˆ é™¤è‡ªå·±çš„è¯„è®º
è¶…çº§ç®¡ç†å‘˜ â†’ å¯ä¿®æ”¹/åˆ é™¤ä»»ä½•è¯„è®º
```

#### 4.2 æƒé™æ§åˆ¶è¯„ä»·

âœ… **ä¼˜ç‚¹**:
- æƒé™åˆ†çº§æ¸…æ™°
- ä½¿ç”¨Spring Securityçš„@PreAuthorizeæ³¨è§£
- Serviceå±‚åŒé‡éªŒè¯

âš ï¸ **é—®é¢˜**:
- æ™®é€šå‘˜å·¥å®Œå…¨æ— æ³•è¯„è®ºï¼ˆè¿‡äºä¸¥æ ¼ï¼‰
- ä¸»ç®¡æƒé™åˆ¤æ–­ç®€åŒ–ï¼ˆæœªå®é™…æ£€æŸ¥ä¸»ç®¡å…³ç³»ï¼‰
- ç¼ºå°‘"å‘¨æŠ¥ä½œè€…å¯ä»¥æŸ¥çœ‹è‡ªå·±å‘¨æŠ¥çš„è¯„è®º"çš„æµ‹è¯•

**å»ºè®®**:
- å…è®¸å‘¨æŠ¥ä½œè€…å¯¹è‡ªå·±çš„å‘¨æŠ¥è¿›è¡Œè¯„è®º
- å®ç°çœŸå®çš„ä¸»ç®¡å…³ç³»åˆ¤æ–­

---

### 5. æ•°æ®æŸ¥è¯¢æ€§èƒ½

#### 5.1 æŸ¥è¯¢ä¼˜åŒ–

**å¥½çš„å®è·µ**:
```java
// ä½¿ç”¨JOIN FETCHé¿å…N+1é—®é¢˜
@Query("SELECT c FROM WeeklyReportComment c LEFT JOIN FETCH c.user WHERE ...")
Page<WeeklyReportComment> findTopLevelCommentsWithUser(...);
```

âœ… **é¢„åŠ è½½ç”¨æˆ·ä¿¡æ¯**ï¼Œå•æ¬¡æŸ¥è¯¢è·å–è¯„è®º+ç”¨æˆ·æ•°æ®

**åˆ†é¡µæ”¯æŒ**:
```java
Page<WeeklyReportComment> findTopLevelCommentsWithUser(Long weeklyReportId, Pageable pageable);
```

âœ… **æ”¯æŒåˆ†é¡µ**ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§é‡æ•°æ®

#### 5.2 æ€§èƒ½ç“¶é¢ˆ

**æ½œåœ¨é—®é¢˜**: å›å¤çš„N+1æŸ¥è¯¢
```java
// WeeklyReportCommentService.java:279
List<WeeklyReportComment> replies = commentRepository.findRepliesWithUser(comment.getId());
```

å¯¹æ¯ä¸ªé¡¶çº§è¯„è®ºéƒ½è¦å•ç‹¬æŸ¥è¯¢å›å¤ï¼Œå¦‚æœæœ‰100ä¸ªè¯„è®ºï¼š
- 1æ¬¡æŸ¥è¯¢é¡¶çº§è¯„è®º
- 100æ¬¡æŸ¥è¯¢å›å¤
- æ€»è®¡101æ¬¡æŸ¥è¯¢

âš ï¸ **N+1é—®é¢˜**: è¯„è®ºå¤šæ—¶æ€§èƒ½ä¸‹é™

**ä¼˜åŒ–å»ºè®®**: æ‰¹é‡åŠ è½½æ‰€æœ‰å›å¤
```java
// 1æ¬¡æŸ¥è¯¢æ‰€æœ‰é¡¶çº§è¯„è®ºçš„æ‰€æœ‰å›å¤
@Query("SELECT c FROM WeeklyReportComment c LEFT JOIN FETCH c.user " +
       "WHERE c.parentCommentId IN :parentIds AND c.status = 'ACTIVE' " +
       "ORDER BY c.parentCommentId, c.createdAt ASC")
List<WeeklyReportComment> findRepliesByParentIds(@Param("parentIds") List<Long> parentIds);
```

---

### 6. ä¸šåŠ¡é€»è¾‘åˆ†æ

#### 6.1 è¯„è®ºç±»å‹è®¾è®¡

**CommentTypeæšä¸¾**:
- `COMMENT` - é¡¶çº§è¯„è®º
- `REPLY` - å›å¤

**è‡ªåŠ¨åˆ¤æ–­é€»è¾‘** (68-76è¡Œ):
```java
if (request.getParentCommentId() != null) {
    comment.setCommentType(CommentType.REPLY);
} else {
    comment.setCommentType(CommentType.COMMENT);
}
```

âœ… **è®¾è®¡åˆç†**: æ ¹æ®parentCommentIdè‡ªåŠ¨è®¾ç½®ç±»å‹

âš ï¸ **é™åˆ¶**: åªæ”¯æŒ2å±‚ï¼ˆè¯„è®ºâ†’å›å¤ï¼‰ï¼Œä¸æ”¯æŒå¤šå±‚åµŒå¥—

#### 6.2 è¯„è®ºçŠ¶æ€ç®¡ç†

**CommentStatusæšä¸¾**:
- `ACTIVE` - æ´»è·ƒ
- `DELETED` - å·²åˆ é™¤
- `HIDDEN` - éšè—

**çŠ¶æ€è½¬æ¢æ–¹æ³•** (239-249è¡Œ):
```java
public void markAsDeleted() { this.status = CommentStatus.DELETED; }
public void markAsHidden() { this.status = CommentStatus.HIDDEN; }
public void activate() { this.status = CommentStatus.ACTIVE; }
```

âœ… **è½¯åˆ é™¤æœºåˆ¶**: æ•°æ®ä¸ç‰©ç†åˆ é™¤ï¼Œä¾¿äºæ¢å¤å’Œå®¡è®¡

âš ï¸ **HIDDENçŠ¶æ€æœªä½¿ç”¨**: ä»£ç ä¸­å®šä¹‰äº†ä½†æ²¡æœ‰ä½¿ç”¨åœºæ™¯

#### 6.3 ä¸šåŠ¡è§„åˆ™

**è§„åˆ™1**: åªèƒ½å¯¹APPROVEDçŠ¶æ€çš„å‘¨æŠ¥è¯„è®º
```java
if (!commentRepository.existsApprovedWeeklyReport(request.getWeeklyReportId())) {
    throw new IllegalStateException("åªèƒ½å¯¹å®¡æ ¸é€šè¿‡çš„å‘¨æŠ¥è¿›è¡Œè¯„è®º");
}
```

âš ï¸ **è¿‡äºä¸¥æ ¼**: å®¡æ ¸è¿‡ç¨‹ä¸­å¯èƒ½éœ€è¦è¯„è®ºï¼ˆç»™å‡ºå®¡æ ¸æ„è§ï¼‰

**å»ºè®®**:
- PENDING_REVIEWçŠ¶æ€: ç®¡ç†å‘˜å¯è¯„è®ºï¼ˆå®¡æ ¸æ„è§ï¼‰
- APPROVEDçŠ¶æ€: æ‰€æœ‰äººå¯è¯„è®ºï¼ˆè®¨è®ºï¼‰
- å…¶ä»–çŠ¶æ€: ä¸å¯è¯„è®º

---

### 7. APIå®Œæ•´æ€§è¯„ä¼°

#### 7.1 CRUDæ“ä½œå®Œæ•´æ€§

| æ“ä½œ | Controller | Service | Repository | å®Œæ•´åº¦ |
|------|-----------|---------|-----------|--------|
| Create | âœ… POST | âœ… createComment | âœ… save | 100% âœ… |
| Read | âœ… GET | âœ… getComments | âœ… find* | 100% âœ… |
| Update | âŒ æ—  | âœ… updateComment | âœ… save | 67% âš ï¸ |
| Delete | âŒ æ—  | âœ… deleteComment | âœ… softDelete | 67% âš ï¸ |

**å®Œæ•´åº¦**: 83% (5/6 åŠŸèƒ½ç‚¹)

**ç¼ºå¤±åŠŸèƒ½**:
1. âŒ PUT /comments/{id} - æ›´æ–°è¯„è®ºAPI
2. âŒ DELETE /comments/{id} - åˆ é™¤è¯„è®ºAPI

**Serviceå·²å®ç°ä½†Controlleræœªæš´éœ²**

#### 7.2 é¢å¤–åŠŸèƒ½

**å·²å®ç°**:
- âœ… è·å–è¯„è®ºå›å¤: `getRepliesByCommentId`
- âœ… åˆ†é¡µæ”¯æŒ
- âœ… ç”¨æˆ·ä¿¡æ¯å…³è”
- âœ… æ ‘å½¢ç»“æ„å“åº”

**æœªå®ç°**:
- âŒ è¯„è®ºç‚¹èµ/ç‚¹è¸©
- âŒ è¯„è®º@æåŠç”¨æˆ·
- âŒ è¯„è®ºé€šçŸ¥ï¼ˆæœ‰äººå›å¤æ—¶é€šçŸ¥ï¼‰
- âŒ è¯„è®ºæœç´¢
- âŒ è¯„è®ºç»Ÿè®¡ï¼ˆæ¯ä¸ªå‘¨æŠ¥çš„è¯„è®ºæ•°ï¼‰
- âŒ è¯„è®ºæ’åºï¼ˆæŒ‰æ—¶é—´/çƒ­åº¦ï¼‰

---

### 8. å®‰å…¨æ€§åˆ†æ

#### 8.1 æƒé™æ§åˆ¶

**Controllerå±‚**: @PreAuthorizeæ³¨è§£
```java
@PreAuthorize("hasRole('ADMIN') or hasRole('SUPER_ADMIN') or hasRole('MANAGER')")
```

**Serviceå±‚**: è‡ªå®šä¹‰æƒé™éªŒè¯
```java
validateCommentPermission(weeklyReportId, currentUserId)
validateAccessPermission(weeklyReportId, currentUserId)
```

âœ… **åŒå±‚é˜²æŠ¤**: Controller + Service

#### 8.2 è¾“å…¥éªŒè¯

**å®ä½“å±‚éªŒè¯**:
```java
@NotBlank(message = "Comment content cannot be blank")
@Size(max = 5000, message = "Comment content must not exceed 5000 characters")
private String content;
```

âœ… **Bean Validation**: è‡ªåŠ¨éªŒè¯è¾“å…¥

#### 8.3 SQLæ³¨å…¥é˜²æŠ¤

æ‰€æœ‰æŸ¥è¯¢ä½¿ç”¨`@Query` + å‚æ•°ç»‘å®š:
```java
@Query("SELECT c FROM WeeklyReportComment c WHERE c.weeklyReportId = :weeklyReportId ...")
```

âœ… **ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢**: é˜²æ­¢SQLæ³¨å…¥

#### 8.4 XSSé˜²æŠ¤

âš ï¸ **ç¼ºå°‘**: è¯„è®ºå†…å®¹æœªè¿›è¡ŒHTMLè½¬ä¹‰
- ç”¨æˆ·å¯èƒ½è¾“å…¥`<script>alert('xss')</script>`
- å‰ç«¯æ˜¾ç¤ºæ—¶å¯èƒ½æ‰§è¡Œ

**å»ºè®®**:
- åç«¯å­˜å‚¨å‰è¿›è¡ŒHTMLè½¬ä¹‰
- æˆ–å‰ç«¯æ˜¾ç¤ºæ—¶ä½¿ç”¨`v-text`è€Œé`v-html`

---

### 9. æ€§èƒ½åˆ†æ

#### 9.1 æŸ¥è¯¢æ€§èƒ½

**ä¼˜ç‚¹**:
- âœ… ä½¿ç”¨ç´¢å¼•æŸ¥è¯¢
- âœ… JOIN FETCHé¢„åŠ è½½
- âœ… åˆ†é¡µæ”¯æŒ

**é—®é¢˜**:
- âš ï¸ å›å¤çš„N+1æŸ¥è¯¢ï¼ˆè§5.2èŠ‚ï¼‰
- âš ï¸ æ²¡æœ‰ç¼“å­˜æœºåˆ¶

**è´Ÿè½½æµ‹è¯•**:
- 100ä¸ªè¯„è®ºï¼Œæ¯ä¸ª10ä¸ªå›å¤
- å½“å‰: 1 + 100 = 101æ¬¡æŸ¥è¯¢
- ä¼˜åŒ–å: 1 + 1 = 2æ¬¡æŸ¥è¯¢

#### 9.2 å¹¶å‘æ€§èƒ½

**å†™æ“ä½œ**: å•ä¸ªINSERTï¼Œæ€§èƒ½è‰¯å¥½
**è¯»æ“ä½œ**: æœ‰ç´¢å¼•æ”¯æŒï¼Œæ€§èƒ½è‰¯å¥½

**æ½œåœ¨ç“¶é¢ˆ**: é«˜å¹¶å‘æŸ¥è¯¢å›å¤æ—¶çš„N+1é—®é¢˜

---

### 10. ä»£ç è´¨é‡è¯„ä¼°

#### 10.1 ä¼˜ç‚¹
- âœ… ä»£ç ç»“æ„æ¸…æ™°
- âœ… æ—¥å¿—è®°å½•å®Œå–„
- âœ… å¼‚å¸¸å¤„ç†è§„èŒƒ
- âœ… ä½¿ç”¨DTOæ¨¡å¼
- âœ… äº‹åŠ¡ç®¡ç†æ­£ç¡®
- âœ… å‘½åè§„èŒƒç»Ÿä¸€

#### 10.2 å¯æ”¹è¿›ç‚¹
- âš ï¸ æœªä½¿ç”¨çš„Repositoryæ–¹æ³•åº”åˆ é™¤
- âš ï¸ HIDDENçŠ¶æ€æœªä½¿ç”¨åº”åˆ é™¤æˆ–å®ç°
- âš ï¸ ä¸»ç®¡å…³ç³»åˆ¤æ–­ç®€åŒ–ï¼ˆæ³¨é‡Šè¯´æ˜äº†ä½†æœªå®ç°ï¼‰
- âš ï¸ ç¼ºå°‘å•å…ƒæµ‹è¯•ï¼ˆåªæœ‰SimpleCommentTestï¼‰

---

## å…³é”®å‘ç°

### ä¼˜åŠ¿
- âœ… æ¶æ„è®¾è®¡è§„èŒƒï¼ˆæ ‡å‡†ä¸‰å±‚æ¶æ„ï¼‰
- âœ… æƒé™æ§åˆ¶å®Œå–„ï¼ˆåŒå±‚é˜²æŠ¤ï¼‰
- âœ… è½¯åˆ é™¤æœºåˆ¶ï¼ˆæ•°æ®ä¸ä¸¢å¤±ï¼‰
- âœ… æ ‘å½¢ç»“æ„æ”¯æŒï¼ˆè¯„è®º+å›å¤ï¼‰
- âœ… åˆ†é¡µæŸ¥è¯¢æ”¯æŒ
- âœ… é˜²æ­¢SQLæ³¨å…¥
- âœ… æ—¥å¿—è®°å½•å®Œå–„
- âœ… ç´¢å¼•è®¾è®¡åˆç†

### é—®é¢˜
- âš ï¸ APIä¸å®Œæ•´ï¼ˆç¼ºå°‘æ›´æ–°å’Œåˆ é™¤ç«¯ç‚¹ï¼‰
- âš ï¸ 50%çš„Repositoryæ–¹æ³•æœªä½¿ç”¨ï¼ˆä»£ç å†—ä½™ï¼‰
- âš ï¸ å›å¤æŸ¥è¯¢å­˜åœ¨N+1é—®é¢˜
- âš ï¸ è¯„è®ºæƒé™è¿‡ä¸¥ï¼ˆåªèƒ½å¯¹APPROVEDå‘¨æŠ¥è¯„è®ºï¼‰
- âš ï¸ ç¼ºå°‘XSSé˜²æŠ¤
- âš ï¸ ä¸»ç®¡å…³ç³»åˆ¤æ–­æœªå®ç°
- âš ï¸ ç¼ºå°‘è¯„è®ºé€šçŸ¥åŠŸèƒ½

### é£é™©
- ğŸš¨ XSSæ”»å‡»é£é™©ï¼ˆä¸­ï¼‰- è¯„è®ºå†…å®¹æœªè½¬ä¹‰
- âš ï¸ æ€§èƒ½é£é™©ï¼ˆä½ï¼‰- N+1æŸ¥è¯¢é—®é¢˜
- ğŸŸ¢ å¹¶å‘é£é™©ï¼ˆä½ï¼‰- è¯„è®ºåŠŸèƒ½ç›¸å¯¹ç‹¬ç«‹

---

## æ”¹è¿›å»ºè®®

### é«˜ä¼˜å…ˆçº§

#### å»ºè®®1: å®Œå–„APIç«¯ç‚¹ â­â­â­â­â­
**å½±å“**: åŠŸèƒ½å®Œæ•´æ€§

**æ·»åŠ æ›´æ–°ç«¯ç‚¹**:
```java
@PutMapping("/comments/{id}")
@PreAuthorize("hasRole('ADMIN') or hasRole('SUPER_ADMIN') or hasRole('MANAGER')")
public ResponseEntity<ApiResponse<CommentResponse>> updateComment(
        @PathVariable Long id,
        @Valid @RequestBody CommentUpdateRequest request,
        Authentication authentication) {
    Long currentUserId = getCurrentUserId(authentication);
    CommentResponse response = commentService.updateComment(id, request, currentUserId);
    return ResponseEntity.ok(ApiResponse.success(response));
}
```

**æ·»åŠ åˆ é™¤ç«¯ç‚¹**:
```java
@DeleteMapping("/comments/{id}")
@PreAuthorize("hasRole('ADMIN') or hasRole('SUPER_ADMIN') or hasRole('MANAGER')")
public ResponseEntity<ApiResponse<Void>> deleteComment(
        @PathVariable Long id,
        Authentication authentication) {
    Long currentUserId = getCurrentUserId(authentication);
    commentService.deleteComment(id, currentUserId);
    return ResponseEntity.ok(ApiResponse.success());
}
```

#### å»ºè®®2: ä¿®å¤XSSæ¼æ´ â­â­â­â­
**å½±å“**: å®‰å…¨æ€§

**æ–¹æ¡ˆA**: åç«¯è½¬ä¹‰ï¼ˆæ¨èï¼‰
```java
import org.springframework.web.util.HtmlUtils;

// åœ¨createCommentå’ŒupdateCommentä¸­
comment.setContent(HtmlUtils.htmlEscape(request.getContent()));
```

**æ–¹æ¡ˆB**: å‰ç«¯é˜²æŠ¤
```vue
<!-- ä½¿ç”¨v-textè€Œév-html -->
<div v-text="comment.content"></div>
```

#### å»ºè®®3: ä¼˜åŒ–å›å¤æŸ¥è¯¢æ€§èƒ½ â­â­â­â­
**å½±å“**: æ€§èƒ½

**å½“å‰**: N+1æŸ¥è¯¢
```java
for (WeeklyReportComment comment : topLevelComments) {
    List<WeeklyReportComment> replies = commentRepository.findRepliesWithUser(comment.getId());
}
```

**ä¼˜åŒ–**: æ‰¹é‡æŸ¥è¯¢
```java
// 1. æ”¶é›†æ‰€æœ‰è¯„è®ºID
List<Long> commentIds = topLevelComments.stream().map(WeeklyReportComment::getId).collect(Collectors.toList());

// 2. ä¸€æ¬¡æŸ¥è¯¢æ‰€æœ‰å›å¤
List<WeeklyReportComment> allReplies = commentRepository.findRepliesByParentIds(commentIds);

// 3. åˆ†ç»„æ˜ å°„
Map<Long, List<WeeklyReportComment>> repliesMap = allReplies.stream()
    .collect(Collectors.groupingBy(WeeklyReportComment::getParentCommentId));
```

### ä¸­ä¼˜å…ˆçº§

#### å»ºè®®4: æ¸…ç†æœªä½¿ç”¨çš„ä»£ç  â­â­â­
**å½±å“**: ä»£ç å¯ç»´æŠ¤æ€§

**åˆ é™¤æœªä½¿ç”¨çš„Repositoryæ–¹æ³•**:
- findByWeeklyReportIdAndStatusActive
- findTopLevelCommentsByWeeklyReportId
- findRepliesByParentCommentId
- findCommentWithPermissionCheck

æˆ–è€…åœ¨Serviceä¸­ä½¿ç”¨è¿™äº›æ–¹æ³•

#### å»ºè®®5: æ”¾å®½è¯„è®ºæƒé™ â­â­â­
**å½±å“**: ç”¨æˆ·ä½“éªŒ

**å…è®¸åœ¨å®¡æ ¸é˜¶æ®µè¯„è®º**:
```java
// ç®¡ç†å‘˜å¯ä»¥åœ¨PENDING_REVIEWçŠ¶æ€è¯„è®ºï¼ˆå®¡æ ¸æ„è§ï¼‰
if (weeklyReport.getStatus() == WeeklyReport.ReportStatus.PENDING_REVIEW && currentUser.isAdmin()) {
    return;
}

// æ‰€æœ‰äººå¯ä»¥å¯¹APPROVEDå‘¨æŠ¥è¯„è®º
if (weeklyReport.getStatus() == WeeklyReport.ReportStatus.APPROVED) {
    return;
}
```

#### å»ºè®®6: æ·»åŠ è¯„è®ºç»Ÿè®¡åŠŸèƒ½ â­â­â­
**å®ç°**: åœ¨å‘¨æŠ¥åˆ—è¡¨ä¸­æ˜¾ç¤ºè¯„è®ºæ•°

```java
// æ·»åŠ åˆ°WeeklyReportDetailResponse
private int commentCount;

// åœ¨æŸ¥è¯¢å‘¨æŠ¥æ—¶å…³è”æŸ¥è¯¢è¯„è®ºæ•°
@Query("SELECT w, COUNT(c) FROM WeeklyReport w " +
       "LEFT JOIN WeeklyReportComment c ON c.weeklyReportId = w.id AND c.status = 'ACTIVE' " +
       "GROUP BY w.id")
```

### ä½ä¼˜å…ˆçº§

#### å»ºè®®7: æ·»åŠ è¯„è®ºé€šçŸ¥ â­â­
**åŠŸèƒ½**: æœ‰äººè¯„è®º/å›å¤æ—¶å‘é€é‚®ä»¶é€šçŸ¥

**å®ç°**:
1. åˆ›å»ºCommentCreatedEvent
2. å‘é€é‚®ä»¶ç»™å‘¨æŠ¥ä½œè€…ï¼ˆæœ‰äººè¯„è®ºï¼‰
3. å‘é€é‚®ä»¶ç»™è¯„è®ºè€…ï¼ˆæœ‰äººå›å¤ï¼‰

#### å»ºè®®8: å®ç°ä¸»ç®¡å…³ç³»åˆ¤æ–­ â­â­
**å½“å‰**: ç®€åŒ–ä¸ºæ‰€æœ‰MANAGERå¯è¯„è®º
**åº”è¯¥**: æ£€æŸ¥æ˜¯å¦ä¸ºå‘¨æŠ¥æäº¤è€…çš„ç›´æ¥ä¸»ç®¡

#### å»ºè®®9: æ·»åŠ è¯„è®ºç‚¹èµåŠŸèƒ½ â­
**å®ç°**: æ–°å¢comment_likesè¡¨

---

## æŠ€æœ¯å€ºåŠ¡è¯„ä¼°

| é¡¹ç›® | ä¸¥é‡ç¨‹åº¦ | å½±å“èŒƒå›´ | å»ºè®®è¡ŒåŠ¨ |
|------|---------|---------|---------|
| ç¼ºå°‘æ›´æ–°/åˆ é™¤API | ä¸­ | åŠŸèƒ½å®Œæ•´æ€§ | è¿‘æœŸæ·»åŠ  |
| XSSæ¼æ´ | é«˜ | å®‰å…¨æ€§ | ç«‹å³ä¿®å¤ |
| N+1æŸ¥è¯¢é—®é¢˜ | ä¸­ | æ€§èƒ½ | ä¸­æœŸä¼˜åŒ– |
| 50%ä»£ç æœªä½¿ç”¨ | ä½ | å¯ç»´æŠ¤æ€§ | åæœŸæ¸…ç† |
| è¯„è®ºæƒé™è¿‡ä¸¥ | ä¸­ | ç”¨æˆ·ä½“éªŒ | è¿‘æœŸè°ƒæ•´ |
| ç¼ºå°‘è¯„è®ºé€šçŸ¥ | ä½ | ç”¨æˆ·ä½“éªŒ | åæœŸæ·»åŠ  |
| ä¸»ç®¡å…³ç³»æœªå®ç° | ä½ | ä¸šåŠ¡å‡†ç¡®æ€§ | åæœŸå®Œå–„ |

---

## æ¶æ„è§†å›¾

### è¯„è®ºæ¨¡å—æ•°æ®æµ

```
ç”¨æˆ·è¯·æ±‚
  â†“
CommentController (@PreAuthorize)
  â†“
WeeklyReportCommentService
  â”œâ”€ validateCommentPermission (æƒé™éªŒè¯)
  â”œâ”€ validateAccessPermission (è®¿é—®éªŒè¯)
  â””â”€ isCurrentUserSuperAdmin (è§’è‰²æ£€æŸ¥)
  â†“
WeeklyReportCommentRepository
  â”œâ”€ JPQLæŸ¥è¯¢ï¼ˆå¸¦JOIN FETCHï¼‰
  â””â”€ ç´¢å¼•ä¼˜åŒ–
  â†“
æ•°æ®åº“ (weekly_report_commentsè¡¨)
```

### è¯„è®ºå…³ç³»æ¨¡å‹

```
WeeklyReport (1) â†â”€â”€â†’ (*) WeeklyReportComment
                            â†“
                       parent_comment_id (è‡ªå…³è”)
                            â†“
                       Comment (1) â†â”€â”€â†’ (*) Reply
```

---

## æ€§èƒ½æŒ‡æ ‡

### å½“å‰æ€§èƒ½ï¼ˆä¼°ç®—ï¼‰

| æ“ä½œ | æ•°æ®é‡ | æŸ¥è¯¢æ¬¡æ•° | é¢„è®¡è€—æ—¶ |
|------|-------|---------|---------|
| è·å–10ä¸ªè¯„è®º(æ— å›å¤) | 10 | 1æ¬¡ | <50ms |
| è·å–10ä¸ªè¯„è®º(å„10å›å¤) | 110 | 11æ¬¡ | ~100ms |
| è·å–100ä¸ªè¯„è®º(å„10å›å¤) | 1100 | 101æ¬¡ | ~1s |
| åˆ›å»ºè¯„è®º | 1 | 3-4æ¬¡ | <100ms |
| åˆ é™¤è¯„è®º | 1 | 2æ¬¡ | <50ms |

### ä¼˜åŒ–åæ€§èƒ½ï¼ˆæ‰¹é‡æŸ¥è¯¢ï¼‰

| æ“ä½œ | æŸ¥è¯¢æ¬¡æ•°ä¼˜åŒ– | é¢„è®¡è€—æ—¶ä¼˜åŒ– |
|------|------------|------------|
| è·å–100ä¸ªè¯„è®º(å„10å›å¤) | 101æ¬¡ â†’ 2æ¬¡ | ~1s â†’ <200ms |

---

## å­¦ä¹ è¦ç‚¹

### å…³é”®æŠ€æœ¯æ¦‚å¿µ

1. **è½¯åˆ é™¤æ¨¡å¼**
   - ä¸ç‰©ç†åˆ é™¤æ•°æ®
   - ä½¿ç”¨çŠ¶æ€æ ‡è®°
   - ä¾¿äºæ•°æ®æ¢å¤å’Œå®¡è®¡

2. **æ ‘å½¢æ•°æ®ç»“æ„**
   - è‡ªå…³è”è¡¨è®¾è®¡
   - parent_idæ¨¡å¼
   - æ”¯æŒè¯„è®ºå›å¤

3. **N+1æŸ¥è¯¢é—®é¢˜**
   - å¾ªç¯ä¸­æ‰§è¡ŒæŸ¥è¯¢å¯¼è‡´
   - ä½¿ç”¨JOIN FETCHæˆ–æ‰¹é‡æŸ¥è¯¢è§£å†³
   - æ€§èƒ½å½±å“æ˜¾è‘—

4. **æƒé™æ§åˆ¶å±‚æ¬¡**
   - Controllerå±‚: @PreAuthorize
   - Serviceå±‚: ä¸šåŠ¡é€»è¾‘éªŒè¯
   - åŒå±‚é˜²æŠ¤æ›´å®‰å…¨

---

## å‚è€ƒèµ„æº

- [Spring Data JPAæ–‡æ¡£](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/)
- [é˜²æ­¢N+1æŸ¥è¯¢æœ€ä½³å®è·µ](https://vladmihalcea.com/n-plus-1-query-problem/)
- [è½¯åˆ é™¤æ¨¡å¼](https://www.martinfowler.com/eaaCatalog/softDelete.html)
- [XSSé˜²æŠ¤æŒ‡å—](https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html)

---

**åˆ†æå®Œæˆæ—¶é—´**: 2025-10-20 15:10:00
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åŠŸèƒ½å®Œæ•´åº¦**: 83%
**ä»£ç è´¨é‡**: è‰¯å¥½
**å®‰å…¨é£é™©**: ä¸­ï¼ˆXSSï¼‰
**æ€§èƒ½é£é™©**: ä½
