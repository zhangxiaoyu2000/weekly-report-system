# å‘¨æŠ¥è‰ç¨¿ä¸å®¡æ ¸æµç¨‹åˆ†ç¦»è®¾è®¡åˆ†æ

**åˆ†ææ—¥æœŸ**: 2025-01-16
**é—®é¢˜æ ¸å¿ƒ**: è‰ç¨¿çŠ¶æ€ä¸åº”æ··å…¥å®¡æ ¸æµç¨‹ï¼Œéœ€ä½œä¸ºç‹¬ç«‹çŠ¶æ€å­˜åœ¨
**è®¾è®¡åŸåˆ™**: æ¸…æ™°åˆ†ç¦»è‰ç¨¿ç¼–è¾‘é˜¶æ®µä¸å®¡æ ¸æµç¨‹é˜¶æ®µ

---

## 1. å½“å‰è®¾è®¡çš„æ ¹æœ¬é—®é¢˜

### 1.1 çŠ¶æ€æ··æ·†

**å½“å‰ApprovalStatusæšä¸¾** (`WeeklyReport.java` ç¬¬92-98è¡Œ):
```java
// å®¡æ‰¹çŠ¶æ€æšä¸¾ (AIåˆ†æâ†’ç®¡ç†å‘˜å®¡æ ¸â†’å®Œæˆï¼Œæ— è‰ç¨¿çŠ¶æ€)
public enum ApprovalStatus {
    AI_ANALYZING,           // AIåˆ†æä¸­ï¼ˆåˆ›å»ºåçš„åˆå§‹çŠ¶æ€ï¼‰
    AI_REJECTED,            // AIåˆ†æä¸é€šè¿‡
    ADMIN_REVIEWING,        // ç®¡ç†å‘˜å®¡æ ¸ä¸­ (AIé€šè¿‡åçš„çŠ¶æ€)
    ADMIN_APPROVED,         // ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡ï¼Œæœ€ç»ˆçŠ¶æ€
    ADMIN_REJECTED          // ç®¡ç†å‘˜å®¡æ ¸ä¸é€šè¿‡
}
```

**æ ¸å¿ƒé—®é¢˜**:
- âŒ **ApprovalStatus** åº”è¯¥åªæè¿°"å®¡æ ¸æµç¨‹"çš„çŠ¶æ€
- âŒ **AI_ANALYZING** ä¸æ˜¯å®¡æ ¸çŠ¶æ€ï¼Œè€Œæ˜¯å¤„ç†çŠ¶æ€
- âŒ **è‰ç¨¿** æ ¹æœ¬ä¸æ˜¯å®¡æ ¸çŠ¶æ€ï¼Œè€Œæ˜¯ç¼–è¾‘çŠ¶æ€
- âŒ å°†ä¸‰ä¸ªä¸åŒæ€§è´¨çš„çŠ¶æ€ï¼ˆç¼–è¾‘ã€å¤„ç†ã€å®¡æ ¸ï¼‰æ··åœ¨ä¸€ä¸ªæšä¸¾ä¸­

### 1.2 è¯­ä¹‰å†²çª

**ç°æœ‰ä»£ç çš„æ··ä¹±è¯­ä¹‰** (`WeeklyReport.java` ç¬¬336-345è¡Œ):
```java
public boolean isDraft() {
    // ç”±äºæ²¡æœ‰DRAFTçŠ¶æ€ï¼Œå‘¨æŠ¥åˆ›å»ºåç›´æ¥è¿›å…¥AIåˆ†æ
    // å¯ä»¥è®¤ä¸ºAI_ANALYZINGçŠ¶æ€ç±»ä¼¼è‰ç¨¿ï¼Œç”¨æˆ·ä»å¯ä¿®æ”¹
    return approvalStatus == ApprovalStatus.AI_ANALYZING;
}

public boolean isSubmitted() {
    // å·²è¿›å…¥å®¡æ ¸æµç¨‹ï¼ˆAIåˆ†æä¸­æˆ–ä¹‹åçš„ä»»ä½•çŠ¶æ€ï¼‰
    return true; // åˆ›å»ºåå³è®¤ä¸ºå·²æäº¤
}
```

**é—®é¢˜åˆ†æ**:
- `isDraft()` æ–¹æ³•åæš—ç¤º"æ˜¯è‰ç¨¿"ï¼Œä½†æ£€æŸ¥çš„æ˜¯ `AI_ANALYZING` çŠ¶æ€
- `isSubmitted()` æ°¸è¿œè¿”å› `true`ï¼Œæ„å‘³ç€"åˆ›å»º=æäº¤"ï¼Œè¿™ä¸ç¬¦åˆè‰ç¨¿æ¦‚å¿µ
- æ³¨é‡Šæ‰¿è®¤"ç”±äºæ²¡æœ‰DRAFTçŠ¶æ€"ï¼Œè¯´æ˜è®¾è®¡æœ¬èº«æœ‰ç¼ºé™·

---

## 2. æ­£ç¡®çš„çŠ¶æ€åˆ†å±‚è®¾è®¡

### 2.1 ä¸‰å±‚çŠ¶æ€æ¨¡å‹

å‘¨æŠ¥åº”è¯¥æœ‰**ä¸‰ä¸ªç‹¬ç«‹çš„çŠ¶æ€ç»´åº¦**ï¼š

#### å±‚æ¬¡1: ç¼–è¾‘çŠ¶æ€ (EditStatus) - ç”¨æˆ·è§†è§’
```java
public enum EditStatus {
    DRAFT,              // è‰ç¨¿ï¼šç”¨æˆ·æ­£åœ¨ç¼–è¾‘ï¼Œæœªæäº¤å®¡æ ¸
    SUBMITTED           // å·²æäº¤ï¼šç”¨æˆ·å®Œæˆç¼–è¾‘ï¼Œè¿›å…¥å®¡æ ¸æµç¨‹
}
```

**ç”¨é€”**:
- åŒºåˆ†"ç”¨æˆ·è¿˜åœ¨å†™"å’Œ"ç”¨æˆ·å†™å®Œäº†"
- å†³å®šæ˜¯å¦å…è®¸ç¼–è¾‘å’Œåˆ é™¤
- å‰ç«¯æ˜¾ç¤º"ä¿å­˜è‰ç¨¿"æˆ–"å·²æäº¤"æ ‡ç­¾

#### å±‚æ¬¡2: å¤„ç†çŠ¶æ€ (ProcessingStatus) - ç³»ç»Ÿè§†è§’
```java
public enum ProcessingStatus {
    PENDING,            // å¾…å¤„ç†ï¼šç­‰å¾…AIåˆ†æ
    AI_PROCESSING,      // AIå¤„ç†ä¸­ï¼šæ­£åœ¨è¿›è¡ŒAIåˆ†æ
    AI_COMPLETED,       // AIå®Œæˆï¼šåˆ†æå®Œæˆï¼Œå¾…å®¡æ ¸
    AI_FAILED           // AIå¤±è´¥ï¼šåˆ†æå‡ºé”™
}
```

**ç”¨é€”**:
- è¿½è¸ªAIåˆ†æè¿›åº¦
- å†³å®šæ˜¯å¦éœ€è¦é‡è¯•AIåˆ†æ
- ç³»ç»Ÿç›‘æ§å’Œå‘Šè­¦

#### å±‚æ¬¡3: å®¡æ ¸çŠ¶æ€ (ApprovalStatus) - ç®¡ç†å‘˜è§†è§’
```java
public enum ApprovalStatus {
    NOT_STARTED,        // æœªå¼€å§‹ï¼šå°šæœªè¿›å…¥å®¡æ ¸æµç¨‹
    PENDING_REVIEW,     // å¾…å®¡æ ¸ï¼šç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸
    APPROVED,           // å·²é€šè¿‡ï¼šå®¡æ ¸é€šè¿‡
    REJECTED            // å·²æ‹’ç»ï¼šå®¡æ ¸ä¸é€šè¿‡
}
```

**ç”¨é€”**:
- ç®¡ç†å‘˜å·¥ä½œæµç®¡ç†
- å®¡æ ¸å†å²è®°å½•
- æƒé™æ§åˆ¶ï¼ˆåªæœ‰ç®¡ç†å‘˜èƒ½å®¡æ ¸ï¼‰

### 2.2 çŠ¶æ€è½¬æ¢å…³ç³»

```
ç”¨æˆ·æ“ä½œ             ç³»ç»ŸçŠ¶æ€å˜åŒ–

åˆ›å»ºå‘¨æŠ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º EditStatus = DRAFT
 â”‚                   ProcessingStatus = PENDING (ä¸å¯åŠ¨)
 â”‚                   ApprovalStatus = NOT_STARTED
 â”‚
 â”‚ ç”¨æˆ·ç¼–è¾‘ä¿®æ”¹
 â”‚ (å…è®¸åå¤ä¿å­˜)
 â”‚
 â–¼
æäº¤å®¡æ ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º EditStatus = SUBMITTED (é”å®šç¼–è¾‘)
 â”‚                   ProcessingStatus = AI_PROCESSING (å¯åŠ¨AI)
 â”‚                   ApprovalStatus = NOT_STARTED
 â”‚
 â–¼
AIåˆ†æå®Œæˆ â”€â”€â”€â”€â”€â”€â”€â”€â–º EditStatus = SUBMITTED
 â”‚                   ProcessingStatus = AI_COMPLETED
 â”‚                   ApprovalStatus = PENDING_REVIEW
 â”‚
 â–¼
ç®¡ç†å‘˜å®¡æ ¸ â”€â”€â”€â”€â”€â”€â”€â”€â–º EditStatus = SUBMITTED
                     ProcessingStatus = AI_COMPLETED
                     ApprovalStatus = APPROVED / REJECTED

å¦‚æœè¢«æ‹’ç»:
ç®¡ç†å‘˜æ‹’ç» â”€â”€â”€â”€â”€â”€â”€â”€â–º EditStatus = DRAFT (è§£é”ç¼–è¾‘)
                     ProcessingStatus = PENDING
                     ApprovalStatus = REJECTED
                     (å…è®¸ç”¨æˆ·ä¿®æ”¹åé‡æ–°æäº¤)
```

---

## 3. ç°æœ‰è®¾è®¡å¯¼è‡´çš„å…·ä½“é—®é¢˜

### 3.1 ç”¨æˆ·ä½“éªŒé—®é¢˜

**åœºæ™¯1: ç”¨æˆ·åˆ›å»ºæœªå®Œæˆçš„å‘¨æŠ¥**
```
ç°çŠ¶:
1. ç”¨æˆ·ç‚¹å‡»"åˆ›å»ºå‘¨æŠ¥"
2. å¡«å†™ä¸€åŠå†…å®¹ï¼Œæƒ³ç¨åç»§ç»­
3. ç‚¹å‡»"ä¿å­˜"
4. ç³»ç»Ÿç«‹å³è®¾ç½® ApprovalStatus = AI_ANALYZING
5. ç«‹å³è§¦å‘AIåˆ†æï¼ˆè§ WeeklyReportService.java ç¬¬157-166è¡Œï¼‰
6. ç”¨æˆ·æ”¶åˆ°"AIåˆ†æç½®ä¿¡åº¦ä½"çš„æ‹’ç»é€šçŸ¥

é—®é¢˜:
- ç”¨æˆ·åªæ˜¯æƒ³ä¿å­˜è‰ç¨¿ï¼Œä¸æ˜¯æäº¤å®¡æ ¸
- æµªè´¹AIåˆ†æèµ„æº
- ç»™ç”¨æˆ·å¸¦æ¥å›°æ‰°ï¼ˆ"æˆ‘è¿˜æ²¡å†™å®Œï¼Œä¸ºä»€ä¹ˆå°±è¢«æ‹’ç»äº†ï¼Ÿ"ï¼‰
```

**åœºæ™¯2: ç”¨æˆ·æ— æ³•åŒºåˆ†"è‰ç¨¿"å’Œ"å·²æäº¤"**
```
ç°çŠ¶:
- isSubmitted() æ°¸è¿œè¿”å› true
- å‰ç«¯æ— æ³•åŒºåˆ†ç”¨æˆ·æ˜¯å¦çœŸæ­£æäº¤
- è‰ç¨¿åˆ—è¡¨å’Œå·²æäº¤åˆ—è¡¨æ— æ³•åˆ†å¼€

é—®é¢˜:
- ç”¨æˆ·æ— æ³•ç®¡ç†è‡ªå·±çš„è‰ç¨¿
- æ— æ³•æ‰¹é‡åˆ é™¤è‰ç¨¿
- æ— æ³•çœ‹åˆ°"æˆ‘æœ‰3ä»½è‰ç¨¿æœªå®Œæˆ"çš„æç¤º
```

### 3.2 ç³»ç»Ÿæ¶æ„é—®é¢˜

**é—®é¢˜1: å®¡æ ¸çŠ¶æ€è¢«æ±¡æŸ“**
```java
// ApprovalStatus åº”è¯¥åªåŒ…å«å®¡æ ¸ç›¸å…³çŠ¶æ€
// ä½†ç°åœ¨æ··å…¥äº†å¤„ç†çŠ¶æ€ (AI_ANALYZING)

// âŒ é”™è¯¯çš„å‘½åå’Œæ··ç”¨
public enum ApprovalStatus {
    AI_ANALYZING,      // è¿™ä¸æ˜¯å®¡æ ¸çŠ¶æ€ï¼è¿™æ˜¯å¤„ç†çŠ¶æ€ï¼
    AI_REJECTED,       // è¿™ä¹Ÿä¸æ˜¯å®¡æ ¸çŠ¶æ€ï¼AIä¸æ˜¯å®¡æ ¸äººï¼
    ADMIN_REVIEWING,   // è¿™æ‰æ˜¯å®¡æ ¸çŠ¶æ€
    ADMIN_APPROVED,
    ADMIN_REJECTED
}
```

**é—®é¢˜2: ä¸šåŠ¡é€»è¾‘æ··ä¹±**
```java
// WeeklyReportService.java ç¬¬157-166è¡Œ
if (weeklyReport.getApprovalStatus() == WeeklyReport.ApprovalStatus.AI_ANALYZING) {
    triggerAIAnalysis(weeklyReport);
}

// âŒ å®¡æ ¸çŠ¶æ€ä¸åº”è¯¥å†³å®šæ˜¯å¦è§¦å‘AIåˆ†æ
// âœ… åº”è¯¥ç”± EditStatus = SUBMITTED è§¦å‘
```

**é—®é¢˜3: æ— æ³•æ­£ç¡®ç»Ÿè®¡å’ŒæŸ¥è¯¢**
```sql
-- ç®¡ç†å‘˜æƒ³æŸ¥è¯¢"å¾…æˆ‘å®¡æ ¸çš„å‘¨æŠ¥"
SELECT * FROM weekly_reports
WHERE approval_status = 'ADMIN_REVIEWING';

-- ä½†å®é™…ä¸Šè¿˜æœ‰ AI_ANALYZING å’Œ AI_REJECTED çš„å‘¨æŠ¥å¯èƒ½ä¹Ÿéœ€è¦äººå·¥ä»‹å…¥
-- æŸ¥è¯¢é€»è¾‘å˜å¾—å¤æ‚å’Œæ··ä¹±
```

---

## 4. æ­£ç¡®çš„å®ä½“è®¾è®¡

### 4.1 WeeklyReportå®ä½“ä¿®æ”¹æ–¹æ¡ˆ

```java
@Entity
@Table(name = "weekly_reports")
public class WeeklyReport {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    // ============= çŠ¶æ€å­—æ®µï¼ˆä¸‰å±‚ç‹¬ç«‹ç®¡ç†ï¼‰=============

    /**
     * ç¼–è¾‘çŠ¶æ€ - ç”¨æˆ·è§†è§’
     * å†³å®šç”¨æˆ·æ˜¯å¦å¯ä»¥ç¼–è¾‘å’Œåˆ é™¤
     */
    @Enumerated(EnumType.STRING)
    @Column(name = "edit_status", nullable = false, length = 20)
    private EditStatus editStatus = EditStatus.DRAFT;

    /**
     * å¤„ç†çŠ¶æ€ - ç³»ç»Ÿè§†è§’
     * è¿½è¸ªAIåˆ†æè¿›åº¦
     */
    @Enumerated(EnumType.STRING)
    @Column(name = "processing_status", nullable = false, length = 30)
    private ProcessingStatus processingStatus = ProcessingStatus.PENDING;

    /**
     * å®¡æ ¸çŠ¶æ€ - ç®¡ç†å‘˜è§†è§’
     * ç®¡ç†å‘˜å®¡æ ¸æµç¨‹ç®¡ç†
     */
    @Enumerated(EnumType.STRING)
    @Column(name = "approval_status", nullable = false, length = 20)
    private ApprovalStatus approvalStatus = ApprovalStatus.NOT_STARTED;

    // ============= çŠ¶æ€æšä¸¾å®šä¹‰ =============

    /**
     * ç¼–è¾‘çŠ¶æ€æšä¸¾
     */
    public enum EditStatus {
        DRAFT("è‰ç¨¿"),
        SUBMITTED("å·²æäº¤");

        private final String description;
        EditStatus(String description) {
            this.description = description;
        }
        public String getDescription() {
            return description;
        }
    }

    /**
     * å¤„ç†çŠ¶æ€æšä¸¾
     */
    public enum ProcessingStatus {
        PENDING("å¾…å¤„ç†"),
        AI_PROCESSING("AIåˆ†æä¸­"),
        AI_COMPLETED("AIåˆ†æå®Œæˆ"),
        AI_FAILED("AIåˆ†æå¤±è´¥");

        private final String description;
        ProcessingStatus(String description) {
            this.description = description;
        }
        public String getDescription() {
            return description;
        }
    }

    /**
     * å®¡æ ¸çŠ¶æ€æšä¸¾
     */
    public enum ApprovalStatus {
        NOT_STARTED("æœªå¼€å§‹å®¡æ ¸"),
        PENDING_REVIEW("å¾…å®¡æ ¸"),
        APPROVED("å®¡æ ¸é€šè¿‡"),
        REJECTED("å®¡æ ¸æ‹’ç»");

        private final String description;
        ApprovalStatus(String description) {
            this.description = description;
        }
        public String getDescription() {
            return description;
        }
    }

    // ============= è¯­ä¹‰æ¸…æ™°çš„è¾…åŠ©æ–¹æ³• =============

    /**
     * æ˜¯å¦ä¸ºè‰ç¨¿çŠ¶æ€ï¼ˆç”¨æˆ·å¯ä»¥ç¼–è¾‘ï¼‰
     */
    public boolean isDraft() {
        return editStatus == EditStatus.DRAFT;
    }

    /**
     * æ˜¯å¦å·²æäº¤å®¡æ ¸
     */
    public boolean isSubmitted() {
        return editStatus == EditStatus.SUBMITTED;
    }

    /**
     * æ˜¯å¦å¯ä»¥ç¼–è¾‘ï¼ˆè‰ç¨¿çŠ¶æ€æˆ–è¢«æ‹’ç»åé‡æ–°æ‰“å¼€ï¼‰
     */
    public boolean isEditable() {
        return editStatus == EditStatus.DRAFT;
    }

    /**
     * æ˜¯å¦æ­£åœ¨AIå¤„ç†ä¸­
     */
    public boolean isAIProcessing() {
        return processingStatus == ProcessingStatus.AI_PROCESSING;
    }

    /**
     * æ˜¯å¦å·²å®ŒæˆAIåˆ†æ
     */
    public boolean isAICompleted() {
        return processingStatus == ProcessingStatus.AI_COMPLETED;
    }

    /**
     * æ˜¯å¦å¾…ç®¡ç†å‘˜å®¡æ ¸
     */
    public boolean isPendingReview() {
        return approvalStatus == ApprovalStatus.PENDING_REVIEW;
    }

    /**
     * æ˜¯å¦å·²å®¡æ ¸é€šè¿‡
     */
    public boolean isApproved() {
        return approvalStatus == ApprovalStatus.APPROVED;
    }

    /**
     * æ˜¯å¦å·²è¢«æ‹’ç»
     */
    public boolean isRejected() {
        return approvalStatus == ApprovalStatus.REJECTED;
    }

    // ============= çŠ¶æ€è½¬æ¢æ–¹æ³• =============

    /**
     * æäº¤å‘¨æŠ¥è¿›è¡Œå®¡æ ¸
     * åªèƒ½ä»è‰ç¨¿çŠ¶æ€æäº¤
     */
    public void submit() {
        if (editStatus != EditStatus.DRAFT) {
            throw new IllegalStateException(
                String.format("åªèƒ½æäº¤è‰ç¨¿çŠ¶æ€çš„å‘¨æŠ¥ï¼Œå½“å‰çŠ¶æ€: %s", editStatus)
            );
        }
        this.editStatus = EditStatus.SUBMITTED;
        this.processingStatus = ProcessingStatus.AI_PROCESSING;
        this.approvalStatus = ApprovalStatus.NOT_STARTED;
    }

    /**
     * AIåˆ†æå®Œæˆ
     * @param confidence AIç½®ä¿¡åº¦
     * @param threshold ç½®ä¿¡åº¦é˜ˆå€¼
     */
    public void completeAIAnalysis(double confidence, double threshold) {
        if (processingStatus != ProcessingStatus.AI_PROCESSING) {
            throw new IllegalStateException(
                String.format("åªèƒ½å®ŒæˆAIå¤„ç†ä¸­çš„å‘¨æŠ¥ï¼Œå½“å‰çŠ¶æ€: %s", processingStatus)
            );
        }

        this.processingStatus = ProcessingStatus.AI_COMPLETED;

        // æ ¹æ®ç½®ä¿¡åº¦å†³å®šæ˜¯å¦è¿›å…¥äººå·¥å®¡æ ¸
        if (confidence >= threshold) {
            this.approvalStatus = ApprovalStatus.PENDING_REVIEW;
        } else {
            // ç½®ä¿¡åº¦ä¸è¶³ï¼Œæ‰“å›è‰ç¨¿
            this.editStatus = EditStatus.DRAFT;
            this.approvalStatus = ApprovalStatus.NOT_STARTED;
        }
    }

    /**
     * ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡
     * @param reviewerId å®¡æ ¸äººID
     */
    public void adminApprove(Long reviewerId) {
        if (approvalStatus != ApprovalStatus.PENDING_REVIEW) {
            throw new IllegalStateException(
                String.format("åªèƒ½å®¡æ ¸å¾…å®¡æ ¸çŠ¶æ€çš„å‘¨æŠ¥ï¼Œå½“å‰çŠ¶æ€: %s", approvalStatus)
            );
        }
        this.approvalStatus = ApprovalStatus.APPROVED;
        this.adminReviewerId = reviewerId;
    }

    /**
     * ç®¡ç†å‘˜å®¡æ ¸æ‹’ç»
     * @param reviewerId å®¡æ ¸äººID
     * @param reason æ‹’ç»åŸå› 
     */
    public void adminReject(Long reviewerId, String reason) {
        if (approvalStatus != ApprovalStatus.PENDING_REVIEW) {
            throw new IllegalStateException(
                String.format("åªèƒ½å®¡æ ¸å¾…å®¡æ ¸çŠ¶æ€çš„å‘¨æŠ¥ï¼Œå½“å‰çŠ¶æ€: %s", approvalStatus)
            );
        }
        this.approvalStatus = ApprovalStatus.REJECTED;
        this.editStatus = EditStatus.DRAFT; // è§£é”ç¼–è¾‘
        this.processingStatus = ProcessingStatus.PENDING; // é‡ç½®å¤„ç†çŠ¶æ€
        this.adminReviewerId = reviewerId;
        this.rejectionReason = reason;
    }

    /**
     * AIåˆ†æå¤±è´¥
     */
    public void markAIFailed() {
        this.processingStatus = ProcessingStatus.AI_FAILED;
        // AIå¤±è´¥åï¼Œæ‰“å›è‰ç¨¿è®©ç”¨æˆ·ä¿®æ”¹
        this.editStatus = EditStatus.DRAFT;
        this.approvalStatus = ApprovalStatus.NOT_STARTED;
    }
}
```

### 4.2 æ•°æ®åº“è¿ç§»SQL

```sql
-- V35__Separate_Draft_From_Approval_Status.sql

-- 1. æ·»åŠ æ–°çš„çŠ¶æ€å­—æ®µ
ALTER TABLE weekly_reports
ADD COLUMN edit_status VARCHAR(20) DEFAULT 'DRAFT' COMMENT 'ç¼–è¾‘çŠ¶æ€: DRAFT-è‰ç¨¿, SUBMITTED-å·²æäº¤',
ADD COLUMN processing_status VARCHAR(30) DEFAULT 'PENDING' COMMENT 'å¤„ç†çŠ¶æ€: PENDING-å¾…å¤„ç†, AI_PROCESSING-AIå¤„ç†ä¸­, AI_COMPLETED-AIå®Œæˆ, AI_FAILED-AIå¤±è´¥';

-- 2. æ•°æ®è¿ç§»ï¼šæ ¹æ®æ—§çš„ approval_status æ¨æ–­æ–°çŠ¶æ€
UPDATE weekly_reports
SET
    edit_status = CASE
        WHEN approval_status IN ('AI_ANALYZING', 'AI_REJECTED') THEN 'DRAFT'
        ELSE 'SUBMITTED'
    END,
    processing_status = CASE
        WHEN approval_status = 'AI_ANALYZING' THEN 'AI_PROCESSING'
        WHEN approval_status IN ('AI_REJECTED', 'ADMIN_REVIEWING', 'ADMIN_APPROVED', 'ADMIN_REJECTED') THEN 'AI_COMPLETED'
        ELSE 'PENDING'
    END;

-- 3. ä¿®æ”¹ approval_status çš„æšä¸¾å€¼
-- æ³¨æ„ï¼šMySQL 8.0 ä¸æ”¯æŒç›´æ¥ä¿®æ”¹ ENUMï¼Œéœ€è¦å…ˆè½¬ä¸º VARCHARï¼Œå†è½¬å› ENUM
ALTER TABLE weekly_reports
MODIFY COLUMN approval_status VARCHAR(20) NOT NULL;

UPDATE weekly_reports
SET approval_status = CASE
    WHEN approval_status = 'AI_ANALYZING' THEN 'NOT_STARTED'
    WHEN approval_status = 'AI_REJECTED' THEN 'NOT_STARTED'
    WHEN approval_status = 'ADMIN_REVIEWING' THEN 'PENDING_REVIEW'
    WHEN approval_status = 'ADMIN_APPROVED' THEN 'APPROVED'
    WHEN approval_status = 'ADMIN_REJECTED' THEN 'REJECTED'
    ELSE 'NOT_STARTED'
END;

ALTER TABLE weekly_reports
MODIFY COLUMN approval_status ENUM('NOT_STARTED', 'PENDING_REVIEW', 'APPROVED', 'REJECTED')
NOT NULL DEFAULT 'NOT_STARTED'
COMMENT 'å®¡æ ¸çŠ¶æ€: NOT_STARTED-æœªå¼€å§‹, PENDING_REVIEW-å¾…å®¡æ ¸, APPROVED-å·²é€šè¿‡, REJECTED-å·²æ‹’ç»';

-- 4. è®¾ç½®å­—æ®µä¸ºéç©ºï¼ˆå·²æœ‰é»˜è®¤å€¼ï¼‰
ALTER TABLE weekly_reports
MODIFY COLUMN edit_status VARCHAR(20) NOT NULL DEFAULT 'DRAFT',
MODIFY COLUMN processing_status VARCHAR(30) NOT NULL DEFAULT 'PENDING';

-- 5. åˆ›å»ºç´¢å¼•åŠ é€ŸæŸ¥è¯¢
CREATE INDEX idx_edit_status ON weekly_reports(edit_status);
CREATE INDEX idx_processing_status ON weekly_reports(processing_status);
CREATE INDEX idx_approval_status ON weekly_reports(approval_status);

-- 6. åˆ›å»ºç»„åˆç´¢å¼•æ”¯æŒå¸¸è§æŸ¥è¯¢åœºæ™¯
CREATE INDEX idx_user_edit_status ON weekly_reports(user_id, edit_status);
CREATE INDEX idx_approval_processing ON weekly_reports(approval_status, processing_status);
```

---

## 5. æœåŠ¡å±‚é€»è¾‘æ”¹è¿›

### 5.1 åˆ›å»ºå‘¨æŠ¥ï¼ˆä¿å­˜è‰ç¨¿ï¼‰

```java
// WeeklyReportService.java

/**
 * åˆ›å»ºå‘¨æŠ¥è‰ç¨¿
 * æ³¨æ„ï¼šæ­¤æ–¹æ³•ä»…åˆ›å»ºè‰ç¨¿ï¼Œä¸è§¦å‘ä»»ä½•å®¡æ ¸æµç¨‹
 */
@Transactional
public WeeklyReportResponse createDraft(WeeklyReportCreateRequest request) {
    User currentUser = getCurrentUser();
    validateCreatePermission(currentUser, request);

    WeeklyReport weeklyReport = new WeeklyReport();
    // ... è®¾ç½®å„ç§å±æ€§ ...

    // æ˜ç¡®è®¾ç½®ä¸ºè‰ç¨¿çŠ¶æ€
    weeklyReport.setEditStatus(WeeklyReport.EditStatus.DRAFT);
    weeklyReport.setProcessingStatus(WeeklyReport.ProcessingStatus.PENDING);
    weeklyReport.setApprovalStatus(WeeklyReport.ApprovalStatus.NOT_STARTED);

    processTaskReports(weeklyReport, request);
    WeeklyReport savedReport = weeklyReportRepository.save(weeklyReport);

    logger.info("âœ… å‘¨æŠ¥è‰ç¨¿å·²åˆ›å»ºï¼Œå‘¨æŠ¥ID: {}, ç”¨æˆ·ID: {}",
        savedReport.getId(), currentUser.getId());

    // âš ï¸ ä¸è§¦å‘AIåˆ†æ
    return convertToResponse(savedReport);
}

/**
 * æ›´æ–°å‘¨æŠ¥è‰ç¨¿
 * åªèƒ½æ›´æ–°è‰ç¨¿çŠ¶æ€çš„å‘¨æŠ¥
 */
@Transactional
public WeeklyReportResponse updateDraft(Long reportId, WeeklyReportUpdateRequest request) {
    WeeklyReport report = weeklyReportRepository.findById(reportId)
        .orElseThrow(() -> new RuntimeException("å‘¨æŠ¥ä¸å­˜åœ¨: " + reportId));

    // æƒé™æ£€æŸ¥
    User currentUser = getCurrentUser();
    if (!report.getUserId().equals(currentUser.getId())) {
        throw new RuntimeException("æ— æƒä¿®æ”¹ä»–äººçš„å‘¨æŠ¥");
    }

    // çŠ¶æ€æ£€æŸ¥ï¼šåªèƒ½ä¿®æ”¹è‰ç¨¿
    if (!report.isDraft()) {
        throw new IllegalStateException(
            String.format("åªèƒ½ä¿®æ”¹è‰ç¨¿çŠ¶æ€çš„å‘¨æŠ¥ï¼Œå½“å‰çŠ¶æ€: %s", report.getEditStatus())
        );
    }

    // æ›´æ–°å†…å®¹
    updateReportContent(report, request);

    WeeklyReport savedReport = weeklyReportRepository.save(report);
    logger.info("âœ… å‘¨æŠ¥è‰ç¨¿å·²æ›´æ–°ï¼Œå‘¨æŠ¥ID: {}", reportId);

    return convertToResponse(savedReport);
}

/**
 * æäº¤å‘¨æŠ¥è¿›è¡Œå®¡æ ¸
 * è¿™æ˜¯è§¦å‘AIåˆ†æçš„å”¯ä¸€å…¥å£
 */
@Transactional
public WeeklyReportResponse submitForReview(Long reportId) {
    WeeklyReport report = weeklyReportRepository.findById(reportId)
        .orElseThrow(() -> new RuntimeException("å‘¨æŠ¥ä¸å­˜åœ¨: " + reportId));

    // æƒé™æ£€æŸ¥
    User currentUser = getCurrentUser();
    if (!report.getUserId().equals(currentUser.getId())) {
        throw new RuntimeException("æ— æƒæäº¤ä»–äººçš„å‘¨æŠ¥");
    }

    // çŠ¶æ€æ£€æŸ¥ï¼šåªèƒ½æäº¤è‰ç¨¿
    if (!report.isDraft()) {
        throw new IllegalStateException(
            String.format("åªèƒ½æäº¤è‰ç¨¿çŠ¶æ€çš„å‘¨æŠ¥ï¼Œå½“å‰çŠ¶æ€: %s", report.getEditStatus())
        );
    }

    // å†…å®¹å®Œæ•´æ€§æ£€æŸ¥
    validateReportCompleteness(report);

    // æäº¤å‘¨æŠ¥ï¼ˆçŠ¶æ€è½¬æ¢ï¼‰
    report.submit();
    WeeklyReport savedReport = weeklyReportRepository.save(report);

    logger.info("ğŸ“¤ å‘¨æŠ¥å·²æäº¤å®¡æ ¸ï¼Œå‘¨æŠ¥ID: {}, ç”¨æˆ·ID: {}",
        reportId, currentUser.getId());

    // è§¦å‘AIåˆ†æ
    triggerAIAnalysis(savedReport);

    return convertToResponse(savedReport);
}

/**
 * å†…å®¹å®Œæ•´æ€§æ ¡éªŒ
 */
private void validateReportCompleteness(WeeklyReport report) {
    List<String> errors = new ArrayList<>();

    if (report.getTitle() == null || report.getTitle().trim().isEmpty()) {
        errors.add("å‘¨æŠ¥æ ‡é¢˜ä¸èƒ½ä¸ºç©º");
    }

    if (report.getContent() == null || report.getContent().trim().length() < 50) {
        errors.add("å‘¨æŠ¥å†…å®¹ä¸èƒ½å°‘äº50å­—");
    }

    if (report.getTaskReports() == null || report.getTaskReports().isEmpty()) {
        errors.add("è‡³å°‘éœ€è¦æ·»åŠ ä¸€é¡¹ä»»åŠ¡æŠ¥å‘Š");
    }

    if (!errors.isEmpty()) {
        throw new IllegalArgumentException(
            "å‘¨æŠ¥å†…å®¹ä¸å®Œæ•´ï¼Œæ— æ³•æäº¤ï¼š" + String.join("; ", errors)
        );
    }
}
```

### 5.2 AIåˆ†æå®Œæˆå¤„ç†

```java
// AIAnalysisService.java

/**
 * æ›´æ–°å‘¨æŠ¥çŠ¶æ€ï¼ˆAIåˆ†æå®Œæˆåï¼‰
 */
@Transactional
public void updateWeeklyReportStatus(Long reportId, Long analysisResultId) {
    WeeklyReport report = weeklyReportRepository.findByIdForUpdate(reportId)
        .orElseThrow(() -> new RuntimeException("å‘¨æŠ¥ä¸å­˜åœ¨: " + reportId));

    // çŠ¶æ€æ£€æŸ¥ï¼šå¿…é¡»æ˜¯AIå¤„ç†ä¸­
    if (report.getProcessingStatus() != WeeklyReport.ProcessingStatus.AI_PROCESSING) {
        logger.warn("âš ï¸ å‘¨æŠ¥çŠ¶æ€ä¸æ­£ç¡®ï¼Œé¢„æœŸ: AI_PROCESSING, å®é™…: {}",
            report.getProcessingStatus());
        return;
    }

    AIAnalysisResult analysisResult = aiAnalysisResultRepository.findById(analysisResultId)
        .orElseThrow(() -> new RuntimeException("AIåˆ†æç»“æœä¸å­˜åœ¨"));

    double confidence = analysisResult.getConfidence() != null ?
        analysisResult.getConfidence() : 0.0;
    boolean completed = analysisResult.getStatus() == AIAnalysisResult.AnalysisStatus.COMPLETED;

    logger.info("ğŸ” AIåˆ†æå®Œæˆï¼Œå‘¨æŠ¥ID: {}, ç½®ä¿¡åº¦: {}, é˜ˆå€¼: {}",
        reportId, confidence, weeklyReportConfidenceThreshold);

    // å…³è”AIåˆ†æç»“æœ
    report.setAiAnalysisId(analysisResultId);

    if (completed && confidence >= weeklyReportConfidenceThreshold) {
        // AIåˆ†æé€šè¿‡ï¼Œè¿›å…¥äººå·¥å®¡æ ¸
        report.completeAIAnalysis(confidence, weeklyReportConfidenceThreshold);
        weeklyReportRepository.save(report);

        logger.info("âœ… AIåˆ†æé€šè¿‡ï¼Œè¿›å…¥ç®¡ç†å‘˜å®¡æ ¸é˜Ÿåˆ—ï¼Œå‘¨æŠ¥ID: {}", reportId);

        // å‘é€é€šçŸ¥ç»™ç®¡ç†å‘˜
        weeklyReportNotificationService.handleAIAnalysisCompleted(reportId);

    } else {
        // AIåˆ†æç½®ä¿¡åº¦ä¸è¶³ï¼Œæ‰“å›è‰ç¨¿
        report.completeAIAnalysis(confidence, weeklyReportConfidenceThreshold);
        report.setRejectionReason(String.format(
            "AIåˆ†æç½®ä¿¡åº¦è¿‡ä½(%.0f%%)ï¼Œä½äºé˜ˆå€¼(%.0f%%)ã€‚å»ºè®®å®Œå–„å†…å®¹åé‡æ–°æäº¤ã€‚",
            confidence * 100,
            weeklyReportConfidenceThreshold * 100
        ));
        weeklyReportRepository.save(report);

        logger.info("ğŸš« AIåˆ†æç½®ä¿¡åº¦ä¸è¶³ï¼Œå·²æ‰“å›è‰ç¨¿ï¼Œå‘¨æŠ¥ID: {}", reportId);

        // å‘é€é€šçŸ¥ç»™ä½œè€…
        weeklyReportNotificationService.handleAIRejected(reportId, report.getRejectionReason());
    }
}
```

### 5.3 ç®¡ç†å‘˜å®¡æ ¸

```java
// WeeklyReportService.java

/**
 * ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡
 */
@Transactional
public void adminApprove(Long reportId, Long reviewerId) {
    WeeklyReport report = weeklyReportRepository.findByIdForUpdate(reportId)
        .orElseThrow(() -> new RuntimeException("å‘¨æŠ¥ä¸å­˜åœ¨: " + reportId));

    // æƒé™æ£€æŸ¥
    User reviewer = userRepository.findById(reviewerId)
        .orElseThrow(() -> new RuntimeException("å®¡æ ¸äººä¸å­˜åœ¨"));
    if (!reviewer.getRole().equals(User.Role.ADMIN) &&
        !reviewer.getRole().equals(User.Role.SUPER_ADMIN)) {
        throw new RuntimeException("æ— æƒå®¡æ ¸å‘¨æŠ¥");
    }

    // çŠ¶æ€æ£€æŸ¥
    if (!report.isPendingReview()) {
        throw new IllegalStateException(
            String.format("åªèƒ½å®¡æ ¸å¾…å®¡æ ¸çŠ¶æ€çš„å‘¨æŠ¥ï¼Œå½“å‰çŠ¶æ€: %s", report.getApprovalStatus())
        );
    }

    report.adminApprove(reviewerId);
    weeklyReportRepository.save(report);

    logger.info("âœ… ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡ï¼Œå‘¨æŠ¥ID: {}, å®¡æ ¸äººID: {}", reportId, reviewerId);

    // å‘é€é€šçŸ¥ç»™ä½œè€…
    weeklyReportNotificationService.handleAdminApproved(reportId, reviewerId);
}

/**
 * ç®¡ç†å‘˜å®¡æ ¸æ‹’ç»
 */
@Transactional
public void adminReject(Long reportId, Long reviewerId, String rejectionReason) {
    WeeklyReport report = weeklyReportRepository.findByIdForUpdate(reportId)
        .orElseThrow(() -> new RuntimeException("å‘¨æŠ¥ä¸å­˜åœ¨: " + reportId));

    // æƒé™æ£€æŸ¥
    User reviewer = userRepository.findById(reviewerId)
        .orElseThrow(() -> new RuntimeException("å®¡æ ¸äººä¸å­˜åœ¨"));
    if (!reviewer.getRole().equals(User.Role.ADMIN) &&
        !reviewer.getRole().equals(User.Role.SUPER_ADMIN)) {
        throw new RuntimeException("æ— æƒå®¡æ ¸å‘¨æŠ¥");
    }

    // çŠ¶æ€æ£€æŸ¥
    if (!report.isPendingReview()) {
        throw new IllegalStateException(
            String.format("åªèƒ½å®¡æ ¸å¾…å®¡æ ¸çŠ¶æ€çš„å‘¨æŠ¥ï¼Œå½“å‰çŠ¶æ€: %s", report.getApprovalStatus())
        );
    }

    report.adminReject(reviewerId, rejectionReason);
    weeklyReportRepository.save(report);

    logger.info("ğŸš« ç®¡ç†å‘˜å®¡æ ¸æ‹’ç»ï¼Œå‘¨æŠ¥ID: {}, å®¡æ ¸äººID: {}, åŸå› : {}",
        reportId, reviewerId, rejectionReason);

    // å‘é€é€šçŸ¥ç»™ä½œè€…
    weeklyReportNotificationService.handleAdminRejected(reportId, rejectionReason, reviewerId);
}
```

---

## 6. Controlleræ¥å£è®¾è®¡

### 6.1 RESTfulæ¥å£è§„åˆ’

```java
// WeeklyReportController.java

/**
 * åˆ›å»ºå‘¨æŠ¥è‰ç¨¿
 */
@PostMapping
@Operation(summary = "åˆ›å»ºå‘¨æŠ¥è‰ç¨¿", description = "åˆ›å»ºä¸€ä»½æ–°çš„å‘¨æŠ¥è‰ç¨¿ï¼Œä¸ä¼šè§¦å‘å®¡æ ¸æµç¨‹")
public ResponseEntity<ApiResponse<WeeklyReportResponse>> createDraft(
        @Valid @RequestBody WeeklyReportCreateRequest request) {
    WeeklyReportResponse response = weeklyReportService.createDraft(request);
    return ResponseEntity.ok(ApiResponse.success(response, "è‰ç¨¿å·²ä¿å­˜"));
}

/**
 * æ›´æ–°å‘¨æŠ¥è‰ç¨¿
 */
@PutMapping("/{id}/draft")
@Operation(summary = "æ›´æ–°å‘¨æŠ¥è‰ç¨¿", description = "æ›´æ–°è‰ç¨¿å†…å®¹ï¼Œåªèƒ½ä¿®æ”¹è‰ç¨¿çŠ¶æ€çš„å‘¨æŠ¥")
public ResponseEntity<ApiResponse<WeeklyReportResponse>> updateDraft(
        @PathVariable Long id,
        @Valid @RequestBody WeeklyReportUpdateRequest request) {
    WeeklyReportResponse response = weeklyReportService.updateDraft(id, request);
    return ResponseEntity.ok(ApiResponse.success(response, "è‰ç¨¿å·²æ›´æ–°"));
}

/**
 * æäº¤å‘¨æŠ¥è¿›è¡Œå®¡æ ¸
 */
@PostMapping("/{id}/submit")
@Operation(summary = "æäº¤å‘¨æŠ¥å®¡æ ¸", description = "æäº¤è‰ç¨¿è¿›è¡ŒAIåˆ†æå’Œäººå·¥å®¡æ ¸")
public ResponseEntity<ApiResponse<WeeklyReportResponse>> submitForReview(
        @PathVariable Long id) {
    WeeklyReportResponse response = weeklyReportService.submitForReview(id);
    return ResponseEntity.ok(ApiResponse.success(response, "å‘¨æŠ¥å·²æäº¤å®¡æ ¸"));
}

/**
 * è·å–æˆ‘çš„è‰ç¨¿åˆ—è¡¨
 */
@GetMapping("/my-drafts")
@Operation(summary = "è·å–æˆ‘çš„è‰ç¨¿", description = "è·å–å½“å‰ç”¨æˆ·æ‰€æœ‰è‰ç¨¿çŠ¶æ€çš„å‘¨æŠ¥")
public ResponseEntity<ApiResponse<List<WeeklyReportListResponse>>> getMyDrafts() {
    User currentUser = getCurrentUser();
    List<WeeklyReport> drafts = weeklyReportRepository.findByUserIdAndEditStatus(
        currentUser.getId(), WeeklyReport.EditStatus.DRAFT
    );
    List<WeeklyReportListResponse> responses = drafts.stream()
        .map(this::convertToListResponse)
        .collect(Collectors.toList());
    return ResponseEntity.ok(ApiResponse.success(responses));
}

/**
 * è·å–æˆ‘çš„å·²æäº¤å‘¨æŠ¥
 */
@GetMapping("/my-submitted")
@Operation(summary = "è·å–æˆ‘çš„å·²æäº¤å‘¨æŠ¥", description = "è·å–å½“å‰ç”¨æˆ·æ‰€æœ‰å·²æäº¤çš„å‘¨æŠ¥")
public ResponseEntity<ApiResponse<List<WeeklyReportListResponse>>> getMySubmitted() {
    User currentUser = getCurrentUser();
    List<WeeklyReport> submitted = weeklyReportRepository.findByUserIdAndEditStatus(
        currentUser.getId(), WeeklyReport.EditStatus.SUBMITTED
    );
    List<WeeklyReportListResponse> responses = submitted.stream()
        .map(this::convertToListResponse)
        .collect(Collectors.toList());
    return ResponseEntity.ok(ApiResponse.success(responses));
}

/**
 * è·å–å¾…å®¡æ ¸å‘¨æŠ¥åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ï¼‰
 */
@GetMapping("/pending-review")
@Operation(summary = "è·å–å¾…å®¡æ ¸å‘¨æŠ¥", description = "ç®¡ç†å‘˜è·å–æ‰€æœ‰å¾…å®¡æ ¸çš„å‘¨æŠ¥")
@PreAuthorize("hasAnyRole('ADMIN', 'SUPER_ADMIN')")
public ResponseEntity<ApiResponse<List<WeeklyReportListResponse>>> getPendingReview() {
    List<WeeklyReport> pending = weeklyReportRepository.findByApprovalStatus(
        WeeklyReport.ApprovalStatus.PENDING_REVIEW
    );
    List<WeeklyReportListResponse> responses = pending.stream()
        .map(this::convertToListResponse)
        .collect(Collectors.toList());
    return ResponseEntity.ok(ApiResponse.success(responses));
}

/**
 * ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡
 */
@PostMapping("/{id}/approve")
@Operation(summary = "å®¡æ ¸é€šè¿‡", description = "ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡å‘¨æŠ¥")
@PreAuthorize("hasAnyRole('ADMIN', 'SUPER_ADMIN')")
public ResponseEntity<ApiResponse<String>> approve(@PathVariable Long id) {
    User currentUser = getCurrentUser();
    weeklyReportService.adminApprove(id, currentUser.getId());
    return ResponseEntity.ok(ApiResponse.success("å®¡æ ¸é€šè¿‡"));
}

/**
 * ç®¡ç†å‘˜å®¡æ ¸æ‹’ç»
 */
@PostMapping("/{id}/reject")
@Operation(summary = "å®¡æ ¸æ‹’ç»", description = "ç®¡ç†å‘˜å®¡æ ¸æ‹’ç»å‘¨æŠ¥")
@PreAuthorize("hasAnyRole('ADMIN', 'SUPER_ADMIN')")
public ResponseEntity<ApiResponse<String>> reject(
        @PathVariable Long id,
        @RequestBody @Valid RejectRequest request) {
    User currentUser = getCurrentUser();
    weeklyReportService.adminReject(id, currentUser.getId(), request.getReason());
    return ResponseEntity.ok(ApiResponse.success("å®¡æ ¸å·²æ‹’ç»"));
}

@Data
public static class RejectRequest {
    @NotBlank(message = "æ‹’ç»åŸå› ä¸èƒ½ä¸ºç©º")
    private String reason;
}
```

---

## 7. RepositoryæŸ¥è¯¢æ–¹æ³•

```java
// WeeklyReportRepository.java

public interface WeeklyReportRepository extends JpaRepository<WeeklyReport, Long> {

    // ============= è‰ç¨¿ç›¸å…³æŸ¥è¯¢ =============

    /**
     * æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰è‰ç¨¿
     */
    List<WeeklyReport> findByUserIdAndEditStatus(Long userId, WeeklyReport.EditStatus editStatus);

    /**
     * æŸ¥è¯¢ç”¨æˆ·çš„è‰ç¨¿æ•°é‡
     */
    long countByUserIdAndEditStatus(Long userId, WeeklyReport.EditStatus editStatus);

    /**
     * æŸ¥è¯¢æŒ‡å®šæ—¶é—´èŒƒå›´å†…çš„è‰ç¨¿ï¼ˆæ¸…ç†ç”¨ï¼‰
     */
    List<WeeklyReport> findByEditStatusAndCreatedAtBefore(
        WeeklyReport.EditStatus editStatus,
        LocalDateTime before
    );

    // ============= å®¡æ ¸ç›¸å…³æŸ¥è¯¢ =============

    /**
     * æŸ¥è¯¢æ‰€æœ‰å¾…å®¡æ ¸çš„å‘¨æŠ¥
     */
    List<WeeklyReport> findByApprovalStatus(WeeklyReport.ApprovalStatus approvalStatus);

    /**
     * æŸ¥è¯¢æŒ‡å®šå®¡æ ¸äººçš„å¾…å®¡æ ¸å‘¨æŠ¥
     */
    @Query("SELECT wr FROM WeeklyReport wr " +
           "WHERE wr.approvalStatus = :status " +
           "ORDER BY wr.createdAt ASC")
    List<WeeklyReport> findPendingReviewReports(
        @Param("status") WeeklyReport.ApprovalStatus status
    );

    // ============= å¤„ç†çŠ¶æ€æŸ¥è¯¢ =============

    /**
     * æŸ¥è¯¢æŒ‡å®šå¤„ç†çŠ¶æ€çš„å‘¨æŠ¥
     */
    List<WeeklyReport> findByProcessingStatus(WeeklyReport.ProcessingStatus processingStatus);

    /**
     * æŸ¥è¯¢AIå¤„ç†å¤±è´¥çš„å‘¨æŠ¥ï¼ˆç”¨äºé‡è¯•ï¼‰
     */
    @Query("SELECT wr FROM WeeklyReport wr " +
           "WHERE wr.processingStatus = 'AI_FAILED' " +
           "AND wr.updatedAt > :since " +
           "ORDER BY wr.updatedAt DESC")
    List<WeeklyReport> findRecentAIFailedReports(@Param("since") LocalDateTime since);

    // ============= æ‚²è§‚é”æŸ¥è¯¢ =============

    /**
     * æ‚²è§‚é”æŸ¥è¯¢ - é˜²æ­¢å¹¶å‘ä¿®æ”¹
     */
    @Lock(LockModeType.PESSIMISTIC_WRITE)
    @Query("SELECT wr FROM WeeklyReport wr WHERE wr.id = :id")
    Optional<WeeklyReport> findByIdForUpdate(@Param("id") Long id);

    // ============= å¤åˆæ¡ä»¶æŸ¥è¯¢ =============

    /**
     * ç»„åˆæŸ¥è¯¢ï¼šç”¨æˆ·ã€ç¼–è¾‘çŠ¶æ€ã€æ—¶é—´èŒƒå›´
     */
    @Query("SELECT wr FROM WeeklyReport wr " +
           "WHERE wr.userId = :userId " +
           "AND wr.editStatus = :editStatus " +
           "AND wr.createdAt BETWEEN :startDate AND :endDate " +
           "ORDER BY wr.createdAt DESC")
    List<WeeklyReport> findByUserAndStatusAndDateRange(
        @Param("userId") Long userId,
        @Param("editStatus") WeeklyReport.EditStatus editStatus,
        @Param("startDate") LocalDateTime startDate,
        @Param("endDate") LocalDateTime endDate
    );

    /**
     * ç»Ÿè®¡æŸ¥è¯¢ï¼šå„çŠ¶æ€çš„å‘¨æŠ¥æ•°é‡
     */
    @Query("SELECT wr.editStatus, COUNT(wr) FROM WeeklyReport wr " +
           "WHERE wr.userId = :userId " +
           "GROUP BY wr.editStatus")
    Map<WeeklyReport.EditStatus, Long> countByUserIdGroupByEditStatus(@Param("userId") Long userId);
}
```

---

## 8. å‰ç«¯äº¤äº’æµç¨‹

### 8.1 ç”¨æˆ·åˆ›å»ºå’Œç¼–è¾‘æµç¨‹

```typescript
// å‰ç«¯é¡µé¢æµç¨‹

// 1. ç”¨æˆ·åˆ›å»ºå‘¨æŠ¥
async function createWeeklyReport(reportData: WeeklyReportCreateRequest) {
    const response = await api.post('/weekly-reports', reportData);

    // åç«¯è¿”å›è‰ç¨¿çŠ¶æ€çš„å‘¨æŠ¥
    console.log(response.data.editStatus); // "DRAFT"

    showMessage('è‰ç¨¿å·²ä¿å­˜');
    router.push('/reports/my-drafts'); // è·³è½¬åˆ°è‰ç¨¿åˆ—è¡¨
}

// 2. ç”¨æˆ·ç¼–è¾‘è‰ç¨¿
async function updateDraft(reportId: number, reportData: WeeklyReportUpdateRequest) {
    const response = await api.put(`/weekly-reports/${reportId}/draft`, reportData);

    showMessage('è‰ç¨¿å·²æ›´æ–°');
}

// 3. ç”¨æˆ·æäº¤å®¡æ ¸
async function submitForReview(reportId: number) {
    const confirmed = await showConfirmDialog({
        title: 'æäº¤å®¡æ ¸',
        message: 'æäº¤åå°†è¿›è¡ŒAIåˆ†æå’Œç®¡ç†å‘˜å®¡æ ¸ï¼ŒæœŸé—´æ— æ³•ç¼–è¾‘ã€‚ç¡®è®¤æäº¤å—ï¼Ÿ'
    });

    if (!confirmed) return;

    try {
        const response = await api.post(`/weekly-reports/${reportId}/submit`);

        showMessage('å‘¨æŠ¥å·²æäº¤ï¼Œæ­£åœ¨è¿›è¡ŒAIåˆ†æ...');
        router.push('/reports/my-submitted');

        // è®¢é˜…WebSocketæ¥æ”¶AIåˆ†æç»“æœ
        subscribeToAIAnalysisResult(reportId);

    } catch (error) {
        if (error.response?.status === 400) {
            showError(`å†…å®¹ä¸å®Œæ•´ï¼š${error.response.data.message}`);
        } else {
            showError('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }
}

// 4. ç›‘å¬AIåˆ†æç»“æœ
function subscribeToAIAnalysisResult(reportId: number) {
    const ws = new WebSocket(`/ws/weekly-report/${reportId}`);

    ws.onmessage = (event) => {
        const result = JSON.parse(event.data);

        if (result.type === 'AI_ANALYSIS_COMPLETED') {
            if (result.approvalStatus === 'PENDING_REVIEW') {
                showNotification('AIåˆ†æé€šè¿‡ï¼Œå·²è¿›å…¥ç®¡ç†å‘˜å®¡æ ¸');
            } else if (result.editStatus === 'DRAFT') {
                showNotification('AIåˆ†æç½®ä¿¡åº¦ä¸è¶³ï¼Œè¯·å®Œå–„å†…å®¹åé‡æ–°æäº¤', 'warning');
                router.push(`/reports/${reportId}/edit`);
            }
        }
    };
}
```

### 8.2 ç®¡ç†å‘˜å®¡æ ¸æµç¨‹

```typescript
// ç®¡ç†å‘˜é¡µé¢æµç¨‹

// 1. è·å–å¾…å®¡æ ¸åˆ—è¡¨
async function loadPendingReviews() {
    const response = await api.get('/weekly-reports/pending-review');
    const reports = response.data;

    // æ˜¾ç¤ºå¾…å®¡æ ¸åˆ—è¡¨
    renderReviewQueue(reports);
}

// 2. å®¡æ ¸é€šè¿‡
async function approveReport(reportId: number) {
    const confirmed = await showConfirmDialog({
        title: 'å®¡æ ¸é€šè¿‡',
        message: 'ç¡®è®¤æ‰¹å‡†æ­¤å‘¨æŠ¥å—ï¼Ÿ'
    });

    if (!confirmed) return;

    await api.post(`/weekly-reports/${reportId}/approve`);
    showMessage('å®¡æ ¸é€šè¿‡');

    // åˆ·æ–°åˆ—è¡¨
    loadPendingReviews();
}

// 3. å®¡æ ¸æ‹’ç»
async function rejectReport(reportId: number) {
    const reason = await showRejectDialog({
        title: 'å®¡æ ¸æ‹’ç»',
        message: 'è¯·è¾“å…¥æ‹’ç»åŸå› ï¼š'
    });

    if (!reason) return;

    await api.post(`/weekly-reports/${reportId}/reject`, { reason });
    showMessage('å·²æ‹’ç»å¹¶é€šçŸ¥ä½œè€…ä¿®æ”¹');

    // åˆ·æ–°åˆ—è¡¨
    loadPendingReviews();
}
```

---

## 9. ä¼˜åŠ¿å¯¹æ¯”

### 9.1 æ–°è®¾è®¡ vs æ—§è®¾è®¡

| ç»´åº¦ | æ—§è®¾è®¡ï¼ˆæ··åˆçŠ¶æ€ï¼‰ | æ–°è®¾è®¡ï¼ˆåˆ†å±‚çŠ¶æ€ï¼‰ |
|------|------------------|------------------|
| **çŠ¶æ€æ¸…æ™°åº¦** | âŒ AI_ANALYZINGæ—¢æ˜¯è‰ç¨¿åˆæ˜¯å¤„ç†çŠ¶æ€ï¼Œæ··ä¹± | âœ… ä¸‰å±‚ç‹¬ç«‹çŠ¶æ€ï¼Œå„å¸å…¶èŒ |
| **è‰ç¨¿åŠŸèƒ½** | âŒ æ— çœŸæ­£è‰ç¨¿ï¼Œåˆ›å»ºå³æäº¤ | âœ… ç‹¬ç«‹è‰ç¨¿çŠ¶æ€ï¼Œå…è®¸åå¤ç¼–è¾‘ |
| **èµ„æºæ¶ˆè€—** | âŒ æœªå®Œæˆå‘¨æŠ¥ä¹Ÿè§¦å‘AIåˆ†æ | âœ… ä»…æäº¤æ—¶è§¦å‘ï¼ŒèŠ‚çœèµ„æº |
| **ç”¨æˆ·ä½“éªŒ** | âŒ ä¿å­˜è‰ç¨¿ç«‹å³æ”¶åˆ°æ‹’ç»é€šçŸ¥ | âœ… æ˜ç¡®åŒºåˆ†"ä¿å­˜"å’Œ"æäº¤" |
| **æŸ¥è¯¢é€»è¾‘** | âŒ æ··ä¹±çš„çŠ¶æ€åˆ¤æ–­å’ŒæŸ¥è¯¢æ¡ä»¶ | âœ… æ¸…æ™°çš„çŠ¶æ€æŸ¥è¯¢ |
| **æ‰©å±•æ€§** | âŒ æ·»åŠ æ–°çŠ¶æ€ä¼šæ±¡æŸ“ApprovalStatus | âœ… æ¯å±‚ç‹¬ç«‹æ‰©å±•ï¼Œäº’ä¸å½±å“ |
| **è¯­ä¹‰å‡†ç¡®** | âŒ ApprovalStatusåŒ…å«éå®¡æ ¸çŠ¶æ€ | âœ… æ¯ä¸ªæšä¸¾åå‰¯å…¶å® |
| **ä¸šåŠ¡ä¸€è‡´** | âŒ isSubmitted()æ°¸è¿œè¿”å›true | âœ… çœŸå®åæ˜ æäº¤çŠ¶æ€ |

### 9.2 å…¸å‹åœºæ™¯å¯¹æ¯”

**åœºæ™¯ï¼šç”¨æˆ·æƒ³ä¿å­˜æœªå®Œæˆçš„å‘¨æŠ¥**

æ—§è®¾è®¡æµç¨‹ï¼š
```
åˆ›å»ºå‘¨æŠ¥ â†’ ApprovalStatus = AI_ANALYZING
â†’ ç«‹å³è§¦å‘AIåˆ†æ
â†’ å‡ ç§’åæ”¶åˆ°"ç½®ä¿¡åº¦ä½ï¼Œè¢«æ‹’ç»"
â†’ ç”¨æˆ·å›°æƒ‘ï¼š"æˆ‘è¿˜æ²¡å†™å®Œå•Šï¼"
```

æ–°è®¾è®¡æµç¨‹ï¼š
```
åˆ›å»ºå‘¨æŠ¥ â†’ EditStatus = DRAFT, ProcessingStatus = PENDING
â†’ ç”¨æˆ·åå¤ç¼–è¾‘ä¿å­˜
â†’ ç”¨æˆ·ç‚¹å‡»"æäº¤å®¡æ ¸" â†’ EditStatus = SUBMITTED, ProcessingStatus = AI_PROCESSING
â†’ AIåˆ†æ â†’ æ ¹æ®ç»“æœå†³å®šæ˜¯å¦è¿›å…¥å®¡æ ¸é˜Ÿåˆ—
â†’ æ¸…æ™°æ˜ç¡®çš„æµç¨‹
```

---

## 10. å®æ–½è·¯å¾„

### 10.1 åˆ†é˜¶æ®µå®æ–½

**é˜¶æ®µ1: æ•°æ®åº“å’Œå®ä½“å±‚** (2å¤©)
- æ·»åŠ  `edit_status` å’Œ `processing_status` å­—æ®µ
- ä¿®æ”¹ `approval_status` æšä¸¾å€¼
- æ•°æ®è¿ç§»SQL
- å®ä½“ç±»ä¿®æ”¹
- å•å…ƒæµ‹è¯•

**é˜¶æ®µ2: Repositoryå’ŒServiceå±‚** (2å¤©)
- ä¿®æ”¹RepositoryæŸ¥è¯¢æ–¹æ³•
- é‡å†™Serviceä¸šåŠ¡é€»è¾‘
- åˆ†ç¦»åˆ›å»ºè‰ç¨¿å’Œæäº¤å®¡æ ¸é€»è¾‘
- é›†æˆæµ‹è¯•

**é˜¶æ®µ3: Controllerå’ŒAPIå±‚** (1å¤©)
- ä¿®æ”¹Controlleræ¥å£
- APIæ–‡æ¡£æ›´æ–°
- æ¥å£æµ‹è¯•

**é˜¶æ®µ4: å‰ç«¯é…åˆ** (2å¤©)
- ä¿®æ”¹å‰ç«¯çŠ¶æ€æ˜¾ç¤ºé€»è¾‘
- æ·»åŠ "æäº¤å®¡æ ¸"æŒ‰é’®
- è‰ç¨¿åˆ—è¡¨å’Œå·²æäº¤åˆ—è¡¨åˆ†ç¦»
- ç«¯åˆ°ç«¯æµ‹è¯•

**é˜¶æ®µ5: é€šçŸ¥å’Œç›‘æ§** (1å¤©)
- è°ƒæ•´é€šçŸ¥é€»è¾‘
- æ—¥å¿—ä¼˜åŒ–
- ç›‘æ§å‘Šè­¦è§„åˆ™æ›´æ–°

**æ€»è®¡: 8ä¸ªå·¥ä½œæ—¥ï¼ˆ1.5å‘¨ï¼‰**

### 10.2 é£é™©æ§åˆ¶

**æŠ€æœ¯é£é™©**:
- æ•°æ®è¿ç§»å¤±è´¥ â†’ æå‰å¤‡ä»½ï¼Œåˆ†æ‰¹è¿ç§»ï¼Œå¯å›æ»š
- çŠ¶æ€è½¬æ¢é€»è¾‘é”™è¯¯ â†’ å®Œå–„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

**ä¸šåŠ¡é£é™©**:
- ç°æœ‰å‘¨æŠ¥çŠ¶æ€ä¸ä¸€è‡´ â†’ æ•°æ®è¿ç§»è„šæœ¬å¤„ç†å†å²æ•°æ®
- ç”¨æˆ·ä¹ æƒ¯æ”¹å˜ â†’ å‰ç«¯æç¤ºç”¨æˆ·æ–°æµç¨‹

**å›æ»šç­–ç•¥**:
- ä¿ç•™æ—§çš„ `approval_status` å€¼ä½œä¸ºå¤‡ä»½åˆ—
- å‰ç«¯ä¿ç•™æ—§APIå…¼å®¹æ€§ï¼ˆä¸€å‘¨è¿‡æ¸¡æœŸï¼‰
- æ•°æ®åº“è¿ç§»å¯é€†ï¼ˆæä¾›å›æ»šSQLï¼‰

---

## 11. æ€»ç»“

### 11.1 æ ¸å¿ƒé—®é¢˜

**åŸæœ‰è®¾è®¡çš„æ ¹æœ¬é”™è¯¯**:
> å°†"è‰ç¨¿çŠ¶æ€"æ··å…¥"å®¡æ ¸çŠ¶æ€"æšä¸¾ä¸­ï¼Œè¿åäº†å•ä¸€èŒè´£åŸåˆ™

### 11.2 æ­£ç¡®çš„è®¾è®¡åŸåˆ™

1. **çŠ¶æ€åˆ†å±‚**: ç¼–è¾‘çŠ¶æ€ã€å¤„ç†çŠ¶æ€ã€å®¡æ ¸çŠ¶æ€å„è‡ªç‹¬ç«‹
2. **è¯­ä¹‰å‡†ç¡®**: æšä¸¾åç§°çœŸå®åæ˜ å…¶ç®¡ç†çš„é¢†åŸŸ
3. **èŒè´£å•ä¸€**: æ¯ä¸ªçŠ¶æ€æšä¸¾åªè´Ÿè´£ä¸€ä¸ªç»´åº¦
4. **æµç¨‹æ¸…æ™°**: ç”¨æˆ·æ“ä½œä¸ç³»ç»ŸçŠ¶æ€ä¸€ä¸€å¯¹åº”

### 11.3 æ ¸å¿ƒæ”¹è¿›ç‚¹

| æ”¹è¿›é¡¹ | æ”¹è¿›æªæ–½ | é¢„æœŸæ”¶ç›Š |
|--------|---------|---------|
| è‰ç¨¿ç‹¬ç«‹ | æ–°å¢ EditStatus.DRAFT | ç”¨æˆ·å¯åå¤ç¼–è¾‘è‰ç¨¿ |
| å®¡æ ¸çº¯å‡€ | ApprovalStatus åªåŒ…å«å®¡æ ¸çŠ¶æ€ | ç®¡ç†å‘˜æŸ¥è¯¢æ¸…æ™° |
| å¤„ç†å¯è§ | æ–°å¢ ProcessingStatus | ç³»ç»Ÿç›‘æ§å’Œæ•…éšœæ’æŸ¥ |
| å»¶è¿Ÿåˆ†æ | æäº¤æ—¶æ‰è§¦å‘AI | èŠ‚çœ30-50% AIè°ƒç”¨ |
| è¯­ä¹‰å‡†ç¡® | isDraft/isSubmittedçœŸå®åæ˜ çŠ¶æ€ | ä»£ç å¯è¯»æ€§æå‡ |

### 11.4 æœ€ç»ˆçŠ¶æ€æœº

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åˆ›å»ºå‘¨æŠ¥   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DRAFT (è‰ç¨¿çŠ¶æ€)        â”‚ â—„â”€â”€â”
â”‚  - ç”¨æˆ·å¯ç¼–è¾‘            â”‚    â”‚ ç½®ä¿¡åº¦ä¸è¶³
â”‚  - ç”¨æˆ·å¯åˆ é™¤            â”‚    â”‚ æˆ–ç®¡ç†å‘˜æ‹’ç»
â”‚  - æœªè§¦å‘AIåˆ†æ          â”‚    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
       â”‚ ç”¨æˆ·ç‚¹å‡»"æäº¤å®¡æ ¸"      â”‚
       â–¼                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  SUBMITTED + AI_PROCESSINGâ”‚  â”‚
â”‚  - é”å®šç¼–è¾‘              â”‚    â”‚
â”‚  - AIåˆ†æä¸­              â”‚    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
       â”‚                        â”‚
       â–¼                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  AIåˆ†æå®Œæˆ              â”‚    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
       â”‚                        â”‚
       â”œâ”€ ç½®ä¿¡åº¦ â‰¥ 70% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”
       â”‚                        â”‚     â”‚
       â””â”€ ç½®ä¿¡åº¦ < 70% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                                      â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚  PENDING_REVIEW       â”‚
                          â”‚  - å¾…ç®¡ç†å‘˜å®¡æ ¸       â”‚
                          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”œâ”€ é€šè¿‡ â”€â”€â–º APPROVED (å®Œæˆ)
                                 â”‚
                                 â””â”€ æ‹’ç» â”€â”€â–º REJECTED (æ‰“å›è‰ç¨¿)
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 2.0
**åˆ†æå®Œæˆæ—¥æœŸ**: 2025-01-16
**ç›¸å…³æ–‡æ¡£**:
- `å‘¨æŠ¥AIåˆ†æç½®ä¿¡åº¦é—®é¢˜åˆ†æ_20250116.md`
- `å‘¨æŠ¥AIåˆ†æç½®ä¿¡åº¦é—®é¢˜æ”¹è¿›æ€»ç»“_20250116.md`
- `å‘¨æŠ¥è‰ç¨¿çŠ¶æ€åˆ†æ_20250116.md` (å·²åºŸå¼ƒï¼Œæœ¬æ–‡æ¡£æ›¿ä»£)
