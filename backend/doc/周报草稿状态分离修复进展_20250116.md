# å‘¨æŠ¥è‰ç¨¿çŠ¶æ€åˆ†ç¦»ä¿®å¤è¿›å±•

**ä¿®å¤æ—¥æœŸ**: 2025-01-16
**ç›®æ ‡**: å®ç°è‰ç¨¿çŠ¶æ€ä¸å®¡æ ¸æµç¨‹çš„å®Œå…¨åˆ†ç¦»
**å‚è€ƒæ–‡æ¡£**: `å‘¨æŠ¥è‰ç¨¿ä¸å®¡æ ¸æµç¨‹åˆ†ç¦»è®¾è®¡_20250116.md`

---

## ä¿®å¤çŠ¶æ€æ€»è§ˆ

### âœ… å·²å®Œæˆéƒ¨åˆ†ï¼ˆé˜¶æ®µ1-2ï¼‰

| å±‚çº§ | ä¿®æ”¹å†…å®¹ | çŠ¶æ€ | æ–‡ä»¶ |
|------|---------|-----|------|
| æ•°æ®åº“å±‚ | æ•°æ®åº“è¿ç§»SQL | âœ… å®Œæˆ | `V35__Separate_Draft_From_Approval_Status.sql` |
| å®ä½“å±‚ | ä¸‰å±‚çŠ¶æ€æšä¸¾ | âœ… å®Œæˆ | `WeeklyReport.java` |
| å®ä½“å±‚ | çŠ¶æ€å­—æ®µå’Œgetter/setter | âœ… å®Œæˆ | `WeeklyReport.java` |
| å®ä½“å±‚ | çŠ¶æ€è½¬æ¢æ–¹æ³• | âœ… å®Œæˆ | `WeeklyReport.java` |
| å®ä½“å±‚ | è¾…åŠ©åˆ¤æ–­æ–¹æ³• | âœ… å®Œæˆ | `WeeklyReport.java` |
| Repositoryå±‚ | æ–°å¢æŸ¥è¯¢æ–¹æ³• | âœ… å®Œæˆ | `WeeklyReportRepository.java` |

### â³ å¾…å®Œæˆéƒ¨åˆ†ï¼ˆé˜¶æ®µ3-5ï¼‰

| å±‚çº§ | ä¿®æ”¹å†…å®¹ | çŠ¶æ€ | é¢„è®¡å·¥ä½œé‡ |
|------|---------|-----|-----------|
| Serviceå±‚ | åˆ›å»ºè‰ç¨¿å’Œæ›´æ–°è‰ç¨¿é€»è¾‘ | â³ å¾…å®Œæˆ | 2å°æ—¶ |
| Serviceå±‚ | æäº¤å®¡æ ¸æµç¨‹ | â³ å¾…å®Œæˆ | 1å°æ—¶ |
| Serviceå±‚ | ç®¡ç†å‘˜å®¡æ ¸é€»è¾‘ | â³ å¾…å®Œæˆ | 1å°æ—¶ |
| AIåˆ†æå±‚ | AIåˆ†æå®Œæˆå¤„ç† | â³ å¾…å®Œæˆ | 1å°æ—¶ |
| Controllerå±‚ | è‰ç¨¿å’Œæäº¤API | â³ å¾…å®Œæˆ | 1.5å°æ—¶ |
| é€šçŸ¥å±‚ | çŠ¶æ€å˜æ›´é€šçŸ¥ | â³ å¾…å®Œæˆ | 0.5å°æ—¶ |
| DTOå±‚ | å“åº”å¯¹è±¡æ›´æ–° | â³ å¾…å®Œæˆ | 0.5å°æ—¶ |

---

## é˜¶æ®µ1: æ•°æ®åº“å±‚ä¿®æ”¹ï¼ˆâœ… å·²å®Œæˆï¼‰

### æ–‡ä»¶ï¼š`V35__Separate_Draft_From_Approval_Status.sql`

**åŠŸèƒ½**:
- æ·»åŠ  `edit_status` å­—æ®µï¼ˆDRAFT/SUBMITTEDï¼‰
- æ·»åŠ  `processing_status` å­—æ®µï¼ˆPENDING/AI_PROCESSING/AI_COMPLETED/AI_FAILEDï¼‰
- ä¿®æ”¹ `approval_status` æšä¸¾å€¼ï¼ˆNOT_STARTED/PENDING_REVIEW/APPROVED/REJECTEDï¼‰
- æ•°æ®è¿ç§»é€»è¾‘ï¼ˆæ—§çŠ¶æ€ â†’ æ–°çŠ¶æ€ï¼‰
- åˆ›å»ºç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢

**æ•°æ®è¿ç§»æ˜ å°„**:
```sql
æ—§ approval_status â†’ æ–°çŠ¶æ€ç»„åˆ:

AI_ANALYZING â†’ edit_status=DRAFT, processing_status=AI_PROCESSING, approval_status=NOT_STARTED
AI_REJECTED â†’ edit_status=DRAFT, processing_status=AI_COMPLETED, approval_status=NOT_STARTED
ADMIN_REVIEWING â†’ edit_status=SUBMITTED, processing_status=AI_COMPLETED, approval_status=PENDING_REVIEW
ADMIN_APPROVED â†’ edit_status=SUBMITTED, processing_status=AI_COMPLETED, approval_status=APPROVED
ADMIN_REJECTED â†’ edit_status=SUBMITTED, processing_status=AI_COMPLETED, approval_status=REJECTED
```

---

## é˜¶æ®µ2: å®ä½“å±‚å’ŒRepositoryå±‚ä¿®æ”¹ï¼ˆâœ… å·²å®Œæˆï¼‰

### æ–‡ä»¶ï¼š`WeeklyReport.java`

**æ–°å¢æšä¸¾**:

```java
// ç¼–è¾‘çŠ¶æ€æšä¸¾ - ç”¨æˆ·è§†è§’
public enum EditStatus {
    DRAFT("è‰ç¨¿"),          // è‰ç¨¿ï¼šç”¨æˆ·æ­£åœ¨ç¼–è¾‘ï¼Œæœªæäº¤å®¡æ ¸
    SUBMITTED("å·²æäº¤");    // å·²æäº¤ï¼šç”¨æˆ·å®Œæˆç¼–è¾‘ï¼Œè¿›å…¥å®¡æ ¸æµç¨‹
}

// å¤„ç†çŠ¶æ€æšä¸¾ - ç³»ç»Ÿè§†è§’
public enum ProcessingStatus {
    PENDING("å¾…å¤„ç†"),              // å¾…å¤„ç†ï¼šç­‰å¾…AIåˆ†æ
    AI_PROCESSING("AIåˆ†æä¸­"),      // AIåˆ†æä¸­ï¼šæ­£åœ¨è¿›è¡ŒAIåˆ†æ
    AI_COMPLETED("AIåˆ†æå®Œæˆ"),     // AIå®Œæˆï¼šåˆ†æå®Œæˆï¼Œå¾…å®¡æ ¸
    AI_FAILED("AIåˆ†æå¤±è´¥");        // AIå¤±è´¥ï¼šåˆ†æå‡ºé”™
}

// å®¡æ ¸çŠ¶æ€æšä¸¾ - ç®¡ç†å‘˜è§†è§’ï¼ˆå·²ä¿®æ”¹ï¼‰
public enum ApprovalStatus {
    NOT_STARTED("æœªå¼€å§‹å®¡æ ¸"),      // æœªå¼€å§‹ï¼šå°šæœªè¿›å…¥å®¡æ ¸æµç¨‹
    PENDING_REVIEW("å¾…å®¡æ ¸"),       // å¾…å®¡æ ¸ï¼šç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸
    APPROVED("å®¡æ ¸é€šè¿‡"),           // å·²é€šè¿‡ï¼šå®¡æ ¸é€šè¿‡
    REJECTED("å®¡æ ¸æ‹’ç»");           // å·²æ‹’ç»ï¼šå®¡æ ¸ä¸é€šè¿‡
}
```

**æ–°å¢å­—æ®µ**:
```java
@Enumerated(EnumType.STRING)
@Column(name = "edit_status", nullable = false, length = 20)
private EditStatus editStatus = EditStatus.DRAFT;

@Enumerated(EnumType.STRING)
@Column(name = "processing_status", nullable = false, length = 30)
private ProcessingStatus processingStatus = ProcessingStatus.PENDING;

@Enumerated(EnumType.STRING)
@Column(name = "approval_status", length = 20, nullable = false)
private ApprovalStatus approvalStatus = ApprovalStatus.NOT_STARTED;
```

**æ–°å¢è¾…åŠ©æ–¹æ³•**:
- `isDraft()` - æ˜¯å¦ä¸ºè‰ç¨¿çŠ¶æ€
- `isSubmitted()` - æ˜¯å¦å·²æäº¤å®¡æ ¸
- `isEditable()` - æ˜¯å¦å¯ç¼–è¾‘
- `isAIProcessing()` - æ˜¯å¦æ­£åœ¨AIå¤„ç†ä¸­
- `isAICompleted()` - æ˜¯å¦å·²å®ŒæˆAIåˆ†æ
- `isPendingReview()` - æ˜¯å¦å¾…ç®¡ç†å‘˜å®¡æ ¸
- `isApproved()` - æ˜¯å¦å·²å®¡æ ¸é€šè¿‡
- `isRejected()` - æ˜¯å¦å·²è¢«æ‹’ç»

**æ–°å¢çŠ¶æ€è½¬æ¢æ–¹æ³•**:
- `submit()` - æäº¤å‘¨æŠ¥è¿›è¡Œå®¡æ ¸
- `completeAIAnalysis(confidence, threshold)` - AIåˆ†æå®Œæˆ
- `adminApprove(reviewerId)` - ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡
- `adminReject(reviewerId, reason)` - ç®¡ç†å‘˜å®¡æ ¸æ‹’ç»
- `markAIFailed()` - AIåˆ†æå¤±è´¥

### æ–‡ä»¶ï¼š`WeeklyReportRepository.java`

**æ–°å¢æŸ¥è¯¢æ–¹æ³•**:
```java
// è‰ç¨¿ç›¸å…³æŸ¥è¯¢
List<WeeklyReport> findByUserIdAndEditStatus(Long userId, EditStatus editStatus);
long countByUserIdAndEditStatus(Long userId, EditStatus editStatus);
List<WeeklyReport> findByEditStatusAndCreatedAtBefore(EditStatus editStatus, LocalDateTime before);

// å¤„ç†çŠ¶æ€æŸ¥è¯¢
List<WeeklyReport> findByProcessingStatus(ProcessingStatus processingStatus);
List<WeeklyReport> findRecentAIFailedReports(LocalDateTime since);

// å®¡æ ¸çŠ¶æ€æŸ¥è¯¢
List<WeeklyReport> findPendingReviewReports(ApprovalStatus status);

// ç»„åˆæŸ¥è¯¢
List<WeeklyReport> findByUserAndStatusAndDateRange(...);
List<Object[]> countByUserIdGroupByEditStatus(Long userId);
Page<WeeklyReport> findByUserIdAndEditStatus(Long userId, EditStatus editStatus, Pageable pageable);
```

---

## é˜¶æ®µ3-5: å¾…å®Œæˆä¿®æ”¹

### é˜¶æ®µ3: Serviceå±‚ä¿®æ”¹ï¼ˆâ³ å¾…å®Œæˆï¼‰

#### æ–‡ä»¶ï¼š`WeeklyReportService.java`

**éœ€è¦ä¿®æ”¹çš„æ–¹æ³•**:

1. **createWeeklyReport()** - åˆ›å»ºè‰ç¨¿
   - ç§»é™¤è‡ªåŠ¨è§¦å‘AIåˆ†æçš„é€»è¾‘
   - è®¾ç½®åˆå§‹çŠ¶æ€ä¸º DRAFT/PENDING/NOT_STARTED
   - æ—¥å¿—è¯´æ˜"è‰ç¨¿å·²ä¿å­˜"

2. **updateWeeklyReport()** - æ›´æ–°è‰ç¨¿
   - æ·»åŠ çŠ¶æ€æ£€æŸ¥ï¼šåªèƒ½æ›´æ–°è‰ç¨¿çŠ¶æ€çš„å‘¨æŠ¥
   - æƒé™æ£€æŸ¥ï¼šåªèƒ½ä¿®æ”¹è‡ªå·±çš„å‘¨æŠ¥

3. **submitForReview()** - æ–°å¢æ–¹æ³•ï¼šæäº¤å®¡æ ¸
   - çŠ¶æ€æ£€æŸ¥ï¼šåªèƒ½æäº¤è‰ç¨¿
   - å†…å®¹å®Œæ•´æ€§æ ¡éªŒ
   - è°ƒç”¨ `report.submit()` è½¬æ¢çŠ¶æ€
   - è§¦å‘AIåˆ†æ
   - æ—¥å¿—è¯´æ˜"å·²æäº¤å®¡æ ¸"

4. **adminApprove()** - ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡
   - ä½¿ç”¨æ–°çš„ `report.adminApprove(reviewerId)` æ–¹æ³•
   - æ›´æ–°çŠ¶æ€æ£€æŸ¥é€»è¾‘

5. **adminReject()** - ç®¡ç†å‘˜å®¡æ ¸æ‹’ç»
   - ä½¿ç”¨æ–°çš„ `report.adminReject(reviewerId, reason)` æ–¹æ³•
   - è‡ªåŠ¨è§£é”ç¼–è¾‘çŠ¶æ€

**ä¼ªä»£ç ç¤ºä¾‹**:

```java
// åˆ›å»ºè‰ç¨¿ï¼ˆä¸è§¦å‘AIåˆ†æï¼‰
@Transactional
public WeeklyReportResponse createDraft(WeeklyReportCreateRequest request) {
    User currentUser = getCurrentUser();
    validateCreatePermission(currentUser, request);

    WeeklyReport weeklyReport = new WeeklyReport();
    // ... è®¾ç½®å„ç§å±æ€§ ...

    // æ˜ç¡®è®¾ç½®ä¸ºè‰ç¨¿çŠ¶æ€
    weeklyReport.setEditStatus(WeeklyReport.EditStatus.DRAFT);
    weeklyReport.setProcessingStatus(WeeklyReport.ProcessingStatus.PENDING);
    weeklyReport.setApprovalStatus(WeeklyReport.ApprovalStatus.NOT_STARTED);

    processTaskReports(weeklyReport, request);
    WeeklyReport savedReport = weeklyReportRepository.save(weeklyReport);

    logger.info("âœ… å‘¨æŠ¥è‰ç¨¿å·²åˆ›å»ºï¼Œå‘¨æŠ¥ID: {}, ç”¨æˆ·ID: {}",
        savedReport.getId(), currentUser.getId());

    // âš ï¸ ä¸è§¦å‘AIåˆ†æ
    return convertToResponse(savedReport);
}

// æäº¤å®¡æ ¸ï¼ˆè§¦å‘AIåˆ†æï¼‰
@Transactional
public WeeklyReportResponse submitForReview(Long reportId) {
    WeeklyReport report = weeklyReportRepository.findById(reportId)
        .orElseThrow(() -> new RuntimeException("å‘¨æŠ¥ä¸å­˜åœ¨: " + reportId));

    // æƒé™æ£€æŸ¥
    User currentUser = getCurrentUser();
    if (!report.getUserId().equals(currentUser.getId())) {
        throw new RuntimeException("æ— æƒæäº¤ä»–äººçš„å‘¨æŠ¥");
    }

    // çŠ¶æ€æ£€æŸ¥ï¼šåªèƒ½æäº¤è‰ç¨¿
    if (!report.isDraft()) {
        throw new IllegalStateException(
            String.format("åªèƒ½æäº¤è‰ç¨¿çŠ¶æ€çš„å‘¨æŠ¥ï¼Œå½“å‰çŠ¶æ€: %s", report.getEditStatus())
        );
    }

    // å†…å®¹å®Œæ•´æ€§æ£€æŸ¥
    validateReportCompleteness(report);

    // æäº¤å‘¨æŠ¥ï¼ˆçŠ¶æ€è½¬æ¢ï¼‰
    report.submit();
    WeeklyReport savedReport = weeklyReportRepository.save(report);

    logger.info("ğŸ“¤ å‘¨æŠ¥å·²æäº¤å®¡æ ¸ï¼Œå‘¨æŠ¥ID: {}, ç”¨æˆ·ID: {}",
        reportId, currentUser.getId());

    // è§¦å‘AIåˆ†æ
    triggerAIAnalysis(savedReport);

    return convertToResponse(savedReport);
}
```

### é˜¶æ®µ4: AIåˆ†æå±‚ä¿®æ”¹ï¼ˆâ³ å¾…å®Œæˆï¼‰

#### æ–‡ä»¶ï¼š`AIAnalysisService.java`

**éœ€è¦ä¿®æ”¹çš„æ–¹æ³•**:

`updateWeeklyReportStatus(reportId, analysisResultId)` - AIåˆ†æå®Œæˆåçš„çŠ¶æ€æ›´æ–°

**ä¿®æ”¹è¦ç‚¹**:
- ä½¿ç”¨æ‚²è§‚é”åŠ è½½å‘¨æŠ¥ï¼š`findByIdForUpdate(reportId)`
- çŠ¶æ€æ£€æŸ¥ï¼šå¿…é¡»æ˜¯ `ProcessingStatus.AI_PROCESSING`
- è°ƒç”¨æ–°æ–¹æ³•ï¼š`report.completeAIAnalysis(confidence, threshold)`
- æ ¹æ®ç½®ä¿¡åº¦è‡ªåŠ¨å†³å®šï¼š
  - `â‰¥ threshold` â†’ è¿›å…¥ `PENDING_REVIEW`ï¼ˆç®¡ç†å‘˜å®¡æ ¸ï¼‰
  - `< threshold` â†’ æ‰“å› `DRAFT`ï¼ˆç”¨æˆ·ä¿®æ”¹ï¼‰
- å‘é€ç›¸åº”é€šçŸ¥

**ä¼ªä»£ç **:
```java
@Transactional
public void updateWeeklyReportStatus(Long reportId, Long analysisResultId) {
    WeeklyReport report = weeklyReportRepository.findByIdForUpdate(reportId)
        .orElseThrow(() -> new RuntimeException("å‘¨æŠ¥ä¸å­˜åœ¨: " + reportId));

    // çŠ¶æ€æ£€æŸ¥ï¼šå¿…é¡»æ˜¯AIå¤„ç†ä¸­
    if (report.getProcessingStatus() != WeeklyReport.ProcessingStatus.AI_PROCESSING) {
        logger.warn("âš ï¸ å‘¨æŠ¥çŠ¶æ€ä¸æ­£ç¡®ï¼Œé¢„æœŸ: AI_PROCESSING, å®é™…: {}",
            report.getProcessingStatus());
        return;
    }

    AIAnalysisResult analysisResult = aiAnalysisResultRepository.findById(analysisResultId)
        .orElseThrow(() -> new RuntimeException("AIåˆ†æç»“æœä¸å­˜åœ¨"));

    double confidence = analysisResult.getConfidence() != null ?
        analysisResult.getConfidence() : 0.0;

    logger.info("ğŸ” AIåˆ†æå®Œæˆï¼Œå‘¨æŠ¥ID: {}, ç½®ä¿¡åº¦: {}, é˜ˆå€¼: {}",
        reportId, confidence, weeklyReportConfidenceThreshold);

    // å…³è”AIåˆ†æç»“æœ
    report.setAiAnalysisId(analysisResultId);

    // è°ƒç”¨å®ä½“æ–¹æ³•å®ŒæˆAIåˆ†æ
    report.completeAIAnalysis(confidence, weeklyReportConfidenceThreshold);

    if (report.isPendingReview()) {
        logger.info("âœ… AIåˆ†æé€šè¿‡ï¼Œè¿›å…¥ç®¡ç†å‘˜å®¡æ ¸é˜Ÿåˆ—ï¼Œå‘¨æŠ¥ID: {}", reportId);
        weeklyReportNotificationService.handleAIAnalysisCompleted(reportId);
    } else {
        report.setRejectionReason(String.format(
            "AIåˆ†æç½®ä¿¡åº¦è¿‡ä½(%.0f%%)ï¼Œä½äºé˜ˆå€¼(%.0f%%)ã€‚å»ºè®®å®Œå–„å†…å®¹åé‡æ–°æäº¤ã€‚",
            confidence * 100,
            weeklyReportConfidenceThreshold * 100
        ));
        logger.info("ğŸš« AIåˆ†æç½®ä¿¡åº¦ä¸è¶³ï¼Œå·²æ‰“å›è‰ç¨¿ï¼Œå‘¨æŠ¥ID: {}", reportId);
        weeklyReportNotificationService.handleAIRejected(reportId, report.getRejectionReason());
    }

    weeklyReportRepository.save(report);
}
```

### é˜¶æ®µ5: Controllerå±‚ä¿®æ”¹ï¼ˆâ³ å¾…å®Œæˆï¼‰

#### æ–‡ä»¶ï¼š`WeeklyReportController.java`

**éœ€è¦ä¿®æ”¹çš„æ¥å£**:

1. **POST `/weekly-reports`** - åˆ›å»ºè‰ç¨¿
   ```java
   @PostMapping
   @Operation(summary = "åˆ›å»ºå‘¨æŠ¥è‰ç¨¿", description = "åˆ›å»ºä¸€ä»½æ–°çš„å‘¨æŠ¥è‰ç¨¿ï¼Œä¸ä¼šè§¦å‘å®¡æ ¸æµç¨‹")
   public ResponseEntity<ApiResponse<WeeklyReportResponse>> createDraft(
           @Valid @RequestBody WeeklyReportCreateRequest request) {
       WeeklyReportResponse response = weeklyReportService.createDraft(request);
       return ResponseEntity.ok(ApiResponse.success(response, "è‰ç¨¿å·²ä¿å­˜"));
   }
   ```

2. **PUT `/weekly-reports/{id}/draft`** - æ›´æ–°è‰ç¨¿
   ```java
   @PutMapping("/{id}/draft")
   @Operation(summary = "æ›´æ–°å‘¨æŠ¥è‰ç¨¿", description = "æ›´æ–°è‰ç¨¿å†…å®¹ï¼Œåªèƒ½ä¿®æ”¹è‰ç¨¿çŠ¶æ€çš„å‘¨æŠ¥")
   public ResponseEntity<ApiResponse<WeeklyReportResponse>> updateDraft(
           @PathVariable Long id,
           @Valid @RequestBody WeeklyReportUpdateRequest request) {
       WeeklyReportResponse response = weeklyReportService.updateDraft(id, request);
       return ResponseEntity.ok(ApiResponse.success(response, "è‰ç¨¿å·²æ›´æ–°"));
   }
   ```

3. **POST `/weekly-reports/{id}/submit`** - æäº¤å®¡æ ¸ï¼ˆæ–°å¢ï¼‰
   ```java
   @PostMapping("/{id}/submit")
   @Operation(summary = "æäº¤å‘¨æŠ¥å®¡æ ¸", description = "æäº¤è‰ç¨¿è¿›è¡ŒAIåˆ†æå’Œäººå·¥å®¡æ ¸")
   public ResponseEntity<ApiResponse<WeeklyReportResponse>> submitForReview(
           @PathVariable Long id) {
       WeeklyReportResponse response = weeklyReportService.submitForReview(id);
       return ResponseEntity.ok(ApiResponse.success(response, "å‘¨æŠ¥å·²æäº¤å®¡æ ¸"));
   }
   ```

4. **GET `/weekly-reports/my-drafts`** - è·å–æˆ‘çš„è‰ç¨¿ï¼ˆæ–°å¢ï¼‰
   ```java
   @GetMapping("/my-drafts")
   @Operation(summary = "è·å–æˆ‘çš„è‰ç¨¿", description = "è·å–å½“å‰ç”¨æˆ·æ‰€æœ‰è‰ç¨¿çŠ¶æ€çš„å‘¨æŠ¥")
   public ResponseEntity<ApiResponse<List<WeeklyReportListResponse>>> getMyDrafts() {
       User currentUser = getCurrentUser();
       List<WeeklyReport> drafts = weeklyReportRepository.findByUserIdAndEditStatus(
           currentUser.getId(), WeeklyReport.EditStatus.DRAFT
       );
       List<WeeklyReportListResponse> responses = drafts.stream()
           .map(this::convertToListResponse)
           .collect(Collectors.toList());
       return ResponseEntity.ok(ApiResponse.success(responses));
   }
   ```

5. **GET `/weekly-reports/my-submitted`** - è·å–æˆ‘çš„å·²æäº¤å‘¨æŠ¥ï¼ˆæ–°å¢ï¼‰
   ```java
   @GetMapping("/my-submitted")
   @Operation(summary = "è·å–æˆ‘çš„å·²æäº¤å‘¨æŠ¥", description = "è·å–å½“å‰ç”¨æˆ·æ‰€æœ‰å·²æäº¤çš„å‘¨æŠ¥")
   public ResponseEntity<ApiResponse<List<WeeklyReportListResponse>>> getMySubmitted() {
       User currentUser = getCurrentUser();
       List<WeeklyReport> submitted = weeklyReportRepository.findByUserIdAndEditStatus(
           currentUser.getId(), WeeklyReport.EditStatus.SUBMITTED
       );
       List<WeeklyReportListResponse> responses = submitted.stream()
           .map(this::convertToListResponse)
           .collect(Collectors.toList());
       return ResponseEntity.ok(ApiResponse.success(responses));
   }
   ```

6. **GET `/weekly-reports/pending-review`** - è·å–å¾…å®¡æ ¸å‘¨æŠ¥ï¼ˆç®¡ç†å‘˜ï¼‰
   ```java
   @GetMapping("/pending-review")
   @Operation(summary = "è·å–å¾…å®¡æ ¸å‘¨æŠ¥", description = "ç®¡ç†å‘˜è·å–æ‰€æœ‰å¾…å®¡æ ¸çš„å‘¨æŠ¥")
   @PreAuthorize("hasAnyRole('ADMIN', 'SUPER_ADMIN')")
   public ResponseEntity<ApiResponse<List<WeeklyReportListResponse>>> getPendingReview() {
       List<WeeklyReport> pending = weeklyReportRepository.findByApprovalStatus(
           WeeklyReport.ApprovalStatus.PENDING_REVIEW
       );
       List<WeeklyReportListResponse> responses = pending.stream()
           .map(this::convertToListResponse)
           .collect(Collectors.toList());
       return ResponseEntity.ok(ApiResponse.success(responses));
   }
   ```

### DTOå±‚ä¿®æ”¹ï¼ˆâ³ å¾…å®Œæˆï¼‰

#### æ–‡ä»¶ï¼š`WeeklyReportResponse.java` å’Œ `WeeklyReportListResponse.java`

**éœ€è¦æ·»åŠ çš„å­—æ®µ**:
```java
private String editStatus;          // ç¼–è¾‘çŠ¶æ€ï¼šDRAFT/SUBMITTED
private String processingStatus;    // å¤„ç†çŠ¶æ€ï¼šPENDING/AI_PROCESSING/AI_COMPLETED/AI_FAILED
// approval_status ä¿æŒä¸å˜ï¼Œä½†å€¼å·²æ›´æ–°ä¸ºï¼šNOT_STARTED/PENDING_REVIEW/APPROVED/REJECTED
```

---

## å®Œæ•´çŠ¶æ€è½¬æ¢æµç¨‹

### ç”¨æˆ·æ­£å¸¸æµç¨‹

```
1. ç”¨æˆ·åˆ›å»ºå‘¨æŠ¥
   POST /weekly-reports
   â†“
   EditStatus = DRAFT
   ProcessingStatus = PENDING
   ApprovalStatus = NOT_STARTED
   â†“
   ç”¨æˆ·å¯ä»¥åå¤ç¼–è¾‘ï¼šPUT /weekly-reports/{id}/draft

2. ç”¨æˆ·æäº¤å®¡æ ¸
   POST /weekly-reports/{id}/submit
   â†“
   EditStatus = SUBMITTEDï¼ˆé”å®šç¼–è¾‘ï¼‰
   ProcessingStatus = AI_PROCESSING
   ApprovalStatus = NOT_STARTED
   â†“
   åç«¯è§¦å‘AIåˆ†æï¼ˆå¼‚æ­¥ï¼‰

3. AIåˆ†æå®Œæˆ
   â†“
   ProcessingStatus = AI_COMPLETED
   â†“
   ç½®ä¿¡åº¦åˆ¤æ–­ï¼š

   â”œâ”€ ç½®ä¿¡åº¦ â‰¥ 70%
   â”‚  â†“
   â”‚  ApprovalStatus = PENDING_REVIEW
   â”‚  â†“
   â”‚  è¿›å…¥ç®¡ç†å‘˜å®¡æ ¸é˜Ÿåˆ—
   â”‚  â†“
   â”‚  ç®¡ç†å‘˜å®¡æ ¸ï¼š
   â”‚  â”œâ”€ é€šè¿‡ï¼šApprovalStatus = APPROVEDï¼ˆå®Œæˆï¼‰
   â”‚  â””â”€ æ‹’ç»ï¼šApprovalStatus = REJECTED
   â”‚           EditStatus = DRAFTï¼ˆè§£é”ç¼–è¾‘ï¼‰
   â”‚           ProcessingStatus = PENDING
   â”‚           â†“
   â”‚           ç”¨æˆ·ä¿®æ”¹åé‡æ–°æäº¤
   â”‚
   â””â”€ ç½®ä¿¡åº¦ < 70%
      â†“
      EditStatus = DRAFTï¼ˆæ‰“å›è‰ç¨¿ï¼‰
      ApprovalStatus = NOT_STARTED
      â†“
      ç”¨æˆ·ä¿®æ”¹åé‡æ–°æäº¤
```

### AIåˆ†æå¤±è´¥æµç¨‹

```
AIåˆ†æè¿‡ç¨‹ä¸­å‡ºé”™
â†“
ProcessingStatus = AI_FAILED
EditStatus = DRAFTï¼ˆè§£é”ç¼–è¾‘ï¼‰
ApprovalStatus = NOT_STARTED
â†“
é€šçŸ¥ç”¨æˆ·ä¿®æ”¹åé‡æ–°æäº¤
```

---

## å‰ç«¯éœ€è¦é…åˆçš„ä¿®æ”¹

### 1. åˆ›å»ºå‘¨æŠ¥é¡µé¢

**ç°çŠ¶**: "åˆ›å»º"æŒ‰é’®ç«‹å³æäº¤å®¡æ ¸
**æ”¹è¿›**:
- æ”¹ä¸º"ä¿å­˜è‰ç¨¿"æŒ‰é’® â†’ è°ƒç”¨ `POST /weekly-reports`
- è‰ç¨¿ä¿å­˜åè·³è½¬åˆ°è‰ç¨¿åˆ—è¡¨

### 2. è‰ç¨¿åˆ—è¡¨é¡µé¢ï¼ˆæ–°å¢ï¼‰

**è·¯ç”±**: `/reports/my-drafts`
**API**: `GET /weekly-reports/my-drafts`
**åŠŸèƒ½**:
- æ˜¾ç¤ºæ‰€æœ‰è‰ç¨¿çŠ¶æ€çš„å‘¨æŠ¥
- æ¯ä¸ªè‰ç¨¿æœ‰"ç¼–è¾‘"å’Œ"æäº¤å®¡æ ¸"æŒ‰é’®
- "ç¼–è¾‘"æŒ‰é’® â†’ è·³è½¬ç¼–è¾‘é¡µ
- "æäº¤å®¡æ ¸"æŒ‰é’® â†’ è°ƒç”¨ `POST /weekly-reports/{id}/submit`

### 3. ç¼–è¾‘è‰ç¨¿é¡µé¢

**è·¯ç”±**: `/reports/{id}/edit`
**æ¡ä»¶**: åªèƒ½ç¼–è¾‘ `editStatus = DRAFT` çš„å‘¨æŠ¥
**æŒ‰é’®**:
- "ä¿å­˜è‰ç¨¿" â†’ `PUT /weekly-reports/{id}/draft`
- "æäº¤å®¡æ ¸" â†’ `POST /weekly-reports/{id}/submit`

### 4. å·²æäº¤å‘¨æŠ¥åˆ—è¡¨

**è·¯ç”±**: `/reports/my-submitted`
**API**: `GET /weekly-reports/my-submitted`
**æ˜¾ç¤º**:
- æ‰€æœ‰ `editStatus = SUBMITTED` çš„å‘¨æŠ¥
- æ˜¾ç¤ºå¤„ç†çŠ¶æ€ï¼šAIåˆ†æä¸­/å¾…å®¡æ ¸/å·²é€šè¿‡/å·²æ‹’ç»

### 5. ç®¡ç†å‘˜å®¡æ ¸é¡µé¢

**è·¯ç”±**: `/admin/reports/pending-review`
**API**: `GET /weekly-reports/pending-review`
**æ¡ä»¶**: åªæ˜¾ç¤º `approvalStatus = PENDING_REVIEW` çš„å‘¨æŠ¥

---

## æµ‹è¯•æ£€æŸ¥æ¸…å•

### æ•°æ®åº“å±‚æµ‹è¯•
- [ ] æ‰§è¡Œè¿ç§»SQLæˆåŠŸ
- [ ] æ—§æ•°æ®æ­£ç¡®è¿ç§»åˆ°æ–°çŠ¶æ€
- [ ] ç´¢å¼•åˆ›å»ºæˆåŠŸ
- [ ] æŸ¥è¯¢æ€§èƒ½ç¬¦åˆé¢„æœŸ

### å®ä½“å±‚æµ‹è¯•
- [ ] çŠ¶æ€æšä¸¾æ­£ç¡®å®šä¹‰
- [ ] çŠ¶æ€è½¬æ¢æ–¹æ³•æŒ‰é¢„æœŸå·¥ä½œ
- [ ] å¼‚å¸¸åœºæ™¯æ­£ç¡®æŠ›å‡ºIllegalStateException

### Repositoryå±‚æµ‹è¯•
- [ ] æ–°å¢æŸ¥è¯¢æ–¹æ³•è¿”å›æ­£ç¡®ç»“æœ
- [ ] æ‚²è§‚é”æŸ¥è¯¢æ­£ç¡®åŠ é”
- [ ] ç»„åˆæŸ¥è¯¢æ¡ä»¶æ­£ç¡®

### Serviceå±‚æµ‹è¯•
- [ ] åˆ›å»ºè‰ç¨¿ä¸è§¦å‘AIåˆ†æ
- [ ] æäº¤å®¡æ ¸è§¦å‘AIåˆ†æ
- [ ] ç®¡ç†å‘˜å®¡æ ¸é€»è¾‘æ­£ç¡®
- [ ] AIåˆ†æå®Œæˆå¤„ç†æ­£ç¡®

### Controllerå±‚æµ‹è¯•
- [ ] åˆ›å»ºè‰ç¨¿APIè¿”å›æ­£ç¡®
- [ ] æäº¤å®¡æ ¸APIè¿”å›æ­£ç¡®
- [ ] è‰ç¨¿åˆ—è¡¨APIè¿”å›æ­£ç¡®
- [ ] å·²æäº¤åˆ—è¡¨APIè¿”å›æ­£ç¡®
- [ ] å¾…å®¡æ ¸åˆ—è¡¨APIè¿”å›æ­£ç¡®ï¼ˆç®¡ç†å‘˜ï¼‰

### é›†æˆæµ‹è¯•
- [ ] å®Œæ•´æµç¨‹ï¼šåˆ›å»ºâ†’ç¼–è¾‘â†’æäº¤â†’AIåˆ†æâ†’å®¡æ ¸
- [ ] æ‹’ç»æµç¨‹ï¼šåˆ›å»ºâ†’æäº¤â†’AIæ‹’ç»â†’ä¿®æ”¹â†’é‡æ–°æäº¤
- [ ] ç®¡ç†å‘˜æ‹’ç»æµç¨‹ï¼š...â†’å®¡æ ¸æ‹’ç»â†’ä¿®æ”¹â†’é‡æ–°æäº¤

---

## é£é™©å’Œæ³¨æ„äº‹é¡¹

### å…¼å®¹æ€§é£é™©
- **æ—§ä»£ç è°ƒç”¨**: æŸäº›ä»£ç å¯èƒ½ç›´æ¥ä½¿ç”¨æ—§çš„æšä¸¾å€¼ï¼ˆå¦‚ `AI_ANALYZING`ï¼‰
- **ç¼“è§£æªæ–½**: ç¼–è¯‘æ£€æŸ¥ä¼šå‘ç°è¿™äº›é—®é¢˜ï¼Œéœ€è¦é€ä¸€ä¿®å¤

### æ•°æ®è¿ç§»é£é™©
- **æ•°æ®ä¸¢å¤±**: è¿ç§»è¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°æ•°æ®ä¸¢å¤±
- **ç¼“è§£æªæ–½**: è¿ç§»å‰å¤‡ä»½æ•°æ®åº“ï¼Œæä¾›å›æ»šè„šæœ¬

### å¹¶å‘é—®é¢˜
- **çŠ¶æ€ç«äº‰**: å¤šä¸ªçº¿ç¨‹åŒæ—¶æ›´æ–°å‘¨æŠ¥çŠ¶æ€
- **ç¼“è§£æªæ–½**: ä½¿ç”¨æ‚²è§‚é” (`findByIdForUpdate`)

### å‰ç«¯å…¼å®¹æ€§
- **APIå˜æ›´**: å‰ç«¯ä¾èµ–çš„APIå“åº”ç»“æ„å˜åŒ–
- **ç¼“è§£æªæ–½**: é€æ­¥è¿ç§»ï¼Œä¿ç•™æ—§APIä¸€æ®µæ—¶é—´

---

## å›æ»šæ–¹æ¡ˆ

å¦‚æœä¿®å¤åå‘ç°ä¸¥é‡é—®é¢˜ï¼Œå¯ä»¥æŒ‰ä»¥ä¸‹æ­¥éª¤å›æ»šï¼š

### 1. æ•°æ®åº“å›æ»š

```sql
-- å›æ»šæ­¥éª¤1ï¼šæ¢å¤æ—§çš„ approval_status æšä¸¾
ALTER TABLE weekly_reports
MODIFY COLUMN approval_status VARCHAR(20) NOT NULL;

UPDATE weekly_reports
SET approval_status = CASE
    WHEN edit_status = 'DRAFT' AND processing_status = 'AI_PROCESSING' THEN 'AI_ANALYZING'
    WHEN edit_status = 'DRAFT' AND approval_status = 'NOT_STARTED' THEN 'AI_REJECTED'
    WHEN approval_status = 'PENDING_REVIEW' THEN 'ADMIN_REVIEWING'
    WHEN approval_status = 'APPROVED' THEN 'ADMIN_APPROVED'
    WHEN approval_status = 'REJECTED' THEN 'ADMIN_REJECTED'
    ELSE 'AI_ANALYZING'
END;

ALTER TABLE weekly_reports
MODIFY COLUMN approval_status ENUM('AI_ANALYZING', 'AI_REJECTED', 'ADMIN_REVIEWING', 'ADMIN_APPROVED', 'ADMIN_REJECTED')
NOT NULL DEFAULT 'AI_ANALYZING';

-- å›æ»šæ­¥éª¤2ï¼šåˆ é™¤æ–°å¢å­—æ®µ
ALTER TABLE weekly_reports
DROP COLUMN edit_status,
DROP COLUMN processing_status;

-- å›æ»šæ­¥éª¤3ï¼šåˆ é™¤æ–°å¢ç´¢å¼•
DROP INDEX idx_edit_status ON weekly_reports;
DROP INDEX idx_processing_status ON weekly_reports;
DROP INDEX idx_user_edit_status ON weekly_reports;
DROP INDEX idx_approval_processing ON weekly_reports;
```

### 2. ä»£ç å›æ»š

- ä»Gitæ¢å¤ä¿®æ”¹å‰çš„ç‰ˆæœ¬
- åˆ é™¤ `V35__Separate_Draft_From_Approval_Status.sql` è¿ç§»è„šæœ¬

---

## æ€»ç»“

**å·²å®Œæˆ**:
- âœ… æ•°æ®åº“å±‚å®Œå…¨é‡æ„ï¼ˆæ–°å¢ä¸¤ä¸ªçŠ¶æ€å­—æ®µï¼Œä¿®æ”¹approval_statusæšä¸¾ï¼‰
- âœ… å®ä½“å±‚å®Œå…¨é‡æ„ï¼ˆä¸‰ä¸ªçŠ¶æ€æšä¸¾ï¼ŒçŠ¶æ€è½¬æ¢æ–¹æ³•ï¼‰
- âœ… Repositoryå±‚æ‰©å±•ï¼ˆæ–°å¢10+æŸ¥è¯¢æ–¹æ³•ï¼‰

**å¾…å®Œæˆ**:
- â³ Serviceå±‚é‡æ„ï¼ˆåˆ›å»ºè‰ç¨¿ã€æäº¤å®¡æ ¸ã€ç®¡ç†å‘˜å®¡æ ¸ï¼‰
- â³ AIåˆ†æå±‚é‡æ„ï¼ˆAIå®Œæˆåçš„çŠ¶æ€å¤„ç†ï¼‰
- â³ Controllerå±‚é‡æ„ï¼ˆæ–°å¢è‰ç¨¿APIï¼Œä¿®æ”¹ç°æœ‰APIï¼‰
- â³ DTOå±‚æ›´æ–°ï¼ˆå“åº”å¯¹è±¡æ·»åŠ æ–°çŠ¶æ€å­—æ®µï¼‰
- â³ é€šçŸ¥å±‚æ›´æ–°ï¼ˆçŠ¶æ€å˜æ›´é€šçŸ¥é€»è¾‘ï¼‰

**é¢„è®¡å‰©ä½™å·¥ä½œé‡**: 6-8å°æ—¶

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**:
1. ç»§ç»­å®ŒæˆServiceå±‚çš„ `createDraft` å’Œ `submitForReview` æ–¹æ³•
2. ä¿®æ”¹AIAnalysisServiceçš„ `updateWeeklyReportStatus` æ–¹æ³•
3. ä¿®æ”¹Controllerå±‚çš„ç›¸å…³æ¥å£
4. æ›´æ–°DTOå“åº”å¯¹è±¡
5. å…¨é¢æµ‹è¯•

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2025-01-16
**ç›¸å…³æ–‡æ¡£**:
- `å‘¨æŠ¥è‰ç¨¿ä¸å®¡æ ¸æµç¨‹åˆ†ç¦»è®¾è®¡_20250116.md` - è®¾è®¡æ–¹æ¡ˆ
- `V35__Separate_Draft_From_Approval_Status.sql` - æ•°æ®åº“è¿ç§»è„šæœ¬
