# 周报草稿状态分离修复进展

**修复日期**: 2025-01-16
**目标**: 实现草稿状态与审核流程的完全分离
**参考文档**: `周报草稿与审核流程分离设计_20250116.md`

---

## 修复状态总览

### ✅ 已完成部分（阶段1-2）

| 层级 | 修改内容 | 状态 | 文件 |
|------|---------|-----|------|
| 数据库层 | 数据库迁移SQL | ✅ 完成 | `V35__Separate_Draft_From_Approval_Status.sql` |
| 实体层 | 三层状态枚举 | ✅ 完成 | `WeeklyReport.java` |
| 实体层 | 状态字段和getter/setter | ✅ 完成 | `WeeklyReport.java` |
| 实体层 | 状态转换方法 | ✅ 完成 | `WeeklyReport.java` |
| 实体层 | 辅助判断方法 | ✅ 完成 | `WeeklyReport.java` |
| Repository层 | 新增查询方法 | ✅ 完成 | `WeeklyReportRepository.java` |

### ⏳ 待完成部分（阶段3-5）

| 层级 | 修改内容 | 状态 | 预计工作量 |
|------|---------|-----|-----------|
| Service层 | 创建草稿和更新草稿逻辑 | ⏳ 待完成 | 2小时 |
| Service层 | 提交审核流程 | ⏳ 待完成 | 1小时 |
| Service层 | 管理员审核逻辑 | ⏳ 待完成 | 1小时 |
| AI分析层 | AI分析完成处理 | ⏳ 待完成 | 1小时 |
| Controller层 | 草稿和提交API | ⏳ 待完成 | 1.5小时 |
| 通知层 | 状态变更通知 | ⏳ 待完成 | 0.5小时 |
| DTO层 | 响应对象更新 | ⏳ 待完成 | 0.5小时 |

---

## 阶段1: 数据库层修改（✅ 已完成）

### 文件：`V35__Separate_Draft_From_Approval_Status.sql`

**功能**:
- 添加 `edit_status` 字段（DRAFT/SUBMITTED）
- 添加 `processing_status` 字段（PENDING/AI_PROCESSING/AI_COMPLETED/AI_FAILED）
- 修改 `approval_status` 枚举值（NOT_STARTED/PENDING_REVIEW/APPROVED/REJECTED）
- 数据迁移逻辑（旧状态 → 新状态）
- 创建索引优化查询

**数据迁移映射**:
```sql
旧 approval_status → 新状态组合:

AI_ANALYZING → edit_status=DRAFT, processing_status=AI_PROCESSING, approval_status=NOT_STARTED
AI_REJECTED → edit_status=DRAFT, processing_status=AI_COMPLETED, approval_status=NOT_STARTED
ADMIN_REVIEWING → edit_status=SUBMITTED, processing_status=AI_COMPLETED, approval_status=PENDING_REVIEW
ADMIN_APPROVED → edit_status=SUBMITTED, processing_status=AI_COMPLETED, approval_status=APPROVED
ADMIN_REJECTED → edit_status=SUBMITTED, processing_status=AI_COMPLETED, approval_status=REJECTED
```

---

## 阶段2: 实体层和Repository层修改（✅ 已完成）

### 文件：`WeeklyReport.java`

**新增枚举**:

```java
// 编辑状态枚举 - 用户视角
public enum EditStatus {
    DRAFT("草稿"),          // 草稿：用户正在编辑，未提交审核
    SUBMITTED("已提交");    // 已提交：用户完成编辑，进入审核流程
}

// 处理状态枚举 - 系统视角
public enum ProcessingStatus {
    PENDING("待处理"),              // 待处理：等待AI分析
    AI_PROCESSING("AI分析中"),      // AI分析中：正在进行AI分析
    AI_COMPLETED("AI分析完成"),     // AI完成：分析完成，待审核
    AI_FAILED("AI分析失败");        // AI失败：分析出错
}

// 审核状态枚举 - 管理员视角（已修改）
public enum ApprovalStatus {
    NOT_STARTED("未开始审核"),      // 未开始：尚未进入审核流程
    PENDING_REVIEW("待审核"),       // 待审核：等待管理员审核
    APPROVED("审核通过"),           // 已通过：审核通过
    REJECTED("审核拒绝");           // 已拒绝：审核不通过
}
```

**新增字段**:
```java
@Enumerated(EnumType.STRING)
@Column(name = "edit_status", nullable = false, length = 20)
private EditStatus editStatus = EditStatus.DRAFT;

@Enumerated(EnumType.STRING)
@Column(name = "processing_status", nullable = false, length = 30)
private ProcessingStatus processingStatus = ProcessingStatus.PENDING;

@Enumerated(EnumType.STRING)
@Column(name = "approval_status", length = 20, nullable = false)
private ApprovalStatus approvalStatus = ApprovalStatus.NOT_STARTED;
```

**新增辅助方法**:
- `isDraft()` - 是否为草稿状态
- `isSubmitted()` - 是否已提交审核
- `isEditable()` - 是否可编辑
- `isAIProcessing()` - 是否正在AI处理中
- `isAICompleted()` - 是否已完成AI分析
- `isPendingReview()` - 是否待管理员审核
- `isApproved()` - 是否已审核通过
- `isRejected()` - 是否已被拒绝

**新增状态转换方法**:
- `submit()` - 提交周报进行审核
- `completeAIAnalysis(confidence, threshold)` - AI分析完成
- `adminApprove(reviewerId)` - 管理员审核通过
- `adminReject(reviewerId, reason)` - 管理员审核拒绝
- `markAIFailed()` - AI分析失败

### 文件：`WeeklyReportRepository.java`

**新增查询方法**:
```java
// 草稿相关查询
List<WeeklyReport> findByUserIdAndEditStatus(Long userId, EditStatus editStatus);
long countByUserIdAndEditStatus(Long userId, EditStatus editStatus);
List<WeeklyReport> findByEditStatusAndCreatedAtBefore(EditStatus editStatus, LocalDateTime before);

// 处理状态查询
List<WeeklyReport> findByProcessingStatus(ProcessingStatus processingStatus);
List<WeeklyReport> findRecentAIFailedReports(LocalDateTime since);

// 审核状态查询
List<WeeklyReport> findPendingReviewReports(ApprovalStatus status);

// 组合查询
List<WeeklyReport> findByUserAndStatusAndDateRange(...);
List<Object[]> countByUserIdGroupByEditStatus(Long userId);
Page<WeeklyReport> findByUserIdAndEditStatus(Long userId, EditStatus editStatus, Pageable pageable);
```

---

## 阶段3-5: 待完成修改

### 阶段3: Service层修改（⏳ 待完成）

#### 文件：`WeeklyReportService.java`

**需要修改的方法**:

1. **createWeeklyReport()** - 创建草稿
   - 移除自动触发AI分析的逻辑
   - 设置初始状态为 DRAFT/PENDING/NOT_STARTED
   - 日志说明"草稿已保存"

2. **updateWeeklyReport()** - 更新草稿
   - 添加状态检查：只能更新草稿状态的周报
   - 权限检查：只能修改自己的周报

3. **submitForReview()** - 新增方法：提交审核
   - 状态检查：只能提交草稿
   - 内容完整性校验
   - 调用 `report.submit()` 转换状态
   - 触发AI分析
   - 日志说明"已提交审核"

4. **adminApprove()** - 管理员审核通过
   - 使用新的 `report.adminApprove(reviewerId)` 方法
   - 更新状态检查逻辑

5. **adminReject()** - 管理员审核拒绝
   - 使用新的 `report.adminReject(reviewerId, reason)` 方法
   - 自动解锁编辑状态

**伪代码示例**:

```java
// 创建草稿（不触发AI分析）
@Transactional
public WeeklyReportResponse createDraft(WeeklyReportCreateRequest request) {
    User currentUser = getCurrentUser();
    validateCreatePermission(currentUser, request);

    WeeklyReport weeklyReport = new WeeklyReport();
    // ... 设置各种属性 ...

    // 明确设置为草稿状态
    weeklyReport.setEditStatus(WeeklyReport.EditStatus.DRAFT);
    weeklyReport.setProcessingStatus(WeeklyReport.ProcessingStatus.PENDING);
    weeklyReport.setApprovalStatus(WeeklyReport.ApprovalStatus.NOT_STARTED);

    processTaskReports(weeklyReport, request);
    WeeklyReport savedReport = weeklyReportRepository.save(weeklyReport);

    logger.info("✅ 周报草稿已创建，周报ID: {}, 用户ID: {}",
        savedReport.getId(), currentUser.getId());

    // ⚠️ 不触发AI分析
    return convertToResponse(savedReport);
}

// 提交审核（触发AI分析）
@Transactional
public WeeklyReportResponse submitForReview(Long reportId) {
    WeeklyReport report = weeklyReportRepository.findById(reportId)
        .orElseThrow(() -> new RuntimeException("周报不存在: " + reportId));

    // 权限检查
    User currentUser = getCurrentUser();
    if (!report.getUserId().equals(currentUser.getId())) {
        throw new RuntimeException("无权提交他人的周报");
    }

    // 状态检查：只能提交草稿
    if (!report.isDraft()) {
        throw new IllegalStateException(
            String.format("只能提交草稿状态的周报，当前状态: %s", report.getEditStatus())
        );
    }

    // 内容完整性检查
    validateReportCompleteness(report);

    // 提交周报（状态转换）
    report.submit();
    WeeklyReport savedReport = weeklyReportRepository.save(report);

    logger.info("📤 周报已提交审核，周报ID: {}, 用户ID: {}",
        reportId, currentUser.getId());

    // 触发AI分析
    triggerAIAnalysis(savedReport);

    return convertToResponse(savedReport);
}
```

### 阶段4: AI分析层修改（⏳ 待完成）

#### 文件：`AIAnalysisService.java`

**需要修改的方法**:

`updateWeeklyReportStatus(reportId, analysisResultId)` - AI分析完成后的状态更新

**修改要点**:
- 使用悲观锁加载周报：`findByIdForUpdate(reportId)`
- 状态检查：必须是 `ProcessingStatus.AI_PROCESSING`
- 调用新方法：`report.completeAIAnalysis(confidence, threshold)`
- 根据置信度自动决定：
  - `≥ threshold` → 进入 `PENDING_REVIEW`（管理员审核）
  - `< threshold` → 打回 `DRAFT`（用户修改）
- 发送相应通知

**伪代码**:
```java
@Transactional
public void updateWeeklyReportStatus(Long reportId, Long analysisResultId) {
    WeeklyReport report = weeklyReportRepository.findByIdForUpdate(reportId)
        .orElseThrow(() -> new RuntimeException("周报不存在: " + reportId));

    // 状态检查：必须是AI处理中
    if (report.getProcessingStatus() != WeeklyReport.ProcessingStatus.AI_PROCESSING) {
        logger.warn("⚠️ 周报状态不正确，预期: AI_PROCESSING, 实际: {}",
            report.getProcessingStatus());
        return;
    }

    AIAnalysisResult analysisResult = aiAnalysisResultRepository.findById(analysisResultId)
        .orElseThrow(() -> new RuntimeException("AI分析结果不存在"));

    double confidence = analysisResult.getConfidence() != null ?
        analysisResult.getConfidence() : 0.0;

    logger.info("🔍 AI分析完成，周报ID: {}, 置信度: {}, 阈值: {}",
        reportId, confidence, weeklyReportConfidenceThreshold);

    // 关联AI分析结果
    report.setAiAnalysisId(analysisResultId);

    // 调用实体方法完成AI分析
    report.completeAIAnalysis(confidence, weeklyReportConfidenceThreshold);

    if (report.isPendingReview()) {
        logger.info("✅ AI分析通过，进入管理员审核队列，周报ID: {}", reportId);
        weeklyReportNotificationService.handleAIAnalysisCompleted(reportId);
    } else {
        report.setRejectionReason(String.format(
            "AI分析置信度过低(%.0f%%)，低于阈值(%.0f%%)。建议完善内容后重新提交。",
            confidence * 100,
            weeklyReportConfidenceThreshold * 100
        ));
        logger.info("🚫 AI分析置信度不足，已打回草稿，周报ID: {}", reportId);
        weeklyReportNotificationService.handleAIRejected(reportId, report.getRejectionReason());
    }

    weeklyReportRepository.save(report);
}
```

### 阶段5: Controller层修改（⏳ 待完成）

#### 文件：`WeeklyReportController.java`

**需要修改的接口**:

1. **POST `/weekly-reports`** - 创建草稿
   ```java
   @PostMapping
   @Operation(summary = "创建周报草稿", description = "创建一份新的周报草稿，不会触发审核流程")
   public ResponseEntity<ApiResponse<WeeklyReportResponse>> createDraft(
           @Valid @RequestBody WeeklyReportCreateRequest request) {
       WeeklyReportResponse response = weeklyReportService.createDraft(request);
       return ResponseEntity.ok(ApiResponse.success(response, "草稿已保存"));
   }
   ```

2. **PUT `/weekly-reports/{id}/draft`** - 更新草稿
   ```java
   @PutMapping("/{id}/draft")
   @Operation(summary = "更新周报草稿", description = "更新草稿内容，只能修改草稿状态的周报")
   public ResponseEntity<ApiResponse<WeeklyReportResponse>> updateDraft(
           @PathVariable Long id,
           @Valid @RequestBody WeeklyReportUpdateRequest request) {
       WeeklyReportResponse response = weeklyReportService.updateDraft(id, request);
       return ResponseEntity.ok(ApiResponse.success(response, "草稿已更新"));
   }
   ```

3. **POST `/weekly-reports/{id}/submit`** - 提交审核（新增）
   ```java
   @PostMapping("/{id}/submit")
   @Operation(summary = "提交周报审核", description = "提交草稿进行AI分析和人工审核")
   public ResponseEntity<ApiResponse<WeeklyReportResponse>> submitForReview(
           @PathVariable Long id) {
       WeeklyReportResponse response = weeklyReportService.submitForReview(id);
       return ResponseEntity.ok(ApiResponse.success(response, "周报已提交审核"));
   }
   ```

4. **GET `/weekly-reports/my-drafts`** - 获取我的草稿（新增）
   ```java
   @GetMapping("/my-drafts")
   @Operation(summary = "获取我的草稿", description = "获取当前用户所有草稿状态的周报")
   public ResponseEntity<ApiResponse<List<WeeklyReportListResponse>>> getMyDrafts() {
       User currentUser = getCurrentUser();
       List<WeeklyReport> drafts = weeklyReportRepository.findByUserIdAndEditStatus(
           currentUser.getId(), WeeklyReport.EditStatus.DRAFT
       );
       List<WeeklyReportListResponse> responses = drafts.stream()
           .map(this::convertToListResponse)
           .collect(Collectors.toList());
       return ResponseEntity.ok(ApiResponse.success(responses));
   }
   ```

5. **GET `/weekly-reports/my-submitted`** - 获取我的已提交周报（新增）
   ```java
   @GetMapping("/my-submitted")
   @Operation(summary = "获取我的已提交周报", description = "获取当前用户所有已提交的周报")
   public ResponseEntity<ApiResponse<List<WeeklyReportListResponse>>> getMySubmitted() {
       User currentUser = getCurrentUser();
       List<WeeklyReport> submitted = weeklyReportRepository.findByUserIdAndEditStatus(
           currentUser.getId(), WeeklyReport.EditStatus.SUBMITTED
       );
       List<WeeklyReportListResponse> responses = submitted.stream()
           .map(this::convertToListResponse)
           .collect(Collectors.toList());
       return ResponseEntity.ok(ApiResponse.success(responses));
   }
   ```

6. **GET `/weekly-reports/pending-review`** - 获取待审核周报（管理员）
   ```java
   @GetMapping("/pending-review")
   @Operation(summary = "获取待审核周报", description = "管理员获取所有待审核的周报")
   @PreAuthorize("hasAnyRole('ADMIN', 'SUPER_ADMIN')")
   public ResponseEntity<ApiResponse<List<WeeklyReportListResponse>>> getPendingReview() {
       List<WeeklyReport> pending = weeklyReportRepository.findByApprovalStatus(
           WeeklyReport.ApprovalStatus.PENDING_REVIEW
       );
       List<WeeklyReportListResponse> responses = pending.stream()
           .map(this::convertToListResponse)
           .collect(Collectors.toList());
       return ResponseEntity.ok(ApiResponse.success(responses));
   }
   ```

### DTO层修改（⏳ 待完成）

#### 文件：`WeeklyReportResponse.java` 和 `WeeklyReportListResponse.java`

**需要添加的字段**:
```java
private String editStatus;          // 编辑状态：DRAFT/SUBMITTED
private String processingStatus;    // 处理状态：PENDING/AI_PROCESSING/AI_COMPLETED/AI_FAILED
// approval_status 保持不变，但值已更新为：NOT_STARTED/PENDING_REVIEW/APPROVED/REJECTED
```

---

## 完整状态转换流程

### 用户正常流程

```
1. 用户创建周报
   POST /weekly-reports
   ↓
   EditStatus = DRAFT
   ProcessingStatus = PENDING
   ApprovalStatus = NOT_STARTED
   ↓
   用户可以反复编辑：PUT /weekly-reports/{id}/draft

2. 用户提交审核
   POST /weekly-reports/{id}/submit
   ↓
   EditStatus = SUBMITTED（锁定编辑）
   ProcessingStatus = AI_PROCESSING
   ApprovalStatus = NOT_STARTED
   ↓
   后端触发AI分析（异步）

3. AI分析完成
   ↓
   ProcessingStatus = AI_COMPLETED
   ↓
   置信度判断：

   ├─ 置信度 ≥ 70%
   │  ↓
   │  ApprovalStatus = PENDING_REVIEW
   │  ↓
   │  进入管理员审核队列
   │  ↓
   │  管理员审核：
   │  ├─ 通过：ApprovalStatus = APPROVED（完成）
   │  └─ 拒绝：ApprovalStatus = REJECTED
   │           EditStatus = DRAFT（解锁编辑）
   │           ProcessingStatus = PENDING
   │           ↓
   │           用户修改后重新提交
   │
   └─ 置信度 < 70%
      ↓
      EditStatus = DRAFT（打回草稿）
      ApprovalStatus = NOT_STARTED
      ↓
      用户修改后重新提交
```

### AI分析失败流程

```
AI分析过程中出错
↓
ProcessingStatus = AI_FAILED
EditStatus = DRAFT（解锁编辑）
ApprovalStatus = NOT_STARTED
↓
通知用户修改后重新提交
```

---

## 前端需要配合的修改

### 1. 创建周报页面

**现状**: "创建"按钮立即提交审核
**改进**:
- 改为"保存草稿"按钮 → 调用 `POST /weekly-reports`
- 草稿保存后跳转到草稿列表

### 2. 草稿列表页面（新增）

**路由**: `/reports/my-drafts`
**API**: `GET /weekly-reports/my-drafts`
**功能**:
- 显示所有草稿状态的周报
- 每个草稿有"编辑"和"提交审核"按钮
- "编辑"按钮 → 跳转编辑页
- "提交审核"按钮 → 调用 `POST /weekly-reports/{id}/submit`

### 3. 编辑草稿页面

**路由**: `/reports/{id}/edit`
**条件**: 只能编辑 `editStatus = DRAFT` 的周报
**按钮**:
- "保存草稿" → `PUT /weekly-reports/{id}/draft`
- "提交审核" → `POST /weekly-reports/{id}/submit`

### 4. 已提交周报列表

**路由**: `/reports/my-submitted`
**API**: `GET /weekly-reports/my-submitted`
**显示**:
- 所有 `editStatus = SUBMITTED` 的周报
- 显示处理状态：AI分析中/待审核/已通过/已拒绝

### 5. 管理员审核页面

**路由**: `/admin/reports/pending-review`
**API**: `GET /weekly-reports/pending-review`
**条件**: 只显示 `approvalStatus = PENDING_REVIEW` 的周报

---

## 测试检查清单

### 数据库层测试
- [ ] 执行迁移SQL成功
- [ ] 旧数据正确迁移到新状态
- [ ] 索引创建成功
- [ ] 查询性能符合预期

### 实体层测试
- [ ] 状态枚举正确定义
- [ ] 状态转换方法按预期工作
- [ ] 异常场景正确抛出IllegalStateException

### Repository层测试
- [ ] 新增查询方法返回正确结果
- [ ] 悲观锁查询正确加锁
- [ ] 组合查询条件正确

### Service层测试
- [ ] 创建草稿不触发AI分析
- [ ] 提交审核触发AI分析
- [ ] 管理员审核逻辑正确
- [ ] AI分析完成处理正确

### Controller层测试
- [ ] 创建草稿API返回正确
- [ ] 提交审核API返回正确
- [ ] 草稿列表API返回正确
- [ ] 已提交列表API返回正确
- [ ] 待审核列表API返回正确（管理员）

### 集成测试
- [ ] 完整流程：创建→编辑→提交→AI分析→审核
- [ ] 拒绝流程：创建→提交→AI拒绝→修改→重新提交
- [ ] 管理员拒绝流程：...→审核拒绝→修改→重新提交

---

## 风险和注意事项

### 兼容性风险
- **旧代码调用**: 某些代码可能直接使用旧的枚举值（如 `AI_ANALYZING`）
- **缓解措施**: 编译检查会发现这些问题，需要逐一修复

### 数据迁移风险
- **数据丢失**: 迁移过程中可能出现数据丢失
- **缓解措施**: 迁移前备份数据库，提供回滚脚本

### 并发问题
- **状态竞争**: 多个线程同时更新周报状态
- **缓解措施**: 使用悲观锁 (`findByIdForUpdate`)

### 前端兼容性
- **API变更**: 前端依赖的API响应结构变化
- **缓解措施**: 逐步迁移，保留旧API一段时间

---

## 回滚方案

如果修复后发现严重问题，可以按以下步骤回滚：

### 1. 数据库回滚

```sql
-- 回滚步骤1：恢复旧的 approval_status 枚举
ALTER TABLE weekly_reports
MODIFY COLUMN approval_status VARCHAR(20) NOT NULL;

UPDATE weekly_reports
SET approval_status = CASE
    WHEN edit_status = 'DRAFT' AND processing_status = 'AI_PROCESSING' THEN 'AI_ANALYZING'
    WHEN edit_status = 'DRAFT' AND approval_status = 'NOT_STARTED' THEN 'AI_REJECTED'
    WHEN approval_status = 'PENDING_REVIEW' THEN 'ADMIN_REVIEWING'
    WHEN approval_status = 'APPROVED' THEN 'ADMIN_APPROVED'
    WHEN approval_status = 'REJECTED' THEN 'ADMIN_REJECTED'
    ELSE 'AI_ANALYZING'
END;

ALTER TABLE weekly_reports
MODIFY COLUMN approval_status ENUM('AI_ANALYZING', 'AI_REJECTED', 'ADMIN_REVIEWING', 'ADMIN_APPROVED', 'ADMIN_REJECTED')
NOT NULL DEFAULT 'AI_ANALYZING';

-- 回滚步骤2：删除新增字段
ALTER TABLE weekly_reports
DROP COLUMN edit_status,
DROP COLUMN processing_status;

-- 回滚步骤3：删除新增索引
DROP INDEX idx_edit_status ON weekly_reports;
DROP INDEX idx_processing_status ON weekly_reports;
DROP INDEX idx_user_edit_status ON weekly_reports;
DROP INDEX idx_approval_processing ON weekly_reports;
```

### 2. 代码回滚

- 从Git恢复修改前的版本
- 删除 `V35__Separate_Draft_From_Approval_Status.sql` 迁移脚本

---

## 总结

**已完成**:
- ✅ 数据库层完全重构（新增两个状态字段，修改approval_status枚举）
- ✅ 实体层完全重构（三个状态枚举，状态转换方法）
- ✅ Repository层扩展（新增10+查询方法）

**待完成**:
- ⏳ Service层重构（创建草稿、提交审核、管理员审核）
- ⏳ AI分析层重构（AI完成后的状态处理）
- ⏳ Controller层重构（新增草稿API，修改现有API）
- ⏳ DTO层更新（响应对象添加新状态字段）
- ⏳ 通知层更新（状态变更通知逻辑）

**预计剩余工作量**: 6-8小时

**下一步行动**:
1. 继续完成Service层的 `createDraft` 和 `submitForReview` 方法
2. 修改AIAnalysisService的 `updateWeeklyReportStatus` 方法
3. 修改Controller层的相关接口
4. 更新DTO响应对象
5. 全面测试

---

**文档版本**: 1.0
**最后更新**: 2025-01-16
**相关文档**:
- `周报草稿与审核流程分离设计_20250116.md` - 设计方案
- `V35__Separate_Draft_From_Approval_Status.sql` - 数据库迁移脚本
