# å‘¨æŠ¥AIåˆ†æç½®ä¿¡åº¦é—®é¢˜åˆ†æ

**åˆ†ææ—¶é—´**: 2025-01-16
**åˆ†æèŒƒå›´**: å‘¨æŠ¥AIåˆ†æä¸å®¡æ‰¹æµç¨‹
**åˆ†æé‡ç‚¹**: ä½ç½®ä¿¡åº¦å‘¨æŠ¥çŠ¶æ€è½¬æ¢é€»è¾‘
**é—®é¢˜æè¿°**: å‘¨æŠ¥AIåˆ†æç½®ä¿¡åº¦æ¯”è¾ƒä½æ—¶ï¼Œä»ç„¶è·³è½¬åˆ°ADMIN_REVIEWINGçŠ¶æ€

---

## æ‰§è¡Œæ‘˜è¦

é€šè¿‡æ·±å…¥åˆ†æå‘¨æŠ¥AIåˆ†ææµç¨‹ï¼Œå‘ç°ç³»ç»Ÿåœ¨å¤„ç†ä½ç½®ä¿¡åº¦å‘¨æŠ¥æ—¶**å­˜åœ¨ä¸‰å±‚é˜²æŠ¤æœºåˆ¶**ï¼Œä½†**å¯èƒ½å­˜åœ¨ç›´æ¥è°ƒç”¨aiApprove()æ–¹æ³•ç»•è¿‡ç½®ä¿¡åº¦æ£€æŸ¥çš„é£é™©**ã€‚ç½®ä¿¡åº¦é˜ˆå€¼ç»Ÿä¸€è®¾ç½®ä¸º0.7ï¼Œä½äºé˜ˆå€¼åº”è¿›å…¥AI_REJECTEDçŠ¶æ€ï¼Œä½†å®é™…è¿è¡Œä¸­å¯èƒ½å› ä¸ºä¸åŒä»£ç è·¯å¾„çš„æ‰§è¡Œæ—¶åºæˆ–ç¼ºå°‘åŒæ­¥æœºåˆ¶ï¼Œå¯¼è‡´çŠ¶æ€è¢«é”™è¯¯è¦†ç›–ã€‚

**å…³é”®å‘ç°**ï¼š
- âœ… ä»£ç é€»è¾‘æœ¬èº«æ­£ç¡®å®ç°äº†ä½ç½®ä¿¡åº¦æ‹’ç»æœºåˆ¶
- âš ï¸ å­˜åœ¨å¤šä¸ªç‹¬ç«‹çš„çŠ¶æ€æ›´æ–°è·¯å¾„ï¼Œå¯èƒ½äº§ç”Ÿç«æ€æ¡ä»¶
- ğŸš¨ `aiApprove()`æ–¹æ³•æ— æ¡ä»¶è®¾ç½®çŠ¶æ€ï¼Œç¼ºå°‘ç½®ä¿¡åº¦å‰ç½®æ£€æŸ¥

---

## åˆ†æç›®æ ‡

æ˜ç¡®å‘¨æŠ¥AIåˆ†ææµç¨‹ä¸­ç½®ä¿¡åº¦æ£€æŸ¥æœºåˆ¶çš„å®Œæ•´æ€§ï¼Œè¯†åˆ«ä½ç½®ä¿¡åº¦å‘¨æŠ¥é”™è¯¯è¿›å…¥ç®¡ç†å‘˜å®¡æ ¸çŠ¶æ€çš„æ ¹æœ¬åŸå› ã€‚

---

## è¯¦ç»†åˆ†æ

### 1. AIåˆ†æç½®ä¿¡åº¦æœºåˆ¶

#### 1.1 ç½®ä¿¡åº¦é˜ˆå€¼é…ç½®

**é…ç½®ä½ç½®**ï¼š
- `application.yml`: `weekly-report.ai.confidence-threshold: 0.7`
- é»˜è®¤å€¼ï¼š0.7ï¼ˆ70%ï¼‰

**ä½¿ç”¨ä½ç½®**ï¼š
1. `AIAnalysisService.java:81` - AIåˆ†ææœåŠ¡
2. `WeeklyReportAIService.java:30` - å‘¨æŠ¥AIæœåŠ¡
3. `WeeklyReportNotificationService.java:32` - é€šçŸ¥æœåŠ¡

#### 1.2 ç½®ä¿¡åº¦è®¡ç®—é€»è¾‘

**å‘¨æŠ¥åˆ†æç½®ä¿¡åº¦è®¡ç®—** (`AIAnalysisService.java:436-490`):

```java
private Double calculateConfidence(Map<String, Object> parsedResult) {
    // è§£æå¤±è´¥ â†’ 0.4
    if (parsedResult == null || parsedResult.isEmpty() || parseError) {
        return 0.4;
    }

    // åŸºäºcompleteness_score (0-10åˆ†) â†’ è½¬æ¢ä¸º0.05-0.9
    if (completenessScore != null) {
        double normalized = completenessScore / 10.0 * 0.9 + 0.05;
        return Math.max(0.1, Math.min(0.9, normalized));
    }

    // ç´¯åŠ è¯„åˆ†æœºåˆ¶ï¼ˆæ— completeness_scoreæ—¶ï¼‰
    double confidence = 0.35; // åŸºçº¿

    // summaryé•¿åº¦: â‰¥60å­— +0.1, â‰¥120å­— +0.05
    // highlightsæ•°é‡: >0 +0.1, >2 +0.05
    // concernsæ•°é‡: >0 +0.05
    // suggestionsæ•°é‡: >0 +0.1, >1 +0.05

    return Math.max(0.2, Math.min(0.85, confidence)); // èŒƒå›´: 0.2-0.85
}
```

**å…³é”®ç‰¹å¾**ï¼š
- è§£æå¤±è´¥å›ºå®šè¿”å›0.4ï¼ˆ< 0.7é˜ˆå€¼ï¼‰â†’ åº”è¢«æ‹’ç»
- æœ€ç»ˆèŒƒå›´é™åˆ¶åœ¨0.2-0.85ï¼Œ**æœ€é«˜ä¹Ÿåªæœ‰0.85**
- æ— completeness_scoreæ—¶ï¼ŒåŸºçº¿0.35ï¼Œéœ€è¦å¤šä¸ªç»´åº¦ç´¯åŠ æ‰èƒ½è¾¾åˆ°0.7

---

### 2. çŠ¶æ€è½¬æ¢è·¯å¾„åˆ†æ

#### 2.1 æ ¸å¿ƒçŠ¶æ€è½¬æ¢ç‚¹

**çŠ¶æ€æµç¨‹**ï¼š
```
AI_ANALYZING (åˆå§‹çŠ¶æ€)
    â†“
[AIåˆ†æå®Œæˆ]
    â†“
ç½®ä¿¡åº¦ â‰¥ 0.7 ?
    â”œâ”€ æ˜¯ â†’ ADMIN_REVIEWING (ç®¡ç†å‘˜å®¡æ ¸)
    â””â”€ å¦ â†’ AI_REJECTED (AIæ‹’ç»)
```

#### 2.2 çŠ¶æ€æ›´æ–°çš„ä¸‰æ¡è·¯å¾„

##### è·¯å¾„1: AIAnalysisService.updateWeeklyReportStatus() âœ…

**ä½ç½®**: `AIAnalysisService.java:533-579`

**é€»è¾‘**ï¼š
```java
if (analysisResult.getStatus() == COMPLETED) {
    double confidence = analysisResult.getConfidence() != null ? analysisResult.getConfidence() : 0.0;

    if (confidence >= weeklyReportConfidenceThreshold) {
        report.setRejectionReason(null);
        report.aiApprove(); // âš ï¸ æ— æ¡ä»¶è°ƒç”¨
        logger.info("å‘¨æŠ¥ID {} AIåˆ†æé€šè¿‡ï¼Œç½®ä¿¡åº¦={}", report.getId(), confidence);
    } else {
        report.setApprovalStatus(AI_REJECTED);
        report.setRejectionReason(
            String.format("AIåˆ†æç½®ä¿¡åº¦è¿‡ä½: %.0f%% (é˜ˆå€¼: %.0f%%)", ...)
        );
        logger.info("å‘¨æŠ¥ID {} AIåˆ†ææœªé€šè¿‡ï¼Œç½®ä¿¡åº¦={}", report.getId(), confidence);
    }
}
```

**è¯„ä¼°**ï¼š
- âœ… æ­£ç¡®æ£€æŸ¥ç½®ä¿¡åº¦é˜ˆå€¼
- âœ… ä½ç½®ä¿¡åº¦æ—¶è®¾ç½®AI_REJECTED
- âš ï¸ é«˜ç½®ä¿¡åº¦æ—¶è°ƒç”¨`aiApprove()`ï¼Œä½†è¯¥æ–¹æ³•å†…éƒ¨æ²¡æœ‰äºŒæ¬¡æ£€æŸ¥

##### è·¯å¾„2: WeeklyReportAIService.processAIResult() âœ…

**ä½ç½®**: `WeeklyReportAIService.java:71-90`

**é€»è¾‘**ï¼š
```java
if (analysisResult.getStatus() == COMPLETED &&
    analysisResult.getConfidence() != null &&
    analysisResult.getConfidence() >= weeklyReportConfidenceThreshold) {

    report.setApprovalStatus(ADMIN_REVIEWING);
    logger.info("AIåˆ†æé€šè¿‡ï¼Œç½®ä¿¡åº¦: {}", analysisResult.getConfidence());
} else {
    report.setApprovalStatus(AI_REJECTED);
    Double confidence = analysisResult.getConfidence() != null ? analysisResult.getConfidence() : 0.0;
    report.setRejectionReason(
        String.format("AIåˆ†æç½®ä¿¡åº¦è¿‡ä½: %.0f%%...", confidence * 100, ...)
    );
    logger.info("AIåˆ†ææœªé€šè¿‡ï¼Œç½®ä¿¡åº¦: {}", confidence);
}
```

**è¯„ä¼°**ï¼š
- âœ… æ­£ç¡®æ£€æŸ¥ç½®ä¿¡åº¦é˜ˆå€¼
- âœ… ä½ç½®ä¿¡åº¦æ—¶è®¾ç½®AI_REJECTED
- âœ… ç›´æ¥è®¾ç½®çŠ¶æ€ï¼Œä¸è°ƒç”¨aiApprove()

##### è·¯å¾„3: WeeklyReportNotificationService.handleAIAnalysisCompleted() âœ…

**ä½ç½®**: `WeeklyReportNotificationService.java:48-114`

**é€»è¾‘**ï¼š
```java
double confidence = analysisResult.getConfidence() != null ? analysisResult.getConfidence() : 0.0;
boolean completed = analysisResult.getStatus() == COMPLETED;

if (!completed || confidence < weeklyReportConfidenceThreshold) {
    ensureRejectedStatus(report, analysisResult, confidence); // è®¾ç½®AI_REJECTED
    return;
}

// åªæœ‰completed=trueä¸”confidenceâ‰¥0.7æ‰ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ
if (report.getApprovalStatus() != ADMIN_REVIEWING) {
    report.setRejectionReason(null);
    report.setApprovalStatus(ADMIN_REVIEWING);
    weeklyReportRepository.save(report);
}
```

**è¯„ä¼°**ï¼š
- âœ… æ­£ç¡®æ£€æŸ¥ç½®ä¿¡åº¦é˜ˆå€¼
- âœ… ä½ç½®ä¿¡åº¦æ—¶è°ƒç”¨`ensureRejectedStatus()`è®¾ç½®AI_REJECTED
- âœ… ç›´æ¥è®¾ç½®çŠ¶æ€ï¼Œä¸è°ƒç”¨aiApprove()

---

### 3. å…³é”®é—®é¢˜ï¼šaiApprove()æ–¹æ³•çš„é£é™©

#### 3.1 æ–¹æ³•å®šä¹‰

**ä½ç½®**: `WeeklyReport.java:292-295`

```java
public void aiApprove() {
    // AIé€šè¿‡åï¼ŒçŠ¶æ€è½¬æ¢ä¸ºç®¡ç†å‘˜å®¡æ ¸ä¸­
    this.approvalStatus = ApprovalStatus.ADMIN_REVIEWING;
}
```

**é—®é¢˜åˆ†æ**ï¼š
- ğŸš¨ **æ— ç½®ä¿¡åº¦æ£€æŸ¥** - æ–¹æ³•å†…éƒ¨ä¸éªŒè¯ç½®ä¿¡åº¦ï¼Œå®Œå…¨ä¾èµ–è°ƒç”¨æ–¹
- ğŸš¨ **æ— æ¡ä»¶è½¬æ¢** - ä»»ä½•è°ƒç”¨éƒ½ä¼šå¼ºåˆ¶è®¾ç½®ä¸ºADMIN_REVIEWING
- ğŸš¨ **å‘½åè¯¯å¯¼** - æ–¹æ³•åæš—ç¤º"AIæ‰¹å‡†"ï¼Œä½†ä¸éªŒè¯æ‰¹å‡†æ¡ä»¶

#### 3.2 è°ƒç”¨ä½ç½®åˆ†æ

**åˆæ³•è°ƒç”¨**ï¼ˆ3å¤„ï¼‰ï¼š
1. `AIAnalysisService.java:554` - **å‰ç½®æ£€æŸ¥âœ…** - `if (confidence >= threshold)`
2. `WeeklyReportService.java:553` - **å‰ç½®æ£€æŸ¥âœ…** - `aiApproveWeeklyReport()`æ–¹æ³•
3. `WeeklyReportServiceV3.java:191` - **å‰ç½®æ£€æŸ¥âœ…** - `aiApproveWeeklyReport()`æ–¹æ³•

**Controllerç«¯ç‚¹æš´éœ²**ï¼š
```java
// WeeklyReportController.java:265-272
@PostMapping("/{id}/ai-approve")
public ResponseEntity<ApiResponse<String>> aiApproveWeeklyReport(
    @PathVariable Long id,
    @RequestParam Long aiAnalysisId) {
    weeklyReportService.aiApproveWeeklyReport(id, aiAnalysisId);
    return ResponseEntity.ok(ApiResponse.success("AIæ‰¹å‡†å‘¨æŠ¥æˆåŠŸ"));
}
```

**æ½œåœ¨é£é™©**ï¼š
- âš ï¸ **APIç«¯ç‚¹ç›´æ¥æš´éœ²** - å¦‚æœè°ƒç”¨æ–¹ä¼ å…¥é”™è¯¯å‚æ•°
- âš ï¸ `aiApproveWeeklyReport()`æ–¹æ³•å®ç°éœ€éªŒè¯ç½®ä¿¡åº¦

---

### 4. ç«æ€æ¡ä»¶åˆ†æ

#### 4.1 å¼‚æ­¥åˆ†ææµç¨‹

**æµç¨‹å›¾**ï¼š
```
ç”¨æˆ·æäº¤å‘¨æŠ¥ â†’ åˆ›å»ºWeeklyReport(AI_ANALYZING)
    â†“
è§¦å‘å¼‚æ­¥AIåˆ†æ (CompletableFuture)
    â†“
AIåˆ†æå®Œæˆ â†’ AIAnalysisService.analyzeWeeklyReportSync()
    â”œâ”€ ä¿å­˜AIAnalysisResult
    â”œâ”€ è°ƒç”¨updateWeeklyReportStatus() [è·¯å¾„1]
    â””â”€ è§¦å‘é€šçŸ¥: handleAIAnalysisCompleted() [è·¯å¾„3]
        â†“
    å¯èƒ½ä¸WeeklyReportAIService.processAIResult() [è·¯å¾„2] å¹¶è¡Œæ‰§è¡Œ
```

**æ½œåœ¨é—®é¢˜**ï¼š
- ğŸš¨ **å¤šè·¯å¾„å¹¶å‘æ›´æ–°** - è·¯å¾„1ã€2ã€3å¯èƒ½åŒæ—¶æ‰§è¡Œ
- ğŸš¨ **æœ€åå†™å…¥èƒœå‡º** - å¦‚æœè·¯å¾„1å…ˆè®¾ç½®AI_REJECTEDï¼Œè·¯å¾„3åè®¾ç½®ADMIN_REVIEWINGï¼Œä¼šè¦†ç›–æ‹’ç»çŠ¶æ€
- ğŸš¨ **ç¼ºå°‘åˆ†å¸ƒå¼é”** - æ²¡æœ‰æœºåˆ¶ä¿è¯çŠ¶æ€æ›´æ–°çš„åŸå­æ€§

#### 4.2 äº‹åŠ¡éš”ç¦»çº§åˆ«

**å½“å‰é…ç½®**ï¼š
- `@Transactional` - Springé»˜è®¤ä¼ æ’­çº§åˆ«REQUIRED
- MySQLé»˜è®¤éš”ç¦»çº§åˆ«ï¼šREPEATABLE_READ

**é—®é¢˜**ï¼š
- âš ï¸ ä¸‰ä¸ªæœåŠ¡ç±»å„è‡ªçš„`@Transactional`å¯èƒ½åˆ›å»ºç‹¬ç«‹äº‹åŠ¡
- âš ï¸ å¦‚æœå¹¶å‘æ‰§è¡Œï¼Œåæäº¤çš„äº‹åŠ¡ä¼šè¦†ç›–å‰é¢çš„çŠ¶æ€

---

### 5. æµ‹è¯•ç”¨ä¾‹éªŒè¯

#### 5.1 å•å…ƒæµ‹è¯•åˆ†æ

**æµ‹è¯•æ–‡ä»¶**: `WeeklyReportAIThresholdTest.java`

**æµ‹è¯•1**: `lowConfidenceShouldRejectDuringStatusSync()`
```java
// ç½®ä¿¡åº¦0.45 < 0.7é˜ˆå€¼
result.setConfidence(0.45);

// è°ƒç”¨updateWeeklyReportStatus()
updateStatus.invoke(aiAnalysisService, report, result);

// æ–­è¨€: åº”ä¸ºAI_REJECTED âœ…
assertEquals(AI_REJECTED, report.getApprovalStatus());
assertTrue(report.getRejectionReason().contains("AIåˆ†æç½®ä¿¡åº¦è¿‡ä½"));
```
**ç»“æœ**: âœ… æµ‹è¯•é€šè¿‡ï¼Œè·¯å¾„1é€»è¾‘æ­£ç¡®

**æµ‹è¯•2**: `notificationShouldKeepReportRejectedWhenConfidenceLow()`
```java
// ç½®ä¿¡åº¦0.5 < 0.7é˜ˆå€¼
analysisResult.setConfidence(0.5);

// è°ƒç”¨handleAIAnalysisCompleted()
notificationService.handleAIAnalysisCompleted(report.getId());

// æ–­è¨€: åº”ä¸ºAI_REJECTED âœ…
assertEquals(AI_REJECTED, report.getApprovalStatus());
assertTrue(report.getRejectionReason().contains("ä½äºé˜ˆå€¼"));
assertFalse(eventPublisher.wasPublished()); // ä¸åº”å‘é€é€šçŸ¥
```
**ç»“æœ**: âœ… æµ‹è¯•é€šè¿‡ï¼Œè·¯å¾„3é€»è¾‘æ­£ç¡®

---

## å…³é”®å‘ç°

### ä¼˜åŠ¿
- âœ… **ä¸‰å±‚é˜²æŠ¤æœºåˆ¶** - ä¸‰ä¸ªç‹¬ç«‹è·¯å¾„éƒ½æ­£ç¡®å®ç°äº†ç½®ä¿¡åº¦æ£€æŸ¥
- âœ… **å•å…ƒæµ‹è¯•è¦†ç›–** - å…³é”®è·¯å¾„æœ‰æµ‹è¯•éªŒè¯
- âœ… **ç»Ÿä¸€é˜ˆå€¼é…ç½®** - æ‰€æœ‰æœåŠ¡ä½¿ç”¨ç›¸åŒçš„0.7é˜ˆå€¼
- âœ… **è¯¦ç»†æ—¥å¿—è®°å½•** - æ¯ä¸ªå†³ç­–ç‚¹éƒ½æœ‰æ—¥å¿—è¾“å‡º

### é—®é¢˜
- âš ï¸ **æ–¹æ³•è®¾è®¡ç¼ºé™·** - `aiApprove()`æ— ç½®ä¿¡åº¦æ£€æŸ¥ï¼Œä¾èµ–è°ƒç”¨æ–¹
- âš ï¸ **å¤šè·¯å¾„ç«æ€é£é™©** - ä¸‰ä¸ªæœåŠ¡å¯èƒ½å¹¶å‘ä¿®æ”¹çŠ¶æ€
- âš ï¸ **ç¼ºå°‘åˆ†å¸ƒå¼é”** - é«˜å¹¶å‘åœºæ™¯ä¸‹çŠ¶æ€å¯èƒ½è¢«é”™è¯¯è¦†ç›–
- âš ï¸ **APIç«¯ç‚¹æš´éœ²** - `/ai-approve`ç«¯ç‚¹ç¼ºå°‘æƒé™å’Œç½®ä¿¡åº¦äºŒæ¬¡éªŒè¯

### é£é™©
- ğŸš¨ **çŠ¶æ€è¦†ç›–é£é™©** - åæ‰§è¡Œçš„è·¯å¾„å¯èƒ½è¦†ç›–æ­£ç¡®çš„AI_REJECTEDçŠ¶æ€
- ğŸš¨ **äº‹åŠ¡éš”ç¦»é—®é¢˜** - ç‹¬ç«‹äº‹åŠ¡å¯èƒ½å¯¼è‡´"ä¸¢å¤±æ›´æ–°"é—®é¢˜
- ğŸš¨ **è°ƒè¯•å›°éš¾** - å¤šè·¯å¾„å¹¶å‘æ‰§è¡Œæ—¶ï¼Œéš¾ä»¥è¿½è¸ªçŠ¶æ€å˜åŒ–é¡ºåº

---

## æ”¹è¿›å»ºè®®

### é«˜ä¼˜å…ˆçº§

#### 1. å¢å¼ºaiApprove()æ–¹æ³•çš„å®‰å…¨æ€§
**ç›®æ ‡**: é˜²æ­¢æ— æ¡ä»¶çŠ¶æ€è½¬æ¢

**æ–¹æ¡ˆA: æ·»åŠ ç½®ä¿¡åº¦å‚æ•°**
```java
public void aiApprove(Double confidence, double threshold) {
    if (confidence == null || confidence < threshold) {
        throw new IllegalStateException(
            String.format("ç½®ä¿¡åº¦ä¸è¶³: %.2f < %.2f", confidence, threshold)
        );
    }
    this.approvalStatus = ApprovalStatus.ADMIN_REVIEWING;
}
```

**æ–¹æ¡ˆB: é‡æ„ä¸ºç§æœ‰æ–¹æ³•+å…¬å…±éªŒè¯æ–¹æ³•**
```java
// å®ä½“å†…éƒ¨
private void setStatusToAdminReviewing() {
    this.approvalStatus = ApprovalStatus.ADMIN_REVIEWING;
}

// æœåŠ¡å±‚ç»Ÿä¸€å…¥å£
public void approveByAI(WeeklyReport report, AIAnalysisResult result) {
    validateConfidence(result);
    report.setStatusToAdminReviewing();
}
```

#### 2. ç»Ÿä¸€çŠ¶æ€æ›´æ–°å…¥å£
**ç›®æ ‡**: æ¶ˆé™¤å¤šè·¯å¾„ç«æ€æ¡ä»¶

**å®æ–½æ–¹æ¡ˆ**:
```java
@Service
public class WeeklyReportStatusManager {

    @Transactional
    public void processAIAnalysisResult(Long reportId, Long analysisResultId) {
        // åŠ é”æŸ¥è¯¢
        WeeklyReport report = weeklyReportRepository
            .findByIdForUpdate(reportId) // SELECT ... FOR UPDATE
            .orElseThrow();

        AIAnalysisResult result = aiAnalysisResultRepository
            .findById(analysisResultId)
            .orElseThrow();

        // ç»Ÿä¸€åˆ¤æ–­é€»è¾‘
        if (shouldApprove(result)) {
            report.setApprovalStatus(ADMIN_REVIEWING);
            notificationService.sendToAdmins(report);
        } else {
            report.setApprovalStatus(AI_REJECTED);
            report.setRejectionReason(buildRejectionMessage(result));
        }

        weeklyReportRepository.save(report);
    }

    private boolean shouldApprove(AIAnalysisResult result) {
        return result.getStatus() == COMPLETED
            && result.getConfidence() != null
            && result.getConfidence() >= confidenceThreshold;
    }
}
```

#### 3. æ·»åŠ æ‚²è§‚é”æœºåˆ¶
**ç›®æ ‡**: é˜²æ­¢å¹¶å‘ä¿®æ”¹çŠ¶æ€

**Repositoryå±‚æ·»åŠ **:
```java
@Lock(LockModeType.PESSIMISTIC_WRITE)
@Query("SELECT wr FROM WeeklyReport wr WHERE wr.id = :id")
Optional<WeeklyReport> findByIdForUpdate(@Param("id") Long id);
```

**ä½¿ç”¨ä½ç½®**:
- AIAnalysisService.updateWeeklyReportStatus()
- WeeklyReportNotificationService.handleAIAnalysisCompleted()

---

### ä¸­ä¼˜å…ˆçº§

#### 4. å¢å¼ºAPIç«¯ç‚¹éªŒè¯
```java
@PostMapping("/{id}/ai-approve")
@PreAuthorize("hasRole('SYSTEM')") // é™åˆ¶ä¸ºç³»ç»Ÿå†…éƒ¨è°ƒç”¨
public ResponseEntity<ApiResponse<String>> aiApproveWeeklyReport(
    @PathVariable Long id,
    @RequestParam Long aiAnalysisId) {

    // äºŒæ¬¡éªŒè¯ç½®ä¿¡åº¦
    AIAnalysisResult result = aiAnalysisService.getAnalysisResults(aiAnalysisId);
    if (result.getConfidence() < confidenceThreshold) {
        return ResponseEntity.badRequest()
            .body(ApiResponse.error("ç½®ä¿¡åº¦ä¸è¶³ï¼Œæ— æ³•æ‰¹å‡†"));
    }

    weeklyReportService.aiApproveWeeklyReport(id, aiAnalysisId);
    return ResponseEntity.ok(ApiResponse.success("AIæ‰¹å‡†å‘¨æŠ¥æˆåŠŸ"));
}
```

#### 5. æ·»åŠ çŠ¶æ€è½¬æ¢å®¡è®¡æ—¥å¿—
```java
@Entity
@Table(name = "weekly_report_status_audit")
public class WeeklyReportStatusAudit {
    private Long reportId;
    private ApprovalStatus fromStatus;
    private ApprovalStatus toStatus;
    private String triggeredBy; // æœåŠ¡ç±»åæˆ–APIç«¯ç‚¹
    private Double confidence;
    private LocalDateTime changedAt;
}
```

#### 6. å®Œå–„ç›‘æ§å‘Šè­¦
```java
// æ£€æµ‹å¼‚å¸¸çŠ¶æ€è½¬æ¢
if (previousStatus == AI_REJECTED && newStatus == ADMIN_REVIEWING) {
    logger.error("âš ï¸ æ£€æµ‹åˆ°å¼‚å¸¸çŠ¶æ€è½¬æ¢: {} â†’ {}, å‘¨æŠ¥ID: {}",
                 previousStatus, newStatus, reportId);
    metricsService.incrementCounter("weekly_report.abnormal_state_transition");
}
```

---

### ä½ä¼˜å…ˆçº§

#### 7. é‡æ„æœåŠ¡èŒè´£è¾¹ç•Œ
**ç›®æ ‡**: æ˜ç¡®å„æœåŠ¡çš„èŒè´£èŒƒå›´

**å½“å‰é—®é¢˜**:
- AIAnalysisServiceæ—¢è´Ÿè´£AIåˆ†æï¼Œåˆè´Ÿè´£çŠ¶æ€åŒæ­¥
- WeeklyReportNotificationServiceæ—¢è´Ÿè´£é€šçŸ¥ï¼Œåˆè´Ÿè´£çŠ¶æ€æ›´æ–°

**å»ºè®®åˆ†ç¦»**:
- AIAnalysisService: ä»…è´Ÿè´£AIåˆ†æå’Œç»“æœä¿å­˜
- WeeklyReportStatusManager: ç»Ÿä¸€è´Ÿè´£çŠ¶æ€è½¬æ¢é€»è¾‘
- WeeklyReportNotificationService: ä»…è´Ÿè´£äº‹ä»¶å‘å¸ƒ

#### 8. ä¼˜åŒ–ç½®ä¿¡åº¦è®¡ç®—ç®—æ³•
**å½“å‰é™åˆ¶**: æœ€é«˜ç½®ä¿¡åº¦0.85ï¼Œå¯¹äºé«˜è´¨é‡å‘¨æŠ¥ä»è¾ƒä½

**å»ºè®®**:
```java
// å…è®¸é«˜è´¨é‡å‘¨æŠ¥è¾¾åˆ°æ›´é«˜ç½®ä¿¡åº¦
return Math.max(0.2, Math.min(0.95, confidence)); // æ”¹ä¸º0.95

// æˆ–å¼•å…¥æƒé‡é…ç½®
@Value("${weekly-report.ai.confidence.max:0.95}")
private double maxConfidence;
```

---

## æŠ€æœ¯å€ºåŠ¡è¯„ä¼°

| é¡¹ç›® | ä¸¥é‡ç¨‹åº¦ | å½±å“èŒƒå›´ | å»ºè®®è¡ŒåŠ¨ |
|------|---------|---------|---------|
| aiApprove()æ— ç½®ä¿¡åº¦æ£€æŸ¥ | é«˜ | çŠ¶æ€è½¬æ¢æ ¸å¿ƒé€»è¾‘ | ç«‹å³é‡æ„ï¼Œæ·»åŠ å‚æ•°éªŒè¯ |
| å¤šè·¯å¾„å¹¶å‘æ›´æ–°çŠ¶æ€ | é«˜ | AIåˆ†æå®Œæˆæµç¨‹ | å¼•å…¥ç»Ÿä¸€çŠ¶æ€ç®¡ç†å™¨+æ‚²è§‚é” |
| ç¼ºå°‘çŠ¶æ€è½¬æ¢å®¡è®¡ | ä¸­ | é—®é¢˜æ’æŸ¥å›°éš¾ | æ·»åŠ å®¡è®¡è¡¨å’Œæ—¥å¿— |
| APIç«¯ç‚¹æƒé™ä¸è¶³ | ä¸­ | å®‰å…¨é£é™© | æ·»åŠ æƒé™éªŒè¯å’Œç½®ä¿¡åº¦äºŒæ¬¡æ£€æŸ¥ |
| ç½®ä¿¡åº¦ä¸Šé™0.85åä½ | ä½ | ç”¨æˆ·ä½“éªŒ | è°ƒæ•´ç®—æ³•å‚æ•°æˆ–é…ç½®åŒ– |

---

## æ ¹æœ¬åŸå› å‡è®¾

åŸºäºä»£ç åˆ†æï¼Œ**æœ€å¯èƒ½çš„æ ¹æœ¬åŸå› **ï¼š

### å‡è®¾1: ç«æ€æ¡ä»¶å¯¼è‡´çŠ¶æ€è¦†ç›– â­â­â­â­â­
**åœºæ™¯**:
1. AIåˆ†æå®Œæˆï¼Œç½®ä¿¡åº¦0.6ï¼ˆ< 0.7ï¼‰
2. `AIAnalysisService.updateWeeklyReportStatus()`å…ˆæ‰§è¡Œï¼Œè®¾ç½®AI_REJECTED
3. `WeeklyReportNotificationService.handleAIAnalysisCompleted()`ç¨åæ‰§è¡Œ
4. ç”±äºå¼‚æ­¥å»¶è¿Ÿæˆ–ç¼“å­˜é—®é¢˜ï¼Œè¯»å–åˆ°çš„`analysisResult.getConfidence()`è¢«è¯¯åˆ¤ä¸ºâ‰¥0.7
5. çŠ¶æ€è¢«è¦†ç›–ä¸ºADMIN_REVIEWING

**éªŒè¯æ–¹æ³•**:
```java
// åœ¨handleAIAnalysisCompleted()æ·»åŠ é˜²å¾¡æ€§æ—¥å¿—
logger.warn("ğŸ” ç½®ä¿¡åº¦æ£€æŸ¥: completed={}, confidence={}, threshold={}, å½“å‰çŠ¶æ€={}",
            completed, confidence, threshold, report.getApprovalStatus());
```

### å‡è®¾2: ç¼“å­˜æˆ–å®ä½“çŠ¶æ€ä¸ä¸€è‡´ â­â­â­â­
**åœºæ™¯**:
- JPAä¸€çº§ç¼“å­˜ä¸­çš„`WeeklyReport`å®ä½“æœªåŠæ—¶åˆ·æ–°
- ä¸åŒæœåŠ¡è¯»å–åˆ°ä¸åŒç‰ˆæœ¬çš„`AIAnalysisResult.confidence`

**éªŒè¯æ–¹æ³•**:
```java
// å¼ºåˆ¶åˆ·æ–°å®ä½“
entityManager.refresh(report);
entityManager.refresh(analysisResult);
```

### å‡è®¾3: æµ‹è¯•ç¯å¢ƒä¸ç”Ÿäº§ç¯å¢ƒé…ç½®å·®å¼‚ â­â­â­
**åœºæ™¯**:
- ç”Ÿäº§ç¯å¢ƒçš„`weekly-report.ai.confidence-threshold`è¢«é”™è¯¯é…ç½®ä¸º0.5æˆ–æ›´ä½
- å¯¼è‡´ä½ç½®ä¿¡åº¦å‘¨æŠ¥é€šè¿‡æ£€æŸ¥

**éªŒè¯æ–¹æ³•**:
```bash
# æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒé…ç½®
kubectl get configmap weekly-report-config -o yaml | grep confidence-threshold
```

---

## è°ƒè¯•å»ºè®®

### çŸ­æœŸå¿«é€ŸéªŒè¯
```java
// åœ¨ä¸‰ä¸ªå…³é”®è·¯å¾„æ·»åŠ ç»Ÿä¸€æ ¼å¼çš„æ—¥å¿—
String logPattern = "ğŸ”[çŠ¶æ€æ£€æŸ¥] å‘¨æŠ¥ID={}, å½“å‰çŠ¶æ€={}, ç½®ä¿¡åº¦={}, é˜ˆå€¼={}, å†³ç­–={}, è§¦å‘ç‚¹={}";

// AIAnalysisService.updateWeeklyReportStatus():554
logger.info(logPattern, report.getId(), report.getApprovalStatus(),
            confidence, threshold, decision, "AIAnalysisService.updateWeeklyReportStatus");

// WeeklyReportAIService.processAIResult():78
logger.info(logPattern, report.getId(), report.getApprovalStatus(),
            confidence, threshold, decision, "WeeklyReportAIService.processAIResult");

// WeeklyReportNotificationService.handleAIAnalysisCompleted():67
logger.info(logPattern, report.getId(), report.getApprovalStatus(),
            confidence, threshold, decision, "WeeklyReportNotificationService.handleAIAnalysisCompleted");
```

### ä¸­æœŸç›‘æ§æ–¹æ¡ˆ
```java
// ä½¿ç”¨Spring AOPæ‹¦æˆªæ‰€æœ‰çŠ¶æ€ä¿®æ”¹
@Aspect
@Component
public class WeeklyReportStatusChangeAspect {

    @Around("execution(* com.weeklyreport.weeklyreport.entity.WeeklyReport.setApprovalStatus(..))")
    public Object logStatusChange(ProceedingJoinPoint pjp) throws Throwable {
        WeeklyReport report = (WeeklyReport) pjp.getThis();
        ApprovalStatus oldStatus = report.getApprovalStatus();
        ApprovalStatus newStatus = (ApprovalStatus) pjp.getArgs()[0];

        StackTraceElement[] stack = Thread.currentThread().getStackTrace();
        String caller = stack[3].getClassName() + "." + stack[3].getMethodName();

        logger.info("ğŸ“[çŠ¶æ€å˜æ›´] å‘¨æŠ¥ID={}, {} â†’ {}, è°ƒç”¨è€…={}",
                   report.getId(), oldStatus, newStatus, caller);

        return pjp.proceed();
    }
}
```

---

## å­¦ä¹ è¦ç‚¹

### 1. å®ä½“æ–¹æ³•è®¾è®¡åŸåˆ™
- **é˜²å¾¡æ€§ç¼–ç¨‹**: å®ä½“æ–¹æ³•åº”éªŒè¯å‰ç½®æ¡ä»¶ï¼Œä¸èƒ½å®Œå…¨ä¾èµ–è°ƒç”¨æ–¹
- **å‘½åæ¸…æ™°æ€§**: æ–¹æ³•ååº”å‡†ç¡®åæ˜ è¡Œä¸ºï¼ˆ`aiApprove()`æš—ç¤ºå·²éªŒè¯ï¼Œä½†å®é™…æœªéªŒè¯ï¼‰
- **æœ€å°æƒé™**: çŠ¶æ€è½¬æ¢æ–¹æ³•åº”ä¸º`protected`æˆ–`private`ï¼Œé€šè¿‡æœåŠ¡å±‚å…¬å¼€

### 2. å¹¶å‘çŠ¶æ€ç®¡ç†
- **å•ä¸€èŒè´£**: çŠ¶æ€è½¬æ¢åº”ç”±å•ä¸€ç»„ä»¶è´Ÿè´£ï¼Œé¿å…å¤šè·¯å¾„å¹¶å‘
- **æ‚²è§‚é”**: å…³é”®çŠ¶æ€å˜æ›´ä½¿ç”¨`SELECT ... FOR UPDATE`
- **åŸå­æ“ä½œ**: æŸ¥è¯¢-åˆ¤æ–­-æ›´æ–°åº”åœ¨åŒä¸€äº‹åŠ¡ä¸­å®Œæˆ

### 3. å¾®æœåŠ¡äº‹ä»¶é©±åŠ¨æ¶æ„
- **æœ€ç»ˆä¸€è‡´æ€§**: å¼‚æ­¥äº‹ä»¶å¯èƒ½å¯¼è‡´çŸ­æš‚ä¸ä¸€è‡´ï¼Œéœ€è¦å¹‚ç­‰æ€§è®¾è®¡
- **äº‹ä»¶é¡ºåº**: ä¸èƒ½å‡è®¾äº‹ä»¶æŒ‰ç‰¹å®šé¡ºåºåˆ°è¾¾
- **è¡¥å¿æœºåˆ¶**: è®¾è®¡é”™è¯¯çŠ¶æ€çš„è‡ªåŠ¨ä¿®å¤æœºåˆ¶

---

## å‚è€ƒèµ„æº

### ç›¸å…³ä»£ç æ–‡ä»¶
- `AIAnalysisService.java` - AIåˆ†ææœåŠ¡ï¼Œç½®ä¿¡åº¦è®¡ç®—é€»è¾‘
- `WeeklyReportAIService.java` - å‘¨æŠ¥AIæœåŠ¡ï¼Œå¤„ç†AIç»“æœ
- `WeeklyReportNotificationService.java` - é€šçŸ¥æœåŠ¡ï¼Œå¼‚æ­¥å¤„ç†
- `WeeklyReport.java` - å®ä½“ç±»ï¼ŒçŠ¶æ€è½¬æ¢æ–¹æ³•
- `WeeklyReportAIThresholdTest.java` - å•å…ƒæµ‹è¯•

### é…ç½®æ–‡ä»¶
- `application.yml` - ç½®ä¿¡åº¦é˜ˆå€¼é…ç½®

### è®¾è®¡æ–‡æ¡£
- `doc/æ•°æ®åº“è®¾è®¡.md` - æ•°æ®åº“è¡¨ç»“æ„è®¾è®¡
- `doc/åç«¯ä¿®æ”¹æŒ‡å¯¼.md` - åç«¯å¼€å‘è§„èŒƒ

---

**åˆ†æå®Œæˆæ—¶é—´**: 2025-01-16
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ†æç»“è®º**: ä»£ç é€»è¾‘æœ¬èº«æ­£ç¡®ï¼Œé—®é¢˜å¾ˆå¯èƒ½æºäº**å¹¶å‘ç«æ€æ¡ä»¶**æˆ–**JPAç¼“å­˜ä¸ä¸€è‡´**ã€‚å»ºè®®ä¼˜å…ˆå®æ–½**é«˜ä¼˜å…ˆçº§æ”¹è¿›å»ºè®®**ï¼Œæ·»åŠ è¯¦ç»†æ—¥å¿—ä»¥å®šä½å…·ä½“è§¦å‘åœºæ™¯ã€‚
