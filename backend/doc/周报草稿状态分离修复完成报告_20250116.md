# 周报草稿状态分离修复完成报告

## 一、修复概述

### 1.1 修复目标
将周报的草稿状态从审核流程中分离，实现三层独立的状态管理：
- **编辑状态 (EditStatus)**: DRAFT / SUBMITTED
- **处理状态 (ProcessingStatus)**: PENDING / AI_PROCESSING / AI_COMPLETED / AI_FAILED
- **审核状态 (ApprovalStatus)**: NOT_STARTED / PENDING_REVIEW / APPROVED / REJECTED

### 1.2 核心问题
- 旧设计将草稿（AI_ANALYZING）与审核流程状态（ADMIN_REVIEWING等）混合在单一ApprovalStatus枚举中
- 导致草稿保存会错误触发AI分析
- 状态判断逻辑混乱

### 1.3 解决方案
完全重构状态模型，采用三层独立状态 + 实体层状态转换方法的设计。

---

## 二、已完成的核心修改

### 2.1 数据库迁移 ✅

**文件**: `src/main/resources/db/migration/V35__Separate_Draft_From_Approval_Status.sql`

**主要修改**:
1. 添加两个新字段：
   - `edit_status` VARCHAR(20): 编辑状态
   - `processing_status` VARCHAR(30): 处理状态
2. 数据迁移逻辑：
   - AI_ANALYZING → DRAFT + AI_PROCESSING + NOT_STARTED
   - AI_REJECTED → DRAFT + AI_COMPLETED + NOT_STARTED
   - ADMIN_REVIEWING → SUBMITTED + AI_COMPLETED + PENDING_REVIEW
   - ADMIN_APPROVED → SUBMITTED + AI_COMPLETED + APPROVED
   - ADMIN_REJECTED → DRAFT + PENDING + NOT_STARTED
3. 修改approval_status枚举：去除旧的5个值，改为新的4个值
4. 创建索引以优化查询性能

### 2.2 实体层重构 ✅

**文件**: `src/main/java/com/weeklyreport/weeklyreport/entity/WeeklyReport.java`

**主要修改**:
1. **添加三个新枚举**:
   ```java
   public enum EditStatus { DRAFT, SUBMITTED }
   public enum ProcessingStatus { PENDING, AI_PROCESSING, AI_COMPLETED, AI_FAILED }
   public enum ApprovalStatus { NOT_STARTED, PENDING_REVIEW, APPROVED, REJECTED }
   ```

2. **添加8个状态判断方法**:
   - `isDraft()`, `isSubmitted()`, `isEditable()`
   - `isAIProcessing()`, `isAICompleted()`
   - `isPendingReview()`, `isApproved()`, `isRejected()`

3. **添加5个状态转换方法**:
   - `submit()`: 草稿 → 已提交 + AI处理中
   - `completeAIAnalysis(confidence, threshold)`: AI分析完成，根据置信度决定是否进入审核
   - `adminApprove(reviewerId)`: 管理员通过
   - `adminReject(reviewerId, reason)`: 管理员拒绝 → 恢复为草稿
   - `markAIFailed()`: 标记AI分析失败

4. **废弃旧方法**:
   - `@Deprecated aiApprove()`
   - `@Deprecated reject()`

### 2.3 Repository层扩展 ✅

**文件**: `src/main/java/com/weeklyreport/weeklyreport/repository/WeeklyReportRepository.java`

**新增查询方法** (共14个):
```java
// 编辑状态查询
List<WeeklyReport> findByUserIdAndEditStatus(userId, editStatus)
long countByUserIdAndEditStatus(userId, editStatus)
Page<WeeklyReport> findByUserIdAndEditStatus(userId, editStatus, pageable)

// 处理状态查询
List<WeeklyReport> findByProcessingStatus(processingStatus)
List<WeeklyReport> findRecentAIFailedReports(since)

// 审核状态查询
List<WeeklyReport> findPendingReviewReports(status)

// 组合查询
List<WeeklyReport> findByUserAndStatusAndDateRange(userId, editStatus, startDate, endDate)
List<Object[]> countByUserIdGroupByEditStatus(userId)
Page<WeeklyReport> findByUserIdAndEditStatusAndApprovalStatus(...)
List<WeeklyReport> findByUserIdAndEditStatusAndProcessingStatus(...)

// 悲观锁查询
@Lock(LockModeType.PESSIMISTIC_WRITE)
Optional<WeeklyReport> findByIdForUpdate(id)
```

### 2.4 Service层重构 ✅

**文件**: `src/main/java/com/weeklyreport/weeklyreport/service/WeeklyReportService.java`

**核心修改**:
1. **createWeeklyReport() 改为创建草稿**:
   ```java
   // 旧: 自动设置为AI_ANALYZING并触发AI分析
   weeklyReport.setApprovalStatus(AI_ANALYZING);
   triggerAIAnalysis(weeklyReport);

   // 新: 创建草稿状态，不触发AI
   weeklyReport.setEditStatus(EditStatus.DRAFT);
   weeklyReport.setProcessingStatus(ProcessingStatus.PENDING);
   weeklyReport.setApprovalStatus(ApprovalStatus.NOT_STARTED);
   // 不调用triggerAIAnalysis()
   ```

2. **新增submitForReview() 方法**:
   ```java
   @Transactional
   public WeeklyReport submitForReview(Long reportId) {
       // 1. 悲观锁查询
       WeeklyReport report = repository.findByIdForUpdate(reportId).orElseThrow(...);

       // 2. 状态检查：只能提交草稿
       if (!report.isDraft()) throw new IllegalStateException(...);

       // 3. 内容完整性验证
       validateReportCompleteness(report);

       // 4. 调用实体方法转换状态
       report.submit();
       WeeklyReport savedReport = repository.save(report);

       // 5. 触发AI分析
       triggerAIAnalysis(savedReport);

       return savedReport;
   }
   ```

3. **更新aiApproveWeeklyReport()**:
   ```java
   // 旧: 检查AI_ANALYZING，调用report.aiApprove()
   if (report.getApprovalStatus() != AI_ANALYZING) throw ...
   report.aiApprove(confidence, threshold);

   // 新: 检查ProcessingStatus，调用实体方法
   if (report.getProcessingStatus() != AI_PROCESSING) throw ...
   report.completeAIAnalysis(confidence, threshold);
   ```

4. **更新adminApproveWeeklyReport()**:
   ```java
   // 旧: 检查ADMIN_REVIEWING
   if (report.getApprovalStatus() != ADMIN_REVIEWING) throw ...

   // 新: 检查PENDING_REVIEW，调用实体方法
   if (report.getApprovalStatus() != PENDING_REVIEW) throw ...
   report.adminApprove(adminId);
   ```

5. **更新rejectWeeklyReport()**:
   ```java
   // 旧: 调用废弃的report.reject()
   report.reject(reviewerId, reason);

   // 新: 检查状态，调用实体的adminReject()
   if (report.getApprovalStatus() != PENDING_REVIEW) throw ...
   report.adminReject(reviewerId, reason);
   ```

6. **更新triggerAIAnalysis() 的错误处理**:
   ```java
   // 旧: 设置AI_REJECTED状态
   report.setApprovalStatus(AI_REJECTED);

   // 新: 调用实体的markAIFailed()方法
   report.markAIFailed();
   ```

7. **废弃submitWeeklyReport()**:
   ```java
   @Deprecated
   public void submitWeeklyReport(Long reportId) {
       logger.warn("调用了已废弃的方法，请使用submitForReview()");
       submitForReview(reportId);
   }
   ```

### 2.5 AI分析服务更新 ✅

**文件**: `src/main/java/com/weeklyreport/ai/service/AIAnalysisService.java`

**主要修改** - `updateWeeklyReportStatus()` 方法:
```java
// AI分析成功
if (analysisResult.getStatus() == COMPLETED) {
    double confidence = analysisResult.getConfidence();

    if (confidence >= threshold) {
        // 置信度足够：完成AI分析并进入待审核
        report.completeAIAnalysis(confidence, threshold);
        // 状态变化: DRAFT+AI_PROCESSING → SUBMITTED+AI_COMPLETED+PENDING_REVIEW
    } else {
        // 置信度不足：完成AI分析但保持草稿
        report.completeAIAnalysis(confidence, threshold);
        // 状态变化: SUBMITTED+AI_PROCESSING → DRAFT+AI_COMPLETED+NOT_STARTED
    }
} else {
    // AI分析失败
    report.markAIFailed();
    // 状态变化: SUBMITTED+AI_PROCESSING → DRAFT+AI_FAILED+NOT_STARTED
}
```

### 2.6 Controller层重构 ✅

**文件**: `src/main/java/com/weeklyreport/weeklyreport/controller/WeeklyReportController.java`

**主要修改**:

1. **更新createWeeklyReport接口注释和返回信息**:
   ```java
   /**
    * 创建周报草稿 - 不触发AI分析
    * 注意：此接口创建的周报处于草稿状态，需要调用提交接口才会触发AI分析
    */
   @PostMapping
   public ResponseEntity<ApiResponse<WeeklyReport>> createWeeklyReport(...) {
       WeeklyReport weeklyReport = service.createWeeklyReport(request);
       return ok(success("周报草稿创建成功，可继续编辑或调用提交接口触发审核", weeklyReport));
   }
   ```

2. **重构submitWeeklyReport接口**:
   ```java
   /**
    * 提交周报草稿进入审批流程 - 触发AI分析
    * 只能提交草稿状态的周报
    */
   @PutMapping("/{id}/submit")
   public ResponseEntity<ApiResponse<WeeklyReport>> submitWeeklyReport(@PathVariable Long id) {
       // 验证周报状态：只能提交草稿
       if (report.getEditStatus() != EditStatus.DRAFT) {
           return badRequest(error("只能提交草稿状态的周报"));
       }

       WeeklyReport submittedReport = service.submitForReview(id);
       return ok(success("周报提交成功，AI分析已启动", submittedReport));
   }
   ```

3. **重构forceSubmitWeeklyReport接口**:
   ```java
   @PutMapping("/{id}/force-submit")
   public ResponseEntity<ApiResponse<WeeklyReport>> forceSubmitWeeklyReport(@PathVariable Long id) {
       // 状态检查：只有草稿状态且AI已分析过的周报可以强行提交
       boolean canForceSubmit = report.getEditStatus() == DRAFT &&
           (report.getProcessingStatus() == AI_COMPLETED ||
            report.getProcessingStatus() == AI_FAILED);

       if (!canForceSubmit) return badRequest(error("..."));

       // 强制提交：直接进入待审核
       report.setEditStatus(SUBMITTED);
       report.setApprovalStatus(PENDING_REVIEW);
       repository.save(report);

       return ok(success("周报强行提交成功", report));
   }
   ```

4. **更新updateWeeklyReport接口**:
   ```java
   // 旧: 检查多个旧状态枚举值
   WeeklyReport.ApprovalStatus[] editableStatuses = {
       AI_ANALYZING, AI_REJECTED, ADMIN_REJECTED
   };

   // 新: 使用实体方法
   if (!report.isEditable()) {
       return badRequest(error("只能更新草稿状态的周报"));
   }
   ```

5. **更新deleteWeeklyReport接口**:
   ```java
   // 旧: 检查多个旧状态枚举值
   // 新: 只检查编辑状态
   if (report.getEditStatus() != EditStatus.DRAFT) {
       return badRequest(error("只能删除草稿状态的周报"));
   }
   ```

6. **更新adminApprove和rejectWeeklyReport接口**:
   ```java
   // 统一改为检查PENDING_REVIEW状态
   if (report.getApprovalStatus() != ApprovalStatus.PENDING_REVIEW) {
       return badRequest(error("只能审批/拒绝待审核状态的周报"));
   }
   ```

7. **新增草稿查询接口** (3个):
   ```java
   // 查询当前用户的草稿列表
   @GetMapping("/my-drafts")
   public ResponseEntity<ApiResponse<Page<WeeklyReport>>> getMyDrafts(...) {
       Page<WeeklyReport> drafts = repository.findByUserIdAndEditStatus(
           currentUser.getId(), EditStatus.DRAFT, pageable
       );
       return ok(success("获取草稿列表成功", drafts));
   }

   // 查询当前用户已提交的周报（支持按审核状态过滤）
   @GetMapping("/my-submitted")
   public ResponseEntity<ApiResponse<Page<WeeklyReport>>> getMySubmitted(...) {
       // 支持approvalStatus参数过滤
       Page<WeeklyReport> reports = repository.findByUserIdAndEditStatus(
           currentUser.getId(), EditStatus.SUBMITTED, pageable
       );
       return ok(success("获取已提交周报列表成功", reports));
   }

   // 查询AI分析失败的周报
   @GetMapping("/my-failed")
   public ResponseEntity<ApiResponse<List<WeeklyReport>>> getMyFailedReports() {
       List<WeeklyReport> failedReports = repository.findByUserIdAndEditStatusAndProcessingStatus(
           currentUser.getId(), EditStatus.DRAFT, ProcessingStatus.AI_FAILED
       );
       return ok(success("获取AI分析失败的周报列表成功", failedReports));
   }
   ```

### 2.7 其他Service文件修复 ✅

**文件**: `src/main/java/com/weeklyreport/weeklyreport/service/WeeklyReportServiceV3.java`

**修改**: 同步更新所有旧枚举值引用为新的三层状态判断

---

## 三、核心业务流程变化

### 3.1 创建周报流程

#### 旧流程:
```
用户创建周报
  → 后端保存并设置为AI_ANALYZING
  → 自动触发AI分析
  → 用户无法继续编辑（状态不可编辑）
```

#### 新流程:
```
用户创建周报
  → 后端保存为草稿状态(DRAFT)
  → 不触发AI分析
  → 用户可继续编辑和完善
  → 用户明确提交时才触发AI分析
```

### 3.2 提交审核流程

#### 新增显式提交步骤:
```
1. 用户调用 POST /weekly-reports/{id}/submit
2. 后端验证：
   - 状态必须是DRAFT
   - 内容必须完整（至少有一个任务报告）
3. 状态转换：
   - EditStatus: DRAFT → SUBMITTED
   - ProcessingStatus: PENDING → AI_PROCESSING
   - ApprovalStatus: NOT_STARTED → NOT_STARTED (等待AI完成)
4. 触发AI分析
5. AI完成后自动更新状态
```

### 3.3 AI分析完成流程

#### 置信度足够 (≥70%):
```
ProcessingStatus: AI_PROCESSING → AI_COMPLETED
ApprovalStatus: NOT_STARTED → PENDING_REVIEW
EditStatus: SUBMITTED (保持)
```

#### 置信度不足 (<70%):
```
ProcessingStatus: AI_PROCESSING → AI_COMPLETED
ApprovalStatus: NOT_STARTED (保持)
EditStatus: SUBMITTED → DRAFT (恢复可编辑)
rejectionReason: 设置置信度不足原因
```

#### AI分析失败:
```
ProcessingStatus: AI_PROCESSING → AI_FAILED
ApprovalStatus: NOT_STARTED (保持)
EditStatus: SUBMITTED → DRAFT (恢复可编辑)
rejectionReason: 设置失败原因
```

### 3.4 强制提交流程

用户在AI分析未通过后可选择强制提交:
```
前置条件:
  - EditStatus = DRAFT
  - ProcessingStatus = AI_COMPLETED 或 AI_FAILED

执行操作:
  1. EditStatus: DRAFT → SUBMITTED
  2. ApprovalStatus: NOT_STARTED → PENDING_REVIEW
  3. ProcessingStatus: 保持不变（记录AI结果）

结果: 直接进入管理员审核队列
```

### 3.5 管理员审核流程

#### 通过:
```
前置条件: ApprovalStatus = PENDING_REVIEW
状态变化: PENDING_REVIEW → APPROVED
EditStatus: SUBMITTED (保持锁定)
```

#### 拒绝:
```
前置条件: ApprovalStatus = PENDING_REVIEW
状态变化:
  - ApprovalStatus: PENDING_REVIEW → REJECTED
  - EditStatus: SUBMITTED → DRAFT (恢复可编辑)
  - ProcessingStatus: 保持 → PENDING (重置为待处理)
  - rejectionReason: 记录拒绝原因
```

---

## 四、状态机图示

```
[创建] → DRAFT+PENDING+NOT_STARTED
         ↓ submit()
         SUBMITTED+AI_PROCESSING+NOT_STARTED
         ↓
    [AI分析完成]
         ├─ 置信度≥70% → SUBMITTED+AI_COMPLETED+PENDING_REVIEW
         │                  ↓ adminApprove()
         │                  SUBMITTED+AI_COMPLETED+APPROVED
         │
         └─ 置信度<70% → DRAFT+AI_COMPLETED+NOT_STARTED
                         ↓ 强制提交
                         SUBMITTED+AI_COMPLETED+PENDING_REVIEW

[管理员拒绝] → DRAFT+PENDING+REJECTED
               ↓ 重新编辑+提交
               继续循环
```

---

## 五、剩余工作

### 5.1 未完成的文件修复 (编译错误)

以下文件仍有旧枚举值引用或缺失类型，需要修复：

1. **WeeklyReportAIService.java** - switch语句使用旧枚举值
2. **WeeklyReportListResponse.java** - switch语句使用旧枚举值
3. **WeeklyReportStatusManager.java** - 使用旧枚举值和aiApprove()方法
4. **缺失的DTO类** - 多个DetailResponse、UpdateRequest类文件缺失
5. **DeepSeek DTO** - DeepSeekRequest/Response类缺失

### 5.2 推荐的后续工作

1. **清理废弃代码**:
   - 删除`WeeklyReport.aiApprove()`和`reject()`方法
   - 删除未使用的V3 Service（如果不需要）

2. **完善测试**:
   - 添加三层状态转换的单元测试
   - 添加状态机转换的集成测试
   - 测试边界条件和异常情况

3. **前端适配**:
   - 更新前端状态判断逻辑
   - 添加"提交审核"按钮（区别于保存草稿）
   - 更新状态显示文本

4. **文档更新**:
   - 更新API文档，说明新的状态模型
   - 更新数据库设计文档
   - 编写用户使用指南

---

## 六、验证清单

### 6.1 功能验证

- [ ] 创建周报草稿不触发AI分析
- [ ] 草稿可以多次编辑
- [ ] 提交审核会触发AI分析
- [ ] AI置信度足够时进入待审核
- [ ] AI置信度不足时恢复为草稿
- [ ] AI失败时恢复为草稿
- [ ] 强制提交可直接进入待审核
- [ ] 管理员审核通过锁定周报
- [ ] 管理员拒绝恢复为草稿
- [ ] 状态查询接口正确过滤

### 6.2 数据一致性验证

- [ ] 数据库迁移脚本成功执行
- [ ] 旧数据正确迁移到新状态
- [ ] 索引创建成功
- [ ] 状态组合符合业务规则
- [ ] 乐观锁/悲观锁正常工作

### 6.3 性能验证

- [ ] 状态查询索引生效
- [ ] 分页查询性能acceptable
- [ ] 悲观锁不影响并发性能

---

## 七、总结

### 7.1 完成情况

✅ **已完成**:
- 数据库迁移脚本
- 核心实体层重构（WeeklyReport）
- Repository查询方法扩展
- 核心Service层重构（WeeklyReportService、AIAnalysisService）
- Controller层完整重构
- 新增草稿查询接口
- ServiceV3同步更新

⏳ **待完成**:
- WeeklyReportAIService、WeeklyReportStatusManager等辅助文件
- 缺失的DTO类文件
- 测试文件更新
- 前端适配
- 文档更新

### 7.2 核心价值

1. **清晰的状态模型**: 三层独立状态，职责明确
2. **正确的草稿语义**: 草稿不进入审核流程，可随时编辑
3. **可靠的状态转换**: 实体方法封装，保证状态一致性
4. **完整的业务流程**: 创建→编辑→提交→AI分析→审核，逻辑清晰
5. **良好的扩展性**: 状态模型便于后续扩展（如多级审核）

### 7.3 影响范围

- **数据库**: 新增2个字段，修改1个枚举
- **实体层**: 重构状态管理逻辑
- **Service层**: 重构核心方法签名和逻辑
- **Controller层**: 重构所有涉及状态的接口
- **前端**: 需要适配新的状态模型和提交流程

---

**报告生成时间**: 2025-01-16
**修复版本**: V35 (数据库迁移版本号)
**修复人员**: Claude Code (AI Assistant)
