# Redis多环境配置更新说明

**更新时间**: 2025-10-20 17:35:00
**更新内容**: Redis配置按环境分离
**影响范围**: 所有环境配置文件

---

## 更新概览

### 配置迁移

**迁移前**: Redis配置在`application.yml`通用配置中
```yaml
# application.yml
spring:
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: ${REDIS_DATABASE:0}
      timeout: ${REDIS_TIMEOUT:2000}
```

**迁移后**: Redis配置按环境独立配置
```
application.yml          → 不包含Redis配置
application-dev.yml      → 本地Redis配置
application-test.yml     → 测试服务器Redis配置
application-docker.yml   → Docker容器Redis配置
application-prod.yml     → 生产环境Redis配置
```

---

## 各环境Redis配置详情

### 1. application-dev.yml (本地开发)

```yaml
spring:
  data:
    redis:
      host: localhost
      port: 6379
      password:           # 无密码
      database: 0
      timeout: 2000
```

**特点**:
- ✅ 连接本地Redis实例
- ✅ 无密码（开发环境）
- ✅ 短超时时间（2秒）

---

### 2. application-test.yml (测试服务器)

```yaml
spring:
  data:
    redis:
      host: ${REDIS_HOST:23.95.193.155}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: ${REDIS_DATABASE:0}
      timeout: ${REDIS_TIMEOUT:3000}
```

**特点**:
- ✅ 默认连接测试服务器Redis (`23.95.193.155`)
- ✅ 支持环境变量覆盖
- ✅ 适度超时时间（3秒）
- ✅ 可配置密码（通过环境变量）

**环境变量示例**:
```bash
export REDIS_HOST=23.95.193.155
export REDIS_PORT=6379
export REDIS_PASSWORD=test_redis_password
export REDIS_DATABASE=0
```

---

### 3. application-docker.yml (Docker容器)

```yaml
spring:
  data:
    redis:
      host: ${REDIS_HOST:redis}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: ${REDIS_DATABASE:0}
      timeout: ${REDIS_TIMEOUT:3000}
```

**特点**:
- ✅ 默认使用Docker Compose服务名 (`redis`)
- ✅ 容器内部网络通信
- ✅ 支持环境变量覆盖
- ✅ 适度超时时间（3秒）

**Docker Compose配置**:
```yaml
services:
  backend:
    environment:
      REDIS_HOST: redis  # Docker服务名
      REDIS_PORT: 6379
      REDIS_PASSWORD: docker_redis_password

  redis:
    image: redis:7-alpine
    container_name: weekly-report-redis
    ports:
      - "6379:6379"
    command: redis-server --requirepass docker_redis_password
```

---

### 4. application-prod.yml (生产环境)

```yaml
spring:
  data:
    redis:
      host: ${REDIS_HOST}              # 必须配置，无默认值
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD}       # 必须配置，无默认值
      database: ${REDIS_DATABASE:0}
      timeout: ${REDIS_TIMEOUT:5000}
      # 生产环境连接池配置
      lettuce:
        pool:
          max-active: 20    # 最大活跃连接
          max-idle: 10      # 最大空闲连接
          min-idle: 5       # 最小空闲连接
          max-wait: 3000    # 最大等待时间（毫秒）
```

**特点**:
- 🔴 **必须配置环境变量**（`REDIS_HOST`和`REDIS_PASSWORD`无默认值）
- ✅ 更长超时时间（5秒）
- ✅ 连接池优化配置
- ✅ 高可用性和性能

**生产环境变量（必填）**:
```bash
export REDIS_HOST=prod-redis-cluster.example.com
export REDIS_PORT=6379
export REDIS_PASSWORD=secure_production_password
export REDIS_DATABASE=0
export REDIS_TIMEOUT=5000
```

---

## 配置对比表

| 环境 | Host默认值 | 密码默认值 | 超时时间 | 连接池配置 | 环境变量要求 |
|------|-----------|-----------|---------|-----------|------------|
| **dev** | localhost | (空) | 2000ms | 无 | 可选 |
| **test** | 23.95.193.155 | (空) | 3000ms | 无 | 推荐 |
| **docker** | redis | (空) | 3000ms | 无 | 推荐 |
| **prod** | (无) | (无) | 5000ms | ✅ 启用 | **必须** |

---

## 环境变量配置指南

### 本地开发环境

```bash
# 通常不需要设置，使用默认配置即可
# 如需连接其他Redis实例：
export REDIS_HOST=localhost
export REDIS_PORT=6379
```

### 测试服务器环境

```bash
# 推荐通过环境变量配置
export SPRING_PROFILES_ACTIVE=test
export REDIS_HOST=23.95.193.155
export REDIS_PORT=6379
export REDIS_PASSWORD=test_password
export REDIS_DATABASE=0
```

### Docker环境

**docker-compose.yml配置**:
```yaml
version: '3.8'

services:
  redis:
    image: redis:7-alpine
    container_name: weekly-report-redis
    ports:
      - "6379:6379"
    command: redis-server --requirepass redis_password
    networks:
      - backend-network

  backend:
    environment:
      SPRING_PROFILES_ACTIVE: docker
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: redis_password
      REDIS_DATABASE: 0
    depends_on:
      - redis
    networks:
      - backend-network

networks:
  backend-network:
    driver: bridge
```

### 生产环境

```bash
# 所有环境变量必须配置
export SPRING_PROFILES_ACTIVE=prod
export REDIS_HOST=prod-redis-cluster.example.com
export REDIS_PORT=6379
export REDIS_PASSWORD=very_secure_production_password
export REDIS_DATABASE=0
export REDIS_TIMEOUT=5000
```

---

## 验证方法

### 1. 检查Redis配置加载

```bash
# 启动应用并查看日志
mvn spring-boot:run -Dspring-boot.run.profiles=dev

# 查看Redis连接日志（如果启用了连接日志）
# 应该显示连接到 localhost:6379
```

### 2. 测试Redis连接

**方法1: 使用Actuator健康检查**
```bash
curl http://localhost:8081/api/actuator/health

# 期望输出包含Redis健康状态
{
  "status": "UP",
  "components": {
    "redis": {
      "status": "UP",
      "details": {
        "version": "7.0.0"
      }
    }
  }
}
```

**方法2: 使用Redis CLI验证**
```bash
# 本地开发环境
redis-cli -h localhost -p 6379 ping
# 期望输出: PONG

# 测试服务器环境
redis-cli -h 23.95.193.155 -p 6379 -a test_password ping
# 期望输出: PONG
```

---

## 迁移检查清单

### ✅ 完成的更新

- [x] 从`application.yml`移除Redis配置
- [x] 添加Redis配置到`application-dev.yml`
- [x] 添加Redis配置到`application-test.yml`
- [x] 添加Redis配置到`application-docker.yml`
- [x] 添加Redis配置到`application-prod.yml`
- [x] 生产环境配置连接池优化

### 📋 待执行的验证

- [ ] 本地dev环境验证Redis连接
- [ ] 测试服务器验证Redis配置
- [ ] Docker环境验证Redis服务互联
- [ ] 更新Docker Compose配置（如需要）
- [ ] 更新部署文档

---

## Docker Compose Redis集成

### 完整的docker-compose.yml配置

```yaml
version: '3.8'

services:
  # MySQL Database
  mysql:
    image: mysql:8.0
    container_name: weekly-report-backend-mysql
    environment:
      MYSQL_ROOT_PASSWORD: rootpass123
      MYSQL_DATABASE: weekly_report_system
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - backend-network

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: weekly-report-redis
    ports:
      - "6379:6379"
    command: redis-server --requirepass redis_password
    volumes:
      - redis_data:/data
    networks:
      - backend-network
    restart: unless-stopped

  # Backend Application
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: weekly-report-backend
    environment:
      SPRING_PROFILES_ACTIVE: docker
      # Database
      DB_HOST: mysql
      DB_PORT: 3306
      DB_NAME: weekly_report_system
      DB_USERNAME: root
      DB_PASSWORD: rootpass123
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: redis_password
      REDIS_DATABASE: 0
      # JWT
      JWT_SECRET: ${JWT_SECRET}
    ports:
      - "8080:8080"
    depends_on:
      - mysql
      - redis
    networks:
      - backend-network

volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local

networks:
  backend-network:
    driver: bridge
```

---

## 常见问题

### Q1: Redis配置从application.yml移除后，会影响现有环境吗？

**答**: 不会。
- 各环境配置文件已包含Redis配置
- 通过`SPRING_PROFILES_ACTIVE`激活对应环境
- 配置会正确加载

### Q2: 生产环境为什么没有默认值？

**答**: 安全考虑。
- 强制通过环境变量配置
- 避免使用不安全的默认值
- 防止误用开发环境配置

### Q3: 如何验证当前使用的Redis配置？

**答**: 查看启动日志或Actuator端点。
```bash
# 方法1: 查看启动日志
# 日志会显示: "Lettuce pool statistics" 或 Redis连接信息

# 方法2: 使用Actuator
curl http://localhost:8081/api/actuator/health
```

### Q4: 测试服务器上Redis地址是什么？

**答**: 默认配置为`23.95.193.155:6379`
- 可通过环境变量`REDIS_HOST`覆盖
- 如Redis与后端在同一服务器，可设置为`localhost`

---

## 性能优化建议

### 生产环境连接池配置（已应用）

```yaml
spring:
  data:
    redis:
      lettuce:
        pool:
          max-active: 20  # 根据并发量调整
          max-idle: 10
          min-idle: 5
          max-wait: 3000
```

**调优指南**:
- **高并发场景**: 增加`max-active`到50-100
- **低并发场景**: 减少到10-20节省资源
- **频繁访问**: 增加`min-idle`保持连接池预热
- **偶尔访问**: 减少`min-idle`节省资源

### 开发/测试环境

不需要连接池配置，使用默认单连接即可。

---

## 安全建议

### 密码管理

1. **开发环境**: 可以无密码（仅本地访问）
2. **测试环境**: 建议设置密码
3. **生产环境**: **必须设置强密码**

### 网络隔离

1. **开发环境**: localhost访问
2. **Docker环境**: 容器内部网络
3. **生产环境**: VPC内部网络 + 访问控制

---

**更新完成时间**: 2025-10-20 17:35:00
**验证状态**: 配置已更新，待验证
**下一步**: 验证各环境Redis连接
