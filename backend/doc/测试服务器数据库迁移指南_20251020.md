# 测试服务器数据库结构同步执行指南

**生成时间**: 2025-10-20 17:40:00
**目标**: 将测试服务器数据库结构更新为与本地Docker一致
**原则**: 只增不减，保留所有现有数据
**迁移脚本**: `src/main/resources/db/migration_to_test_server_20251020.sql`

---

## 🔍 差异分析

### 缺失的表（测试服务器需要新建）

| 表名 | 用途 | 风险等级 | 数据依赖 |
|------|------|---------|---------|
| `file_attachments` | 文件附件存储 | 🟢 低 | 独立表，无现有数据依赖 |
| `weekly_report_attachments` | 周报附件关联 | 🟢 低 | 依赖file_attachments |
| `weekly_report_comments` | 周报评论 | 🟢 低 | 依赖weekly_reports |
| `file_access_logs` | 文件访问日志 | 🟢 低 | 依赖file_attachments |

**安全性评估**: ✅ 所有表都是新建，不涉及现有数据修改

### 字段差异（需要修改）

#### projects表

| 字段 | 测试服务器 | 本地Docker | 操作 | 风险 |
|------|-----------|-----------|------|------|
| `name` | VARCHAR(200) | TEXT | MODIFY | 🟢 安全 - 数据自动转换 |
| `approval_status` | 包含'AI_APPROVED' | 不包含'AI_APPROVED' | MODIFY | 🟡 **需检查** - 确保无数据使用该值 |

**关键风险点**: `approval_status`枚举修改

---

## ⚠️ 执行前必须检查

### 🔴 关键检查: approval_status数据验证

**目的**: 确保没有数据使用'AI_APPROVED'状态

**检查命令**:
```bash
sshpass -p 'To1YHvWPvyX157jf38' ssh -o StrictHostKeyChecking=no root@23.95.193.155 \
  "docker exec weekly-report-mysql mysql -u root -prootpass123 -e \"
    USE weekly_report_system;
    SELECT approval_status, COUNT(*) as count
    FROM projects
    GROUP BY approval_status;
  \""
```

**期望结果**:
- ✅ 如果没有'AI_APPROVED'记录 → 可以安全执行迁移
- ❌ 如果有'AI_APPROVED'记录 → **必须先手动处理这些数据**

**数据处理方案（如果有AI_APPROVED记录）**:
```sql
-- 将AI_APPROVED状态迁移为AI_ANALYZING
UPDATE projects
SET approval_status = 'AI_ANALYZING'
WHERE approval_status = 'AI_APPROVED';
```

---

## 📋 执行步骤

### 步骤1: 备份测试服务器数据库（必须！）

```bash
# 1.1 SSH登录测试服务器
ssh root@23.95.193.155
# 密码: To1YHvWPvyX157jf38

# 1.2 创建备份目录
mkdir -p /root/database-backups

# 1.3 导出完整数据库备份
docker exec weekly-report-mysql mysqldump -u root -prootpass123 \
  --single-transaction \
  --routines \
  --triggers \
  --events \
  weekly_report_system \
  > /root/database-backups/weekly_report_system_backup_$(date +%Y%m%d_%H%M%S).sql

# 1.4 验证备份文件
ls -lh /root/database-backups/
# 应该看到新创建的备份文件

# 1.5 测试备份可恢复性（可选但强烈推荐）
docker exec weekly-report-mysql mysql -u root -prootpass123 \
  -e "CREATE DATABASE IF NOT EXISTS backup_test;"

docker exec -i weekly-report-mysql mysql -u root -prootpass123 backup_test \
  < /root/database-backups/weekly_report_system_backup_*.sql

docker exec weekly-report-mysql mysql -u root -prootpass123 \
  -e "DROP DATABASE backup_test;"
```

**验证成功标志**: 备份文件大小 > 1KB，且可以成功导入

---

### 步骤2: 检查approval_status数据

```bash
# 在测试服务器上执行
docker exec weekly-report-mysql mysql -u root -prootpass123 -e "
  USE weekly_report_system;
  SELECT approval_status, COUNT(*) as count
  FROM projects
  GROUP BY approval_status;
"
```

**处理逻辑**:
- **如果有AI_APPROVED**: 先执行数据迁移
  ```sql
  UPDATE projects
  SET approval_status = 'AI_ANALYZING'
  WHERE approval_status = 'AI_APPROVED';
  ```
- **如果没有AI_APPROVED**: 直接进入步骤3

---

### 步骤3: 上传迁移脚本到测试服务器

```bash
# 在本地执行
scp -r /Volumes/project/Projects/WeeklyReport/backend/src/main/resources/db/migration_to_test_server_20251020.sql \
  root@23.95.193.155:/root/
```

**验证**:
```bash
ssh root@23.95.193.155 "ls -lh /root/migration_to_test_server_20251020.sql"
```

---

### 步骤4: 执行迁移脚本

```bash
# SSH登录测试服务器
ssh root@23.95.193.155

# 执行迁移脚本
docker exec -i weekly-report-mysql mysql -u root -prootpass123 weekly_report_system \
  < /root/migration_to_test_server_20251020.sql

# 查看执行结果
echo "迁移脚本执行完成，检查结果..."
```

**预期输出**:
```
Query OK, 0 rows affected (0.05 sec)  # ALTER TABLE projects成功
Query OK, 0 rows affected (0.02 sec)  # CREATE TABLE file_attachments成功
Query OK, 0 rows affected (0.02 sec)  # CREATE TABLE weekly_report_attachments成功
Query OK, 0 rows affected (0.02 sec)  # CREATE TABLE weekly_report_comments成功
Query OK, 0 rows affected (0.02 sec)  # CREATE TABLE file_access_logs成功
```

---

### 步骤5: 验证迁移结果

```bash
# 5.1 检查表列表
docker exec weekly-report-mysql mysql -u root -prootpass123 -e "
  USE weekly_report_system;
  SHOW TABLES;
"

# 应该看到12个表（与本地Docker一致）:
# - ai_analysis_results
# - dev_task_reports
# - file_access_logs          ← 新增
# - file_attachments           ← 新增
# - project_phases
# - projects
# - task_reports
# - tasks
# - users
# - weekly_report_attachments  ← 新增
# - weekly_report_comments     ← 新增
# - weekly_reports

# 5.2 验证projects表字段
docker exec weekly-report-mysql mysql -u root -prootpass123 -e "
  USE weekly_report_system;
  DESCRIBE projects;
" | grep -E "name|approval_status"

# 应该看到:
# name: text
# approval_status: enum(...不包含AI_APPROVED...)

# 5.3 验证数据完整性
docker exec weekly-report-mysql mysql -u root -prootpass123 -e "
  USE weekly_report_system;
  SELECT COUNT(*) as total_users FROM users;
  SELECT COUNT(*) as total_projects FROM projects;
  SELECT COUNT(*) as total_reports FROM weekly_reports;
"

# 数据数量应该与迁移前一致

# 5.4 验证新表为空
docker exec weekly-report-mysql mysql -u root -prootpass123 -e "
  USE weekly_report_system;
  SELECT
    (SELECT COUNT(*) FROM file_attachments) as file_attachments,
    (SELECT COUNT(*) FROM weekly_report_attachments) as report_attachments,
    (SELECT COUNT(*) FROM weekly_report_comments) as comments,
    (SELECT COUNT(*) FROM file_access_logs) as access_logs;
"

# 应该全部为0（新表无数据）
```

---

## 🔒 安全检查清单

### 执行前检查

- [ ] ✅ 已备份测试服务器数据库到 `/root/database-backups/`
- [ ] ✅ 已验证备份文件完整性
- [ ] ✅ 已检查projects表中无'AI_APPROVED'状态数据
- [ ] ✅ 已上传迁移脚本到测试服务器
- [ ] ✅ 已确认当前时间非业务高峰期

### 执行中监控

- [ ] ✅ 观察每条SQL语句的执行结果
- [ ] ✅ 检查是否有ERROR错误
- [ ] ✅ 记录执行时间和影响行数

### 执行后验证

- [ ] ✅ 表数量正确（12个表）
- [ ] ✅ projects.name字段类型为TEXT
- [ ] ✅ projects.approval_status不包含AI_APPROVED
- [ ] ✅ 新增4个表存在且为空
- [ ] ✅ 现有数据数量不变
- [ ] ✅ 外键约束正确创建
- [ ] ✅ 索引正确创建

---

## 🚨 回滚方案

### 如果迁移失败

**方案1: 恢复备份**
```bash
# SSH登录测试服务器
ssh root@23.95.193.155

# 停止后端服务（避免连接冲突）
docker stop weekly-report-backend

# 删除当前数据库
docker exec weekly-report-mysql mysql -u root -prootpass123 \
  -e "DROP DATABASE weekly_report_system;"

# 恢复备份
docker exec weekly-report-mysql mysql -u root -prootpass123 \
  -e "CREATE DATABASE weekly_report_system CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

docker exec -i weekly-report-mysql mysql -u root -prootpass123 weekly_report_system \
  < /root/database-backups/weekly_report_system_backup_20251020_*.sql

# 重启后端服务
docker start weekly-report-backend
```

**方案2: 仅回滚表结构修改**
```sql
-- 回滚projects表修改
ALTER TABLE projects
  MODIFY COLUMN name VARCHAR(200) NOT NULL COMMENT '项目名称',
  MODIFY COLUMN approval_status ENUM(
    'AI_ANALYZING',
    'AI_APPROVED',
    'AI_REJECTED',
    'ADMIN_REVIEWING',
    'ADMIN_APPROVED',
    'ADMIN_REJECTED',
    'SUPER_ADMIN_REVIEWING',
    'SUPER_ADMIN_APPROVED',
    'SUPER_ADMIN_REJECTED',
    'FINAL_APPROVED'
  ) NOT NULL DEFAULT 'AI_ANALYZING';

-- 删除新增的表
DROP TABLE IF EXISTS file_access_logs;
DROP TABLE IF EXISTS weekly_report_attachments;
DROP TABLE IF EXISTS weekly_report_comments;
DROP TABLE IF EXISTS file_attachments;
```

---

## 📊 预期影响

### 服务中断时间

- **备份阶段**: 0秒（在线备份，不影响服务）
- **迁移执行**: <5秒（仅DDL操作）
- **验证阶段**: 0秒（SELECT查询）

**总中断时间**: 预计0秒（迁移期间服务可正常运行）

### 数据变更

- **新增表**: 4个（全部为空）
- **修改表**: 1个（projects表字段类型优化）
- **数据丢失**: 0条（只增不减）
- **数据转换**: projects.name自动转换（VARCHAR → TEXT）

---

## 🎯 执行命令快捷清单

### 一键执行脚本（完整流程）

```bash
#!/bin/bash
# 测试服务器数据库迁移一键执行脚本

set -e  # 遇到错误立即退出

echo "=========================================="
echo "测试服务器数据库迁移开始"
echo "=========================================="

# 步骤1: 备份数据库
echo "步骤1: 备份数据库..."
sshpass -p 'To1YHvWPvyX157jf38' ssh -o StrictHostKeyChecking=no root@23.95.193.155 \
  "mkdir -p /root/database-backups && \
   docker exec weekly-report-mysql mysqldump -u root -prootpass123 \
     --single-transaction weekly_report_system \
     > /root/database-backups/weekly_report_system_backup_\$(date +%Y%m%d_%H%M%S).sql && \
   ls -lh /root/database-backups/ | tail -1"

echo "✅ 备份完成"

# 步骤2: 检查approval_status数据
echo "步骤2: 检查approval_status数据..."
sshpass -p 'To1YHvWPvyX157jf38' ssh -o StrictHostKeyChecking=no root@23.95.193.155 \
  "docker exec weekly-report-mysql mysql -u root -prootpass123 -e \"
    USE weekly_report_system;
    SELECT approval_status, COUNT(*) as count
    FROM projects
    GROUP BY approval_status;
  \"" 2>&1 | grep -v "Warning"

read -p "如果有AI_APPROVED记录，是否继续？(yes/no): " confirm
if [ "$confirm" != "yes" ]; then
    echo "❌ 用户取消操作"
    exit 1
fi

# 步骤3: 上传迁移脚本
echo "步骤3: 上传迁移脚本..."
scp /Volumes/project/Projects/WeeklyReport/backend/src/main/resources/db/migration_to_test_server_20251020.sql \
  root@23.95.193.155:/root/

echo "✅ 脚本上传完成"

# 步骤4: 执行迁移
echo "步骤4: 执行迁移脚本..."
sshpass -p 'To1YHvWPvyX157jf38' ssh -o StrictHostKeyChecking=no root@23.95.193.155 \
  "docker exec -i weekly-report-mysql mysql -u root -prootpass123 weekly_report_system \
     < /root/migration_to_test_server_20251020.sql"

echo "✅ 迁移脚本执行完成"

# 步骤5: 验证结果
echo "步骤5: 验证迁移结果..."
sshpass -p 'To1YHvWPvyX157jf38' ssh -o StrictHostKeyChecking=no root@23.95.193.155 \
  "docker exec weekly-report-mysql mysql -u root -prootpass123 -e \"
    USE weekly_report_system;
    SHOW TABLES;
  \"" 2>&1 | grep -v "Warning"

echo "=========================================="
echo "✅ 测试服务器数据库迁移完成"
echo "=========================================="
```

---

## 📖 手动执行步骤（推荐）

### 步骤1: 备份数据库

```bash
ssh root@23.95.193.155
# 密码: To1YHvWPvyX157jf38

mkdir -p /root/database-backups

docker exec weekly-report-mysql mysqldump -u root -prootpass123 \
  --single-transaction weekly_report_system \
  > /root/database-backups/weekly_report_system_backup_$(date +%Y%m%d_%H%M%S).sql

ls -lh /root/database-backups/
```

### 步骤2: 检查approval_status

```bash
docker exec weekly-report-mysql mysql -u root -prootpass123 -e "
  USE weekly_report_system;
  SELECT approval_status, COUNT(*) as count
  FROM projects
  GROUP BY approval_status;
"
```

**如果有AI_APPROVED记录**:
```bash
# 先迁移数据
docker exec weekly-report-mysql mysql -u root -prootpass123 -e "
  USE weekly_report_system;
  UPDATE projects
  SET approval_status = 'AI_ANALYZING'
  WHERE approval_status = 'AI_APPROVED';
"
```

### 步骤3: 上传迁移脚本

```bash
# 退出SSH，在本地执行
exit

scp /Volumes/project/Projects/WeeklyReport/backend/src/main/resources/db/migration_to_test_server_20251020.sql \
  root@23.95.193.155:/root/
```

### 步骤4: 执行迁移

```bash
# 重新SSH登录
ssh root@23.95.193.155

docker exec -i weekly-report-mysql mysql -u root -prootpass123 weekly_report_system \
  < /root/migration_to_test_server_20251020.sql
```

### 步骤5: 验证结果

```bash
# 检查表数量
docker exec weekly-report-mysql mysql -u root -prootpass123 -e "
  USE weekly_report_system;
  SELECT COUNT(*) as total_tables
  FROM information_schema.tables
  WHERE table_schema = 'weekly_report_system';
"
# 期望: 12个表

# 检查新表
docker exec weekly-report-mysql mysql -u root -prootpass123 -e "
  USE weekly_report_system;
  SHOW TABLES LIKE '%file%';
  SHOW TABLES LIKE '%comment%';
"
# 期望: 看到file_attachments, file_access_logs, weekly_report_comments等

# 检查projects表结构
docker exec weekly-report-mysql mysql -u root -prootpass123 -e "
  USE weekly_report_system;
  DESCRIBE projects;
" | grep -E "name|approval_status"

# 验证数据完整性
docker exec weekly-report-mysql mysql -u root -prootpass123 -e "
  USE weekly_report_system;
  SELECT
    (SELECT COUNT(*) FROM users) as users,
    (SELECT COUNT(*) FROM projects) as projects,
    (SELECT COUNT(*) FROM weekly_reports) as reports;
"
```

---

## 常见问题

### Q1: 迁移会影响正在运行的后端服务吗？

**答**: 会有极短暂影响（<1秒）
- DDL操作会短暂锁表
- 建议在低峰期执行
- 如有必要，可临时停止后端容器

### Q2: 如果projects表中有AI_APPROVED数据怎么办？

**答**: 先迁移数据，再执行schema修改
```sql
-- 迁移方案1: 改为AI_ANALYZING
UPDATE projects SET approval_status = 'AI_ANALYZING'
WHERE approval_status = 'AI_APPROVED';

-- 迁移方案2: 改为ADMIN_REVIEWING
UPDATE projects SET approval_status = 'ADMIN_REVIEWING'
WHERE approval_status = 'AI_APPROVED';
```

### Q3: 新增的表会立即使用吗？

**答**: 不会
- 这些表是文件管理和评论功能
- 需要前端功能开发后才会有数据
- 当前创建是为了schema完整性

### Q4: 如果迁移失败如何恢复？

**答**: 使用备份恢复
```bash
docker exec -i weekly-report-mysql mysql -u root -prootpass123 \
  -e "DROP DATABASE weekly_report_system;"

docker exec -i weekly-report-mysql mysql -u root -prootpass123 \
  -e "CREATE DATABASE weekly_report_system CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

docker exec -i weekly-report-mysql mysql -u root -prootpass123 weekly_report_system \
  < /root/database-backups/weekly_report_system_backup_20251020_*.sql
```

---

## 📝 执行记录模板

```
执行时间: ________________
执行人员: ________________

备份信息:
- 备份文件: /root/database-backups/weekly_report_system_backup_YYYYMMDD_HHMMSS.sql
- 备份大小: _______ KB
- 验证结果: ✅/❌

approval_status检查:
- AI_APPROVED记录数: _______
- 处理方式: _________________

迁移执行:
- 开始时间: __:__:__
- 结束时间: __:__:__
- 执行结果: ✅/❌

验证结果:
- 表数量: _______ (期望12)
- projects.name类型: _______ (期望TEXT)
- 数据完整性: ✅/❌
- 新表创建: ✅/❌

问题记录:
_______________________________
_______________________________
```

---

**文档生成时间**: 2025-10-20 17:45:00
**迁移脚本**: `src/main/resources/db/migration_to_test_server_20251020.sql`
**风险等级**: 🟡 中等（需要备份和验证）
**预计执行时间**: 5-10分钟
