# 周报系统模块化架构文档

## 项目概述
本项目是一个基于Spring Boot的周报管理系统，支持用户提交周报、项目管理、AI分析等功能。项目采用分层架构和领域驱动设计思想，具有清晰的模块划分和职责分离。

## 模块划分

### 1. 认证授权模块 (Authentication & Authorization)
**包路径**: `com.weeklyreport.security`、`com.weeklyreport.dto.auth`、部分`com.weeklyreport.controller`

**核心业务**: 用户认证、授权、JWT令牌管理、角色权限控制

**主要组件**:
- **Security包**:
  - `JwtTokenProvider` - JWT令牌生成和验证
  - `CustomUserDetailsService` - 用户详情服务
  - `JwtAuthenticationFilter` - JWT认证过滤器
  - `CustomUserPrincipal` - 自定义用户主体
  - `JwtAccessDeniedHandler` - 访问拒绝处理器
  - `JwtAuthenticationEntryPoint` - 认证入口点

- **Controller层**:
  - `AuthController` - 认证API接口（登录、注册、令牌刷新）

- **DTO包**:
  - `AuthResponse` - 认证响应
  - `LoginRequest` - 登录请求
  - `RegisterRequest` - 注册请求
  - `ChangePasswordRequest` - 修改密码请求
  - `RefreshTokenRequest` - 刷新令牌请求
  - `UpdateProfileRequest` - 更新用户资料请求

- **Service层**:
  - `AuthService` - 认证业务逻辑

**业务功能**:
- 用户登录、注册
- JWT令牌生成、刷新、验证
- 密码加密和验证
- 用户权限控制（USER、MANAGER、ADMIN、SUPER_ADMIN）
- 会话管理

---

### 2. 用户管理模块 (User Management)
**包路径**: `com.weeklyreport.entity.User`、`com.weeklyreport.dto.user`、`com.weeklyreport.service.UserService`

**核心业务**: 用户信息管理、用户状态管理、用户查询

**主要组件**:
- **Entity层**:
  - `User` - 用户实体（用户名、邮箱、密码、角色、状态）

- **Repository层**:
  - `UserRepository` - 用户数据访问

- **Service层**:
  - `UserService` - 用户业务逻辑和统计

- **Controller层**:
  - `UserController` - 用户管理API接口

- **DTO包**:
  - `UpdateUserRequest` - 更新用户请求
  - `UserListDTO` - 用户列表DTO

**业务功能**:
- 用户信息CRUD操作
- 用户状态管理（ACTIVE、INACTIVE、LOCKED、PENDING）
- 用户角色管理
- 用户统计和查询

---

### 3. 项目管理模块 (Project Management)
**包路径**: `com.weeklyreport.entity.Project*`、`com.weeklyreport.dto.project`、相关Service和Controller

**核心业务**: 项目创建、管理、审批流程、项目成员管理

**主要组件**:
- **Entity层**:
  - `Project` - 项目实体（项目基本信息、审批状态）
  - `ProjectMember` - 项目成员实体
  - `ProjectPhase` - 项目阶段实体
  - `SimpleProject` - 简化项目实体

- **Repository层**:
  - `ProjectRepository` - 项目数据访问
  - `ProjectMemberRepository` - 项目成员数据访问
  - `ProjectPhaseRepository` - 项目阶段数据访问
  - `SimpleProjectRepository` - 简化项目数据访问

- **Service层**:
  - 项目相关业务逻辑在各个Service中分散处理

- **Controller层**:
  - `ProjectController` - 项目管理API接口

- **DTO包**:
  - `ProjectCreateRequest` - 项目创建请求
  - `ProjectUpdateRequest` - 项目更新请求
  - `ProjectResponse` - 项目响应
  - `ProjectListResponse` - 项目列表响应
  - `ProjectFilterRequest` - 项目过滤请求
  - `ProjectMemberRequest` - 项目成员请求
  - `ProjectMemberResponse` - 项目成员响应
  - `ProjectPhaseCreateRequest` - 项目阶段创建请求
  - `ProjectPhaseResponse` - 项目阶段响应

**业务功能**:
- 项目创建、编辑、删除
- 项目审批流程（待审批、已审批、已拒绝）
- 项目成员管理
- 项目阶段管理
- 项目状态跟踪
- 项目优先级管理

---

### 4. 周报管理模块 (Weekly Report Management)
**包路径**: `com.weeklyreport.entity.WeeklyReport*`、`com.weeklyreport.dto.weeklyreport`、相关Service和Controller

**核心业务**: 周报创建、编辑、提交、审批、查询

**主要组件**:
- **Entity层**:
  - `WeeklyReport` - 主周报实体
  - `WeeklyReportV2` - 第二版周报实体
  - `SimpleWeeklyReport` - 简化周报实体

- **Repository层**:
  - `WeeklyReportRepository` - 周报数据访问
  - `WeeklyReportV2Repository` - V2周报数据访问
  - `SimpleWeeklyReportRepository` - 简化周报数据访问

- **Service层**:
  - `WeeklyReportService` - 周报核心业务逻辑
  - `WeeklyReportServiceV3` - V3版本周报服务
  - `WeeklyReportAIService` - 周报AI集成服务

- **Controller层**:
  - `WeeklyReportController` - 周报API接口
  - `SimpleController` - 简化版周报接口

- **DTO包**:
  - `WeeklyReportCreateRequest` - 周报创建请求
  - `WeeklyReportUpdateRequest` - 周报更新请求
  - `WeeklyReportResponse` - 周报响应
  - `WeeklyReportDetailResponse` - 周报详情响应
  - `WeeklyReportListResponse` - 周报列表响应
  - `WeeklyReportFilterRequest` - 周报过滤请求
  - `WeeklyReportTaskReference` - 周报任务引用
  - `WeeklyReportV2Request` - V2版本请求
  - 多种任务相关DTO（DevTaskReportDTO、TaskReportDTO等）

**业务功能**:
- 周报创建、编辑、删除
- 周报提交和撤回
- 周报审批流程
- 周报状态管理（草稿、已提交、审批中、已批准、已拒绝）
- 周报模板管理
- 周报查询和过滤
- 周报统计分析

---

### 5. 任务管理模块 (Task Management)
**包路径**: `com.weeklyreport.entity.Task*`、`com.weeklyreport.dto.task`、相关Service和Controller

**核心业务**: 任务创建、分配、跟踪、报告

**主要组件**:
- **Entity层**:
  - `Task` - 任务实体
  - `TaskReport` - 任务报告实体
  - `DevTaskReport` - 开发任务报告实体
  - `RoutineTask` - 常规任务实体

- **Repository层**:
  - `TaskRepository` - 任务数据访问
  - `TaskReportRepository` - 任务报告数据访问
  - `DevTaskReportRepository` - 开发任务报告数据访问
  - `RoutineTaskRepository` - 常规任务数据访问

- **Service层**:
  - `TaskService` - 任务业务逻辑
  - `RoutineTaskService` - 常规任务业务逻辑

- **Controller层**:
  - `TaskController` - 任务API接口

- **DTO包**:
  - `TaskCreateRequest` - 任务创建请求
  - `TaskResponse` - 任务响应

**业务功能**:
- 任务创建和分配
- 任务状态跟踪
- 任务优先级管理
- 任务报告生成
- 开发任务和常规任务管理
- 任务统计分析

---

### 6. AI分析模块 (AI Analysis)
**包路径**: `com.weeklyreport.service.ai`、`com.weeklyreport.dto.ai`、相关Controller

**核心业务**: AI驱动的周报和项目分析、智能建议、数据洞察

**主要组件**:
- **Entity层**:
  - `AIAnalysisResult` - AI分析结果实体

- **Repository层**:
  - `AIAnalysisResultRepository` - AI分析结果数据访问

- **Service层**:
  - `AIAnalysisService` - AI分析服务
  - `EnhancedAIAnalysisService` - 增强AI分析服务
  - `AIMonitoringService` - AI监控服务
  - `AICallbackTransactionService` - AI回调事务服务
  - `AIServiceFactory` - AI服务工厂
  - `AbstractAIServiceProvider` - 抽象AI服务提供者
  - `DataSanitizer` - 数据清洗服务
  - **AI Provider子模块**:
    - `DeepSeekAIService` - DeepSeek AI集成
    - `OpenAIService` - OpenAI集成  
    - `MockAIService` - 模拟AI服务

- **Controller层**:
  - `AITestController` - AI测试接口
  - `TestAIController` - AI测试控制器

- **DTO包**:
  - `AIAnalysisRequest` - AI分析请求
  - `AIAnalysisResponse` - AI分析响应
  - `AIAnalysisResultResponse` - AI分析结果响应
  - `AIMetricsResponse` - AI指标响应
  - `AIProjectInsightRequest` - AI项目洞察请求
  - `AIProjectInsightResponse` - AI项目洞察响应
  - `AISuggestionRequest` - AI建议请求
  - `AISuggestionResponse` - AI建议响应

**业务功能**:
- 周报内容AI分析
- 项目进度AI评估
- 智能建议生成
- 数据洞察和趋势分析
- 多AI提供商支持（DeepSeek、OpenAI）
- AI分析结果缓存和监控
- 数据清洗和预处理

---

### 7. 系统基础设施模块 (Infrastructure)
**包路径**: `com.weeklyreport.config`、`com.weeklyreport.util`、`com.weeklyreport.validation`、`com.weeklyreport.exception`

**核心业务**: 系统配置、工具类、异常处理、数据验证

**主要组件**:
- **配置包**:
  - `SecurityConfig` - 安全配置
  - `DatabaseConfig` - 数据库配置
  - `AIConfig` - AI服务配置
  - `WebMvcConfig` - Web MVC配置
  - `OpenApiConfig` - API文档配置
  - `AsyncConfig` - 异步配置
  - `AIAsyncConfig` - AI异步配置
  - `PerformanceConfig` - 性能配置
  - `DataInitializer` - 数据初始化

- **工具包**:
  - `WeekFormatHelper` - 周期格式辅助类
  - `PasswordFixUtil` - 密码修复工具
  - `ComprehensiveDatabaseFix` - 数据库修复工具
  - `SimpleCommentsTableFix` - 评论表修复工具
  - **认证工具子包**:
    - `AuthorizationHelper` - 授权辅助
    - `PermissionChecker` - 权限检查
    - `RoleHierarchy` - 角色层次
    - `SecurityUtils` - 安全工具

- **验证包**:
  - `PasswordMatching` - 密码匹配验证注解
  - `PasswordMatchingValidator` - 密码匹配验证器
  - `UniqueEmail` - 邮箱唯一性验证注解
  - `UniqueEmailValidator` - 邮箱唯一性验证器
  - `UniqueUsername` - 用户名唯一性验证注解
  - `UniqueUsernameValidator` - 用户名唯一性验证器

- **异常处理包**:
  - `GlobalExceptionHandler` - 全局异常处理器
  - `AuthenticationException` - 认证异常
  - `UserManagementException` - 用户管理异常

- **Controller层**:
  - `BaseController` - 基础控制器
  - `HealthController` - 健康检查控制器
  - `DebugController` - 调试控制器

**业务功能**:
- 系统安全配置
- 数据库连接和事务管理
- 跨域请求处理
- 异步任务配置
- 数据验证和清洗
- 全局异常处理
- 系统监控和健康检查
- 性能优化配置

---

### 8. 评论模块 (Comment)
**包路径**: `com.weeklyreport.entity.Comment`、相关Repository

**核心业务**: 周报和项目评论功能

**主要组件**:
- **Entity层**:
  - `Comment` - 评论实体

- **Repository层**:
  - `CommentRepository` - 评论数据访问

**业务功能**:
- 周报评论
- 项目评论
- 评论状态管理
- 评论类型分类

---

## 模块间依赖关系

### 依赖层次图
```
┌─────────────────────────────────────────────────────────────┐
│                    Web层 (Controller)                       │
│  AuthController, WeeklyReportController, ProjectController  │
│                   UserController, TaskController            │
└─────────────────────────┬───────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────┐
│                   业务层 (Service)                          │
│   AuthService, WeeklyReportService, UserService            │
│   TaskService, AIAnalysisService                           │
└─────────────────────────┬───────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────┐
│                  数据访问层 (Repository)                     │
│   UserRepository, WeeklyReportRepository                   │
│   ProjectRepository, TaskRepository                        │
└─────────────────────────┬───────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────┐
│                   实体层 (Entity)                           │
│   User, WeeklyReport, Project, Task, Comment               │
└─────────────────────────────────────────────────────────────┘

横切关注点:
┌─────────────────────────────────────────────────────────────┐
│  Security (认证授权) + Exception (异常处理) + Validation     │
│  Config (配置管理) + Utils (工具类) + AI (智能分析)          │
└─────────────────────────────────────────────────────────────┘
```

### 核心依赖关系
1. **认证授权模块** → 所有业务模块（提供安全保障）
2. **周报管理模块** → 项目管理模块、任务管理模块、AI分析模块
3. **AI分析模块** → 周报管理模块、项目管理模块（提供智能分析）
4. **系统基础设施模块** → 所有模块（提供基础服务）
5. **用户管理模块** → 认证授权模块、周报管理模块、项目管理模块

### 数据流向
```
用户请求 → 认证过滤器 → Controller → Service → Repository → Entity
         ↓                    ↓         ↓
      JWT验证              业务逻辑    数据持久化
         ↓                    ↓         ↓
      权限检查              AI分析     数据验证
```

## 建议的模块重构方案

### 当前问题
1. **包结构过于平坦**: 所有功能混在一个包层级下
2. **模块边界不清晰**: Service和Controller职责重叠
3. **AI模块相对独立**: 但与业务模块集成度不够高
4. **配置分散**: 各类配置混在一个config包下

### 推荐的新包结构
```
com.weeklyreport/
├── core/                           # 核心基础设施
│   ├── config/                     # 配置管理
│   ├── security/                   # 安全框架
│   ├── exception/                  # 异常处理
│   └── validation/                 # 数据验证
│
├── user/                          # 用户管理领域
│   ├── controller/
│   ├── service/
│   ├── repository/
│   ├── entity/
│   └── dto/
│
├── auth/                          # 认证授权领域
│   ├── controller/
│   ├── service/
│   ├── security/
│   └── dto/
│
├── project/                       # 项目管理领域
│   ├── controller/
│   ├── service/
│   ├── repository/
│   ├── entity/
│   └── dto/
│
├── weeklyreport/                  # 周报管理领域
│   ├── controller/
│   ├── service/
│   ├── repository/
│   ├── entity/
│   └── dto/
│
├── task/                          # 任务管理领域
│   ├── controller/
│   ├── service/
│   ├── repository/
│   ├── entity/
│   └── dto/
│
├── ai/                            # AI分析领域
│   ├── service/
│   ├── provider/                   # AI提供商
│   ├── entity/
│   └── dto/
│
└── common/                        # 通用组件
    ├── dto/                       # 通用DTO
    ├── util/                      # 工具类
    └── constant/                  # 常量定义
```

### 重构收益
1. **清晰的领域边界**: 每个模块专注于特定业务领域
2. **更好的可维护性**: 相关代码组织在一起
3. **降低耦合度**: 模块间通过明确接口交互
4. **便于团队协作**: 不同团队可以专注不同领域
5. **更好的测试性**: 模块化便于单元测试和集成测试

---

*文档生成时间: 2025-09-25*  
*项目版本: Weekly Report System v1.0*  
*文档维护: 开发团队*