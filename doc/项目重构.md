# 项目重构分析文档

基于error3.md需求分析的周报系统重构方案

## 一、重构背景与目标

### 1.1 问题现状
现有周报系统存在以下关键问题：
- 数据结构冗余，包含不必要字段（`workSummary`、`achievements`、`challenges`、`priority`等）
- 前端硬编码日期格式，未使用中文周格式
- 任务关联方式复杂，序列化/反序列化导致关联信息丢失
- 缺乏结构化的任务引用机制

### 1.2 重构目标
- 简化数据结构，删除冗余字段
- 实现结构化任务引用，提高数据一致性
- 引入中文周格式显示
- 优化数据库设计，提高查询效率
- 保持向后兼容性

## 二、数据库重构分析

### 2.1 当前数据库结构分析

#### 现有核心表：
```sql
-- 用户表（保留）
users (id, username, email, password, first_name, last_name, role, department_id, status)

-- 周报表（需要重构）
weekly_reports (
    id, user_id, template_id, title, content, summary, status, 
    week_start, week_end, submitted_at, reviewed_at, reviewed_by, 
    review_comments, priority, tags, attachments, view_count,
    created_at, updated_at, deleted_at
)

-- 任务表（需要扩展）
tasks (现有结构需要补充任务类型字段)

-- 简化项目表（已存在）
simple_projects (
    id, project_name, project_content, project_members, 
    key_indicators, expected_results, actual_results, 
    timeline, stop_loss, status, ai_analysis_result, 
    created_by, created_at, updated_at
)
```

### 2.2 需要删除的冗余字段

#### weekly_reports表中需要删除的字段：
- `template_id` - 不再使用模板机制
- `priority` - 优先级字段为多余
- `tags` - 标签功能暂不需要
- `attachments` - 附件功能暂不需要
- `view_count` - 查看次数非核心功能

#### 需要添加的字段：
- `report_week` VARCHAR(50) - 中文周格式显示
- `additional_notes` TEXT - 其他备注
- `development_opportunities` TEXT - 可发展性清单
- `ai_analysis_passed` BOOLEAN - AI分析是否通过
- `ai_analysis_result` TEXT - AI分析结果
- `admin_reviewer_id` BIGINT - 管理员审批人ID
- `super_admin_reviewer_id` BIGINT - 超级管理员审批人ID
- `rejection_reason` TEXT - 拒绝理由
- `approval_status` ENUM('PENDING_AI', 'PENDING_ADMIN', 'PENDING_SUPER_ADMIN', 'APPROVED', 'REJECTED')

### 2.3 新增数据库表设计

#### 2.3.1 日常性任务表
```sql
CREATE TABLE routine_tasks (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    task_name VARCHAR(255) NOT NULL COMMENT '任务名称',
    task_description TEXT COMMENT '任务描述',
    created_by BIGINT NOT NULL COMMENT '创建者ID',
    status ENUM('ACTIVE', 'INACTIVE') DEFAULT 'ACTIVE',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_routine_tasks_created_by (created_by),
    INDEX idx_routine_tasks_status (status)
) COMMENT='日常性任务表';
```

#### 2.3.2 项目阶段表
```sql
CREATE TABLE project_phases (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    project_id BIGINT NOT NULL COMMENT '关联项目ID',
    phase_name VARCHAR(255) NOT NULL COMMENT '阶段名称',
    phase_description TEXT COMMENT '阶段描述',
    expected_start_date DATE COMMENT '预期开始日期',
    expected_end_date DATE COMMENT '预期结束日期',
    actual_start_date DATE COMMENT '实际开始日期',
    actual_end_date DATE COMMENT '实际结束日期',
    status ENUM('NOT_STARTED', 'IN_PROGRESS', 'COMPLETED', 'CANCELLED') DEFAULT 'NOT_STARTED',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (project_id) REFERENCES simple_projects(id) ON DELETE CASCADE,
    INDEX idx_project_phases_project_id (project_id),
    INDEX idx_project_phases_status (status)
) COMMENT='项目阶段表';
```

#### 2.3.3 重构后的周报表
```sql
CREATE TABLE weekly_reports_v2 (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL COMMENT '用户ID',
    title VARCHAR(200) NOT NULL COMMENT '周报标题',
    report_week VARCHAR(50) NOT NULL COMMENT '周报周次（中文格式）',
    content JSON NOT NULL COMMENT '结构化内容',
    additional_notes TEXT COMMENT '其他备注',
    development_opportunities TEXT COMMENT '可发展性清单',
    
    -- 状态控制
    status ENUM('DRAFT', 'SUBMITTED', 'PENDING_AI', 'PENDING_ADMIN', 'PENDING_SUPER_ADMIN', 'APPROVED', 'REJECTED') DEFAULT 'DRAFT',
    
    -- AI分析相关
    ai_analysis_passed BOOLEAN DEFAULT NULL COMMENT 'AI分析是否通过',
    ai_analysis_result TEXT COMMENT 'AI分析结果',
    
    -- 审批相关
    admin_reviewer_id BIGINT COMMENT '管理员审批人ID',
    super_admin_reviewer_id BIGINT COMMENT '超级管理员审批人ID',
    rejection_reason TEXT COMMENT '拒绝理由',
    
    -- 时间控制
    week_start DATE NOT NULL COMMENT '周开始日期',
    week_end DATE NOT NULL COMMENT '周结束日期',
    submitted_at TIMESTAMP NULL COMMENT '提交时间',
    reviewed_at TIMESTAMP NULL COMMENT '审核时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (admin_reviewer_id) REFERENCES users(id) ON DELETE SET NULL,
    FOREIGN KEY (super_admin_reviewer_id) REFERENCES users(id) ON DELETE SET NULL,
    
    INDEX idx_weekly_reports_v2_user_id (user_id),
    INDEX idx_weekly_reports_v2_status (status),
    INDEX idx_weekly_reports_v2_week_start (week_start),
    INDEX idx_weekly_reports_v2_report_week (report_week),
    UNIQUE KEY uk_user_week (user_id, week_start)
) COMMENT='周报表V2';
```

### 2.4 JSON内容结构设计
```json
{
  "thisWeekReport": {
    "routineTasks": [
      {
        "taskId": 1,
        "actualResult": "实际结果",
        "analysisOfResultDifferences": "结果差异分析"
      }
    ],
    "developmentTasks": [
      {
        "projectId": 1,
        "phaseId": 1,
        "actualResult": "实际结果",
        "analysisOfResultDifferences": "结果差异分析"
      }
    ]
  },
  "nextWeekPlan": {
    "routineTasks": [
      {
        "taskId": 2
      }
    ],
    "developmentTasks": [
      {
        "projectId": 1,
        "phaseId": 2
      }
    ]
  }
}
```

### 2.5 数据迁移策略

#### 2.5.1 保留数据
- `users` 表完全保留
- `simple_projects` 表保留，需要添加审批相关字段
- `weekly_reports` 表数据需要转换到新结构

#### 2.5.2 删除数据
- `templates` 表及相关数据（不再使用模板）
- `comments` 表相关数据（简化系统）
- `departments` 表（暂时简化组织架构）

## 三、后端重构分析

### 3.1 需要删除的类和文件

#### DTO类：
- `WeeklyReportCreateRequest.java` - 替换为V2版本
- `WeeklyReportUpdateRequest.java` - 合并到V2版本
- `WeeklyReportResponse.java` - 重构为V2版本
- 模板相关的所有DTO类

#### 服务类：
- `TemplateService.java` - 删除模板功能
- `CommentService.java` - 删除评论功能
- `DepartmentService.java` - 简化组织架构

#### 控制器：
- `TemplateController.java`
- `CommentController.java`
- `DepartmentController.java`

### 3.2 需要新建的类

#### 实体类：
```java
@Entity
@Table(name = "routine_tasks")
public class RoutineTask {
    private Long id;
    private String taskName;
    private String taskDescription;
    private User createdBy;
    private TaskStatus status;
    // ... getters/setters
}

@Entity  
@Table(name = "project_phases")
public class ProjectPhase {
    private Long id;
    private SimpleProject project;
    private String phaseName;
    private String phaseDescription;
    private LocalDate expectedStartDate;
    private LocalDate expectedEndDate;
    private PhaseStatus status;
    // ... getters/setters
}
```

#### DTO类：
```java
// 结构化内容DTO
public class WeeklyReportContentV2 {
    private ThisWeekReport thisWeekReport;
    private NextWeekPlan nextWeekPlan;
}

public class ThisWeekReport {
    private List<RoutineTaskReference> routineTasks;
    private List<DevelopmentTaskReference> developmentTasks;
}

public class RoutineTaskReference {
    private Long taskId;
    private String actualResult;
    private String analysisOfResultDifferences;
}

public class DevelopmentTaskReference {
    private Long projectId;
    private Long phaseId;
    private String actualResult;
    private String analysisOfResultDifferences;
}
```

#### 服务类：
```java
@Service
public class RoutineTaskService {
    // 日常任务管理
}

@Service
public class ProjectPhaseService {
    // 项目阶段管理
}

@Service
public class WeeklyReportServiceV2 {
    // V2版本周报服务（已存在，需要完善）
}
```

### 3.3 需要重构的现有类

#### WeeklyReportController.java
- 保留基础CRUD操作
- 添加V2版本的API端点
- 移除模板相关端点
- 添加审批流程端点

#### WeeklyReportService.java
- 保留基础功能用于向后兼容
- 逐步迁移到V2版本

#### User.java实体类
- 添加审批相关的方法
- 优化角色权限体系

## 四、前端重构分析

### 4.1 需要删除的组件和文件

#### 组件：
- `TemplateManager.vue` - 模板管理组件
- `CommentSection.vue` - 评论相关组件
- `DepartmentManagement.vue` - 部门管理组件
- 所有模板相关的子组件

#### 页面：
- `TemplateView.vue`
- `DepartmentView.vue`
- 评论管理相关页面

#### 工具类：
- `templateUtils.js`
- `commentUtils.js`

### 4.2 需要新建的组件

#### 任务管理组件：
```vue
<!-- RoutineTaskManager.vue -->
<template>
  <div class="routine-task-manager">
    <!-- 日常任务管理界面 -->
  </div>
</template>

<!-- ProjectPhaseManager.vue -->
<template>
  <div class="project-phase-manager">
    <!-- 项目阶段管理界面 -->
  </div>
</template>

<!-- TaskReferenceSelector.vue -->
<template>
  <div class="task-reference-selector">
    <!-- 任务引用选择器 -->
  </div>
</template>
```

#### 周报组件重构：
```vue
<!-- WeeklyReportFormV2.vue -->
<template>
  <div class="weekly-report-form-v2">
    <div class="this-week-section">
      <!-- 本周汇报结构化输入 -->
    </div>
    <div class="next-week-section">
      <!-- 下周规划结构化输入 -->
    </div>
  </div>
</template>
```

### 4.3 需要重构的现有组件

#### ReportManager.vue
- 移除模板选择功能
- 添加结构化任务选择
- 重构数据提交格式

#### CreateReportView.vue / EditReportView.vue
- 重构表单结构
- 实现任务引用机制
- 添加中文周格式显示

#### ReportsView.vue
- 更新列表显示格式
- 移除不必要的字段显示
- 优化查询和过滤功能

### 4.4 API服务重构

#### api.js
```javascript
// 删除的API调用
- getAllTemplates()
- createTemplate()
- updateTemplate()
- deleteTemplate()
- getAllComments()
- createComment()

// 新增的API调用
+ getRoutineTasks()
+ createRoutineTask()
+ getProjectPhases(projectId)
+ createProjectPhase()
+ createWeeklyReportV2()
+ getWeeklyReportV2(id)
+ updateWeeklyReportV2(id, data)

// 重构的API调用
~ getAllWeeklyReports() // 适配新数据结构
~ getWeeklyReport(id) // 支持V2格式
```

## 五、工具类和辅助功能

### 5.1 日期格式化工具

#### WeekFormatHelper.java
```java
public class WeekFormatHelper {
    /**
     * 获取中文周格式：几月第几周（周几）
     */
    public static String getReportWeekDisplay(LocalDate date) {
        int month = date.getMonthValue();
        int weekOfMonth = getWeekOfMonth(date);
        String dayOfWeek = getDayOfWeekChinese(date.getDayOfWeek());
        return String.format("%d月第%d周（%s）", month, weekOfMonth, dayOfWeek);
    }
}
```

### 5.2 数据验证工具

#### TaskReferenceValidator.java
```java
public class TaskReferenceValidator {
    public static void validateRoutineTaskReference(RoutineTaskReference ref);
    public static void validateDevelopmentTaskReference(DevelopmentTaskReference ref);
    public static void validateWeeklyReportContent(WeeklyReportContentV2 content);
}
```

## 六、重构实施计划

### 6.1 第一阶段：数据库重构
1. 创建新表：`routine_tasks`, `project_phases`
2. 修改现有表：添加新字段到 `simple_projects` 和 `weekly_reports`
3. 数据迁移脚本：将现有数据转换为新格式
4. 索引优化：添加必要的数据库索引

### 6.2 第二阶段：后端重构
1. 创建新的实体类和DTO
2. 实现V2版本的服务类
3. 添加V2版本的API端点
4. 单元测试和集成测试

### 6.3 第三阶段：前端重构
1. 创建新的组件
2. 重构现有页面
3. 更新API调用
4. 端到端测试

### 6.4 第四阶段：清理和优化
1. 删除不再使用的代码
2. 性能优化
3. 文档更新
4. 部署和监控

## 七、风险评估与注意事项

### 7.1 数据安全风险
- 数据迁移过程中需要完整备份
- 迁移脚本需要充分测试
- 保留回滚机制

### 7.2 向后兼容性
- 保留旧API一段时间用于过渡
- 提供数据格式转换工具
- 渐进式迁移策略

### 7.3 用户体验影响
- 用户界面变化需要培训
- 提供迁移指南
- 收集用户反馈并及时调整

## 八、总结

本次重构将显著简化系统架构，提高数据一致性和系统性能。通过删除冗余功能（模板、评论、部门管理）和优化核心业务流程（周报管理、任务引用），系统将更加聚焦于核心功能，同时为未来扩展奠定良好基础。

重构完成后，系统将具备：
- 简洁清晰的数据结构
- 高效的任务引用机制
- 用户友好的中文界面
- 完整的审批工作流
- 可扩展的架构设计

重构需要谨慎实施，建议采用分阶段、渐进式的方式，确保系统稳定性和数据安全。