# 周报管理系统数据库设计说明文档

## 1. 概述

本文档严格按照 `errors/error3.md` 的要求，详细描述重构后的数据库设计。设计采用关联表模式，移除冗余字段，保留核心业务功能。

### 1.1 设计原则

- **严格按照error3.md要求**: 只保留指定的表和字段
- **关联表模式**: 使用 `task_reports` 和 `dev_task_reports` 关联表替代JSON存储
- **字段最小化**: 移除所有非必要字段，只保留核心业务字段
- **三级审批**: 支持AI分析 → 管理员审核 → 超级管理员审核

### 1.2 表保留/删除情况

#### ✅ 保留的表（共8张）
1. `ai_analysis_results` - AI分析结果表
2. `projects` - 项目表（由simple_projects更名）
3. `project_phases` - 项目阶段表
4. `tasks` - 任务表
5. `users` - 用户表
6. `weekly_reports` - 周报表
7. `task_reports` - 日常任务与周报关联表（新增）
8. `dev_task_reports` - 发展任务与周报关联表（新增）

#### ❌ 删除的表
- `departments` - 部门表
- `flyway_schema_history` - Flyway历史表
- `simple_weekly_reports` - 简化周报表
- `task_templates` - 任务模板表
- `templates` - 模板表
- `comments` - 评论表

## 2. 核心表设计

### 2.1 AI分析结果表 (ai_analysis_results)

**说明**: 保持原样不变

```sql
CREATE TABLE ai_analysis_results (
    id BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    report_id BIGINT NOT NULL,
    analysis_type VARCHAR(50) NOT NULL,
    result TEXT NOT NULL,
    confidence DECIMAL(3,2),
    status VARCHAR(20) NOT NULL DEFAULT 'PENDING',
    processing_time_ms BIGINT,
    model_version VARCHAR(100),
    parameters TEXT,
    error_message TEXT,
    metadata JSON,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    completed_at TIMESTAMP NULL
);
```

### 2.2 用户表 (users)

**说明**: 保留核心字段，删除非必要字段

#### 核心字段（保留）

| 字段名 | 类型 | 说明 | 对应error3.md |
|--------|------|------|---------------|
| `id` | BIGINT | 用户ID | #用户ID |
| `username` | VARCHAR(50) | 用户名 | #用户名 |
| `email` | VARCHAR(100) | 邮箱 | #邮箱 |
| `password` | VARCHAR(255) | 密码 | #密码 |
| `role` | ENUM | 角色 | #角色 |
| `status` | ENUM | 状态 | #状态 |
| `created_at` | DATETIME | 创建时间 | 基础字段 |
| `updated_at` | DATETIME | 更新时间 | 基础字段 |

#### 删除的字段
- `first_name`, `last_name` → 简化为username
- `department_id` → 不需要部门管理
- `employee_id`, `position`, `phone`, `avatar_url` → 非核心字段
- `last_login`, `last_login_time` → 重复字段
- `deleted_at` → 使用status管理
- `full_name` → 计算字段，非必要

### 2.3 项目表 (projects)

**说明**: 由 `simple_projects` 更名而来，保留基础信息字段

#### 核心字段（按error3.md要求）

| 字段名 | 类型 | 说明 | 对应error3.md | 原字段映射 |
|--------|------|------|---------------|-----------|
| `id` | BIGINT | 项目ID | #项目ID | ✅ 保留 |
| `name` | VARCHAR(200) | 项目名称 | #项目名称 | `project_name` |
| `description` | TEXT | 项目内容 | #项目内容 | `project_content` |
| `members` | TEXT | 项目成员 | #项目成员 | `project_members` |
| `expected_results` | TEXT | 预期结果 | #预期结果 | ✅ 保留 |
| `timeline` | TEXT | 时间线 | #时间线 | ✅ 保留 |
| `stop_loss` | TEXT | 止损点 | #止损点 | ✅ 保留 |
| `created_by` | BIGINT | 创建者 | - | ✅ 保留 |
| `ai_analysis_id` | BIGINT | AI分析结果ID | 要求：AI分析结果id（外键） | 新增 |
| `admin_reviewer_id` | BIGINT | 管理员审批人ID | 要求：管理员审批人ID | 保留 |
| `super_admin_reviewer_id` | BIGINT | 超级管理员审批人ID | 要求：超级管理员审批人ID | 保留 |
| `rejection_reason` | TEXT | 拒绝理由 | 要求：拒绝理由 | 保留 |
| `approval_status` | ENUM | 审批状态 | 要求：审批状态 | 保留 |
| `created_at` | TIMESTAMP | 创建时间 | 基础字段 | 新增 |
| `updated_at` | TIMESTAMP | 更新时间 | 基础字段 | 新增 |

#### 审批状态枚举值
```sql
approval_status ENUM(
    'DRAFT',                    -- 草稿
    'AI_ANALYZING',            -- AI分析中
    'AI_APPROVED',             -- AI分析通过
    'AI_REJECTED',             -- AI分析拒绝
    'ADMIN_REVIEWING',         -- 管理员审核中
    'ADMIN_APPROVED',          -- 管理员审核通过
    'ADMIN_REJECTED',          -- 管理员审核拒绝
    'SUPER_ADMIN_REVIEWING',   -- 超级管理员审核中
    'SUPER_ADMIN_APPROVED',    -- 超级管理员审核通过
    'SUPER_ADMIN_REJECTED',    -- 超级管理员审核拒绝
    'FINAL_APPROVED'           -- 最终批准
) NOT NULL DEFAULT 'DRAFT'
```

#### 删除的字段
- `actual_results` → 在project_phases中记录
- `status` → 使用approval_status替代
- `ai_analysis_result` → 通过ai_analysis_id关联
- `manager_reviewer_id` → 简化审批流程
- `manager_review_comment`, `manager_reviewed_at` → 简化审批流程
- `admin_review_comment`, `admin_reviewed_at` → 不需要详细审核记录
- `super_admin_review_comment`, `super_admin_reviewed_at` → 不需要详细审核记录
- `ai_confidence`, `ai_feasibility_score`, `ai_risk_level` → 通过ai_analysis_id关联
- `ai_provider_used`, `ai_processing_time_ms`, `ai_analyzed_at` → 通过ai_analysis_id关联
- `ai_key_issues`, `ai_recommendations` → 通过ai_analysis_id关联

### 2.4 项目阶段表 (project_phases)

**说明**: 存储项目的阶段性任务

#### 核心字段（按error3.md要求）

| 字段名 | 类型 | 说明 | 对应error3.md |
|--------|------|------|---------------|
| `id` | BIGINT | 任务ID | #任务ID |
| `phase_name` | VARCHAR(200) | 任务名称 | #任务名称 |
| `description` | TEXT | 阶段描述 | #阶段描述 |
| `assigned_members` | VARCHAR(500) | 负责成员 | #负责成员 |
| `schedule` | VARCHAR(300) | 时间安排 | #时间安排 |
| `expected_results` | TEXT | 预期结果 | #预期结果 |
| `project_id` | BIGINT | 关联项目ID | #关联项目ID |

**注意**: `actual_results`(实际结果) 和 `result_difference_analysis`(结果差异分析) 字段已移除，现在存储在 `dev_task_reports` 表中。

#### 删除的字段
- `phase_description` → 使用description替代
- `timeline` → 使用schedule替代
- `estimated_results` → 使用expected_results替代
- `status`, `start_date`, `end_date`, `completion_date` → 简化管理
- `phase_order` → 不需要排序

### 2.5 任务表 (tasks)

**说明**: 存储日常性任务

#### 核心字段（按error3.md要求）

| 字段名 | 类型 | 说明 | 对应error3.md |
|--------|------|------|---------------|
| `id` | BIGINT | 任务ID | #任务ID |
| `task_name` | VARCHAR(200) | 任务名称 | #任务名称 |
| `personnel_assignment` | VARCHAR(100) | 人员分配 | #人员分配 |
| `timeline` | VARCHAR(200) | 时间线 | #时间线 |
| `quantitative_metrics` | VARCHAR(300) | 量化指标 | #量化指标 |
| `expected_results` | VARCHAR(500) | 预期结果 | #预期结果 |
| `created_by` | BIGINT | 创建者ID | 业务需要 |

**注意**: `actual_results`(实际结果)、`result_difference_analysis`(结果差异分析) 和 `task_type`(任务类型) 字段已移除。实际结果和差异分析现在存储在 `task_reports` 表中。

#### 删除的字段
- `stop_loss_point` → 非日常任务字段
- `progress`, `start_date`, `due_date`, `completion_date` → 简化管理
- `budget` → 非日常任务字段
- `is_completed`, `is_overdue` → 通过actual_results判断
- `priority` → error3.md明确删除
- `task_template_id` → 删除模板功能
- `project_id`, `simple_project_id`, `project_phase_id`, `weekly_report_id` → 使用关联表
- `report_section` → 使用关联表区分

### 2.6 周报表 (weekly_reports)

**说明**: 简化存储，通过关联表连接任务

#### 核心字段（按error3.md要求）

| 字段名 | 类型 | 说明 | 对应error3.md | 前端字段映射 |
|--------|------|------|---------------|-------------|
| `id` | BIGINT | 周报ID | # 周报ID | - |
| `user_id` | BIGINT | 提交周报的用户ID | # 提交周报的用户ID | `userid` |
| `title` | VARCHAR(200) | 周报标题 | # 周报标题 | `title` |
| `report_week` | VARCHAR(50) | 周报周期 | 前端字段 | `reportWeek` |
| `additional_notes` | TEXT | 其他备注 | # 其他备注 | `additionalNotes` |
| `development_opportunities` | TEXT | 可发展性清单 | # 可发展性清单 | `developmentOpportunities` |
| `ai_analysis_id` | BIGINT | AI分析结果ID | 要求：AI分析结果id（外键） | - |
| `admin_reviewer_id` | BIGINT | 管理员审批人ID | 要求：管理员审批人ID | - |
| `rejection_reason` | TEXT | 拒绝理由 | 要求：拒绝理由 | - |
| `approval_status` | ENUM | 审批状态 | 要求：审批状态 | - |
| `created_at` | DATETIME | 创建时间 | 基础字段 | - |
| `updated_at` | DATETIME | 更新时间 | 基础字段 | - |

#### 删除的字段（error3.md明确标记为多余）
- `content` → 通过关联表存储
- `workSummary` → 多余字段
- `achievements` → 多余字段
- `challenges` → 多余字段
- `nextWeekPlan` → 通过关联表存储
- `priority` → 多余字段
- `projectId` → 通过关联表存储
- `templateId` → 删除模板功能

#### 其他删除的字段
- `week_start`, `week_end` → 使用report_week替代
- `submitted_at`, `reviewed_at`, `reviewed_by`, `review_comments` → 简化审核
- `manager_reviewer_id`, `manager_review_comment`, `manager_reviewed_at` → 简化审批
- `admin_review_comment`, `admin_reviewed_at` → 简化审批
- `super_admin_reviewer_id`, `super_admin_review_comment`, `super_admin_reviewed_at` → 简化审批
- `ai_confidence`, `ai_quality_score`, `ai_risk_level` → 通过ai_analysis_id关联
- `ai_provider_used`, `ai_processing_time_ms`, `ai_analyzed_at` → 通过ai_analysis_id关联
- `ai_key_issues`, `ai_recommendations` → 通过ai_analysis_id关联

## 3. 关联表设计

### 3.1 日常任务-周报关联表 (task_reports)

**说明**: 新增表，实现日常任务与周报的多对多关联

```sql
CREATE TABLE task_reports (
    weekly_report_id BIGINT NOT NULL COMMENT '周报ID 主键',
    task_id BIGINT NOT NULL COMMENT '任务ID 主键',
    actual_results TEXT COMMENT '实际结果',
    result_difference_analysis TEXT COMMENT '结果差异分析', 
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (weekly_report_id, task_id),
    FOREIGN KEY (weekly_report_id) REFERENCES weekly_reports(id) ON DELETE CASCADE,
    FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE
);
```

#### 对应error3.md结构
```
task_reports:{
    #周报ID 主键 ✅
    #任务ID 主键 ✅
}
```

### 3.2 发展任务-周报关联表 (dev_task_reports)

**说明**: 新增表，实现项目阶段任务与周报的关联

```sql
CREATE TABLE dev_task_reports (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
    weekly_report_id BIGINT NOT NULL COMMENT '周报ID',
    project_id BIGINT NOT NULL COMMENT '项目ID',
    phases_id BIGINT NOT NULL COMMENT '项目阶段ID（关联project_phases表）',
    actual_results TEXT COMMENT '实际结果',
    result_difference_analysis TEXT COMMENT '结果差异分析',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE KEY uk_dev_task_reports_unique (weekly_report_id, project_id, phases_id),
    FOREIGN KEY (weekly_report_id) REFERENCES weekly_reports(id) ON DELETE CASCADE,
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
    FOREIGN KEY (phases_id) REFERENCES project_phases(id) ON DELETE CASCADE
);
```

#### 对应error3.md结构
```
dev_task_reports:{
    #项目ID ✅
    #phases_id ✅ (原task_id改名为phases_id，关联project_phases表)
    #周报ID ✅
    #实际结果 ✅
    #结果差异分析 ✅
}
```

## 4. 数据流映射

### 4.1 周报提交数据映射

根据error3.md期望的前端数据结构，映射到数据库存储：

#### 前端提交格式（error3.md要求）
```json
{
  "userid": "",
  "title": "22",
  "reportWeek": "几月第几周（周几）",
  "content": {
    "Routine_tasks": [
      {
        "task_id": "",
        "actual_result": "",
        "AnalysisofResultDifferences": ""
      }
    ],
    "Developmental_tasks": [
      {
        "project_id": "",
        "phase_id": "",
        "actual_result": "",
        "AnalysisofResultDifferences": ""
      }
    ]
  },
  "nextWeekPlan": {
    "Routine_tasks": [{"task_id": ""}],
    "Developmental_tasks": [{"project_id": "", "phase_id": ""}]
  },
  "additionalNotes": "22222",
  "developmentOpportunities": "22222"
}
```

#### 数据库存储映射

1. **周报基础信息** → `weekly_reports`
   - `user_id` ← `userid`
   - `title` ← `title`
   - `report_week` ← `reportWeek`
   - `additional_notes` ← `additionalNotes`
   - `development_opportunities` ← `developmentOpportunities`

2. **日常任务关联** → `task_reports`
   - `weekly_report_id` ← 新创建周报ID
   - `task_id` ← `content.Routine_tasks[].task_id`

3. **发展任务关联** → `dev_task_reports`
   - `weekly_report_id` ← 新创建周报ID
   - `project_id` ← `content.Developmental_tasks[].project_id`
   - `phases_id` ← `content.Developmental_tasks[].phase_id`
   - `actual_results` ← `content.Developmental_tasks[].actual_result`
   - `result_difference_analysis` ← `content.Developmental_tasks[].AnalysisofResultDifferences`

4. **任务结果更新** → 直接存储在关联表中
   - `task_reports.actual_results` ← `content.Routine_tasks[].actual_result`
   - `task_reports.result_difference_analysis` ← `content.Routine_tasks[].AnalysisofResultDifferences`
   - `dev_task_reports.actual_results` ← `content.Developmental_tasks[].actual_result`
   - `dev_task_reports.result_difference_analysis` ← `content.Developmental_tasks[].AnalysisofResultDifferences`

5. **下周规划处理**
   - `nextWeekPlan` 数据不存储，用于前端显示和下次周报的任务选择

## 5. 后端修改对照表

### 5.1 Entity类修改

#### 需要重构的Entity
1. **WeeklyReport.java**
   - 删除字段：content, workSummary, achievements, challenges, nextWeekPlan, priority, projectId, templateId
   - 保留字段：id, userId, title, reportWeek, additionalNotes, developmentOpportunities
   - 新增关联：`@OneToMany` taskReports, devTaskReports

2. **Project.java**
   - 字段名映射：project_name → name, project_content → description, project_members → members
   - 删除复杂审批字段，保留核心审批字段

3. **Task.java**
   - 删除项目关联字段：projectId, simpleProjectId, projectPhaseId, weeklyReportId
   - 删除管理字段：progress, startDate, dueDate, completionDate, budget, isCompleted, isOverdue, priority

#### 需要新增的Entity
1. **TaskReport.java** - 关联表实体
2. **DevTaskReport.java** - 关联表实体

### 5.2 DTO类修改

#### WeeklyReportDTO重构
按照error3.md的前端数据结构重新设计：
```java
public class WeeklyReportCreateRequest {
    private String userid;
    private String title;
    private String reportWeek;
    private ContentDTO content;
    private NextWeekPlanDTO nextWeekPlan;
    private String additionalNotes;
    private String developmentOpportunities;
    
    public static class ContentDTO {
        private List<RoutineTaskDTO> Routine_tasks;
        private List<DevelopmentalTaskDTO> Developmental_tasks;
    }
    
    public static class RoutineTaskDTO {
        private String task_id;
        private String actual_result;
        private String AnalysisofResultDifferences;
    }
    
    public static class DevelopmentalTaskDTO {
        private String project_id;
        private String phase_id;
        private String actual_result;
        private String AnalysisofResultDifferences;
    }
}
```

### 5.3 Service类修改

#### 需要重写的核心逻辑
1. **WeeklyReportService.createWeeklyReport()**
   - 解析新的DTO结构
   - 创建关联表记录
   - 更新任务实际结果

2. **WeeklyReportService.getWeeklyReportDetail()**
   - 通过关联表查询任务
   - 组装完整的周报数据

### 5.4 Controller修改

#### API接口调整
所有涉及周报的API都需要按照error3.md的数据结构重新设计。

## 6. 总结

### 6.1 主要变更

1. **表结构简化**: 删除6张非必要表，保留8张核心表
2. **字段最小化**: 每张表只保留error3.md指定的核心字段
3. **关联表模式**: 新增2张关联表替代JSON存储
4. **字段映射**: 明确标出原字段与新字段的对应关系

### 6.2 后端重构重点

1. **Entity重构**: 按照新字段结构重写所有Entity类
2. **DTO重构**: 严格按照error3.md的前端数据格式设计DTO
3. **Service重构**: 重写周报创建和查询逻辑
4. **关联关系**: 处理新增的关联表操作

### 6.3 数据库Schema修正记录

**修正日期**: 2025-09-20
**修正内容**:
1. ✅ 删除冗余表 `weekly_reports_v2`
2. ✅ `projects` 表添加缺失字段:
   - `super_admin_reviewer_id BIGINT` - 超级管理员审批人ID
   - `approval_status ENUM(...)` - 完整审批状态枚举
   - `created_at`, `updated_at` - 时间戳字段
3. ✅ `project_phases` 表添加时间戳字段: `created_at`, `updated_at`
4. ✅ `tasks` 表添加时间戳字段: `created_at`, `updated_at`

5. ✅ 补充 `users` 表时间戳字段文档说明: `created_at`, `updated_at`

**修正结果**: 数据库schema现在与设计文档完全一致，支持完整的三级审批工作流程。

### 6.5 数据库字段结构修正记录

**修正日期**: 2025-09-21
**修正内容**:
1. ✅ **tasks表字段修正**:
   - 移除 `actual_results` 字段 - 实际结果现存储在 `task_reports` 表中
   - 移除 `result_difference_analysis` 字段 - 结果差异分析现存储在 `task_reports` 表中  
   - 移除 `task_type` 字段 - 任务表不应该有任务类型分类

2. ✅ **project_phases表字段修正**:
   - 移除 `actual_results` 字段 - 实际结果现存储在 `dev_task_reports` 表中
   - 移除 `result_difference_analysis` 字段 - 结果差异分析现存储在 `dev_task_reports` 表中

3. ✅ **task_reports表字段增强**:
   - 新增 `actual_results TEXT` 字段 - 存储日常任务的实际结果
   - 新增 `result_difference_analysis TEXT` 字段 - 存储日常任务的结果差异分析

4. ✅ **dev_task_reports表重构**:
   - 重建表结构，将 `task_id` 字段重命名为 `phases_id`，更准确地表示关联project_phases表
   - 新增 `actual_results TEXT` 字段 - 存储发展性任务的实际结果  
   - 新增 `result_difference_analysis TEXT` 字段 - 存储发展性任务的结果差异分析
   - 新增 `id` 主键字段，改为使用复合唯一约束保证数据唯一性

**修正原因**: 
- 任务基础信息表(tasks/project_phases)应该只存储任务的基本信息，不应该包含执行结果
- 实际结果和差异分析属于周报填写时的内容，应该存储在对应的关联表中
- 通过外键关联可以更好地管理周报与任务的关系，支持一个任务在多个周报中被引用

**修正结果**: 数据库结构更加合理，符合关系型数据库设计原则，任务信息与执行结果分离存储。

### 6.4 时间戳字段类型说明

**数据库中实际使用的时间戳类型**:
- **DATETIME类型**: `users`, `weekly_reports` 表
- **TIMESTAMP类型**: `projects`, `project_phases`, `tasks`, `ai_analysis_results`, `task_reports`, `dev_task_reports` 表

**类型选择原因**:
- `DATETIME`: 支持更大时间范围(1000-9999年)，适用于用户和业务数据
- `TIMESTAMP`: 自动时区转换，适用于系统操作记录

**功能影响**: 两种类型在Java应用中使用`LocalDateTime`时功能完全一致。

此设计严格按照error3.md要求执行，为后端重构提供准确的数据结构指导。