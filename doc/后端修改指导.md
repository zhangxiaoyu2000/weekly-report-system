# 周报管理系统后端修改指导文档

## 概述

本文档基于 `doc/数据库设计.md` 和 V26 数据库重构完成的结果，详细指导后端代码如何适配新的数据库结构。重构的核心是将原有的复杂JSON存储模式改为关联表模式，移除非必要字段，严格按照error3.md的要求实现。

## 目录
1. [修改优先级和流程](#修改优先级和流程)
2. [Entity层重构](#entity层重构)
3. [Repository层修改](#repository层修改)
4. [DTO层重构](#dto层重构)
5. [Service层重构](#service层重构)
6. [Controller层修改](#controller层修改)
7. [测试和验证](#测试和验证)

---

## 修改优先级和流程

### 🔴 高优先级（立即修改）
1. **Entity类适配** - 修改实体类以匹配新数据库结构
2. **关联表Entity** - 创建TaskReport和DevTaskReport实体
3. **WeeklyReportCreateRequest** - 按error3.md重新设计DTO
4. **核心Service重构** - WeeklyReportService核心逻辑

### 🟡 中优先级（后续修改）
5. **Repository方法更新** - 关联表查询方法
6. **Controller接口适配** - API接口调整
7. **其他DTO类更新** - Response和Update请求

### 🟢 低优先级（优化阶段）
8. **清理废弃代码** - 删除不再使用的类和方法
9. **性能优化** - 查询优化和缓存
10. **文档更新** - API文档更新

---

## Entity层重构

### 1. WeeklyReport实体重构

#### 1.1 删除字段（已通过V26迁移删除）

```java
// ❌ 需要删除的字段
private String content;                    // 通过关联表存储
private String summary;                    // 多余字段
private ReportStatus status;               // 使用approval_status替代
private LocalDate weekStart;               // 使用report_week替代  
private LocalDate weekEnd;               // 使用report_week替代
private LocalDateTime submittedAt;         // 简化时间管理
private LocalDateTime reviewedAt;          // 简化审核
private User reviewedBy;                   // 简化审核
private String reviewComments;             // 简化审核
private ReportPriority priority;           // error3.md标记为多余
private String tags;                       // 多余字段
private String attachments;                // 多余字段
private Integer viewCount;                 // 多余字段
private LocalDateTime createdAt;           // 简化时间管理
private LocalDateTime updatedAt;           // 简化时间管理
private LocalDateTime deletedAt;           // 使用status管理
private Template template;                 // 删除模板功能
private Project project;                   // 通过关联表存储

// 复杂审批字段（简化为核心字段）
private User managerReviewer;              // 简化审批流程
private String managerReviewComment;       // 简化审批流程
private LocalDateTime managerReviewedAt;   // 简化审批流程
private String adminReviewComment;         // 不需要详细审核记录
private LocalDateTime adminReviewedAt;     // 不需要详细审核记录
private User superAdminReviewer;           // 通过super_admin_reviewer_id字段
private String superAdminReviewComment;    // 不需要详细审核记录
private LocalDateTime superAdminReviewedAt; // 不需要详细审核记录

// AI分析详细字段（通过ai_analysis_id关联）
private Double aiConfidence;               // 通过ai_analysis_id关联
private Double aiQualityScore;             // 通过ai_analysis_id关联
private String aiRiskLevel;                // 通过ai_analysis_id关联
private String aiProviderUsed;             // 通过ai_analysis_id关联
private Long aiProcessingTimeMs;           // 通过ai_analysis_id关联
private LocalDateTime aiAnalyzedAt;        // 通过ai_analysis_id关联
private String aiKeyIssues;                // 通过ai_analysis_id关联
private String aiRecommendations;          // 通过ai_analysis_id关联
```

#### 1.2 保留和新增字段

```java
@Entity
@Table(name = "weekly_reports")
public class WeeklyReport {
    
    // ✅ 保留的核心字段
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;                       // 周报ID
    
    @NotNull
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id", nullable = false)
    private User user;                     // 提交周报的用户ID（字段名从author改为user）
    
    @NotBlank
    @Size(max = 200)
    @Column(name = "title", nullable = false, length = 200)
    private String title;                  // 周报标题
    
    @NotBlank
    @Column(name = "report_week", nullable = false, length = 50)
    private String reportWeek;             // 周报周期（中文格式：几月第几周（周几））
    
    @Column(name = "additional_notes", columnDefinition = "TEXT")
    private String additionalNotes;        // 其他备注
    
    @Column(name = "development_opportunities", columnDefinition = "TEXT")
    private String developmentOpportunities; // 可发展性清单
    
    // ✅ 新增的审批字段
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "ai_analysis_id")
    private AIAnalysisResult aiAnalysis;   // AI分析结果ID（外键）
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "admin_reviewer_id")
    private User adminReviewer;            // 管理员审批人ID
    
    @Column(name = "rejection_reason", columnDefinition = "TEXT")
    private String rejectionReason;        // 拒绝理由
    
    @Enumerated(EnumType.STRING)
    @Column(name = "approval_status")
    private ApprovalStatus approvalStatus = ApprovalStatus.DRAFT; // 审批状态
    
    // ✅ 新增的关联表关系
    @OneToMany(mappedBy = "weeklyReport", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
    private Set<TaskReport> taskReports = new HashSet<>();        // 日常任务关联
    
    @OneToMany(mappedBy = "weeklyReport", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
    private Set<DevTaskReport> devTaskReports = new HashSet<>();  // 发展任务关联

    // ✅ 新的审批状态枚举
    public enum ApprovalStatus {
        DRAFT,                    // 草稿
        AI_ANALYZING,            // AI分析中
        AI_APPROVED,             // AI已批准
        AI_REJECTED,             // AI已拒绝
        ADMIN_REVIEWING,         // 管理员审核中
        ADMIN_APPROVED,          // 管理员已批准
        ADMIN_REJECTED,          // 管理员已拒绝
        SUPER_ADMIN_REVIEWING,   // 超级管理员审核中
        SUPER_ADMIN_APPROVED,    // 超级管理员已批准
        SUPER_ADMIN_REJECTED,    // 超级管理员已拒绝
        FINAL_APPROVED           // 最终批准
    }
    
    // ✅ 关联表管理方法
    public void addTaskReport(TaskReport taskReport) {
        taskReports.add(taskReport);
        taskReport.setWeeklyReport(this);
    }
    
    public void removeTaskReport(TaskReport taskReport) {
        taskReports.remove(taskReport);
        taskReport.setWeeklyReport(null);
    }
    
    public void addDevTaskReport(DevTaskReport devTaskReport) {
        devTaskReports.add(devTaskReport);
        devTaskReport.setWeeklyReport(this);
    }
    
    public void removeDevTaskReport(DevTaskReport devTaskReport) {
        devTaskReports.remove(devTaskReport);
        devTaskReport.setWeeklyReport(null);
    }
}
```

### 2. 新增关联表实体

#### 2.1 TaskReport实体（日常任务-周报关联表）

```java
package com.weeklyreport.entity;

import jakarta.persistence.*;
import org.hibernate.annotations.CreationTimestamp;

import java.time.LocalDateTime;

/**
 * 日常性任务与周报关联表
 * 实现多对多关系：一个周报可以关联多个日常任务，一个任务可以被多个周报引用
 */
@Entity
@Table(name = "task_reports")
public class TaskReport {
    
    @EmbeddedId
    private TaskReportId id;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @MapsId("weeklyReportId")
    @JoinColumn(name = "weekly_report_id", nullable = false)
    private WeeklyReport weeklyReport;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @MapsId("taskId")
    @JoinColumn(name = "task_id", nullable = false)
    private Task task;
    
    @CreationTimestamp
    @Column(name = "created_at")
    private LocalDateTime createdAt;
    
    // 构造函数、getter和setter
    public TaskReport() {}
    
    public TaskReport(WeeklyReport weeklyReport, Task task) {
        this.id = new TaskReportId(weeklyReport.getId(), task.getId());
        this.weeklyReport = weeklyReport;
        this.task = task;
    }
    
    // getter和setter方法...
}

/**
 * 复合主键类
 */
@Embeddable
public class TaskReportId implements Serializable {
    @Column(name = "weekly_report_id")
    private Long weeklyReportId;
    
    @Column(name = "task_id")
    private Long taskId;
    
    // 构造函数、equals、hashCode方法
    public TaskReportId() {}
    
    public TaskReportId(Long weeklyReportId, Long taskId) {
        this.weeklyReportId = weeklyReportId;
        this.taskId = taskId;
    }
    
    // equals、hashCode和getter/setter方法...
}
```

#### 2.2 DevTaskReport实体（发展任务-周报关联表）

```java
package com.weeklyreport.entity;

import jakarta.persistence.*;
import org.hibernate.annotations.CreationTimestamp;

import java.time.LocalDateTime;

/**
 * 发展性项目阶段任务与周报关联表
 * 实现项目阶段任务与周报的关联
 */
@Entity
@Table(name = "dev_task_reports")
public class DevTaskReport {
    
    @EmbeddedId
    private DevTaskReportId id;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @MapsId("weeklyReportId")
    @JoinColumn(name = "weekly_report_id", nullable = false)
    private WeeklyReport weeklyReport;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @MapsId("projectId")
    @JoinColumn(name = "project_id", nullable = false)
    private Project project;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @MapsId("taskId")
    @JoinColumn(name = "task_id", nullable = false)
    private ProjectPhase projectPhase; // 对应project_phases表
    
    @CreationTimestamp
    @Column(name = "created_at")
    private LocalDateTime createdAt;
    
    // 构造函数、getter和setter
    public DevTaskReport() {}
    
    public DevTaskReport(WeeklyReport weeklyReport, Project project, ProjectPhase projectPhase) {
        this.id = new DevTaskReportId(weeklyReport.getId(), project.getId(), projectPhase.getId());
        this.weeklyReport = weeklyReport;
        this.project = project;
        this.projectPhase = projectPhase;
    }
    
    // getter和setter方法...
}

/**
 * 复合主键类
 */
@Embeddable
public class DevTaskReportId implements Serializable {
    @Column(name = "weekly_report_id")
    private Long weeklyReportId;
    
    @Column(name = "project_id")
    private Long projectId;
    
    @Column(name = "task_id")
    private Long taskId;
    
    // 构造函数、equals、hashCode方法
    public DevTaskReportId() {}
    
    public DevTaskReportId(Long weeklyReportId, Long projectId, Long taskId) {
        this.weeklyReportId = weeklyReportId;
        this.projectId = projectId;
        this.taskId = taskId;
    }
    
    // equals、hashCode和getter/setter方法...
}
```

### 3. User实体简化

#### 3.1 删除字段（已通过V26迁移删除）

```java
// ❌ 需要删除的字段
private String firstName;              // 简化为username
private String lastName;               // 简化为username
private String employeeId;             // 非核心字段
private String position;               // 非核心字段
private String phone;                  // 非核心字段
private String avatarUrl;              // 非核心字段
private String fullName;               // 计算字段，非必要
private LocalDateTime lastLogin;       // 重复字段
private LocalDateTime lastLoginTime;   // 重复字段
private LocalDateTime deletedAt;       // 使用status管理
private LocalDateTime createdAt;       // 简化时间管理
private LocalDateTime updatedAt;       // 简化时间管理
private Department department;         // 不需要部门管理
```

#### 3.2 简化后的User实体

```java
@Entity
@Table(name = "users")
public class User {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;                   // 用户ID
    
    @NotBlank
    @Size(min = 3, max = 50)
    @Column(name = "username", unique = true, nullable = false, length = 50)
    private String username;           // 用户名
    
    @NotBlank
    @Email
    @Size(max = 100)
    @Column(name = "email", unique = true, nullable = false, length = 100)
    private String email;              // 邮箱
    
    @NotBlank
    @Column(name = "password", nullable = false)
    private String password;           // 密码
    
    @NotNull
    @Enumerated(EnumType.STRING)
    @Column(name = "role", nullable = false)
    private Role role = Role.EMPLOYEE; // 角色
    
    @NotNull
    @Enumerated(EnumType.STRING)
    @Column(name = "status", nullable = false)
    private UserStatus status = UserStatus.ACTIVE; // 状态
    
    // 角色枚举保持不变
    public enum Role {
        ADMIN,          // 管理员
        MANAGER,        // 主管
        EMPLOYEE,       // 员工
        SUPER_ADMIN     // 超级管理员
    }
    
    // 状态枚举保持不变
    public enum UserStatus {
        ACTIVE,         // 激活状态
        INACTIVE,       // 非激活状态
        SUSPENDED,      // 暂停状态
        LOCKED,         // 锁定状态
        DELETED         // 删除状态
    }
}
```

### 4. Task实体适配

#### 4.1 删除项目关联字段（已通过V26迁移删除）

```java
// ❌ 需要删除的字段（通过关联表管理）
@ManyToOne
@JoinColumn(name = "project_id")
private Project project;               // 通过关联表存储

@ManyToOne  
@JoinColumn(name = "simple_project_id")
private SimpleProject simpleProject;   // 通过关联表存储

@ManyToOne
@JoinColumn(name = "project_phase_id") 
private ProjectPhase projectPhase;     // 通过关联表存储

@ManyToOne
@JoinColumn(name = "weekly_report_id")
private WeeklyReport weeklyReport;     // 通过关联表存储

@Enumerated(EnumType.STRING)
@Column(name = "report_section")
private ReportSection reportSection;   // 使用关联表区分

// 删除管理字段
private String stopLossPoint;          // 非日常任务字段
private Integer progress;              // 通过actual_results判断
private LocalDate startDate;           // 简化管理
private LocalDate dueDate;             // 简化管理
private LocalDate completionDate;      // 简化管理
private BigDecimal budget;             // 非日常任务字段
private Boolean isCompleted;           // 通过actual_results判断
private Boolean isOverdue;             // 通过actual_results判断
private Integer priority;              // error3.md明确删除
private Long taskTemplateId;           // 删除模板功能
private LocalDateTime createdAt;       // 简化时间管理
private LocalDateTime updatedAt;       // 简化时间管理
```

#### 4.2 适配后的Task实体

```java
@Entity
@Table(name = "tasks")
public class Task {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;                           // 任务ID
    
    @NotBlank
    @Size(max = 200)
    @Column(name = "task_name", nullable = false, length = 200)
    private String taskName;                   // 任务名称
    
    @Size(max = 200)
    @Column(name = "personnel_assignment", length = 100)
    private String personnelAssignment;        // 人员分配
    
    @Size(max = 200)
    @Column(name = "timeline", length = 200)
    private String timeline;                   // 时间线
    
    @Size(max = 300)
    @Column(name = "quantitative_metrics", length = 300)
    private String quantitativeMetrics;        // 量化指标
    
    @Column(name = "expected_results", columnDefinition = "TEXT")
    private String expectedResults;            // 预期结果
    
    @Column(name = "actual_results", columnDefinition = "TEXT")
    private String actualResults;              // 实际结果
    
    @Column(name = "result_difference_analysis", columnDefinition = "TEXT")
    private String resultDifferenceAnalysis;   // 结果差异分析
    
    @NotNull
    @Enumerated(EnumType.STRING)
    @Column(name = "task_type", nullable = false)
    private TaskType taskType;                 // 任务类型
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "created_by")
    private User createdBy;                    // 创建者ID
    
    // 任务类型枚举更新
    public enum TaskType {
        DAILY,      // 每日任务
        WEEKLY,     // 每周任务  
        MONTHLY     // 每月任务
    }
    
    // 关联表关系（反向关系，方便查询）
    @OneToMany(mappedBy = "task", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
    private Set<TaskReport> taskReports = new HashSet<>();
}
```

---

## Repository层修改

### 1. 新增关联表Repository

#### 1.1 TaskReportRepository

```java
package com.weeklyreport.repository;

import com.weeklyreport.entity.TaskReport;
import com.weeklyreport.entity.TaskReportId;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface TaskReportRepository extends JpaRepository<TaskReport, TaskReportId> {
    
    // 查询周报关联的所有日常任务
    List<TaskReport> findByWeeklyReportId(Long weeklyReportId);
    
    // 查询任务关联的所有周报
    List<TaskReport> findByTaskId(Long taskId);
    
    // 批量删除周报的任务关联
    void deleteByWeeklyReportId(Long weeklyReportId);
    
    // 删除特定任务的周报关联
    void deleteByTaskId(Long taskId);
    
    // 检查特定任务是否已关联到周报
    boolean existsByWeeklyReportIdAndTaskId(Long weeklyReportId, Long taskId);
    
    // 查询用户的所有任务关联（通过周报）
    @Query("SELECT tr FROM TaskReport tr " +
           "WHERE tr.weeklyReport.user.id = :userId")
    List<TaskReport> findByUserId(@Param("userId") Long userId);
}
```

#### 1.2 DevTaskReportRepository

```java
package com.weeklyreport.repository;

import com.weeklyreport.entity.DevTaskReport;
import com.weeklyreport.entity.DevTaskReportId;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface DevTaskReportRepository extends JpaRepository<DevTaskReport, DevTaskReportId> {
    
    // 查询周报关联的所有发展任务
    List<DevTaskReport> findByWeeklyReportId(Long weeklyReportId);
    
    // 查询项目关联的所有周报
    List<DevTaskReport> findByProjectId(Long projectId);
    
    // 查询项目阶段关联的所有周报
    List<DevTaskReport> findByTaskId(Long taskId); // taskId对应project_phases的id
    
    // 批量删除周报的发展任务关联
    void deleteByWeeklyReportId(Long weeklyReportId);
    
    // 删除特定项目的周报关联
    void deleteByProjectId(Long projectId);
    
    // 检查特定项目阶段是否已关联到周报
    boolean existsByWeeklyReportIdAndProjectIdAndTaskId(Long weeklyReportId, Long projectId, Long taskId);
    
    // 查询用户的所有发展任务关联（通过周报）
    @Query("SELECT dtr FROM DevTaskReport dtr " +
           "WHERE dtr.weeklyReport.user.id = :userId")
    List<DevTaskReport> findByUserId(@Param("userId") Long userId);
}
```

### 2. WeeklyReportRepository更新

```java
@Repository
public interface WeeklyReportRepository extends JpaRepository<WeeklyReport, Long>, JpaSpecificationExecutor<WeeklyReport> {
    
    // ✅ 更新方法名（author → user）
    List<WeeklyReport> findByUserId(Long userId);
    Page<WeeklyReport> findByUserId(Long userId, Pageable pageable);
    List<WeeklyReport> findByUser(User user);
    
    // ✅ 更新字段名（weekStart → reportWeek）
    List<WeeklyReport> findByReportWeek(String reportWeek);
    Optional<WeeklyReport> findByUserIdAndReportWeek(Long userId, String reportWeek);
    boolean existsByUserIdAndReportWeek(Long userId, String reportWeek);
    boolean existsByUserAndReportWeek(User user, String reportWeek);
    
    // ✅ 更新状态字段（status → approvalStatus）
    List<WeeklyReport> findByApprovalStatus(WeeklyReport.ApprovalStatus approvalStatus);
    Page<WeeklyReport> findByApprovalStatus(WeeklyReport.ApprovalStatus approvalStatus, Pageable pageable);
    
    // ✅ 新增审批状态查询
    List<WeeklyReport> findByApprovalStatusIn(List<WeeklyReport.ApprovalStatus> statuses);
    
    // ✅ 查询等待审批的周报
    @Query("SELECT wr FROM WeeklyReport wr " +
           "WHERE wr.approvalStatus IN ('AI_APPROVED', 'ADMIN_REVIEWING', 'SUPER_ADMIN_REVIEWING')")
    List<WeeklyReport> findPendingApprovalReports();
    
    // ✅ 根据AI分析结果查询
    List<WeeklyReport> findByAiAnalysisId(Long aiAnalysisId);
    
    // ✅ 根据审核人查询
    List<WeeklyReport> findByAdminReviewerId(Long adminReviewerId);
    
    // ❌ 删除不需要的方法
    // findByWeekStart -> findByReportWeek
    // findByStatus -> findByApprovalStatus
    // findByAuthor -> findByUser
    // findByTemplate -> 删除模板功能
    // findByProject -> 通过关联表查询
}
```

---

## DTO层重构

### 1. WeeklyReportCreateRequest重构（核心）

按照error3.md的前端数据结构重新设计：

```java
package com.weeklyreport.dto.weeklyreport;

import jakarta.validation.constraints.*;
import java.util.List;

/**
 * 周报创建请求DTO - 严格按照error3.md的前端数据结构设计
 */
public class WeeklyReportCreateRequest {
    
    @NotBlank(message = "用户ID不能为空")
    private String userid;                  // 提交周报的用户id
    
    @NotBlank(message = "标题不能为空")
    @Size(max = 200, message = "标题不能超过200字符")
    private String title;                   // 周报标题
    
    @NotBlank(message = "周报周期不能为空")
    private String reportWeek;              // 几月第几周（周几）
    
    @NotNull(message = "周报内容不能为空")
    private ContentDTO content;             // 本周汇报内容
    
    @NotNull(message = "下周规划不能为空")
    private NextWeekPlanDTO nextWeekPlan;   // 下周规划
    
    @Size(max = 2000, message = "其他备注不能超过2000字符")
    private String additionalNotes;         // 其他备注
    
    @Size(max = 2000, message = "可发展性清单不能超过2000字符")
    private String developmentOpportunities; // 可发展性清单
    
    // 内部类：本周汇报内容
    public static class ContentDTO {
        private List<RoutineTaskDTO> Routine_tasks;      // 日常性任务
        private List<DevelopmentalTaskDTO> Developmental_tasks; // 发展性任务
        
        // getter和setter...
    }
    
    // 内部类：日常性任务
    public static class RoutineTaskDTO {
        @NotBlank(message = "任务ID不能为空")
        private String task_id;                          // 对应任务表中的日常性任务的id 外键
        
        @Size(max = 500, message = "实际结果不能超过500字符")
        private String actual_result;                    // 实际结果
        
        @Size(max = 1000, message = "结果差异分析不能超过1000字符")
        private String AnalysisofResultDifferences;      // 结果差异分析
        
        // getter和setter...
    }
    
    // 内部类：发展性任务
    public static class DevelopmentalTaskDTO {
        @NotBlank(message = "项目ID不能为空")
        private String project_id;                       // 对应项目表中的项目id 外键
        
        @NotBlank(message = "阶段ID不能为空")
        private String phase_id;                         // 对应该项目的某个阶段的id 外键
        
        @Size(max = 500, message = "实际结果不能超过500字符")
        private String actual_result;                    // 实际结果
        
        @Size(max = 1000, message = "结果差异分析不能超过1000字符")
        private String AnalysisofResultDifferences;      // 结果差异分析
        
        // getter和setter...
    }
    
    // 内部类：下周规划
    public static class NextWeekPlanDTO {
        private List<NextWeekRoutineTaskDTO> Routine_tasks;      // 日常性任务
        private List<NextWeekDevelopmentalTaskDTO> Developmental_tasks; // 发展性任务
        
        // getter和setter...
    }
    
    // 内部类：下周规划日常任务
    public static class NextWeekRoutineTaskDTO {
        @NotBlank(message = "任务ID不能为空")
        private String task_id;                          // 对应任务表中的日常性任务的id 外键
        
        // getter和setter...
    }
    
    // 内部类：下周规划发展任务
    public static class NextWeekDevelopmentalTaskDTO {
        @NotBlank(message = "项目ID不能为空")
        private String project_id;                       // 对应项目表中的项目id 外键
        
        @NotBlank(message = "阶段ID不能为空")
        private String phase_id;                         // 对应该项目的某个阶段的id 外键
        
        // getter和setter...
    }
    
    // 所有字段的getter和setter方法...
}
```

### 2. WeeklyReportResponse重构

```java
package com.weeklyreport.dto.weeklyreport;

import com.weeklyreport.entity.WeeklyReport;
import java.util.List;

/**
 * 周报响应DTO - 匹配新的数据库结构
 */
public class WeeklyReportResponse {
    
    private Long id;                        // 周报ID
    private Long userId;                    // 用户ID
    private String username;                // 用户名（从用户表获取）
    private String title;                   // 周报标题
    private String reportWeek;              // 周报周期
    private String additionalNotes;         // 其他备注
    private String developmentOpportunities; // 可发展性清单
    
    // 审批相关信息
    private String approvalStatus;          // 审批状态
    private Long aiAnalysisId;              // AI分析结果ID
    private Long adminReviewerId;           // 管理员审批人ID
    private String adminReviewerName;       // 管理员姓名
    private String rejectionReason;         // 拒绝理由
    
    // 关联任务信息
    private List<TaskInfo> routineTasks;    // 关联的日常任务
    private List<DevTaskInfo> devTasks;     // 关联的发展任务
    
    // 内部类：任务信息
    public static class TaskInfo {
        private Long taskId;
        private String taskName;
        private String actualResults;
        private String resultDifferenceAnalysis;
        
        // getter和setter...
    }
    
    // 内部类：发展任务信息
    public static class DevTaskInfo {
        private Long projectId;
        private String projectName;
        private Long phaseId;
        private String phaseName;
        private String actualResults;
        private String resultDifferenceAnalysis;
        
        // getter和setter...
    }
    
    // 工厂方法：从Entity转换
    public static WeeklyReportResponse fromEntity(WeeklyReport entity) {
        WeeklyReportResponse response = new WeeklyReportResponse();
        response.setId(entity.getId());
        response.setUserId(entity.getUser().getId());
        response.setUsername(entity.getUser().getUsername());
        response.setTitle(entity.getTitle());
        response.setReportWeek(entity.getReportWeek());
        response.setAdditionalNotes(entity.getAdditionalNotes());
        response.setDevelopmentOpportunities(entity.getDevelopmentOpportunities());
        response.setApprovalStatus(entity.getApprovalStatus().name());
        response.setAiAnalysisId(entity.getAiAnalysis() != null ? entity.getAiAnalysis().getId() : null);
        response.setAdminReviewerId(entity.getAdminReviewer() != null ? entity.getAdminReviewer().getId() : null);
        response.setAdminReviewerName(entity.getAdminReviewer() != null ? entity.getAdminReviewer().getUsername() : null);
        response.setRejectionReason(entity.getRejectionReason());
        
        // 设置关联任务信息
        // response.setRoutineTasks(...);
        // response.setDevTasks(...);
        
        return response;
    }
    
    // 所有字段的getter和setter方法...
}
```

### 3. 其他DTO更新

#### 3.1 简化的DTO（删除不需要的）

```java
// ❌ 删除的DTO类
// WeeklyReportFilterRequest中的复杂过滤条件
// WeeklyReportUpdateRequest中的复杂字段
// Template相关的所有DTO
// Department相关的所有DTO
// ProjectMember相关的所有DTO
// Comment相关的所有DTO

// ✅ 保留和更新的DTO
// UserDTO - 简化字段
// ProjectDTO - 字段映射更新
// TaskDTO - 删除项目关联字段
// AIAnalysisResultDTO - 保持不变
```

---

## Service层重构

### 1. WeeklyReportService核心重构

```java
@Service
@Transactional
public class WeeklyReportService {
    
    @Autowired
    private WeeklyReportRepository weeklyReportRepository;
    
    @Autowired
    private TaskReportRepository taskReportRepository;
    
    @Autowired
    private DevTaskReportRepository devTaskReportRepository;
    
    @Autowired
    private TaskRepository taskRepository;
    
    @Autowired
    private ProjectRepository projectRepository;
    
    @Autowired
    private ProjectPhaseRepository projectPhaseRepository;
    
    @Autowired
    private UserRepository userRepository;

    /**
     * 创建周报（核心重构方法）
     * 按照error3.md的数据结构处理
     */
    public WeeklyReportResponse createWeeklyReport(WeeklyReportCreateRequest request) {
        logger.info("Creating weekly report with new structure: {}", request.getTitle());
        
        // 1. 验证用户
        Long userId = Long.parseLong(request.getUserid());
        User user = userRepository.findById(userId)
                .orElseThrow(() -> new IllegalArgumentException("用户不存在"));
        
        // 2. 检查重复周报
        if (weeklyReportRepository.existsByUserIdAndReportWeek(userId, request.getReportWeek())) {
            throw new IllegalArgumentException("该周期的周报已存在");
        }
        
        // 3. 创建周报主体
        WeeklyReport report = new WeeklyReport();
        report.setUser(user);
        report.setTitle(request.getTitle());
        report.setReportWeek(request.getReportWeek());
        report.setAdditionalNotes(request.getAdditionalNotes());
        report.setDevelopmentOpportunities(request.getDevelopmentOpportunities());
        report.setApprovalStatus(WeeklyReport.ApprovalStatus.DRAFT);
        
        // 4. 保存周报
        WeeklyReport savedReport = weeklyReportRepository.save(report);
        
        // 5. 处理日常任务关联
        if (request.getContent() != null && request.getContent().getRoutine_tasks() != null) {
            for (WeeklyReportCreateRequest.RoutineTaskDTO routineTask : request.getContent().getRoutine_tasks()) {
                // 获取任务
                Long taskId = Long.parseLong(routineTask.getTask_id());
                Task task = taskRepository.findById(taskId)
                        .orElseThrow(() -> new IllegalArgumentException("日常任务不存在: " + taskId));
                
                // 更新任务的实际结果
                task.setActualResults(routineTask.getActual_result());
                task.setResultDifferenceAnalysis(routineTask.getAnalysisofResultDifferences());
                taskRepository.save(task);
                
                // 创建关联记录
                TaskReport taskReport = new TaskReport(savedReport, task);
                taskReportRepository.save(taskReport);
            }
        }
        
        // 6. 处理发展任务关联
        if (request.getContent() != null && request.getContent().getDevelopmental_tasks() != null) {
            for (WeeklyReportCreateRequest.DevelopmentalTaskDTO devTask : request.getContent().getDevelopmental_tasks()) {
                // 获取项目和阶段
                Long projectId = Long.parseLong(devTask.getProject_id());
                Long phaseId = Long.parseLong(devTask.getPhase_id());
                
                Project project = projectRepository.findById(projectId)
                        .orElseThrow(() -> new IllegalArgumentException("项目不存在: " + projectId));
                ProjectPhase phase = projectPhaseRepository.findById(phaseId)
                        .orElseThrow(() -> new IllegalArgumentException("项目阶段不存在: " + phaseId));
                
                // 更新阶段的实际结果
                phase.setActualResults(devTask.getActual_result());
                phase.setResultDifferenceAnalysis(devTask.getAnalysisofResultDifferences());
                projectPhaseRepository.save(phase);
                
                // 创建关联记录
                DevTaskReport devTaskReport = new DevTaskReport(savedReport, project, phase);
                devTaskReportRepository.save(devTaskReport);
            }
        }
        
        // 7. 处理下周规划（可选：存储为新的计划记录或仅用于前端显示）
        // nextWeekPlan数据通常不存储，主要用于前端显示和下次周报的任务选择
        
        logger.info("Weekly report created successfully: {}", savedReport.getId());
        return WeeklyReportResponse.fromEntity(savedReport);
    }
    
    /**
     * 获取周报详情（重构查询逻辑）
     */
    public WeeklyReportResponse getWeeklyReportDetail(Long reportId) {
        WeeklyReport report = weeklyReportRepository.findById(reportId)
                .orElseThrow(() -> new IllegalArgumentException("周报不存在"));
        
        WeeklyReportResponse response = WeeklyReportResponse.fromEntity(report);
        
        // 查询关联的日常任务
        List<TaskReport> taskReports = taskReportRepository.findByWeeklyReportId(reportId);
        List<WeeklyReportResponse.TaskInfo> routineTasks = taskReports.stream()
                .map(tr -> {
                    WeeklyReportResponse.TaskInfo taskInfo = new WeeklyReportResponse.TaskInfo();
                    taskInfo.setTaskId(tr.getTask().getId());
                    taskInfo.setTaskName(tr.getTask().getTaskName());
                    taskInfo.setActualResults(tr.getTask().getActualResults());
                    taskInfo.setResultDifferenceAnalysis(tr.getTask().getResultDifferenceAnalysis());
                    return taskInfo;
                })
                .collect(Collectors.toList());
        response.setRoutineTasks(routineTasks);
        
        // 查询关联的发展任务
        List<DevTaskReport> devTaskReports = devTaskReportRepository.findByWeeklyReportId(reportId);
        List<WeeklyReportResponse.DevTaskInfo> devTasks = devTaskReports.stream()
                .map(dtr -> {
                    WeeklyReportResponse.DevTaskInfo devTaskInfo = new WeeklyReportResponse.DevTaskInfo();
                    devTaskInfo.setProjectId(dtr.getProject().getId());
                    devTaskInfo.setProjectName(dtr.getProject().getName()); // 使用新的name字段
                    devTaskInfo.setPhaseId(dtr.getProjectPhase().getId());
                    devTaskInfo.setPhaseName(dtr.getProjectPhase().getPhaseName());
                    devTaskInfo.setActualResults(dtr.getProjectPhase().getActualResults());
                    devTaskInfo.setResultDifferenceAnalysis(dtr.getProjectPhase().getResultDifferenceAnalysis());
                    return devTaskInfo;
                })
                .collect(Collectors.toList());
        response.setDevTasks(devTasks);
        
        return response;
    }
    
    /**
     * 更新周报（适配新结构）
     */
    public WeeklyReportResponse updateWeeklyReport(Long reportId, WeeklyReportCreateRequest request) {
        WeeklyReport report = weeklyReportRepository.findById(reportId)
                .orElseThrow(() -> new IllegalArgumentException("周报不存在"));
        
        // 只允许修改草稿状态的周报
        if (report.getApprovalStatus() != WeeklyReport.ApprovalStatus.DRAFT) {
            throw new IllegalStateException("只能修改草稿状态的周报");
        }
        
        // 更新基础信息
        report.setTitle(request.getTitle());
        report.setReportWeek(request.getReportWeek());
        report.setAdditionalNotes(request.getAdditionalNotes());
        report.setDevelopmentOpportunities(request.getDevelopmentOpportunities());
        
        // 删除原有关联
        taskReportRepository.deleteByWeeklyReportId(reportId);
        devTaskReportRepository.deleteByWeeklyReportId(reportId);
        
        // 重新创建关联（复用创建逻辑的关联部分）
        // ... (关联逻辑与创建方法相同)
        
        WeeklyReport savedReport = weeklyReportRepository.save(report);
        return WeeklyReportResponse.fromEntity(savedReport);
    }
    
    /**
     * 删除周报
     */
    public void deleteWeeklyReport(Long reportId) {
        WeeklyReport report = weeklyReportRepository.findById(reportId)
                .orElseThrow(() -> new IllegalArgumentException("周报不存在"));
        
        // 只允许删除草稿状态的周报
        if (report.getApprovalStatus() != WeeklyReport.ApprovalStatus.DRAFT) {
            throw new IllegalStateException("只能删除草稿状态的周报");
        }
        
        // 删除关联记录（级联删除已配置）
        weeklyReportRepository.delete(report);
    }
    
    /**
     * 提交周报（状态变更）
     */
    public WeeklyReportResponse submitWeeklyReport(Long reportId) {
        WeeklyReport report = weeklyReportRepository.findById(reportId)
                .orElseThrow(() -> new IllegalArgumentException("周报不存在"));
        
        if (report.getApprovalStatus() != WeeklyReport.ApprovalStatus.DRAFT) {
            throw new IllegalStateException("只能提交草稿状态的周报");
        }
        
        // 更新状态为AI分析中
        report.setApprovalStatus(WeeklyReport.ApprovalStatus.AI_ANALYZING);
        
        // 触发AI分析（异步处理）
        // weeklyReportAIService.analyzeReport(report);
        
        WeeklyReport savedReport = weeklyReportRepository.save(report);
        return WeeklyReportResponse.fromEntity(savedReport);
    }
    
    // 其他业务方法...
}
```

### 2. 新增关联表Service

```java
@Service
@Transactional
public class TaskReportService {
    
    @Autowired
    private TaskReportRepository taskReportRepository;
    
    @Autowired
    private TaskRepository taskRepository;
    
    @Autowired
    private WeeklyReportRepository weeklyReportRepository;
    
    /**
     * 为周报添加日常任务关联
     */
    public void addTaskToReport(Long weeklyReportId, Long taskId) {
        WeeklyReport report = weeklyReportRepository.findById(weeklyReportId)
                .orElseThrow(() -> new IllegalArgumentException("周报不存在"));
        Task task = taskRepository.findById(taskId)
                .orElseThrow(() -> new IllegalArgumentException("任务不存在"));
        
        if (!taskReportRepository.existsByWeeklyReportIdAndTaskId(weeklyReportId, taskId)) {
            TaskReport taskReport = new TaskReport(report, task);
            taskReportRepository.save(taskReport);
        }
    }
    
    /**
     * 移除周报的任务关联
     */
    public void removeTaskFromReport(Long weeklyReportId, Long taskId) {
        TaskReportId id = new TaskReportId(weeklyReportId, taskId);
        taskReportRepository.deleteById(id);
    }
    
    /**
     * 获取周报的所有关联任务
     */
    public List<Task> getTasksByReportId(Long weeklyReportId) {
        List<TaskReport> taskReports = taskReportRepository.findByWeeklyReportId(weeklyReportId);
        return taskReports.stream()
                .map(TaskReport::getTask)
                .collect(Collectors.toList());
    }
}
```

---

## Controller层修改

### 1. WeeklyReportController适配

```java
@RestController
@RequestMapping("/api/v1/weekly-reports")
@CrossOrigin(origins = "*")
public class WeeklyReportController {
    
    @Autowired
    private WeeklyReportService weeklyReportService;
    
    /**
     * 创建周报 - 适配新的数据结构
     * POST /api/v1/weekly-reports
     */
    @PostMapping
    public ResponseEntity<ApiResponse<WeeklyReportResponse>> createWeeklyReport(
            @Valid @RequestBody WeeklyReportCreateRequest request,
            Authentication authentication) {
        
        try {
            logger.info("Creating weekly report with new structure: {}", request.getTitle());
            
            // 验证用户权限
            String currentUsername = authentication.getName();
            User currentUser = userService.findByUsername(currentUsername);
            
            // 验证用户ID匹配
            if (!currentUser.getId().toString().equals(request.getUserid())) {
                return ResponseEntity.status(HttpStatus.FORBIDDEN)
                        .body(ApiResponse.error("无权为其他用户创建周报"));
            }
            
            WeeklyReportResponse response = weeklyReportService.createWeeklyReport(request);
            
            return ResponseEntity.ok(ApiResponse.success(response));
            
        } catch (IllegalArgumentException e) {
            logger.warn("Invalid argument for creating weekly report: {}", e.getMessage());
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error(e.getMessage()));
        } catch (Exception e) {
            logger.error("Error creating weekly report", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(ApiResponse.error("创建周报失败"));
        }
    }
    
    /**
     * 获取周报详情 - 返回新的数据结构
     * GET /api/v1/weekly-reports/{id}
     */
    @GetMapping("/{id}")
    public ResponseEntity<ApiResponse<WeeklyReportResponse>> getWeeklyReport(
            @PathVariable Long id,
            Authentication authentication) {
        
        try {
            WeeklyReportResponse response = weeklyReportService.getWeeklyReportDetail(id);
            
            // 验证用户权限
            String currentUsername = authentication.getName();
            User currentUser = userService.findByUsername(currentUsername);
            
            if (!hasPermissionToViewReport(currentUser, response)) {
                return ResponseEntity.status(HttpStatus.FORBIDDEN)
                        .body(ApiResponse.error("无权查看此周报"));
            }
            
            return ResponseEntity.ok(ApiResponse.success(response));
            
        } catch (IllegalArgumentException e) {
            return ResponseEntity.notFound().build();
        } catch (Exception e) {
            logger.error("Error getting weekly report", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(ApiResponse.error("获取周报失败"));
        }
    }
    
    /**
     * 更新周报
     * PUT /api/v1/weekly-reports/{id}
     */
    @PutMapping("/{id}")
    public ResponseEntity<ApiResponse<WeeklyReportResponse>> updateWeeklyReport(
            @PathVariable Long id,
            @Valid @RequestBody WeeklyReportCreateRequest request,
            Authentication authentication) {
        
        try {
            // 权限验证
            String currentUsername = authentication.getName();
            User currentUser = userService.findByUsername(currentUsername);
            
            if (!currentUser.getId().toString().equals(request.getUserid())) {
                return ResponseEntity.status(HttpStatus.FORBIDDEN)
                        .body(ApiResponse.error("无权修改其他用户的周报"));
            }
            
            WeeklyReportResponse response = weeklyReportService.updateWeeklyReport(id, request);
            
            return ResponseEntity.ok(ApiResponse.success(response));
            
        } catch (IllegalArgumentException e) {
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error(e.getMessage()));
        } catch (IllegalStateException e) {
            return ResponseEntity.status(HttpStatus.CONFLICT)
                    .body(ApiResponse.error(e.getMessage()));
        } catch (Exception e) {
            logger.error("Error updating weekly report", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(ApiResponse.error("更新周报失败"));
        }
    }
    
    /**
     * 提交周报（状态变更）
     * POST /api/v1/weekly-reports/{id}/submit
     */
    @PostMapping("/{id}/submit")
    public ResponseEntity<ApiResponse<WeeklyReportResponse>> submitWeeklyReport(
            @PathVariable Long id,
            Authentication authentication) {
        
        try {
            WeeklyReportResponse response = weeklyReportService.submitWeeklyReport(id);
            return ResponseEntity.ok(ApiResponse.success(response));
            
        } catch (IllegalArgumentException e) {
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error(e.getMessage()));
        } catch (IllegalStateException e) {
            return ResponseEntity.status(HttpStatus.CONFLICT)
                    .body(ApiResponse.error(e.getMessage()));
        } catch (Exception e) {
            logger.error("Error submitting weekly report", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(ApiResponse.error("提交周报失败"));
        }
    }
    
    /**
     * 获取用户的周报列表
     * GET /api/v1/weekly-reports/my
     */
    @GetMapping("/my")
    public ResponseEntity<ApiResponse<Page<WeeklyReportResponse>>> getMyWeeklyReports(
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size,
            @RequestParam(defaultValue = "id") String sort,
            @RequestParam(defaultValue = "desc") String direction,
            Authentication authentication) {
        
        try {
            String currentUsername = authentication.getName();
            User currentUser = userService.findByUsername(currentUsername);
            
            Pageable pageable = PageRequest.of(page, size, 
                Sort.by(Sort.Direction.fromString(direction), sort));
            
            Page<WeeklyReportResponse> reports = weeklyReportService
                    .getWeeklyReportsByUser(currentUser.getId(), pageable);
            
            return ResponseEntity.ok(ApiResponse.success(reports));
            
        } catch (Exception e) {
            logger.error("Error getting user's weekly reports", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(ApiResponse.error("获取周报列表失败"));
        }
    }
    
    // 其他方法...
    
    /**
     * 检查用户是否有权查看周报
     */
    private boolean hasPermissionToViewReport(User user, WeeklyReportResponse report) {
        // 1. 用户可以查看自己的周报
        if (user.getId().equals(report.getUserId())) {
            return true;
        }
        
        // 2. 管理员和超级管理员可以查看所有周报
        if (user.getRole() == User.Role.ADMIN || user.getRole() == User.Role.SUPER_ADMIN) {
            return true;
        }
        
        // 3. 主管可以查看下属的周报（需要实现组织架构逻辑）
        // if (user.getRole() == User.Role.MANAGER) {
        //     return isSubordinate(user, report.getUserId());
        // }
        
        return false;
    }
}
```

### 2. 新增关联API

```java
@RestController
@RequestMapping("/api/v1/weekly-reports")
public class WeeklyReportTaskController {
    
    @Autowired
    private TaskReportService taskReportService;
    
    @Autowired
    private DevTaskReportService devTaskReportService;
    
    /**
     * 为周报添加日常任务
     * POST /api/v1/weekly-reports/{reportId}/tasks/{taskId}
     */
    @PostMapping("/{reportId}/tasks/{taskId}")
    public ResponseEntity<ApiResponse<Void>> addTaskToReport(
            @PathVariable Long reportId,
            @PathVariable Long taskId,
            Authentication authentication) {
        
        try {
            // 权限验证...
            taskReportService.addTaskToReport(reportId, taskId);
            return ResponseEntity.ok(ApiResponse.success(null));
            
        } catch (Exception e) {
            logger.error("Error adding task to report", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(ApiResponse.error("添加任务关联失败"));
        }
    }
    
    /**
     * 移除周报的任务关联
     * DELETE /api/v1/weekly-reports/{reportId}/tasks/{taskId}
     */
    @DeleteMapping("/{reportId}/tasks/{taskId}")
    public ResponseEntity<ApiResponse<Void>> removeTaskFromReport(
            @PathVariable Long reportId,
            @PathVariable Long taskId,
            Authentication authentication) {
        
        try {
            // 权限验证...
            taskReportService.removeTaskFromReport(reportId, taskId);
            return ResponseEntity.ok(ApiResponse.success(null));
            
        } catch (Exception e) {
            logger.error("Error removing task from report", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(ApiResponse.error("移除任务关联失败"));
        }
    }
    
    /**
     * 获取周报关联的所有任务
     * GET /api/v1/weekly-reports/{reportId}/tasks
     */
    @GetMapping("/{reportId}/tasks")
    public ResponseEntity<ApiResponse<List<Task>>> getReportTasks(
            @PathVariable Long reportId,
            Authentication authentication) {
        
        try {
            // 权限验证...
            List<Task> tasks = taskReportService.getTasksByReportId(reportId);
            return ResponseEntity.ok(ApiResponse.success(tasks));
            
        } catch (Exception e) {
            logger.error("Error getting report tasks", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(ApiResponse.error("获取关联任务失败"));
        }
    }
}
```

---

## 测试和验证

### 1. 单元测试更新

```java
@ExtendWith(MockitoExtension.class)
class WeeklyReportServiceTest {
    
    @Mock
    private WeeklyReportRepository weeklyReportRepository;
    
    @Mock
    private TaskReportRepository taskReportRepository;
    
    @Mock
    private DevTaskReportRepository devTaskReportRepository;
    
    @Mock
    private UserRepository userRepository;
    
    @InjectMocks
    private WeeklyReportService weeklyReportService;
    
    @Test
    void createWeeklyReport_shouldCreateWithNewStructure() {
        // Given
        WeeklyReportCreateRequest request = createTestRequest();
        User user = createTestUser();
        
        when(userRepository.findById(1L)).thenReturn(Optional.of(user));
        when(weeklyReportRepository.existsByUserIdAndReportWeek(1L, "2024年1月第1周（周一）"))
                .thenReturn(false);
        when(weeklyReportRepository.save(any(WeeklyReport.class)))
                .thenAnswer(invocation -> {
                    WeeklyReport report = invocation.getArgument(0);
                    report.setId(1L);
                    return report;
                });
        
        // When
        WeeklyReportResponse response = weeklyReportService.createWeeklyReport(request);
        
        // Then
        assertThat(response).isNotNull();
        assertThat(response.getId()).isEqualTo(1L);
        assertThat(response.getTitle()).isEqualTo(request.getTitle());
        assertThat(response.getReportWeek()).isEqualTo(request.getReportWeek());
        
        verify(weeklyReportRepository).save(any(WeeklyReport.class));
        verify(taskReportRepository, atLeastOnce()).save(any(TaskReport.class));
    }
    
    private WeeklyReportCreateRequest createTestRequest() {
        WeeklyReportCreateRequest request = new WeeklyReportCreateRequest();
        request.setUserid("1");
        request.setTitle("测试周报");
        request.setReportWeek("2024年1月第1周（周一）");
        request.setAdditionalNotes("测试备注");
        request.setDevelopmentOpportunities("测试机会");
        
        // 设置内容
        WeeklyReportCreateRequest.ContentDTO content = new WeeklyReportCreateRequest.ContentDTO();
        
        // 日常任务
        WeeklyReportCreateRequest.RoutineTaskDTO routineTask = new WeeklyReportCreateRequest.RoutineTaskDTO();
        routineTask.setTask_id("1");
        routineTask.setActual_result("实际结果");
        routineTask.setAnalysisofResultDifferences("差异分析");
        content.setRoutine_tasks(List.of(routineTask));
        
        request.setContent(content);
        
        return request;
    }
    
    private User createTestUser() {
        User user = new User();
        user.setId(1L);
        user.setUsername("testuser");
        user.setEmail("test@example.com");
        return user;
    }
}
```

### 2. 集成测试

```java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@TestPropertySource(properties = {
    "spring.datasource.url=jdbc:h2:mem:testdb",
    "spring.flyway.enabled=false"
})
class WeeklyReportIntegrationTest {
    
    @Autowired
    private TestRestTemplate restTemplate;
    
    @Autowired
    private WeeklyReportRepository weeklyReportRepository;
    
    @Autowired
    private TaskReportRepository taskReportRepository;
    
    @Test
    void createAndRetrieveWeeklyReport_shouldWork() {
        // Given
        WeeklyReportCreateRequest request = createValidRequest();
        
        // When - Create
        ResponseEntity<ApiResponse> createResponse = restTemplate.postForEntity(
                "/api/v1/weekly-reports", request, ApiResponse.class);
        
        // Then - Verify creation
        assertThat(createResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
        
        // When - Retrieve
        Long reportId = extractReportId(createResponse);
        ResponseEntity<ApiResponse> getResponse = restTemplate.getForEntity(
                "/api/v1/weekly-reports/" + reportId, ApiResponse.class);
        
        // Then - Verify retrieval
        assertThat(getResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
        
        // Verify database state
        Optional<WeeklyReport> savedReport = weeklyReportRepository.findById(reportId);
        assertThat(savedReport).isPresent();
        assertThat(savedReport.get().getTitle()).isEqualTo(request.getTitle());
        
        List<TaskReport> taskReports = taskReportRepository.findByWeeklyReportId(reportId);
        assertThat(taskReports).hasSize(request.getContent().getRoutine_tasks().size());
    }
    
    // 辅助方法...
}
```

### 3. API测试

```bash
# 创建周报的测试请求
POST /api/v1/weekly-reports
Content-Type: application/json

{
  "userid": "1",
  "title": "2024年第1周工作汇报",
  "reportWeek": "2024年1月第1周（周一）",
  "content": {
    "Routine_tasks": [
      {
        "task_id": "1",
        "actual_result": "完成了系统升级工作",
        "AnalysisofResultDifferences": "比预期提前完成"
      }
    ],
    "Developmental_tasks": [
      {
        "project_id": "1", 
        "phase_id": "1",
        "actual_result": "完成了需求分析",
        "AnalysisofResultDifferences": "需求收集比预期复杂"
      }
    ]
  },
  "nextWeekPlan": {
    "Routine_tasks": [
      {
        "task_id": "2"
      }
    ],
    "Developmental_tasks": [
      {
        "project_id": "1",
        "phase_id": "2"
      }
    ]
  },
  "additionalNotes": "本周工作顺利完成",
  "developmentOpportunities": "可以加强技术学习"
}
```

---

## 实施步骤

### 阶段1：准备工作（1天）
1. ✅ 备份当前代码和数据库
2. ✅ 确认V26数据库迁移已完成 
3. ✅ 创建功能分支 `feature/backend-restructure`

### 阶段2：Entity层重构（2-3天）
1. 修改WeeklyReport实体，删除废弃字段
2. 创建TaskReport和DevTaskReport关联表实体
3. 简化User实体，删除非必要字段
4. 更新Task实体，删除项目关联字段
5. 更新所有实体的字段映射注解

### 阶段3：Repository层更新（1天）
1. 创建TaskReportRepository和DevTaskReportRepository
2. 更新WeeklyReportRepository的查询方法
3. 删除废弃的Repository接口

### 阶段4：DTO层重构（2天）
1. 按照error3.md重构WeeklyReportCreateRequest
2. 更新WeeklyReportResponse以支持关联表数据
3. 删除废弃的DTO类
4. 更新验证注解

### 阶段5：Service层重构（3-4天）
1. 重构WeeklyReportService核心方法
2. 创建TaskReportService和DevTaskReportService
3. 更新审批流程Service
4. 删除废弃的Service方法

### 阶段6：Controller层适配（2天）
1. 更新WeeklyReportController的API接口
2. 创建关联表管理的API
3. 更新错误处理和权限验证
4. 删除废弃的Controller

### 阶段7：测试和验证（2-3天）
1. 编写单元测试
2. 编写集成测试
3. API测试
4. 端到端测试

### 阶段8：部署和监控（1天）
1. 代码review
2. 部署到测试环境
3. 性能测试
4. 生产环境部署

**总计预估时间：12-17天**

---

## 风险和注意事项

### 🔴 高风险
1. **数据一致性**: 确保关联表数据的完整性
2. **性能影响**: 多表关联查询的性能优化
3. **向后兼容**: 现有API的兼容性处理

### 🟡 中风险  
1. **前端适配**: 前端需要同步调整数据结构
2. **测试覆盖**: 确保所有场景的测试覆盖
3. **数据迁移**: 现有数据的迁移和转换

### 🟢 低风险
1. **代码清理**: 废弃代码的清理工作
2. **文档更新**: API文档的更新
3. **监控告警**: 新接口的监控配置

---

## 总结

本指导文档详细阐述了基于V26数据库重构的后端代码修改方案。核心改动包括：

1. **实体层**: 删除复杂字段，新增关联表实体
2. **数据层**: 实现关联表查询和操作
3. **业务层**: 重构周报创建和查询逻辑
4. **接口层**: 适配error3.md的数据结构
5. **测试层**: 确保重构后的功能正确性

通过这一系列改动，系统将从复杂的JSON存储模式转向清晰的关联表模式，提供更好的数据一致性、查询性能和业务逻辑的可维护性。

重构完成后，系统将完全符合error3.md的要求，为前端提供标准化的数据接口，同时保持高效的数据处理能力。