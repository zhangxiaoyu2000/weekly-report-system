# å‘¨æŠ¥ç®¡ç†ç³»ç»Ÿåç«¯ä¿®æ”¹æŒ‡å¯¼æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£åŸºäº `doc/æ•°æ®åº“è®¾è®¡.md` å’Œ V26 æ•°æ®åº“é‡æ„å®Œæˆçš„ç»“æœï¼Œè¯¦ç»†æŒ‡å¯¼åç«¯ä»£ç å¦‚ä½•é€‚é…æ–°çš„æ•°æ®åº“ç»“æ„ã€‚é‡æ„çš„æ ¸å¿ƒæ˜¯å°†åŸæœ‰çš„å¤æ‚JSONå­˜å‚¨æ¨¡å¼æ”¹ä¸ºå…³è”è¡¨æ¨¡å¼ï¼Œç§»é™¤éå¿…è¦å­—æ®µï¼Œä¸¥æ ¼æŒ‰ç…§error3.mdçš„è¦æ±‚å®ç°ã€‚

## ç›®å½•
1. [ä¿®æ”¹ä¼˜å…ˆçº§å’Œæµç¨‹](#ä¿®æ”¹ä¼˜å…ˆçº§å’Œæµç¨‹)
2. [Entityå±‚é‡æ„](#entityå±‚é‡æ„)
3. [Repositoryå±‚ä¿®æ”¹](#repositoryå±‚ä¿®æ”¹)
4. [DTOå±‚é‡æ„](#dtoå±‚é‡æ„)
5. [Serviceå±‚é‡æ„](#serviceå±‚é‡æ„)
6. [Controllerå±‚ä¿®æ”¹](#controllerå±‚ä¿®æ”¹)
7. [æµ‹è¯•å’ŒéªŒè¯](#æµ‹è¯•å’ŒéªŒè¯)

---

## ä¿®æ”¹ä¼˜å…ˆçº§å’Œæµç¨‹

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³ä¿®æ”¹ï¼‰
1. **Entityç±»é€‚é…** - ä¿®æ”¹å®ä½“ç±»ä»¥åŒ¹é…æ–°æ•°æ®åº“ç»“æ„
2. **å…³è”è¡¨Entity** - åˆ›å»ºTaskReportå’ŒDevTaskReportå®ä½“
3. **WeeklyReportCreateRequest** - æŒ‰error3.mdé‡æ–°è®¾è®¡DTO
4. **æ ¸å¿ƒServiceé‡æ„** - WeeklyReportServiceæ ¸å¿ƒé€»è¾‘

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆåç»­ä¿®æ”¹ï¼‰
5. **Repositoryæ–¹æ³•æ›´æ–°** - å…³è”è¡¨æŸ¥è¯¢æ–¹æ³•
6. **Controlleræ¥å£é€‚é…** - APIæ¥å£è°ƒæ•´
7. **å…¶ä»–DTOç±»æ›´æ–°** - Responseå’ŒUpdateè¯·æ±‚

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆä¼˜åŒ–é˜¶æ®µï¼‰
8. **æ¸…ç†åºŸå¼ƒä»£ç ** - åˆ é™¤ä¸å†ä½¿ç”¨çš„ç±»å’Œæ–¹æ³•
9. **æ€§èƒ½ä¼˜åŒ–** - æŸ¥è¯¢ä¼˜åŒ–å’Œç¼“å­˜
10. **æ–‡æ¡£æ›´æ–°** - APIæ–‡æ¡£æ›´æ–°

---

## Entityå±‚é‡æ„

### 1. WeeklyReportå®ä½“é‡æ„

#### 1.1 åˆ é™¤å­—æ®µï¼ˆå·²é€šè¿‡V26è¿ç§»åˆ é™¤ï¼‰

```java
// âŒ éœ€è¦åˆ é™¤çš„å­—æ®µ
private String content;                    // é€šè¿‡å…³è”è¡¨å­˜å‚¨
private String summary;                    // å¤šä½™å­—æ®µ
private ReportStatus status;               // ä½¿ç”¨approval_statusæ›¿ä»£
private LocalDate weekStart;               // ä½¿ç”¨report_weekæ›¿ä»£  
private LocalDate weekEnd;               // ä½¿ç”¨report_weekæ›¿ä»£
private LocalDateTime submittedAt;         // ç®€åŒ–æ—¶é—´ç®¡ç†
private LocalDateTime reviewedAt;          // ç®€åŒ–å®¡æ ¸
private User reviewedBy;                   // ç®€åŒ–å®¡æ ¸
private String reviewComments;             // ç®€åŒ–å®¡æ ¸
private ReportPriority priority;           // error3.mdæ ‡è®°ä¸ºå¤šä½™
private String tags;                       // å¤šä½™å­—æ®µ
private String attachments;                // å¤šä½™å­—æ®µ
private Integer viewCount;                 // å¤šä½™å­—æ®µ
private LocalDateTime createdAt;           // ç®€åŒ–æ—¶é—´ç®¡ç†
private LocalDateTime updatedAt;           // ç®€åŒ–æ—¶é—´ç®¡ç†
private LocalDateTime deletedAt;           // ä½¿ç”¨statusç®¡ç†
private Template template;                 // åˆ é™¤æ¨¡æ¿åŠŸèƒ½
private Project project;                   // é€šè¿‡å…³è”è¡¨å­˜å‚¨

// å¤æ‚å®¡æ‰¹å­—æ®µï¼ˆç®€åŒ–ä¸ºæ ¸å¿ƒå­—æ®µï¼‰
private User managerReviewer;              // ç®€åŒ–å®¡æ‰¹æµç¨‹
private String managerReviewComment;       // ç®€åŒ–å®¡æ‰¹æµç¨‹
private LocalDateTime managerReviewedAt;   // ç®€åŒ–å®¡æ‰¹æµç¨‹
private String adminReviewComment;         // ä¸éœ€è¦è¯¦ç»†å®¡æ ¸è®°å½•
private LocalDateTime adminReviewedAt;     // ä¸éœ€è¦è¯¦ç»†å®¡æ ¸è®°å½•
private User superAdminReviewer;           // é€šè¿‡super_admin_reviewer_idå­—æ®µ
private String superAdminReviewComment;    // ä¸éœ€è¦è¯¦ç»†å®¡æ ¸è®°å½•
private LocalDateTime superAdminReviewedAt; // ä¸éœ€è¦è¯¦ç»†å®¡æ ¸è®°å½•

// AIåˆ†æè¯¦ç»†å­—æ®µï¼ˆé€šè¿‡ai_analysis_idå…³è”ï¼‰
private Double aiConfidence;               // é€šè¿‡ai_analysis_idå…³è”
private Double aiQualityScore;             // é€šè¿‡ai_analysis_idå…³è”
private String aiRiskLevel;                // é€šè¿‡ai_analysis_idå…³è”
private String aiProviderUsed;             // é€šè¿‡ai_analysis_idå…³è”
private Long aiProcessingTimeMs;           // é€šè¿‡ai_analysis_idå…³è”
private LocalDateTime aiAnalyzedAt;        // é€šè¿‡ai_analysis_idå…³è”
private String aiKeyIssues;                // é€šè¿‡ai_analysis_idå…³è”
private String aiRecommendations;          // é€šè¿‡ai_analysis_idå…³è”
```

#### 1.2 ä¿ç•™å’Œæ–°å¢å­—æ®µ

```java
@Entity
@Table(name = "weekly_reports")
public class WeeklyReport {
    
    // âœ… ä¿ç•™çš„æ ¸å¿ƒå­—æ®µ
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;                       // å‘¨æŠ¥ID
    
    @NotNull
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id", nullable = false)
    private User user;                     // æäº¤å‘¨æŠ¥çš„ç”¨æˆ·IDï¼ˆå­—æ®µåä»authoræ”¹ä¸ºuserï¼‰
    
    @NotBlank
    @Size(max = 200)
    @Column(name = "title", nullable = false, length = 200)
    private String title;                  // å‘¨æŠ¥æ ‡é¢˜
    
    @NotBlank
    @Column(name = "report_week", nullable = false, length = 50)
    private String reportWeek;             // å‘¨æŠ¥å‘¨æœŸï¼ˆä¸­æ–‡æ ¼å¼ï¼šå‡ æœˆç¬¬å‡ å‘¨ï¼ˆå‘¨å‡ ï¼‰ï¼‰
    
    @Column(name = "additional_notes", columnDefinition = "TEXT")
    private String additionalNotes;        // å…¶ä»–å¤‡æ³¨
    
    @Column(name = "development_opportunities", columnDefinition = "TEXT")
    private String developmentOpportunities; // å¯å‘å±•æ€§æ¸…å•
    
    // âœ… æ–°å¢çš„å®¡æ‰¹å­—æ®µ
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "ai_analysis_id")
    private AIAnalysisResult aiAnalysis;   // AIåˆ†æç»“æœIDï¼ˆå¤–é”®ï¼‰
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "admin_reviewer_id")
    private User adminReviewer;            // ç®¡ç†å‘˜å®¡æ‰¹äººID
    
    @Column(name = "rejection_reason", columnDefinition = "TEXT")
    private String rejectionReason;        // æ‹’ç»ç†ç”±
    
    @Enumerated(EnumType.STRING)
    @Column(name = "approval_status")
    private ApprovalStatus approvalStatus = ApprovalStatus.DRAFT; // å®¡æ‰¹çŠ¶æ€
    
    // âœ… æ–°å¢çš„å…³è”è¡¨å…³ç³»
    @OneToMany(mappedBy = "weeklyReport", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
    private Set<TaskReport> taskReports = new HashSet<>();        // æ—¥å¸¸ä»»åŠ¡å…³è”
    
    @OneToMany(mappedBy = "weeklyReport", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
    private Set<DevTaskReport> devTaskReports = new HashSet<>();  // å‘å±•ä»»åŠ¡å…³è”

    // âœ… æ–°çš„å®¡æ‰¹çŠ¶æ€æšä¸¾
    public enum ApprovalStatus {
        DRAFT,                    // è‰ç¨¿
        AI_ANALYZING,            // AIåˆ†æä¸­
        AI_APPROVED,             // AIå·²æ‰¹å‡†
        AI_REJECTED,             // AIå·²æ‹’ç»
        ADMIN_REVIEWING,         // ç®¡ç†å‘˜å®¡æ ¸ä¸­
        ADMIN_APPROVED,          // ç®¡ç†å‘˜å·²æ‰¹å‡†
        ADMIN_REJECTED,          // ç®¡ç†å‘˜å·²æ‹’ç»
        SUPER_ADMIN_REVIEWING,   // è¶…çº§ç®¡ç†å‘˜å®¡æ ¸ä¸­
        SUPER_ADMIN_APPROVED,    // è¶…çº§ç®¡ç†å‘˜å·²æ‰¹å‡†
        SUPER_ADMIN_REJECTED,    // è¶…çº§ç®¡ç†å‘˜å·²æ‹’ç»
        FINAL_APPROVED           // æœ€ç»ˆæ‰¹å‡†
    }
    
    // âœ… å…³è”è¡¨ç®¡ç†æ–¹æ³•
    public void addTaskReport(TaskReport taskReport) {
        taskReports.add(taskReport);
        taskReport.setWeeklyReport(this);
    }
    
    public void removeTaskReport(TaskReport taskReport) {
        taskReports.remove(taskReport);
        taskReport.setWeeklyReport(null);
    }
    
    public void addDevTaskReport(DevTaskReport devTaskReport) {
        devTaskReports.add(devTaskReport);
        devTaskReport.setWeeklyReport(this);
    }
    
    public void removeDevTaskReport(DevTaskReport devTaskReport) {
        devTaskReports.remove(devTaskReport);
        devTaskReport.setWeeklyReport(null);
    }
}
```

### 2. æ–°å¢å…³è”è¡¨å®ä½“

#### 2.1 TaskReportå®ä½“ï¼ˆæ—¥å¸¸ä»»åŠ¡-å‘¨æŠ¥å…³è”è¡¨ï¼‰

```java
package com.weeklyreport.entity;

import jakarta.persistence.*;
import org.hibernate.annotations.CreationTimestamp;

import java.time.LocalDateTime;

/**
 * æ—¥å¸¸æ€§ä»»åŠ¡ä¸å‘¨æŠ¥å…³è”è¡¨
 * å®ç°å¤šå¯¹å¤šå…³ç³»ï¼šä¸€ä¸ªå‘¨æŠ¥å¯ä»¥å…³è”å¤šä¸ªæ—¥å¸¸ä»»åŠ¡ï¼Œä¸€ä¸ªä»»åŠ¡å¯ä»¥è¢«å¤šä¸ªå‘¨æŠ¥å¼•ç”¨
 */
@Entity
@Table(name = "task_reports")
public class TaskReport {
    
    @EmbeddedId
    private TaskReportId id;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @MapsId("weeklyReportId")
    @JoinColumn(name = "weekly_report_id", nullable = false)
    private WeeklyReport weeklyReport;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @MapsId("taskId")
    @JoinColumn(name = "task_id", nullable = false)
    private Task task;
    
    @CreationTimestamp
    @Column(name = "created_at")
    private LocalDateTime createdAt;
    
    // æ„é€ å‡½æ•°ã€getterå’Œsetter
    public TaskReport() {}
    
    public TaskReport(WeeklyReport weeklyReport, Task task) {
        this.id = new TaskReportId(weeklyReport.getId(), task.getId());
        this.weeklyReport = weeklyReport;
        this.task = task;
    }
    
    // getterå’Œsetteræ–¹æ³•...
}

/**
 * å¤åˆä¸»é”®ç±»
 */
@Embeddable
public class TaskReportId implements Serializable {
    @Column(name = "weekly_report_id")
    private Long weeklyReportId;
    
    @Column(name = "task_id")
    private Long taskId;
    
    // æ„é€ å‡½æ•°ã€equalsã€hashCodeæ–¹æ³•
    public TaskReportId() {}
    
    public TaskReportId(Long weeklyReportId, Long taskId) {
        this.weeklyReportId = weeklyReportId;
        this.taskId = taskId;
    }
    
    // equalsã€hashCodeå’Œgetter/setteræ–¹æ³•...
}
```

#### 2.2 DevTaskReportå®ä½“ï¼ˆå‘å±•ä»»åŠ¡-å‘¨æŠ¥å…³è”è¡¨ï¼‰

```java
package com.weeklyreport.entity;

import jakarta.persistence.*;
import org.hibernate.annotations.CreationTimestamp;

import java.time.LocalDateTime;

/**
 * å‘å±•æ€§é¡¹ç›®é˜¶æ®µä»»åŠ¡ä¸å‘¨æŠ¥å…³è”è¡¨
 * å®ç°é¡¹ç›®é˜¶æ®µä»»åŠ¡ä¸å‘¨æŠ¥çš„å…³è”
 */
@Entity
@Table(name = "dev_task_reports")
public class DevTaskReport {
    
    @EmbeddedId
    private DevTaskReportId id;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @MapsId("weeklyReportId")
    @JoinColumn(name = "weekly_report_id", nullable = false)
    private WeeklyReport weeklyReport;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @MapsId("projectId")
    @JoinColumn(name = "project_id", nullable = false)
    private Project project;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @MapsId("taskId")
    @JoinColumn(name = "task_id", nullable = false)
    private ProjectPhase projectPhase; // å¯¹åº”project_phasesè¡¨
    
    @CreationTimestamp
    @Column(name = "created_at")
    private LocalDateTime createdAt;
    
    // æ„é€ å‡½æ•°ã€getterå’Œsetter
    public DevTaskReport() {}
    
    public DevTaskReport(WeeklyReport weeklyReport, Project project, ProjectPhase projectPhase) {
        this.id = new DevTaskReportId(weeklyReport.getId(), project.getId(), projectPhase.getId());
        this.weeklyReport = weeklyReport;
        this.project = project;
        this.projectPhase = projectPhase;
    }
    
    // getterå’Œsetteræ–¹æ³•...
}

/**
 * å¤åˆä¸»é”®ç±»
 */
@Embeddable
public class DevTaskReportId implements Serializable {
    @Column(name = "weekly_report_id")
    private Long weeklyReportId;
    
    @Column(name = "project_id")
    private Long projectId;
    
    @Column(name = "task_id")
    private Long taskId;
    
    // æ„é€ å‡½æ•°ã€equalsã€hashCodeæ–¹æ³•
    public DevTaskReportId() {}
    
    public DevTaskReportId(Long weeklyReportId, Long projectId, Long taskId) {
        this.weeklyReportId = weeklyReportId;
        this.projectId = projectId;
        this.taskId = taskId;
    }
    
    // equalsã€hashCodeå’Œgetter/setteræ–¹æ³•...
}
```

### 3. Userå®ä½“ç®€åŒ–

#### 3.1 åˆ é™¤å­—æ®µï¼ˆå·²é€šè¿‡V26è¿ç§»åˆ é™¤ï¼‰

```java
// âŒ éœ€è¦åˆ é™¤çš„å­—æ®µ
private String firstName;              // ç®€åŒ–ä¸ºusername
private String lastName;               // ç®€åŒ–ä¸ºusername
private String employeeId;             // éæ ¸å¿ƒå­—æ®µ
private String position;               // éæ ¸å¿ƒå­—æ®µ
private String phone;                  // éæ ¸å¿ƒå­—æ®µ
private String avatarUrl;              // éæ ¸å¿ƒå­—æ®µ
private String fullName;               // è®¡ç®—å­—æ®µï¼Œéå¿…è¦
private LocalDateTime lastLogin;       // é‡å¤å­—æ®µ
private LocalDateTime lastLoginTime;   // é‡å¤å­—æ®µ
private LocalDateTime deletedAt;       // ä½¿ç”¨statusç®¡ç†
private LocalDateTime createdAt;       // ç®€åŒ–æ—¶é—´ç®¡ç†
private LocalDateTime updatedAt;       // ç®€åŒ–æ—¶é—´ç®¡ç†
private Department department;         // ä¸éœ€è¦éƒ¨é—¨ç®¡ç†
```

#### 3.2 ç®€åŒ–åçš„Userå®ä½“

```java
@Entity
@Table(name = "users")
public class User {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;                   // ç”¨æˆ·ID
    
    @NotBlank
    @Size(min = 3, max = 50)
    @Column(name = "username", unique = true, nullable = false, length = 50)
    private String username;           // ç”¨æˆ·å
    
    @NotBlank
    @Email
    @Size(max = 100)
    @Column(name = "email", unique = true, nullable = false, length = 100)
    private String email;              // é‚®ç®±
    
    @NotBlank
    @Column(name = "password", nullable = false)
    private String password;           // å¯†ç 
    
    @NotNull
    @Enumerated(EnumType.STRING)
    @Column(name = "role", nullable = false)
    private Role role = Role.EMPLOYEE; // è§’è‰²
    
    @NotNull
    @Enumerated(EnumType.STRING)
    @Column(name = "status", nullable = false)
    private UserStatus status = UserStatus.ACTIVE; // çŠ¶æ€
    
    // è§’è‰²æšä¸¾ä¿æŒä¸å˜
    public enum Role {
        ADMIN,          // ç®¡ç†å‘˜
        MANAGER,        // ä¸»ç®¡
        EMPLOYEE,       // å‘˜å·¥
        SUPER_ADMIN     // è¶…çº§ç®¡ç†å‘˜
    }
    
    // çŠ¶æ€æšä¸¾ä¿æŒä¸å˜
    public enum UserStatus {
        ACTIVE,         // æ¿€æ´»çŠ¶æ€
        INACTIVE,       // éæ¿€æ´»çŠ¶æ€
        SUSPENDED,      // æš‚åœçŠ¶æ€
        LOCKED,         // é”å®šçŠ¶æ€
        DELETED         // åˆ é™¤çŠ¶æ€
    }
}
```

### 4. Taskå®ä½“é€‚é…

#### 4.1 åˆ é™¤é¡¹ç›®å…³è”å­—æ®µï¼ˆå·²é€šè¿‡V26è¿ç§»åˆ é™¤ï¼‰

```java
// âŒ éœ€è¦åˆ é™¤çš„å­—æ®µï¼ˆé€šè¿‡å…³è”è¡¨ç®¡ç†ï¼‰
@ManyToOne
@JoinColumn(name = "project_id")
private Project project;               // é€šè¿‡å…³è”è¡¨å­˜å‚¨

@ManyToOne  
@JoinColumn(name = "simple_project_id")
private SimpleProject simpleProject;   // é€šè¿‡å…³è”è¡¨å­˜å‚¨

@ManyToOne
@JoinColumn(name = "project_phase_id") 
private ProjectPhase projectPhase;     // é€šè¿‡å…³è”è¡¨å­˜å‚¨

@ManyToOne
@JoinColumn(name = "weekly_report_id")
private WeeklyReport weeklyReport;     // é€šè¿‡å…³è”è¡¨å­˜å‚¨

@Enumerated(EnumType.STRING)
@Column(name = "report_section")
private ReportSection reportSection;   // ä½¿ç”¨å…³è”è¡¨åŒºåˆ†

// åˆ é™¤ç®¡ç†å­—æ®µ
private String stopLossPoint;          // éæ—¥å¸¸ä»»åŠ¡å­—æ®µ
private Integer progress;              // é€šè¿‡actual_resultsåˆ¤æ–­
private LocalDate startDate;           // ç®€åŒ–ç®¡ç†
private LocalDate dueDate;             // ç®€åŒ–ç®¡ç†
private LocalDate completionDate;      // ç®€åŒ–ç®¡ç†
private BigDecimal budget;             // éæ—¥å¸¸ä»»åŠ¡å­—æ®µ
private Boolean isCompleted;           // é€šè¿‡actual_resultsåˆ¤æ–­
private Boolean isOverdue;             // é€šè¿‡actual_resultsåˆ¤æ–­
private Integer priority;              // error3.mdæ˜ç¡®åˆ é™¤
private Long taskTemplateId;           // åˆ é™¤æ¨¡æ¿åŠŸèƒ½
private LocalDateTime createdAt;       // ç®€åŒ–æ—¶é—´ç®¡ç†
private LocalDateTime updatedAt;       // ç®€åŒ–æ—¶é—´ç®¡ç†
```

#### 4.2 é€‚é…åçš„Taskå®ä½“

```java
@Entity
@Table(name = "tasks")
public class Task {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;                           // ä»»åŠ¡ID
    
    @NotBlank
    @Size(max = 200)
    @Column(name = "task_name", nullable = false, length = 200)
    private String taskName;                   // ä»»åŠ¡åç§°
    
    @Size(max = 200)
    @Column(name = "personnel_assignment", length = 100)
    private String personnelAssignment;        // äººå‘˜åˆ†é…
    
    @Size(max = 200)
    @Column(name = "timeline", length = 200)
    private String timeline;                   // æ—¶é—´çº¿
    
    @Size(max = 300)
    @Column(name = "quantitative_metrics", length = 300)
    private String quantitativeMetrics;        // é‡åŒ–æŒ‡æ ‡
    
    @Column(name = "expected_results", columnDefinition = "TEXT")
    private String expectedResults;            // é¢„æœŸç»“æœ
    
    @Column(name = "actual_results", columnDefinition = "TEXT")
    private String actualResults;              // å®é™…ç»“æœ
    
    @Column(name = "result_difference_analysis", columnDefinition = "TEXT")
    private String resultDifferenceAnalysis;   // ç»“æœå·®å¼‚åˆ†æ
    
    @NotNull
    @Enumerated(EnumType.STRING)
    @Column(name = "task_type", nullable = false)
    private TaskType taskType;                 // ä»»åŠ¡ç±»å‹
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "created_by")
    private User createdBy;                    // åˆ›å»ºè€…ID
    
    // ä»»åŠ¡ç±»å‹æšä¸¾æ›´æ–°
    public enum TaskType {
        DAILY,      // æ¯æ—¥ä»»åŠ¡
        WEEKLY,     // æ¯å‘¨ä»»åŠ¡  
        MONTHLY     // æ¯æœˆä»»åŠ¡
    }
    
    // å…³è”è¡¨å…³ç³»ï¼ˆåå‘å…³ç³»ï¼Œæ–¹ä¾¿æŸ¥è¯¢ï¼‰
    @OneToMany(mappedBy = "task", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
    private Set<TaskReport> taskReports = new HashSet<>();
}
```

---

## Repositoryå±‚ä¿®æ”¹

### 1. æ–°å¢å…³è”è¡¨Repository

#### 1.1 TaskReportRepository

```java
package com.weeklyreport.repository;

import com.weeklyreport.entity.TaskReport;
import com.weeklyreport.entity.TaskReportId;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface TaskReportRepository extends JpaRepository<TaskReport, TaskReportId> {
    
    // æŸ¥è¯¢å‘¨æŠ¥å…³è”çš„æ‰€æœ‰æ—¥å¸¸ä»»åŠ¡
    List<TaskReport> findByWeeklyReportId(Long weeklyReportId);
    
    // æŸ¥è¯¢ä»»åŠ¡å…³è”çš„æ‰€æœ‰å‘¨æŠ¥
    List<TaskReport> findByTaskId(Long taskId);
    
    // æ‰¹é‡åˆ é™¤å‘¨æŠ¥çš„ä»»åŠ¡å…³è”
    void deleteByWeeklyReportId(Long weeklyReportId);
    
    // åˆ é™¤ç‰¹å®šä»»åŠ¡çš„å‘¨æŠ¥å…³è”
    void deleteByTaskId(Long taskId);
    
    // æ£€æŸ¥ç‰¹å®šä»»åŠ¡æ˜¯å¦å·²å…³è”åˆ°å‘¨æŠ¥
    boolean existsByWeeklyReportIdAndTaskId(Long weeklyReportId, Long taskId);
    
    // æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰ä»»åŠ¡å…³è”ï¼ˆé€šè¿‡å‘¨æŠ¥ï¼‰
    @Query("SELECT tr FROM TaskReport tr " +
           "WHERE tr.weeklyReport.user.id = :userId")
    List<TaskReport> findByUserId(@Param("userId") Long userId);
}
```

#### 1.2 DevTaskReportRepository

```java
package com.weeklyreport.repository;

import com.weeklyreport.entity.DevTaskReport;
import com.weeklyreport.entity.DevTaskReportId;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface DevTaskReportRepository extends JpaRepository<DevTaskReport, DevTaskReportId> {
    
    // æŸ¥è¯¢å‘¨æŠ¥å…³è”çš„æ‰€æœ‰å‘å±•ä»»åŠ¡
    List<DevTaskReport> findByWeeklyReportId(Long weeklyReportId);
    
    // æŸ¥è¯¢é¡¹ç›®å…³è”çš„æ‰€æœ‰å‘¨æŠ¥
    List<DevTaskReport> findByProjectId(Long projectId);
    
    // æŸ¥è¯¢é¡¹ç›®é˜¶æ®µå…³è”çš„æ‰€æœ‰å‘¨æŠ¥
    List<DevTaskReport> findByTaskId(Long taskId); // taskIdå¯¹åº”project_phasesçš„id
    
    // æ‰¹é‡åˆ é™¤å‘¨æŠ¥çš„å‘å±•ä»»åŠ¡å…³è”
    void deleteByWeeklyReportId(Long weeklyReportId);
    
    // åˆ é™¤ç‰¹å®šé¡¹ç›®çš„å‘¨æŠ¥å…³è”
    void deleteByProjectId(Long projectId);
    
    // æ£€æŸ¥ç‰¹å®šé¡¹ç›®é˜¶æ®µæ˜¯å¦å·²å…³è”åˆ°å‘¨æŠ¥
    boolean existsByWeeklyReportIdAndProjectIdAndTaskId(Long weeklyReportId, Long projectId, Long taskId);
    
    // æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰å‘å±•ä»»åŠ¡å…³è”ï¼ˆé€šè¿‡å‘¨æŠ¥ï¼‰
    @Query("SELECT dtr FROM DevTaskReport dtr " +
           "WHERE dtr.weeklyReport.user.id = :userId")
    List<DevTaskReport> findByUserId(@Param("userId") Long userId);
}
```

### 2. WeeklyReportRepositoryæ›´æ–°

```java
@Repository
public interface WeeklyReportRepository extends JpaRepository<WeeklyReport, Long>, JpaSpecificationExecutor<WeeklyReport> {
    
    // âœ… æ›´æ–°æ–¹æ³•åï¼ˆauthor â†’ userï¼‰
    List<WeeklyReport> findByUserId(Long userId);
    Page<WeeklyReport> findByUserId(Long userId, Pageable pageable);
    List<WeeklyReport> findByUser(User user);
    
    // âœ… æ›´æ–°å­—æ®µåï¼ˆweekStart â†’ reportWeekï¼‰
    List<WeeklyReport> findByReportWeek(String reportWeek);
    Optional<WeeklyReport> findByUserIdAndReportWeek(Long userId, String reportWeek);
    boolean existsByUserIdAndReportWeek(Long userId, String reportWeek);
    boolean existsByUserAndReportWeek(User user, String reportWeek);
    
    // âœ… æ›´æ–°çŠ¶æ€å­—æ®µï¼ˆstatus â†’ approvalStatusï¼‰
    List<WeeklyReport> findByApprovalStatus(WeeklyReport.ApprovalStatus approvalStatus);
    Page<WeeklyReport> findByApprovalStatus(WeeklyReport.ApprovalStatus approvalStatus, Pageable pageable);
    
    // âœ… æ–°å¢å®¡æ‰¹çŠ¶æ€æŸ¥è¯¢
    List<WeeklyReport> findByApprovalStatusIn(List<WeeklyReport.ApprovalStatus> statuses);
    
    // âœ… æŸ¥è¯¢ç­‰å¾…å®¡æ‰¹çš„å‘¨æŠ¥
    @Query("SELECT wr FROM WeeklyReport wr " +
           "WHERE wr.approvalStatus IN ('AI_APPROVED', 'ADMIN_REVIEWING', 'SUPER_ADMIN_REVIEWING')")
    List<WeeklyReport> findPendingApprovalReports();
    
    // âœ… æ ¹æ®AIåˆ†æç»“æœæŸ¥è¯¢
    List<WeeklyReport> findByAiAnalysisId(Long aiAnalysisId);
    
    // âœ… æ ¹æ®å®¡æ ¸äººæŸ¥è¯¢
    List<WeeklyReport> findByAdminReviewerId(Long adminReviewerId);
    
    // âŒ åˆ é™¤ä¸éœ€è¦çš„æ–¹æ³•
    // findByWeekStart -> findByReportWeek
    // findByStatus -> findByApprovalStatus
    // findByAuthor -> findByUser
    // findByTemplate -> åˆ é™¤æ¨¡æ¿åŠŸèƒ½
    // findByProject -> é€šè¿‡å…³è”è¡¨æŸ¥è¯¢
}
```

---

## DTOå±‚é‡æ„

### 1. WeeklyReportCreateRequesté‡æ„ï¼ˆæ ¸å¿ƒï¼‰

æŒ‰ç…§error3.mdçš„å‰ç«¯æ•°æ®ç»“æ„é‡æ–°è®¾è®¡ï¼š

```java
package com.weeklyreport.dto.weeklyreport;

import jakarta.validation.constraints.*;
import java.util.List;

/**
 * å‘¨æŠ¥åˆ›å»ºè¯·æ±‚DTO - ä¸¥æ ¼æŒ‰ç…§error3.mdçš„å‰ç«¯æ•°æ®ç»“æ„è®¾è®¡
 */
public class WeeklyReportCreateRequest {
    
    @NotBlank(message = "ç”¨æˆ·IDä¸èƒ½ä¸ºç©º")
    private String userid;                  // æäº¤å‘¨æŠ¥çš„ç”¨æˆ·id
    
    @NotBlank(message = "æ ‡é¢˜ä¸èƒ½ä¸ºç©º")
    @Size(max = 200, message = "æ ‡é¢˜ä¸èƒ½è¶…è¿‡200å­—ç¬¦")
    private String title;                   // å‘¨æŠ¥æ ‡é¢˜
    
    @NotBlank(message = "å‘¨æŠ¥å‘¨æœŸä¸èƒ½ä¸ºç©º")
    private String reportWeek;              // å‡ æœˆç¬¬å‡ å‘¨ï¼ˆå‘¨å‡ ï¼‰
    
    @NotNull(message = "å‘¨æŠ¥å†…å®¹ä¸èƒ½ä¸ºç©º")
    private ContentDTO content;             // æœ¬å‘¨æ±‡æŠ¥å†…å®¹
    
    @NotNull(message = "ä¸‹å‘¨è§„åˆ’ä¸èƒ½ä¸ºç©º")
    private NextWeekPlanDTO nextWeekPlan;   // ä¸‹å‘¨è§„åˆ’
    
    @Size(max = 2000, message = "å…¶ä»–å¤‡æ³¨ä¸èƒ½è¶…è¿‡2000å­—ç¬¦")
    private String additionalNotes;         // å…¶ä»–å¤‡æ³¨
    
    @Size(max = 2000, message = "å¯å‘å±•æ€§æ¸…å•ä¸èƒ½è¶…è¿‡2000å­—ç¬¦")
    private String developmentOpportunities; // å¯å‘å±•æ€§æ¸…å•
    
    // å†…éƒ¨ç±»ï¼šæœ¬å‘¨æ±‡æŠ¥å†…å®¹
    public static class ContentDTO {
        private List<RoutineTaskDTO> Routine_tasks;      // æ—¥å¸¸æ€§ä»»åŠ¡
        private List<DevelopmentalTaskDTO> Developmental_tasks; // å‘å±•æ€§ä»»åŠ¡
        
        // getterå’Œsetter...
    }
    
    // å†…éƒ¨ç±»ï¼šæ—¥å¸¸æ€§ä»»åŠ¡
    public static class RoutineTaskDTO {
        @NotBlank(message = "ä»»åŠ¡IDä¸èƒ½ä¸ºç©º")
        private String task_id;                          // å¯¹åº”ä»»åŠ¡è¡¨ä¸­çš„æ—¥å¸¸æ€§ä»»åŠ¡çš„id å¤–é”®
        
        @Size(max = 500, message = "å®é™…ç»“æœä¸èƒ½è¶…è¿‡500å­—ç¬¦")
        private String actual_result;                    // å®é™…ç»“æœ
        
        @Size(max = 1000, message = "ç»“æœå·®å¼‚åˆ†æä¸èƒ½è¶…è¿‡1000å­—ç¬¦")
        private String AnalysisofResultDifferences;      // ç»“æœå·®å¼‚åˆ†æ
        
        // getterå’Œsetter...
    }
    
    // å†…éƒ¨ç±»ï¼šå‘å±•æ€§ä»»åŠ¡
    public static class DevelopmentalTaskDTO {
        @NotBlank(message = "é¡¹ç›®IDä¸èƒ½ä¸ºç©º")
        private String project_id;                       // å¯¹åº”é¡¹ç›®è¡¨ä¸­çš„é¡¹ç›®id å¤–é”®
        
        @NotBlank(message = "é˜¶æ®µIDä¸èƒ½ä¸ºç©º")
        private String phase_id;                         // å¯¹åº”è¯¥é¡¹ç›®çš„æŸä¸ªé˜¶æ®µçš„id å¤–é”®
        
        @Size(max = 500, message = "å®é™…ç»“æœä¸èƒ½è¶…è¿‡500å­—ç¬¦")
        private String actual_result;                    // å®é™…ç»“æœ
        
        @Size(max = 1000, message = "ç»“æœå·®å¼‚åˆ†æä¸èƒ½è¶…è¿‡1000å­—ç¬¦")
        private String AnalysisofResultDifferences;      // ç»“æœå·®å¼‚åˆ†æ
        
        // getterå’Œsetter...
    }
    
    // å†…éƒ¨ç±»ï¼šä¸‹å‘¨è§„åˆ’
    public static class NextWeekPlanDTO {
        private List<NextWeekRoutineTaskDTO> Routine_tasks;      // æ—¥å¸¸æ€§ä»»åŠ¡
        private List<NextWeekDevelopmentalTaskDTO> Developmental_tasks; // å‘å±•æ€§ä»»åŠ¡
        
        // getterå’Œsetter...
    }
    
    // å†…éƒ¨ç±»ï¼šä¸‹å‘¨è§„åˆ’æ—¥å¸¸ä»»åŠ¡
    public static class NextWeekRoutineTaskDTO {
        @NotBlank(message = "ä»»åŠ¡IDä¸èƒ½ä¸ºç©º")
        private String task_id;                          // å¯¹åº”ä»»åŠ¡è¡¨ä¸­çš„æ—¥å¸¸æ€§ä»»åŠ¡çš„id å¤–é”®
        
        // getterå’Œsetter...
    }
    
    // å†…éƒ¨ç±»ï¼šä¸‹å‘¨è§„åˆ’å‘å±•ä»»åŠ¡
    public static class NextWeekDevelopmentalTaskDTO {
        @NotBlank(message = "é¡¹ç›®IDä¸èƒ½ä¸ºç©º")
        private String project_id;                       // å¯¹åº”é¡¹ç›®è¡¨ä¸­çš„é¡¹ç›®id å¤–é”®
        
        @NotBlank(message = "é˜¶æ®µIDä¸èƒ½ä¸ºç©º")
        private String phase_id;                         // å¯¹åº”è¯¥é¡¹ç›®çš„æŸä¸ªé˜¶æ®µçš„id å¤–é”®
        
        // getterå’Œsetter...
    }
    
    // æ‰€æœ‰å­—æ®µçš„getterå’Œsetteræ–¹æ³•...
}
```

### 2. WeeklyReportResponseé‡æ„

```java
package com.weeklyreport.dto.weeklyreport;

import com.weeklyreport.entity.WeeklyReport;
import java.util.List;

/**
 * å‘¨æŠ¥å“åº”DTO - åŒ¹é…æ–°çš„æ•°æ®åº“ç»“æ„
 */
public class WeeklyReportResponse {
    
    private Long id;                        // å‘¨æŠ¥ID
    private Long userId;                    // ç”¨æˆ·ID
    private String username;                // ç”¨æˆ·åï¼ˆä»ç”¨æˆ·è¡¨è·å–ï¼‰
    private String title;                   // å‘¨æŠ¥æ ‡é¢˜
    private String reportWeek;              // å‘¨æŠ¥å‘¨æœŸ
    private String additionalNotes;         // å…¶ä»–å¤‡æ³¨
    private String developmentOpportunities; // å¯å‘å±•æ€§æ¸…å•
    
    // å®¡æ‰¹ç›¸å…³ä¿¡æ¯
    private String approvalStatus;          // å®¡æ‰¹çŠ¶æ€
    private Long aiAnalysisId;              // AIåˆ†æç»“æœID
    private Long adminReviewerId;           // ç®¡ç†å‘˜å®¡æ‰¹äººID
    private String adminReviewerName;       // ç®¡ç†å‘˜å§“å
    private String rejectionReason;         // æ‹’ç»ç†ç”±
    
    // å…³è”ä»»åŠ¡ä¿¡æ¯
    private List<TaskInfo> routineTasks;    // å…³è”çš„æ—¥å¸¸ä»»åŠ¡
    private List<DevTaskInfo> devTasks;     // å…³è”çš„å‘å±•ä»»åŠ¡
    
    // å†…éƒ¨ç±»ï¼šä»»åŠ¡ä¿¡æ¯
    public static class TaskInfo {
        private Long taskId;
        private String taskName;
        private String actualResults;
        private String resultDifferenceAnalysis;
        
        // getterå’Œsetter...
    }
    
    // å†…éƒ¨ç±»ï¼šå‘å±•ä»»åŠ¡ä¿¡æ¯
    public static class DevTaskInfo {
        private Long projectId;
        private String projectName;
        private Long phaseId;
        private String phaseName;
        private String actualResults;
        private String resultDifferenceAnalysis;
        
        // getterå’Œsetter...
    }
    
    // å·¥å‚æ–¹æ³•ï¼šä»Entityè½¬æ¢
    public static WeeklyReportResponse fromEntity(WeeklyReport entity) {
        WeeklyReportResponse response = new WeeklyReportResponse();
        response.setId(entity.getId());
        response.setUserId(entity.getUser().getId());
        response.setUsername(entity.getUser().getUsername());
        response.setTitle(entity.getTitle());
        response.setReportWeek(entity.getReportWeek());
        response.setAdditionalNotes(entity.getAdditionalNotes());
        response.setDevelopmentOpportunities(entity.getDevelopmentOpportunities());
        response.setApprovalStatus(entity.getApprovalStatus().name());
        response.setAiAnalysisId(entity.getAiAnalysis() != null ? entity.getAiAnalysis().getId() : null);
        response.setAdminReviewerId(entity.getAdminReviewer() != null ? entity.getAdminReviewer().getId() : null);
        response.setAdminReviewerName(entity.getAdminReviewer() != null ? entity.getAdminReviewer().getUsername() : null);
        response.setRejectionReason(entity.getRejectionReason());
        
        // è®¾ç½®å…³è”ä»»åŠ¡ä¿¡æ¯
        // response.setRoutineTasks(...);
        // response.setDevTasks(...);
        
        return response;
    }
    
    // æ‰€æœ‰å­—æ®µçš„getterå’Œsetteræ–¹æ³•...
}
```

### 3. å…¶ä»–DTOæ›´æ–°

#### 3.1 ç®€åŒ–çš„DTOï¼ˆåˆ é™¤ä¸éœ€è¦çš„ï¼‰

```java
// âŒ åˆ é™¤çš„DTOç±»
// WeeklyReportFilterRequestä¸­çš„å¤æ‚è¿‡æ»¤æ¡ä»¶
// WeeklyReportUpdateRequestä¸­çš„å¤æ‚å­—æ®µ
// Templateç›¸å…³çš„æ‰€æœ‰DTO
// Departmentç›¸å…³çš„æ‰€æœ‰DTO
// ProjectMemberç›¸å…³çš„æ‰€æœ‰DTO
// Commentç›¸å…³çš„æ‰€æœ‰DTO

// âœ… ä¿ç•™å’Œæ›´æ–°çš„DTO
// UserDTO - ç®€åŒ–å­—æ®µ
// ProjectDTO - å­—æ®µæ˜ å°„æ›´æ–°
// TaskDTO - åˆ é™¤é¡¹ç›®å…³è”å­—æ®µ
// AIAnalysisResultDTO - ä¿æŒä¸å˜
```

---

## Serviceå±‚é‡æ„

### 1. WeeklyReportServiceæ ¸å¿ƒé‡æ„

```java
@Service
@Transactional
public class WeeklyReportService {
    
    @Autowired
    private WeeklyReportRepository weeklyReportRepository;
    
    @Autowired
    private TaskReportRepository taskReportRepository;
    
    @Autowired
    private DevTaskReportRepository devTaskReportRepository;
    
    @Autowired
    private TaskRepository taskRepository;
    
    @Autowired
    private ProjectRepository projectRepository;
    
    @Autowired
    private ProjectPhaseRepository projectPhaseRepository;
    
    @Autowired
    private UserRepository userRepository;

    /**
     * åˆ›å»ºå‘¨æŠ¥ï¼ˆæ ¸å¿ƒé‡æ„æ–¹æ³•ï¼‰
     * æŒ‰ç…§error3.mdçš„æ•°æ®ç»“æ„å¤„ç†
     */
    public WeeklyReportResponse createWeeklyReport(WeeklyReportCreateRequest request) {
        logger.info("Creating weekly report with new structure: {}", request.getTitle());
        
        // 1. éªŒè¯ç”¨æˆ·
        Long userId = Long.parseLong(request.getUserid());
        User user = userRepository.findById(userId)
                .orElseThrow(() -> new IllegalArgumentException("ç”¨æˆ·ä¸å­˜åœ¨"));
        
        // 2. æ£€æŸ¥é‡å¤å‘¨æŠ¥
        if (weeklyReportRepository.existsByUserIdAndReportWeek(userId, request.getReportWeek())) {
            throw new IllegalArgumentException("è¯¥å‘¨æœŸçš„å‘¨æŠ¥å·²å­˜åœ¨");
        }
        
        // 3. åˆ›å»ºå‘¨æŠ¥ä¸»ä½“
        WeeklyReport report = new WeeklyReport();
        report.setUser(user);
        report.setTitle(request.getTitle());
        report.setReportWeek(request.getReportWeek());
        report.setAdditionalNotes(request.getAdditionalNotes());
        report.setDevelopmentOpportunities(request.getDevelopmentOpportunities());
        report.setApprovalStatus(WeeklyReport.ApprovalStatus.DRAFT);
        
        // 4. ä¿å­˜å‘¨æŠ¥
        WeeklyReport savedReport = weeklyReportRepository.save(report);
        
        // 5. å¤„ç†æ—¥å¸¸ä»»åŠ¡å…³è”
        if (request.getContent() != null && request.getContent().getRoutine_tasks() != null) {
            for (WeeklyReportCreateRequest.RoutineTaskDTO routineTask : request.getContent().getRoutine_tasks()) {
                // è·å–ä»»åŠ¡
                Long taskId = Long.parseLong(routineTask.getTask_id());
                Task task = taskRepository.findById(taskId)
                        .orElseThrow(() -> new IllegalArgumentException("æ—¥å¸¸ä»»åŠ¡ä¸å­˜åœ¨: " + taskId));
                
                // æ›´æ–°ä»»åŠ¡çš„å®é™…ç»“æœ
                task.setActualResults(routineTask.getActual_result());
                task.setResultDifferenceAnalysis(routineTask.getAnalysisofResultDifferences());
                taskRepository.save(task);
                
                // åˆ›å»ºå…³è”è®°å½•
                TaskReport taskReport = new TaskReport(savedReport, task);
                taskReportRepository.save(taskReport);
            }
        }
        
        // 6. å¤„ç†å‘å±•ä»»åŠ¡å…³è”
        if (request.getContent() != null && request.getContent().getDevelopmental_tasks() != null) {
            for (WeeklyReportCreateRequest.DevelopmentalTaskDTO devTask : request.getContent().getDevelopmental_tasks()) {
                // è·å–é¡¹ç›®å’Œé˜¶æ®µ
                Long projectId = Long.parseLong(devTask.getProject_id());
                Long phaseId = Long.parseLong(devTask.getPhase_id());
                
                Project project = projectRepository.findById(projectId)
                        .orElseThrow(() -> new IllegalArgumentException("é¡¹ç›®ä¸å­˜åœ¨: " + projectId));
                ProjectPhase phase = projectPhaseRepository.findById(phaseId)
                        .orElseThrow(() -> new IllegalArgumentException("é¡¹ç›®é˜¶æ®µä¸å­˜åœ¨: " + phaseId));
                
                // æ›´æ–°é˜¶æ®µçš„å®é™…ç»“æœ
                phase.setActualResults(devTask.getActual_result());
                phase.setResultDifferenceAnalysis(devTask.getAnalysisofResultDifferences());
                projectPhaseRepository.save(phase);
                
                // åˆ›å»ºå…³è”è®°å½•
                DevTaskReport devTaskReport = new DevTaskReport(savedReport, project, phase);
                devTaskReportRepository.save(devTaskReport);
            }
        }
        
        // 7. å¤„ç†ä¸‹å‘¨è§„åˆ’ï¼ˆå¯é€‰ï¼šå­˜å‚¨ä¸ºæ–°çš„è®¡åˆ’è®°å½•æˆ–ä»…ç”¨äºå‰ç«¯æ˜¾ç¤ºï¼‰
        // nextWeekPlanæ•°æ®é€šå¸¸ä¸å­˜å‚¨ï¼Œä¸»è¦ç”¨äºå‰ç«¯æ˜¾ç¤ºå’Œä¸‹æ¬¡å‘¨æŠ¥çš„ä»»åŠ¡é€‰æ‹©
        
        logger.info("Weekly report created successfully: {}", savedReport.getId());
        return WeeklyReportResponse.fromEntity(savedReport);
    }
    
    /**
     * è·å–å‘¨æŠ¥è¯¦æƒ…ï¼ˆé‡æ„æŸ¥è¯¢é€»è¾‘ï¼‰
     */
    public WeeklyReportResponse getWeeklyReportDetail(Long reportId) {
        WeeklyReport report = weeklyReportRepository.findById(reportId)
                .orElseThrow(() -> new IllegalArgumentException("å‘¨æŠ¥ä¸å­˜åœ¨"));
        
        WeeklyReportResponse response = WeeklyReportResponse.fromEntity(report);
        
        // æŸ¥è¯¢å…³è”çš„æ—¥å¸¸ä»»åŠ¡
        List<TaskReport> taskReports = taskReportRepository.findByWeeklyReportId(reportId);
        List<WeeklyReportResponse.TaskInfo> routineTasks = taskReports.stream()
                .map(tr -> {
                    WeeklyReportResponse.TaskInfo taskInfo = new WeeklyReportResponse.TaskInfo();
                    taskInfo.setTaskId(tr.getTask().getId());
                    taskInfo.setTaskName(tr.getTask().getTaskName());
                    taskInfo.setActualResults(tr.getTask().getActualResults());
                    taskInfo.setResultDifferenceAnalysis(tr.getTask().getResultDifferenceAnalysis());
                    return taskInfo;
                })
                .collect(Collectors.toList());
        response.setRoutineTasks(routineTasks);
        
        // æŸ¥è¯¢å…³è”çš„å‘å±•ä»»åŠ¡
        List<DevTaskReport> devTaskReports = devTaskReportRepository.findByWeeklyReportId(reportId);
        List<WeeklyReportResponse.DevTaskInfo> devTasks = devTaskReports.stream()
                .map(dtr -> {
                    WeeklyReportResponse.DevTaskInfo devTaskInfo = new WeeklyReportResponse.DevTaskInfo();
                    devTaskInfo.setProjectId(dtr.getProject().getId());
                    devTaskInfo.setProjectName(dtr.getProject().getName()); // ä½¿ç”¨æ–°çš„nameå­—æ®µ
                    devTaskInfo.setPhaseId(dtr.getProjectPhase().getId());
                    devTaskInfo.setPhaseName(dtr.getProjectPhase().getPhaseName());
                    devTaskInfo.setActualResults(dtr.getProjectPhase().getActualResults());
                    devTaskInfo.setResultDifferenceAnalysis(dtr.getProjectPhase().getResultDifferenceAnalysis());
                    return devTaskInfo;
                })
                .collect(Collectors.toList());
        response.setDevTasks(devTasks);
        
        return response;
    }
    
    /**
     * æ›´æ–°å‘¨æŠ¥ï¼ˆé€‚é…æ–°ç»“æ„ï¼‰
     */
    public WeeklyReportResponse updateWeeklyReport(Long reportId, WeeklyReportCreateRequest request) {
        WeeklyReport report = weeklyReportRepository.findById(reportId)
                .orElseThrow(() -> new IllegalArgumentException("å‘¨æŠ¥ä¸å­˜åœ¨"));
        
        // åªå…è®¸ä¿®æ”¹è‰ç¨¿çŠ¶æ€çš„å‘¨æŠ¥
        if (report.getApprovalStatus() != WeeklyReport.ApprovalStatus.DRAFT) {
            throw new IllegalStateException("åªèƒ½ä¿®æ”¹è‰ç¨¿çŠ¶æ€çš„å‘¨æŠ¥");
        }
        
        // æ›´æ–°åŸºç¡€ä¿¡æ¯
        report.setTitle(request.getTitle());
        report.setReportWeek(request.getReportWeek());
        report.setAdditionalNotes(request.getAdditionalNotes());
        report.setDevelopmentOpportunities(request.getDevelopmentOpportunities());
        
        // åˆ é™¤åŸæœ‰å…³è”
        taskReportRepository.deleteByWeeklyReportId(reportId);
        devTaskReportRepository.deleteByWeeklyReportId(reportId);
        
        // é‡æ–°åˆ›å»ºå…³è”ï¼ˆå¤ç”¨åˆ›å»ºé€»è¾‘çš„å…³è”éƒ¨åˆ†ï¼‰
        // ... (å…³è”é€»è¾‘ä¸åˆ›å»ºæ–¹æ³•ç›¸åŒ)
        
        WeeklyReport savedReport = weeklyReportRepository.save(report);
        return WeeklyReportResponse.fromEntity(savedReport);
    }
    
    /**
     * åˆ é™¤å‘¨æŠ¥
     */
    public void deleteWeeklyReport(Long reportId) {
        WeeklyReport report = weeklyReportRepository.findById(reportId)
                .orElseThrow(() -> new IllegalArgumentException("å‘¨æŠ¥ä¸å­˜åœ¨"));
        
        // åªå…è®¸åˆ é™¤è‰ç¨¿çŠ¶æ€çš„å‘¨æŠ¥
        if (report.getApprovalStatus() != WeeklyReport.ApprovalStatus.DRAFT) {
            throw new IllegalStateException("åªèƒ½åˆ é™¤è‰ç¨¿çŠ¶æ€çš„å‘¨æŠ¥");
        }
        
        // åˆ é™¤å…³è”è®°å½•ï¼ˆçº§è”åˆ é™¤å·²é…ç½®ï¼‰
        weeklyReportRepository.delete(report);
    }
    
    /**
     * æäº¤å‘¨æŠ¥ï¼ˆçŠ¶æ€å˜æ›´ï¼‰
     */
    public WeeklyReportResponse submitWeeklyReport(Long reportId) {
        WeeklyReport report = weeklyReportRepository.findById(reportId)
                .orElseThrow(() -> new IllegalArgumentException("å‘¨æŠ¥ä¸å­˜åœ¨"));
        
        if (report.getApprovalStatus() != WeeklyReport.ApprovalStatus.DRAFT) {
            throw new IllegalStateException("åªèƒ½æäº¤è‰ç¨¿çŠ¶æ€çš„å‘¨æŠ¥");
        }
        
        // æ›´æ–°çŠ¶æ€ä¸ºAIåˆ†æä¸­
        report.setApprovalStatus(WeeklyReport.ApprovalStatus.AI_ANALYZING);
        
        // è§¦å‘AIåˆ†æï¼ˆå¼‚æ­¥å¤„ç†ï¼‰
        // weeklyReportAIService.analyzeReport(report);
        
        WeeklyReport savedReport = weeklyReportRepository.save(report);
        return WeeklyReportResponse.fromEntity(savedReport);
    }
    
    // å…¶ä»–ä¸šåŠ¡æ–¹æ³•...
}
```

### 2. æ–°å¢å…³è”è¡¨Service

```java
@Service
@Transactional
public class TaskReportService {
    
    @Autowired
    private TaskReportRepository taskReportRepository;
    
    @Autowired
    private TaskRepository taskRepository;
    
    @Autowired
    private WeeklyReportRepository weeklyReportRepository;
    
    /**
     * ä¸ºå‘¨æŠ¥æ·»åŠ æ—¥å¸¸ä»»åŠ¡å…³è”
     */
    public void addTaskToReport(Long weeklyReportId, Long taskId) {
        WeeklyReport report = weeklyReportRepository.findById(weeklyReportId)
                .orElseThrow(() -> new IllegalArgumentException("å‘¨æŠ¥ä¸å­˜åœ¨"));
        Task task = taskRepository.findById(taskId)
                .orElseThrow(() -> new IllegalArgumentException("ä»»åŠ¡ä¸å­˜åœ¨"));
        
        if (!taskReportRepository.existsByWeeklyReportIdAndTaskId(weeklyReportId, taskId)) {
            TaskReport taskReport = new TaskReport(report, task);
            taskReportRepository.save(taskReport);
        }
    }
    
    /**
     * ç§»é™¤å‘¨æŠ¥çš„ä»»åŠ¡å…³è”
     */
    public void removeTaskFromReport(Long weeklyReportId, Long taskId) {
        TaskReportId id = new TaskReportId(weeklyReportId, taskId);
        taskReportRepository.deleteById(id);
    }
    
    /**
     * è·å–å‘¨æŠ¥çš„æ‰€æœ‰å…³è”ä»»åŠ¡
     */
    public List<Task> getTasksByReportId(Long weeklyReportId) {
        List<TaskReport> taskReports = taskReportRepository.findByWeeklyReportId(weeklyReportId);
        return taskReports.stream()
                .map(TaskReport::getTask)
                .collect(Collectors.toList());
    }
}
```

---

## Controllerå±‚ä¿®æ”¹

### 1. WeeklyReportControlleré€‚é…

```java
@RestController
@RequestMapping("/api/v1/weekly-reports")
@CrossOrigin(origins = "*")
public class WeeklyReportController {
    
    @Autowired
    private WeeklyReportService weeklyReportService;
    
    /**
     * åˆ›å»ºå‘¨æŠ¥ - é€‚é…æ–°çš„æ•°æ®ç»“æ„
     * POST /api/v1/weekly-reports
     */
    @PostMapping
    public ResponseEntity<ApiResponse<WeeklyReportResponse>> createWeeklyReport(
            @Valid @RequestBody WeeklyReportCreateRequest request,
            Authentication authentication) {
        
        try {
            logger.info("Creating weekly report with new structure: {}", request.getTitle());
            
            // éªŒè¯ç”¨æˆ·æƒé™
            String currentUsername = authentication.getName();
            User currentUser = userService.findByUsername(currentUsername);
            
            // éªŒè¯ç”¨æˆ·IDåŒ¹é…
            if (!currentUser.getId().toString().equals(request.getUserid())) {
                return ResponseEntity.status(HttpStatus.FORBIDDEN)
                        .body(ApiResponse.error("æ— æƒä¸ºå…¶ä»–ç”¨æˆ·åˆ›å»ºå‘¨æŠ¥"));
            }
            
            WeeklyReportResponse response = weeklyReportService.createWeeklyReport(request);
            
            return ResponseEntity.ok(ApiResponse.success(response));
            
        } catch (IllegalArgumentException e) {
            logger.warn("Invalid argument for creating weekly report: {}", e.getMessage());
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error(e.getMessage()));
        } catch (Exception e) {
            logger.error("Error creating weekly report", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(ApiResponse.error("åˆ›å»ºå‘¨æŠ¥å¤±è´¥"));
        }
    }
    
    /**
     * è·å–å‘¨æŠ¥è¯¦æƒ… - è¿”å›æ–°çš„æ•°æ®ç»“æ„
     * GET /api/v1/weekly-reports/{id}
     */
    @GetMapping("/{id}")
    public ResponseEntity<ApiResponse<WeeklyReportResponse>> getWeeklyReport(
            @PathVariable Long id,
            Authentication authentication) {
        
        try {
            WeeklyReportResponse response = weeklyReportService.getWeeklyReportDetail(id);
            
            // éªŒè¯ç”¨æˆ·æƒé™
            String currentUsername = authentication.getName();
            User currentUser = userService.findByUsername(currentUsername);
            
            if (!hasPermissionToViewReport(currentUser, response)) {
                return ResponseEntity.status(HttpStatus.FORBIDDEN)
                        .body(ApiResponse.error("æ— æƒæŸ¥çœ‹æ­¤å‘¨æŠ¥"));
            }
            
            return ResponseEntity.ok(ApiResponse.success(response));
            
        } catch (IllegalArgumentException e) {
            return ResponseEntity.notFound().build();
        } catch (Exception e) {
            logger.error("Error getting weekly report", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(ApiResponse.error("è·å–å‘¨æŠ¥å¤±è´¥"));
        }
    }
    
    /**
     * æ›´æ–°å‘¨æŠ¥
     * PUT /api/v1/weekly-reports/{id}
     */
    @PutMapping("/{id}")
    public ResponseEntity<ApiResponse<WeeklyReportResponse>> updateWeeklyReport(
            @PathVariable Long id,
            @Valid @RequestBody WeeklyReportCreateRequest request,
            Authentication authentication) {
        
        try {
            // æƒé™éªŒè¯
            String currentUsername = authentication.getName();
            User currentUser = userService.findByUsername(currentUsername);
            
            if (!currentUser.getId().toString().equals(request.getUserid())) {
                return ResponseEntity.status(HttpStatus.FORBIDDEN)
                        .body(ApiResponse.error("æ— æƒä¿®æ”¹å…¶ä»–ç”¨æˆ·çš„å‘¨æŠ¥"));
            }
            
            WeeklyReportResponse response = weeklyReportService.updateWeeklyReport(id, request);
            
            return ResponseEntity.ok(ApiResponse.success(response));
            
        } catch (IllegalArgumentException e) {
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error(e.getMessage()));
        } catch (IllegalStateException e) {
            return ResponseEntity.status(HttpStatus.CONFLICT)
                    .body(ApiResponse.error(e.getMessage()));
        } catch (Exception e) {
            logger.error("Error updating weekly report", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(ApiResponse.error("æ›´æ–°å‘¨æŠ¥å¤±è´¥"));
        }
    }
    
    /**
     * æäº¤å‘¨æŠ¥ï¼ˆçŠ¶æ€å˜æ›´ï¼‰
     * POST /api/v1/weekly-reports/{id}/submit
     */
    @PostMapping("/{id}/submit")
    public ResponseEntity<ApiResponse<WeeklyReportResponse>> submitWeeklyReport(
            @PathVariable Long id,
            Authentication authentication) {
        
        try {
            WeeklyReportResponse response = weeklyReportService.submitWeeklyReport(id);
            return ResponseEntity.ok(ApiResponse.success(response));
            
        } catch (IllegalArgumentException e) {
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error(e.getMessage()));
        } catch (IllegalStateException e) {
            return ResponseEntity.status(HttpStatus.CONFLICT)
                    .body(ApiResponse.error(e.getMessage()));
        } catch (Exception e) {
            logger.error("Error submitting weekly report", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(ApiResponse.error("æäº¤å‘¨æŠ¥å¤±è´¥"));
        }
    }
    
    /**
     * è·å–ç”¨æˆ·çš„å‘¨æŠ¥åˆ—è¡¨
     * GET /api/v1/weekly-reports/my
     */
    @GetMapping("/my")
    public ResponseEntity<ApiResponse<Page<WeeklyReportResponse>>> getMyWeeklyReports(
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size,
            @RequestParam(defaultValue = "id") String sort,
            @RequestParam(defaultValue = "desc") String direction,
            Authentication authentication) {
        
        try {
            String currentUsername = authentication.getName();
            User currentUser = userService.findByUsername(currentUsername);
            
            Pageable pageable = PageRequest.of(page, size, 
                Sort.by(Sort.Direction.fromString(direction), sort));
            
            Page<WeeklyReportResponse> reports = weeklyReportService
                    .getWeeklyReportsByUser(currentUser.getId(), pageable);
            
            return ResponseEntity.ok(ApiResponse.success(reports));
            
        } catch (Exception e) {
            logger.error("Error getting user's weekly reports", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(ApiResponse.error("è·å–å‘¨æŠ¥åˆ—è¡¨å¤±è´¥"));
        }
    }
    
    // å…¶ä»–æ–¹æ³•...
    
    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒæŸ¥çœ‹å‘¨æŠ¥
     */
    private boolean hasPermissionToViewReport(User user, WeeklyReportResponse report) {
        // 1. ç”¨æˆ·å¯ä»¥æŸ¥çœ‹è‡ªå·±çš„å‘¨æŠ¥
        if (user.getId().equals(report.getUserId())) {
            return true;
        }
        
        // 2. ç®¡ç†å‘˜å’Œè¶…çº§ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å‘¨æŠ¥
        if (user.getRole() == User.Role.ADMIN || user.getRole() == User.Role.SUPER_ADMIN) {
            return true;
        }
        
        // 3. ä¸»ç®¡å¯ä»¥æŸ¥çœ‹ä¸‹å±çš„å‘¨æŠ¥ï¼ˆéœ€è¦å®ç°ç»„ç»‡æ¶æ„é€»è¾‘ï¼‰
        // if (user.getRole() == User.Role.MANAGER) {
        //     return isSubordinate(user, report.getUserId());
        // }
        
        return false;
    }
}
```

### 2. æ–°å¢å…³è”API

```java
@RestController
@RequestMapping("/api/v1/weekly-reports")
public class WeeklyReportTaskController {
    
    @Autowired
    private TaskReportService taskReportService;
    
    @Autowired
    private DevTaskReportService devTaskReportService;
    
    /**
     * ä¸ºå‘¨æŠ¥æ·»åŠ æ—¥å¸¸ä»»åŠ¡
     * POST /api/v1/weekly-reports/{reportId}/tasks/{taskId}
     */
    @PostMapping("/{reportId}/tasks/{taskId}")
    public ResponseEntity<ApiResponse<Void>> addTaskToReport(
            @PathVariable Long reportId,
            @PathVariable Long taskId,
            Authentication authentication) {
        
        try {
            // æƒé™éªŒè¯...
            taskReportService.addTaskToReport(reportId, taskId);
            return ResponseEntity.ok(ApiResponse.success(null));
            
        } catch (Exception e) {
            logger.error("Error adding task to report", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(ApiResponse.error("æ·»åŠ ä»»åŠ¡å…³è”å¤±è´¥"));
        }
    }
    
    /**
     * ç§»é™¤å‘¨æŠ¥çš„ä»»åŠ¡å…³è”
     * DELETE /api/v1/weekly-reports/{reportId}/tasks/{taskId}
     */
    @DeleteMapping("/{reportId}/tasks/{taskId}")
    public ResponseEntity<ApiResponse<Void>> removeTaskFromReport(
            @PathVariable Long reportId,
            @PathVariable Long taskId,
            Authentication authentication) {
        
        try {
            // æƒé™éªŒè¯...
            taskReportService.removeTaskFromReport(reportId, taskId);
            return ResponseEntity.ok(ApiResponse.success(null));
            
        } catch (Exception e) {
            logger.error("Error removing task from report", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(ApiResponse.error("ç§»é™¤ä»»åŠ¡å…³è”å¤±è´¥"));
        }
    }
    
    /**
     * è·å–å‘¨æŠ¥å…³è”çš„æ‰€æœ‰ä»»åŠ¡
     * GET /api/v1/weekly-reports/{reportId}/tasks
     */
    @GetMapping("/{reportId}/tasks")
    public ResponseEntity<ApiResponse<List<Task>>> getReportTasks(
            @PathVariable Long reportId,
            Authentication authentication) {
        
        try {
            // æƒé™éªŒè¯...
            List<Task> tasks = taskReportService.getTasksByReportId(reportId);
            return ResponseEntity.ok(ApiResponse.success(tasks));
            
        } catch (Exception e) {
            logger.error("Error getting report tasks", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(ApiResponse.error("è·å–å…³è”ä»»åŠ¡å¤±è´¥"));
        }
    }
}
```

---

## æµ‹è¯•å’ŒéªŒè¯

### 1. å•å…ƒæµ‹è¯•æ›´æ–°

```java
@ExtendWith(MockitoExtension.class)
class WeeklyReportServiceTest {
    
    @Mock
    private WeeklyReportRepository weeklyReportRepository;
    
    @Mock
    private TaskReportRepository taskReportRepository;
    
    @Mock
    private DevTaskReportRepository devTaskReportRepository;
    
    @Mock
    private UserRepository userRepository;
    
    @InjectMocks
    private WeeklyReportService weeklyReportService;
    
    @Test
    void createWeeklyReport_shouldCreateWithNewStructure() {
        // Given
        WeeklyReportCreateRequest request = createTestRequest();
        User user = createTestUser();
        
        when(userRepository.findById(1L)).thenReturn(Optional.of(user));
        when(weeklyReportRepository.existsByUserIdAndReportWeek(1L, "2024å¹´1æœˆç¬¬1å‘¨ï¼ˆå‘¨ä¸€ï¼‰"))
                .thenReturn(false);
        when(weeklyReportRepository.save(any(WeeklyReport.class)))
                .thenAnswer(invocation -> {
                    WeeklyReport report = invocation.getArgument(0);
                    report.setId(1L);
                    return report;
                });
        
        // When
        WeeklyReportResponse response = weeklyReportService.createWeeklyReport(request);
        
        // Then
        assertThat(response).isNotNull();
        assertThat(response.getId()).isEqualTo(1L);
        assertThat(response.getTitle()).isEqualTo(request.getTitle());
        assertThat(response.getReportWeek()).isEqualTo(request.getReportWeek());
        
        verify(weeklyReportRepository).save(any(WeeklyReport.class));
        verify(taskReportRepository, atLeastOnce()).save(any(TaskReport.class));
    }
    
    private WeeklyReportCreateRequest createTestRequest() {
        WeeklyReportCreateRequest request = new WeeklyReportCreateRequest();
        request.setUserid("1");
        request.setTitle("æµ‹è¯•å‘¨æŠ¥");
        request.setReportWeek("2024å¹´1æœˆç¬¬1å‘¨ï¼ˆå‘¨ä¸€ï¼‰");
        request.setAdditionalNotes("æµ‹è¯•å¤‡æ³¨");
        request.setDevelopmentOpportunities("æµ‹è¯•æœºä¼š");
        
        // è®¾ç½®å†…å®¹
        WeeklyReportCreateRequest.ContentDTO content = new WeeklyReportCreateRequest.ContentDTO();
        
        // æ—¥å¸¸ä»»åŠ¡
        WeeklyReportCreateRequest.RoutineTaskDTO routineTask = new WeeklyReportCreateRequest.RoutineTaskDTO();
        routineTask.setTask_id("1");
        routineTask.setActual_result("å®é™…ç»“æœ");
        routineTask.setAnalysisofResultDifferences("å·®å¼‚åˆ†æ");
        content.setRoutine_tasks(List.of(routineTask));
        
        request.setContent(content);
        
        return request;
    }
    
    private User createTestUser() {
        User user = new User();
        user.setId(1L);
        user.setUsername("testuser");
        user.setEmail("test@example.com");
        return user;
    }
}
```

### 2. é›†æˆæµ‹è¯•

```java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@TestPropertySource(properties = {
    "spring.datasource.url=jdbc:h2:mem:testdb",
    "spring.flyway.enabled=false"
})
class WeeklyReportIntegrationTest {
    
    @Autowired
    private TestRestTemplate restTemplate;
    
    @Autowired
    private WeeklyReportRepository weeklyReportRepository;
    
    @Autowired
    private TaskReportRepository taskReportRepository;
    
    @Test
    void createAndRetrieveWeeklyReport_shouldWork() {
        // Given
        WeeklyReportCreateRequest request = createValidRequest();
        
        // When - Create
        ResponseEntity<ApiResponse> createResponse = restTemplate.postForEntity(
                "/api/v1/weekly-reports", request, ApiResponse.class);
        
        // Then - Verify creation
        assertThat(createResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
        
        // When - Retrieve
        Long reportId = extractReportId(createResponse);
        ResponseEntity<ApiResponse> getResponse = restTemplate.getForEntity(
                "/api/v1/weekly-reports/" + reportId, ApiResponse.class);
        
        // Then - Verify retrieval
        assertThat(getResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
        
        // Verify database state
        Optional<WeeklyReport> savedReport = weeklyReportRepository.findById(reportId);
        assertThat(savedReport).isPresent();
        assertThat(savedReport.get().getTitle()).isEqualTo(request.getTitle());
        
        List<TaskReport> taskReports = taskReportRepository.findByWeeklyReportId(reportId);
        assertThat(taskReports).hasSize(request.getContent().getRoutine_tasks().size());
    }
    
    // è¾…åŠ©æ–¹æ³•...
}
```

### 3. APIæµ‹è¯•

```bash
# åˆ›å»ºå‘¨æŠ¥çš„æµ‹è¯•è¯·æ±‚
POST /api/v1/weekly-reports
Content-Type: application/json

{
  "userid": "1",
  "title": "2024å¹´ç¬¬1å‘¨å·¥ä½œæ±‡æŠ¥",
  "reportWeek": "2024å¹´1æœˆç¬¬1å‘¨ï¼ˆå‘¨ä¸€ï¼‰",
  "content": {
    "Routine_tasks": [
      {
        "task_id": "1",
        "actual_result": "å®Œæˆäº†ç³»ç»Ÿå‡çº§å·¥ä½œ",
        "AnalysisofResultDifferences": "æ¯”é¢„æœŸæå‰å®Œæˆ"
      }
    ],
    "Developmental_tasks": [
      {
        "project_id": "1", 
        "phase_id": "1",
        "actual_result": "å®Œæˆäº†éœ€æ±‚åˆ†æ",
        "AnalysisofResultDifferences": "éœ€æ±‚æ”¶é›†æ¯”é¢„æœŸå¤æ‚"
      }
    ]
  },
  "nextWeekPlan": {
    "Routine_tasks": [
      {
        "task_id": "2"
      }
    ],
    "Developmental_tasks": [
      {
        "project_id": "1",
        "phase_id": "2"
      }
    ]
  },
  "additionalNotes": "æœ¬å‘¨å·¥ä½œé¡ºåˆ©å®Œæˆ",
  "developmentOpportunities": "å¯ä»¥åŠ å¼ºæŠ€æœ¯å­¦ä¹ "
}
```

---

## å®æ–½æ­¥éª¤

### é˜¶æ®µ1ï¼šå‡†å¤‡å·¥ä½œï¼ˆ1å¤©ï¼‰
1. âœ… å¤‡ä»½å½“å‰ä»£ç å’Œæ•°æ®åº“
2. âœ… ç¡®è®¤V26æ•°æ®åº“è¿ç§»å·²å®Œæˆ 
3. âœ… åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ `feature/backend-restructure`

### é˜¶æ®µ2ï¼šEntityå±‚é‡æ„ï¼ˆ2-3å¤©ï¼‰
1. ä¿®æ”¹WeeklyReportå®ä½“ï¼Œåˆ é™¤åºŸå¼ƒå­—æ®µ
2. åˆ›å»ºTaskReportå’ŒDevTaskReportå…³è”è¡¨å®ä½“
3. ç®€åŒ–Userå®ä½“ï¼Œåˆ é™¤éå¿…è¦å­—æ®µ
4. æ›´æ–°Taskå®ä½“ï¼Œåˆ é™¤é¡¹ç›®å…³è”å­—æ®µ
5. æ›´æ–°æ‰€æœ‰å®ä½“çš„å­—æ®µæ˜ å°„æ³¨è§£

### é˜¶æ®µ3ï¼šRepositoryå±‚æ›´æ–°ï¼ˆ1å¤©ï¼‰
1. åˆ›å»ºTaskReportRepositoryå’ŒDevTaskReportRepository
2. æ›´æ–°WeeklyReportRepositoryçš„æŸ¥è¯¢æ–¹æ³•
3. åˆ é™¤åºŸå¼ƒçš„Repositoryæ¥å£

### é˜¶æ®µ4ï¼šDTOå±‚é‡æ„ï¼ˆ2å¤©ï¼‰
1. æŒ‰ç…§error3.mdé‡æ„WeeklyReportCreateRequest
2. æ›´æ–°WeeklyReportResponseä»¥æ”¯æŒå…³è”è¡¨æ•°æ®
3. åˆ é™¤åºŸå¼ƒçš„DTOç±»
4. æ›´æ–°éªŒè¯æ³¨è§£

### é˜¶æ®µ5ï¼šServiceå±‚é‡æ„ï¼ˆ3-4å¤©ï¼‰
1. é‡æ„WeeklyReportServiceæ ¸å¿ƒæ–¹æ³•
2. åˆ›å»ºTaskReportServiceå’ŒDevTaskReportService
3. æ›´æ–°å®¡æ‰¹æµç¨‹Service
4. åˆ é™¤åºŸå¼ƒçš„Serviceæ–¹æ³•

### é˜¶æ®µ6ï¼šControllerå±‚é€‚é…ï¼ˆ2å¤©ï¼‰
1. æ›´æ–°WeeklyReportControllerçš„APIæ¥å£
2. åˆ›å»ºå…³è”è¡¨ç®¡ç†çš„API
3. æ›´æ–°é”™è¯¯å¤„ç†å’Œæƒé™éªŒè¯
4. åˆ é™¤åºŸå¼ƒçš„Controller

### é˜¶æ®µ7ï¼šæµ‹è¯•å’ŒéªŒè¯ï¼ˆ2-3å¤©ï¼‰
1. ç¼–å†™å•å…ƒæµ‹è¯•
2. ç¼–å†™é›†æˆæµ‹è¯•
3. APIæµ‹è¯•
4. ç«¯åˆ°ç«¯æµ‹è¯•

### é˜¶æ®µ8ï¼šéƒ¨ç½²å’Œç›‘æ§ï¼ˆ1å¤©ï¼‰
1. ä»£ç review
2. éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
3. æ€§èƒ½æµ‹è¯•
4. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

**æ€»è®¡é¢„ä¼°æ—¶é—´ï¼š12-17å¤©**

---

## é£é™©å’Œæ³¨æ„äº‹é¡¹

### ğŸ”´ é«˜é£é™©
1. **æ•°æ®ä¸€è‡´æ€§**: ç¡®ä¿å…³è”è¡¨æ•°æ®çš„å®Œæ•´æ€§
2. **æ€§èƒ½å½±å“**: å¤šè¡¨å…³è”æŸ¥è¯¢çš„æ€§èƒ½ä¼˜åŒ–
3. **å‘åå…¼å®¹**: ç°æœ‰APIçš„å…¼å®¹æ€§å¤„ç†

### ğŸŸ¡ ä¸­é£é™©  
1. **å‰ç«¯é€‚é…**: å‰ç«¯éœ€è¦åŒæ­¥è°ƒæ•´æ•°æ®ç»“æ„
2. **æµ‹è¯•è¦†ç›–**: ç¡®ä¿æ‰€æœ‰åœºæ™¯çš„æµ‹è¯•è¦†ç›–
3. **æ•°æ®è¿ç§»**: ç°æœ‰æ•°æ®çš„è¿ç§»å’Œè½¬æ¢

### ğŸŸ¢ ä½é£é™©
1. **ä»£ç æ¸…ç†**: åºŸå¼ƒä»£ç çš„æ¸…ç†å·¥ä½œ
2. **æ–‡æ¡£æ›´æ–°**: APIæ–‡æ¡£çš„æ›´æ–°
3. **ç›‘æ§å‘Šè­¦**: æ–°æ¥å£çš„ç›‘æ§é…ç½®

---

## æ€»ç»“

æœ¬æŒ‡å¯¼æ–‡æ¡£è¯¦ç»†é˜è¿°äº†åŸºäºV26æ•°æ®åº“é‡æ„çš„åç«¯ä»£ç ä¿®æ”¹æ–¹æ¡ˆã€‚æ ¸å¿ƒæ”¹åŠ¨åŒ…æ‹¬ï¼š

1. **å®ä½“å±‚**: åˆ é™¤å¤æ‚å­—æ®µï¼Œæ–°å¢å…³è”è¡¨å®ä½“
2. **æ•°æ®å±‚**: å®ç°å…³è”è¡¨æŸ¥è¯¢å’Œæ“ä½œ
3. **ä¸šåŠ¡å±‚**: é‡æ„å‘¨æŠ¥åˆ›å»ºå’ŒæŸ¥è¯¢é€»è¾‘
4. **æ¥å£å±‚**: é€‚é…error3.mdçš„æ•°æ®ç»“æ„
5. **æµ‹è¯•å±‚**: ç¡®ä¿é‡æ„åçš„åŠŸèƒ½æ­£ç¡®æ€§

é€šè¿‡è¿™ä¸€ç³»åˆ—æ”¹åŠ¨ï¼Œç³»ç»Ÿå°†ä»å¤æ‚çš„JSONå­˜å‚¨æ¨¡å¼è½¬å‘æ¸…æ™°çš„å…³è”è¡¨æ¨¡å¼ï¼Œæä¾›æ›´å¥½çš„æ•°æ®ä¸€è‡´æ€§ã€æŸ¥è¯¢æ€§èƒ½å’Œä¸šåŠ¡é€»è¾‘çš„å¯ç»´æŠ¤æ€§ã€‚

é‡æ„å®Œæˆåï¼Œç³»ç»Ÿå°†å®Œå…¨ç¬¦åˆerror3.mdçš„è¦æ±‚ï¼Œä¸ºå‰ç«¯æä¾›æ ‡å‡†åŒ–çš„æ•°æ®æ¥å£ï¼ŒåŒæ—¶ä¿æŒé«˜æ•ˆçš„æ•°æ®å¤„ç†èƒ½åŠ›ã€‚